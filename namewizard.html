<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NameWizard.io - AI-Powered File Renaming</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-transparent.png">
  <link rel="apple-touch-icon" href="/favicon-transparent.png">
  <!-- SEO Meta Tags -->
  <meta name="description" content="NameWizard.io - The #1 AI-powered file renaming tool. Instantly rename files, photos, and documents using advanced AI. Supports batch renaming, smart organization, and multiple AI models. Free trial available.">
  <meta name="keywords" content="AI file renaming, AI rename files, batch file renaming, smart file organization, AI file organizer, automatic file naming, intelligent file renaming, file management AI, rename photos AI, document renaming tool, AI powered renaming, file renaming software, bulk rename AI, smart file naming">
  <meta name="author" content="NameWizard.io">
  <meta name="robots" content="index, follow, max-image-preview:large, max-snippet:-1, max-video-preview:-1">
  <link rel="canonical" href="https://namewizard.io/">
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://namewizard.io/">
  <meta property="og:title" content="NameWizard.io - AI-Powered File Renaming Tool | #1 Smart File Organizer">
  <meta property="og:description" content="Transform your file organization with AI. NameWizard.io uses advanced AI to intelligently rename and organize your files in seconds. Supports images, documents, videos, and more. Try free!">
  <meta property="og:image" content="https://namewizard.io/logo.png">
  <meta property="og:image:width" content="1200">
  <meta property="og:image:height" content="630">
  <meta property="og:site_name" content="NameWizard.io">
  <meta property="og:locale" content="en_US">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:url" content="https://namewizard.io/">
  <meta name="twitter:title" content="NameWizard.io - AI-Powered File Renaming Tool">
  <meta name="twitter:description" content="The #1 AI-powered file renaming tool. Instantly rename files, photos, and documents using advanced AI. Free trial available.">
  <meta name="twitter:image" content="https://namewizard.io/logo.png">
  <meta name="twitter:creator" content="@namewizard">
  <meta name="twitter:site" content="@namewizard">
  
  <!-- Additional SEO -->
  <meta name="theme-color" content="#f97316">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="NameWizard">
  <meta name="application-name" content="NameWizard.io">
  <meta name="msapplication-TileColor" content="#f97316">
  <meta name="format-detection" content="telephone=no">
  
  <!-- Preconnect for Performance -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com">
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Schema.org JSON-LD -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "NameWizard.io",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Web Browser",
    "description": "AI-powered file renaming and organization tool that uses advanced artificial intelligence to intelligently rename files, photos, and documents.",
    "url": "https://namewizard.io",
    "image": "https://namewizard.io/logo.png",
    "screenshot": "https://namewizard.io/logo.png",
    "aggregateRating": {
      "@type": "AggregateRating",
      "ratingValue": "4.9",
      "ratingCount": "1247",
      "bestRating": "5",
      "worstRating": "1"
    },
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD",
      "availability": "https://schema.org/InStock",
      "priceValidUntil": "2026-12-31"
    },
    "author": {
      "@type": "Organization",
      "name": "NameWizard.io",
      "url": "https://namewizard.io"
    },
    "publisher": {
      "@type": "Organization",
      "name": "NameWizard.io",
      "logo": {
        "@type": "ImageObject",
        "url": "https://namewizard.io/logo.png"
      }
    },
    "featureList": [
      "AI-Powered File Renaming",
      "Batch File Processing",
      "Smart File Organization",
      "Multiple AI Models",
      "Image Recognition",
      "Document Analysis",
      "Custom Naming Rules",
      "Magic Folder Automation"
    ],
    "softwareVersion": "3.0",
    "datePublished": "2024-01-01",
    "dateModified": "2025-12-30"
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "NameWizard.io",
    "url": "https://namewizard.io",
    "potentialAction": {
      "@type": "SearchAction",
      "target": {
        "@type": "EntryPoint",
        "urlTemplate": "https://namewizard.io/search?q={search_term_string}"
      },
      "query-input": "required name=search_term_string"
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Organization",
    "name": "NameWizard.io",
    "url": "https://namewizard.io",
    "logo": "https://namewizard.io/logo.png",
    "description": "AI-powered file renaming and organization platform",
    "sameAs": [
      "https://twitter.com/namewizard",
      "https://facebook.com/namewizard",
      "https://linkedin.com/company/namewizard"
    ],
    "contactPoint": {
      "@type": "ContactPoint",
      "contactType": "Customer Support",
      "email": "support@namewizard.io",
      "availableLanguage": ["English"]
    }
  }
  </script>
  
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "FAQPage",
    "mainEntity": [
      {
        "@type": "Question",
        "name": "What is AI file renaming?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "AI file renaming uses artificial intelligence to automatically analyze and rename files based on their content. NameWizard.io uses advanced AI models to understand images, documents, and other files to generate meaningful, organized filenames."
        }
      },
      {
        "@type": "Question",
        "name": "How does NameWizard.io work?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Simply upload your files to NameWizard.io, and our AI will analyze the content using computer vision and natural language processing. The AI then generates intelligent, descriptive filenames based on what it sees in your files. You can customize naming rules and process files in bulk."
        }
      },
      {
        "@type": "Question",
        "name": "Is NameWizard.io free?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "Yes! NameWizard.io offers a free tier with 100 files per month. We also offer Pro and Business plans with higher limits and advanced features like Magic Folders and priority processing."
        }
      },
      {
        "@type": "Question",
        "name": "What file types does NameWizard.io support?",
        "acceptedAnswer": {
          "@type": "Answer",
          "text": "NameWizard.io supports all major file types including images (JPG, PNG, GIF, WebP), documents (PDF, DOC, DOCX, TXT), videos (MP4, MOV, AVI), and more. Our AI can analyze and rename any file type."
        }
      }
    ]
  }
  </script>
  <style>
:root{--bg:#0a0a0a;--card:#111;--elevated:#1a1a1a;--border:#262626;--text:#fafafa;--text-sec:#a3a3a3;--text-muted:#737373;--orange:#f97316;--orange-dark:#ea580c;--green:#22c55e;--red:#ef4444;--yellow:#eab308;--blue:#3b82f6;--purple:#a855f7;--card-hover:#1f1f1f}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;line-height:1.6}
.container{max-width:1200px;margin:0 auto;padding:0 24px}

/* Buttons */
.btn{display:inline-flex;align-items:center;gap:8px;padding:10px 20px;border-radius:8px;font-weight:500;cursor:pointer;transition:all 0.2s;border:none;font-size:0.95rem}
.btn-primary{background:var(--orange);color:#fff}.btn-primary:hover{background:var(--orange-dark)}
.btn-secondary{background:var(--elevated);color:var(--text);border:1px solid var(--border)}.btn-secondary:hover{background:var(--card-hover)}
.btn-ghost{background:transparent;color:var(--text-sec)}.btn-ghost:hover{color:var(--text);background:var(--elevated)}
.btn-outline{background:transparent;border:1px solid var(--border);color:var(--text)}.btn-outline:hover{border-color:var(--orange);color:var(--orange)}
.btn-danger{background:var(--red);color:#fff}.btn-danger:hover{opacity:0.9}
.btn-sm{padding:6px 12px;font-size:0.85rem}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.btn-locked{background:var(--elevated);color:var(--text-muted);cursor:not-allowed}.btn-locked::before{content:'ðŸ”’';margin-right:4px}

/* Navigation */
nav{background:var(--card);border-bottom:1px solid var(--border);padding:16px 0;position:sticky;top:0;z-index:100}
nav .container{display:flex;align-items:center;justify-content:space-between}
.logo{display:flex;align-items:center;gap:8px;font-weight:700;font-size:1.25rem;cursor:pointer}
.logo svg{color:var(--orange)}
.logo-text{color:var(--text)}
.logo-ai{color:var(--orange)}
.logo-img{height:180px;width:auto;object-fit:contain}
.nav-links{display:flex;gap:8px}
.nav-link{color:var(--text-sec);text-decoration:none;padding:8px 16px;border-radius:6px;font-size:0.9rem;transition:all 0.2s}
.nav-link:hover{color:var(--text);background:var(--elevated)}
.nav-right{display:flex;align-items:center;gap:12px}

/* User Menu */
.user-menu-container{position:relative}
.user-avatar{width:36px;height:36px;border-radius:50%;background:var(--orange);display:flex;align-items:center;justify-content:center;font-weight:600;cursor:pointer;font-size:0.85rem;border:2px solid transparent;transition:border-color 0.2s}
.user-avatar:hover{border-color:var(--orange)}
.user-avatar img{width:100%;height:100%;border-radius:50%;object-fit:cover}
.user-menu{position:absolute;top:calc(100% + 8px);right:0;background:var(--card);border:1px solid var(--border);border-radius:12px;min-width:280px;max-height:600px;overflow-y:auto;display:none;box-shadow:0 10px 40px rgba(0,0,0,0.5)}
.user-menu.open{display:block}
.user-menu-header{padding:16px;border-bottom:1px solid var(--border)}
.user-menu-name{font-weight:600}
.user-menu-email{font-size:0.85rem;color:var(--text-muted)}
.user-menu-stats{padding:12px 16px;border-bottom:1px solid var(--border);font-size:0.85rem}
.user-menu-stats-item{display:flex;justify-content:space-between;margin-bottom:4px}
.user-menu-stats-item:last-child{margin-bottom:0}
.user-menu-plan{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;background:var(--orange);color:#fff;border-radius:4px;font-size:0.75rem;font-weight:600}
.user-menu-plan.god{background:linear-gradient(135deg,#f59e0b,#ef4444)}
.user-menu-items{padding:8px}
.user-menu-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:8px;cursor:pointer;font-size:0.9rem;color:var(--text-sec);transition:all 0.2s}
.user-menu-item:hover{background:var(--elevated);color:var(--text)}
.user-menu-item.danger{color:var(--red)}
.user-menu-divider{height:1px;background:var(--border);margin:8px 0}
.user-menu-god{padding:8px;border-top:1px solid var(--border);background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(239,68,68,0.1))}
.user-menu-god-label{font-size:0.75rem;color:var(--yellow);font-weight:600;padding:4px 12px}
.user-menu-section-label{font-size:0.75rem;color:var(--orange);font-weight:600;padding:8px 12px 4px 12px;text-transform:uppercase;letter-spacing:0.5px}
.user-menu-section{padding:4px 0}
.user-menu-admin{padding:8px;border-top:1px solid var(--border);background:linear-gradient(135deg,rgba(245,158,11,0.05),rgba(239,68,68,0.05))}

/* Pages */
.page{display:none;min-height:calc(100vh - 73px)}
.page.active{display:block}
.landing{padding-top:0}

/* Hero */
.hero{padding:80px 0;text-align:center}
.hero-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;background:rgba(249,115,22,0.1);border:1px solid rgba(249,115,22,0.3);border-radius:50px;font-size:0.85rem;color:var(--orange);margin-bottom:24px}
.hero h1{font-size:3.5rem;font-weight:700;margin-bottom:20px;line-height:1.1}
.hero h1 span{color:var(--orange)}
.hero p{font-size:1.2rem;color:var(--text-sec);max-width:600px;margin:0 auto 32px}
.hero-cta{display:flex;gap:16px;justify-content:center}

/* Features Grid */
.features-section{padding:80px 0;background:var(--card)}
.features-section h2{text-align:center;font-size:2rem;margin-bottom:48px}
.features-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:24px}
.feature-card{background:var(--elevated);border:1px solid var(--border);border-radius:16px;padding:24px;transition:all 0.2s}
.feature-card:hover{border-color:var(--orange);transform:translateY(-2px)}
.feature-icon{width:48px;height:48px;background:rgba(249,115,22,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:16px}
.feature-icon svg{width:24px;height:24px;color:var(--orange)}
.feature-card h3{font-size:1rem;margin-bottom:8px}
.feature-card p{font-size:0.9rem;color:var(--text-sec)}
.feature-card .tier-badge{font-size:0.7rem;padding:2px 6px;border-radius:4px;margin-left:8px}
.tier-badge.free{background:var(--green);color:#fff}
.tier-badge.pro{background:var(--blue);color:#fff}
.tier-badge.business{background:var(--yellow);color:#000}

/* App Layout */
.app-layout{display:grid;grid-template-columns:280px 1fr;gap:24px;padding:24px 0}
.sidebar{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;height:fit-content;position:sticky;top:97px}
.sidebar-section{margin-bottom:24px}
.sidebar-section:last-child{margin-bottom:0}
.sidebar-title{font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.5px;margin-bottom:12px}

/* Model Dropdowns */
.model-select-group{margin-bottom:16px}
.model-select-group label{display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px}
.model-select{width:100%;padding:10px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;cursor:pointer}
.model-select:focus{outline:none;border-color:var(--orange)}
.model-select:disabled{opacity:0.5;cursor:not-allowed}
.model-select option{background:var(--card);color:var(--text)}
.model-locked-msg{font-size:0.75rem;color:var(--yellow);margin-top:4px;display:flex;align-items:center;gap:4px}

/* Main Content */
.main-content{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}

/* Upload Zone */
.upload-zone{border:2px dashed var(--border);border-radius:12px;padding:48px;text-align:center;cursor:pointer;transition:all 0.2s}
.upload-zone:hover,.upload-zone.dragover{border-color:var(--orange);background:rgba(249,115,22,0.05)}
.upload-zone svg{width:48px;height:48px;color:var(--text-muted);margin-bottom:16px}
.upload-zone h3{margin-bottom:8px}
.upload-zone p{color:var(--text-sec);font-size:0.9rem}
.upload-zone input{display:none}

/* File List */
.selected-files-section{margin-top:24px;display:none}
.section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.section-header h3{display:flex;align-items:center;gap:8px}
.file-count{background:var(--orange);color:#fff;padding:2px 8px;border-radius:12px;font-size:0.8rem}
.file-list{display:flex;flex-direction:column;gap:8px;max-height:300px;overflow-y:auto}
.file-item{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--elevated);border-radius:8px}
.file-item input[type="checkbox"]{width:18px;height:18px;accent-color:var(--orange)}
.file-icon{width:36px;height:36px;background:var(--card);border-radius:8px;display:flex;align-items:center;justify-content:center}
.file-icon svg{width:20px;height:20px;color:var(--orange)}
.file-info{flex:1}
.file-name{font-size:0.9rem;font-weight:500;word-break:break-all}
.file-size{font-size:0.8rem;color:var(--text-muted)}
.file-remove{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px}
.file-remove:hover{color:var(--red)}
.file-actions{display:flex;gap:8px;margin-top:16px}

/* Process Button */
.process-section{margin-top:24px;padding-top:24px;border-top:1px solid var(--border);display:flex;align-items:center;justify-content:space-between}
.process-info{font-size:0.9rem;color:var(--text-sec)}
.process-info span{color:var(--orange);font-weight:600}

/* Results */
.results-section{margin-top:24px;display:none}
.results-table{width:100%;border-collapse:collapse}
.results-table th,.results-table td{padding:12px;text-align:left;border-bottom:1px solid var(--border)}
.results-table th{font-size:0.85rem;color:var(--text-muted);font-weight:500}
.new-name{color:var(--green);font-family:'JetBrains Mono',monospace;font-size:0.85rem}
.provider-badge{background:var(--elevated);padding:4px 8px;border-radius:4px;font-size:0.75rem}
.status-ready{color:var(--green);display:flex;align-items:center;gap:4px;font-size:0.85rem}
.status-ready svg{width:16px;height:16px}
.action-btns{display:flex;gap:4px}
.action-btn{background:var(--elevated);border:none;padding:6px;border-radius:4px;cursor:pointer;color:var(--text-sec)}
.action-btn:hover{background:var(--card-hover);color:var(--text)}
.action-btn.danger:hover{color:var(--red)}
.results-actions{margin-top:16px;display:flex;gap:12px}

/* Toast */
.toast-container{position:fixed;top:24px;right:24px;z-index:1000;display:flex;flex-direction:column;gap:12px}
.toast{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px 20px;display:flex;align-items:flex-start;gap:12px;min-width:320px;box-shadow:0 10px 40px rgba(0,0,0,0.3);animation:slideIn 0.3s ease}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.toast.success{border-left:3px solid var(--green)}
.toast.error{border-left:3px solid var(--red)}
.toast-icon{flex-shrink:0;width:20px;height:20px}
.toast.success .toast-icon{color:var(--green)}
.toast.error .toast-icon{color:var(--red)}
.toast-content h4{font-size:0.95rem;margin-bottom:2px}
.toast-content p{font-size:0.85rem;color:var(--text-sec)}

/* Progress Bar */
.progress-bar{width:100%;height:8px;background:var(--elevated);border-radius:4px;overflow:hidden}
.progress-fill{height:100%;background:linear-gradient(90deg,var(--orange),var(--orange-dark));border-radius:4px;transition:width 0.3s ease}
.progress-fill.warning{background:linear-gradient(90deg,var(--yellow),#ca8a04)}
.progress-fill.danger{background:linear-gradient(90deg,var(--red),#dc2626)}

/* Modals */
.modal{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;align-items:center;justify-content:center;z-index:200;padding:24px}
.modal.active{display:flex}
.modal-content{background:var(--card);border:1px solid var(--border);border-radius:16px;max-width:480px;width:100%;max-height:90vh;overflow-y:auto}
.modal-header{display:flex;align-items:center;justify-content:space-between;padding:20px 24px;border-bottom:1px solid var(--border)}
.modal-header h2{font-size:1.25rem}
.modal-close{background:none;border:none;color:var(--text-muted);cursor:pointer;padding:4px}
.modal-close:hover{color:var(--text)}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}

/* Auth Modal */
.auth-tabs{display:flex;border-bottom:1px solid var(--border)}
.auth-tab{flex:1;padding:12px;text-align:center;cursor:pointer;color:var(--text-sec);font-weight:500;transition:all 0.2s;border-bottom:2px solid transparent}
.auth-tab.active{color:var(--orange);border-bottom-color:var(--orange)}
.auth-form{padding:24px}
.form-group{margin-bottom:16px}
.form-group label{display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.95rem}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--orange)}
.password-field{position:relative}
.password-field input{padding-right:44px}
.password-toggle{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:none;border:none;cursor:pointer;color:var(--text-muted);padding:4px;display:flex;align-items:center;justify-content:center}
.password-toggle:hover{color:var(--text)}
.form-divider{display:flex;align-items:center;gap:16px;margin:20px 0;color:var(--text-muted);font-size:0.85rem}
.form-divider::before,.form-divider::after{content:'';flex:1;height:1px;background:var(--border)}
.google-btn{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;padding:12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;font-size:0.95rem;transition:all 0.2s}
.google-btn:hover{background:var(--card-hover);border-color:var(--text-muted)}
.google-btn svg{width:20px;height:20px}

/* Settings Modal */
.settings-tabs{display:flex;gap:8px;padding:0 24px;border-bottom:1px solid var(--border)}
.settings-tab{padding:12px 16px;cursor:pointer;color:var(--text-sec);font-size:0.9rem;border-bottom:2px solid transparent;transition:all 0.2s}
.settings-tab.active{color:var(--orange);border-bottom-color:var(--orange)}
.settings-content{padding:24px}
.settings-section{margin-bottom:24px}
.settings-section:last-child{margin-bottom:0}
.settings-section h3{font-size:0.9rem;color:var(--text-muted);margin-bottom:12px}
.setting-row{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid var(--border)}
.setting-row:last-child{border-bottom:none}
.setting-label{font-size:0.95rem}
.setting-desc{font-size:0.8rem;color:var(--text-muted);margin-top:2px}
.toggle{width:44px;height:24px;background:var(--elevated);border-radius:12px;position:relative;cursor:pointer;transition:background 0.2s}
.toggle::after{content:'';position:absolute;width:20px;height:20px;background:var(--text-muted);border-radius:50%;top:2px;left:2px;transition:all 0.2s}
.toggle.active{background:var(--orange)}
.toggle.active::after{left:22px;background:#fff}

/* Custom Instructions Section */
.custom-instructions{background:var(--elevated);border-radius:12px;padding:20px;margin-top:16px}
.custom-instructions h4{margin-bottom:16px;display:flex;align-items:center;gap:8px}
.custom-instructions h4 svg{color:var(--orange)}
.instruction-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.instruction-group{margin-bottom:0}
.instruction-group label{display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px}
.instruction-group input,.instruction-group select{width:100%;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem}
.instruction-group input:focus,.instruction-group select:focus{outline:none;border-color:var(--orange)}
.instruction-group.full-width{grid-column:1/-1}
.instruction-group textarea{width:100%;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem;min-height:80px;resize:vertical}
.radio-group{display:flex;gap:12px;flex-wrap:wrap}
.radio-option{display:flex;align-items:center;gap:6px;padding:8px 12px;background:var(--card);border:1px solid var(--border);border-radius:6px;cursor:pointer;font-size:0.85rem}
.radio-option.active{border-color:var(--orange);background:rgba(249,115,22,0.1)}
.radio-option input{display:none}
.length-slider{width:100%;accent-color:var(--orange)}
.length-value{font-size:0.85rem;color:var(--orange);margin-left:8px}

/* God Mode Page */
.god-mode-page{padding:24px 0}
.god-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:24px}
.god-header h1{display:flex;align-items:center;gap:12px;font-size:1.5rem}
.god-header h1 span{color:var(--yellow)}
.god-tabs{display:flex;gap:8px;margin-bottom:24px}
.god-tab{padding:10px 20px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;cursor:pointer;font-size:0.9rem;color:var(--text-sec);transition:all 0.2s}
.god-tab.active{background:var(--orange);border-color:var(--orange);color:#fff}

/* Dashboard Stats */
.stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
.stat-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px}
.stat-card h3{font-size:0.85rem;color:var(--text-muted);margin-bottom:8px}
.stat-card .value{font-size:2rem;font-weight:700;color:var(--orange)}
.stat-card .change{font-size:0.85rem;color:var(--green);margin-top:4px}

/* API Cards Grid */
.api-settings-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.api-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.api-card-header{display:flex;align-items:center;gap:12px;padding:16px;border-bottom:1px solid var(--border)}
.api-logo{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.api-logo svg{width:24px;height:24px}
.api-logo.openai{background:#10a37f;color:#fff}
.api-logo.anthropic{background:#d4a574;color:#1a1a1a}
.api-logo.google{background:#fff}
.api-logo.openrouter{background:var(--elevated);color:var(--orange)}
.api-logo.aws{background:#ff9900;color:#fff}
.api-logo.azure{background:#0078d4;color:#fff}
.api-logo.stripe{background:#635bff;color:#fff}
.api-info{flex:1}
.api-info h3{font-size:0.95rem;font-weight:600}
.api-info p{font-size:0.8rem;color:var(--text-muted)}
.api-status{display:flex;align-items:center;gap:6px;font-size:0.8rem}
.api-status .status-dot{width:8px;height:8px;border-radius:50%;background:var(--text-muted)}
.api-status.online .status-dot{background:var(--green)}
.api-status.offline .status-dot{background:var(--red)}
.api-status.degraded .status-dot{background:var(--yellow)}
.api-card-body{padding:16px}
.api-input-group{margin-bottom:12px}
.api-input-group label{display:block;font-size:0.8rem;color:var(--text-sec);margin-bottom:4px}
.api-input-wrapper{display:flex;gap:8px}
.api-input{flex:1;padding:10px;background:var(--elevated);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.85rem}
.api-input:focus{outline:none;border-color:var(--orange)}
.api-toggle-btn{padding:0 10px;background:var(--elevated);border:1px solid var(--border);border-radius:6px;cursor:pointer;color:var(--text-sec)}
.api-toggle-btn:hover{background:var(--card-hover)}
.api-actions{display:flex;gap:8px;margin-top:12px}
.api-metrics{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.api-metric{text-align:center}
.api-metric-value{font-size:0.9rem;font-weight:600;color:var(--orange)}
.api-metric-label{font-size:0.7rem;color:var(--text-muted)}

/* Usage Table */
.users-table{width:100%;border-collapse:collapse;background:var(--card);border-radius:12px;overflow:hidden}
.users-table th,.users-table td{padding:12px 16px;text-align:left;border-bottom:1px solid var(--border)}
.users-table th{background:var(--elevated);font-size:0.8rem;color:var(--text-muted);font-weight:500;text-transform:uppercase}
.users-table tr:last-child td{border-bottom:none}
.users-table .plan-badge{padding:4px 8px;border-radius:4px;font-size:0.75rem;font-weight:600}
.plan-badge.free{background:rgba(107,114,128,0.2);color:var(--text-muted)}
.plan-badge.pro{background:rgba(59,130,246,0.2);color:var(--blue)}
.plan-badge.business{background:rgba(234,179,8,0.2);color:var(--yellow)}
.plan-badge.god{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(239,68,68,0.2));color:var(--orange)}

/* Plan Switcher (God Mode Testing) */
.plan-switcher{padding:16px;background:linear-gradient(135deg,rgba(245,158,11,0.1),rgba(239,68,68,0.1));border:1px solid rgba(245,158,11,0.3);border-radius:12px;margin-bottom:20px}
.plan-switcher label{display:block;font-size:0.85rem;color:var(--yellow);margin-bottom:8px}
.plan-switcher select{width:100%;padding:10px;background:var(--card);border:1px solid rgba(245,158,11,0.3);border-radius:8px;color:var(--text)}

/* Magic Folders */
.magic-folders-list{display:flex;flex-direction:column;gap:16px}
.folder-card{background:var(--card);border:1px solid var(--border);border-radius:12px;overflow:hidden}
.folder-header{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border)}
.folder-name{font-weight:600;display:flex;align-items:center;gap:8px}
.folder-name svg{color:var(--orange)}
.folder-status{font-size:0.8rem;padding:4px 8px;border-radius:4px}
.folder-status.active{background:rgba(34,197,94,0.2);color:var(--green)}
.folder-status.paused{background:rgba(107,114,128,0.2);color:var(--text-muted)}
.folder-body{padding:16px}
.folder-settings{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
.folder-stats{display:flex;gap:24px;margin-top:16px;padding-top:16px;border-top:1px solid var(--border)}
.folder-stat{text-align:center}
.folder-stat-value{font-size:1.25rem;font-weight:600;color:var(--orange)}
.folder-stat-label{font-size:0.8rem;color:var(--text-muted)}

/* Upgrade Modal */
.upgrade-modal .modal-content{max-width:600px}
.upgrade-plans{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;padding:24px}
.upgrade-plan{background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;cursor:pointer;transition:all 0.2s}
.upgrade-plan:hover{border-color:var(--orange)}
.upgrade-plan.popular{border-color:var(--orange);position:relative}
.upgrade-plan.popular::before{content:'Popular';position:absolute;top:-10px;left:50%;transform:translateX(-50%);background:var(--orange);color:#fff;padding:2px 12px;border-radius:10px;font-size:0.75rem}
.upgrade-plan h3{font-size:1.1rem;margin-bottom:8px}
.upgrade-plan .price{font-size:1.75rem;font-weight:700;color:var(--orange)}
.upgrade-plan .price span{font-size:0.9rem;color:var(--text-muted);font-weight:400}
.upgrade-plan ul{list-style:none;margin:16px 0;text-align:left}
.upgrade-plan li{padding:6px 0;font-size:0.85rem;color:var(--text-sec);display:flex;align-items:center;gap:8px}
.upgrade-plan li svg{color:var(--green);flex-shrink:0}

/* Responsive */
@media(max-width:1024px){.app-layout{grid-template-columns:1fr}.sidebar{display:none}.features-grid{grid-template-columns:repeat(2,1fr)}.stats-grid{grid-template-columns:repeat(2,1fr)}.api-settings-grid{grid-template-columns:1fr}.ai-features-grid{grid-template-columns:repeat(2,1fr)}.api-providers-grid{grid-template-columns:1fr}.api-status-grid{grid-template-columns:repeat(2,1fr)}.folder-options-grid{grid-template-columns:repeat(2,1fr)}.steps-grid{grid-template-columns:repeat(2,1fr)}}
@media(max-width:768px){.nav-links{display:none}.hero h1{font-size:2.5rem}.features-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr}.instruction-grid{grid-template-columns:1fr}.ai-features-grid{grid-template-columns:1fr}.api-status-grid{grid-template-columns:1fr}.folder-options-grid{grid-template-columns:1fr}.steps-grid{grid-template-columns:1fr}.stats-row{grid-template-columns:1fr}}

/* Animations */
@keyframes spin{from{transform:rotate(0deg)}to{transform:rotate(360deg)}}
.spin{animation:spin 1s linear infinite}

/* Plan Badge in Navbar */
.nav-plan-badge{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:20px;font-size:0.8rem;font-weight:600;color:var(--text)}
.nav-plan-badge.free{border-color:var(--green);color:var(--green)}
.nav-plan-badge.paygo{border-color:var(--purple);color:var(--purple);gap:8px}
.nav-plan-badge.paygo .plan-name{font-weight:600}
.nav-plan-badge.paygo .credit-count{font-weight:400;opacity:0.8}
.nav-plan-badge.pro{border-color:var(--blue);color:var(--blue)}
.nav-plan-badge.business{border-color:var(--yellow);color:var(--yellow)}
.nav-plan-badge.god{background:linear-gradient(135deg,rgba(245,158,11,0.2),rgba(239,68,68,0.2));border-color:var(--orange);color:var(--orange)}

/* Stats Section */
.stats-section{padding:60px 0;background:var(--bg)}
.stats-row{display:grid;grid-template-columns:repeat(3,1fr);gap:32px;max-width:800px;margin:0 auto;text-align:center}
.stat-item{padding:24px}
.stat-number{font-size:3rem;font-weight:700;color:var(--orange);margin-bottom:8px}
.stat-label{color:var(--text-sec);font-size:1rem}

/* How It Works Section */
.how-it-works{margin-top:32px;padding:32px;background:var(--elevated);border:1px solid var(--border);border-radius:16px}
.how-it-works h2{font-size:1.5rem;margin-bottom:24px;display:flex;align-items:center;gap:12px}
.steps-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.step-card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;transition:all 0.2s}
.step-card:hover{border-color:var(--orange);transform:translateY(-2px)}
.step-number{width:36px;height:36px;background:var(--orange);color:#fff;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;margin:0 auto 12px;font-size:0.9rem}
.step-card h4{margin-bottom:8px;font-size:0.95rem}
.step-card p{color:var(--text-sec);font-size:0.8rem;line-height:1.4}

/* AI Features Page */
.ai-features-page{padding:40px 24px}
.ai-features-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.ai-feature-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;transition:all 0.2s}
.ai-feature-card:hover{border-color:var(--orange)}
.ai-feature-card.disabled{opacity:0.5}
.ai-feature-header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px}
.ai-feature-icon{width:48px;height:48px;background:rgba(249,115,22,0.1);border-radius:12px;display:flex;align-items:center;justify-content:center}
.ai-feature-icon svg{width:24px;height:24px;color:var(--orange)}
.ai-feature-card h3{font-size:1rem;margin-bottom:8px}
.ai-feature-card p{color:var(--text-sec);font-size:0.85rem;margin-bottom:16px}
.ai-feature-footer{display:flex;justify-content:space-between;align-items:center;padding-top:12px;border-top:1px solid var(--border)}
.ai-feature-limit{font-size:0.8rem;color:var(--text-muted)}
.ai-feature-limit span{color:var(--text);font-weight:600}
.feature-toggle{position:relative;width:50px;height:26px;background:var(--elevated);border-radius:13px;cursor:pointer;transition:all 0.2s}
.feature-toggle::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:var(--text-muted);border-radius:50%;transition:all 0.2s}
.feature-toggle.active{background:var(--orange)}
.feature-toggle.active::after{left:27px;background:#fff}
.feature-toggle.locked{opacity:0.5;cursor:not-allowed}

/* API Settings Page */
.api-settings-page{padding:40px 24px}
.api-settings-page h1{margin-bottom:32px}
.api-providers-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;margin-bottom:32px}
.api-provider-card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.api-provider-header{display:flex;align-items:center;gap:16px;margin-bottom:20px}
.api-provider-logo{width:48px;height:48px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.5rem}
.api-provider-info h3{font-size:1.1rem;margin-bottom:4px}
.api-provider-info p{font-size:0.85rem;color:var(--text-sec)}
.api-key-input-group{display:flex;gap:8px;margin-bottom:12px}
.api-key-input-group input{flex:1;padding:12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:'JetBrains Mono',monospace;font-size:0.85rem}
.api-key-input-group button{padding:12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text-sec);cursor:pointer}
.api-key-input-group button:hover{background:var(--card-hover);color:var(--text)}
.api-provider-actions{display:flex;gap:8px}
.api-status-overview{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.api-status-overview h2{margin-bottom:20px}
.api-status-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px}
.api-status-item{background:var(--elevated);border-radius:12px;padding:16px;text-align:center}
.api-status-item h4{font-size:0.9rem;margin-bottom:8px}
.api-status-indicator{display:inline-flex;align-items:center;gap:6px;font-size:0.85rem}
.api-status-indicator .dot{width:8px;height:8px;border-radius:50%}
.api-status-indicator .dot.online{background:var(--green)}
.api-status-indicator .dot.offline{background:var(--red)}
.api-status-indicator .dot.unknown{background:var(--text-muted)}

/* Magic Folders Full Page */
.magic-folders-page{padding:40px 24px}
.magic-folders-page h1{margin-bottom:32px}
.folder-config-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px}
.folder-config-section h3{margin-bottom:20px;display:flex;align-items:center;gap:12px}
.folder-options-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:20px}
.folder-option{display:flex;flex-direction:column;gap:8px}
.folder-option label{font-size:0.85rem;color:var(--text-sec)}
.folder-option select,.folder-option input{padding:10px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text)}
.checkbox-option{display:flex;align-items:center;gap:10px;cursor:pointer}
.checkbox-option input{width:18px;height:18px;accent-color:var(--orange)}
.space-buttons{display:flex;gap:8px}
.space-btn{padding:8px 16px;background:var(--elevated);border:1px solid var(--border);border-radius:6px;cursor:pointer;color:var(--text-sec);font-size:0.9rem;transition:all 0.2s}
.space-btn:hover{border-color:var(--orange);color:var(--text)}
.space-btn.active{background:var(--orange);border-color:var(--orange);color:#fff}
.extensions-grid{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
.ext-btn{padding:6px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:4px;cursor:pointer;font-size:0.8rem;color:var(--text-sec)}
.ext-btn:hover{border-color:var(--orange)}
.ext-btn.active{background:var(--orange);border-color:var(--orange);color:#fff}
.template-builder{background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:20px;margin-top:20px}
.template-builder h4{margin-bottom:16px}
.template-tags{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:16px}
.template-tag{padding:8px 14px;background:var(--card);border:1px solid var(--border);border-radius:20px;cursor:grab;font-size:0.85rem;display:flex;align-items:center;gap:6px;transition:all 0.2s}
.template-tag:hover{border-color:var(--orange);background:rgba(249,115,22,0.1)}
.template-tag.dragging{opacity:0.5}
.template-dropzone{min-height:60px;background:var(--bg);border:2px dashed var(--border);border-radius:8px;padding:16px;display:flex;flex-wrap:wrap;gap:8px;align-items:center}
.template-dropzone.dragover{border-color:var(--orange);background:rgba(249,115,22,0.05)}
.template-dropzone .template-tag{cursor:grab;background:var(--orange);border-color:var(--orange);color:#fff}
.template-dropzone .template-tag .remove-tag{margin-left:4px;cursor:pointer;opacity:0.7}
.template-dropzone .template-tag .remove-tag:hover{opacity:1}
.template-preview{margin-top:16px;padding:16px;background:var(--card);border-radius:8px}
.template-preview label{font-size:0.8rem;color:var(--text-muted);margin-bottom:8px;display:block}
.template-preview-text{font-family:'JetBrains Mono',monospace;font-size:0.95rem;color:var(--green)}
.folder-list-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.folder-list-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
.magic-folder-item{display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--elevated);border-radius:12px;margin-bottom:12px}
.magic-folder-item:last-child{margin-bottom:0}
.magic-folder-info{display:flex;align-items:center;gap:16px}
.magic-folder-icon{width:44px;height:44px;background:rgba(249,115,22,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--text-muted)}
.magic-folder-icon.active{background:rgba(249,115,22,0.2);color:var(--orange)}
.magic-folder-icon svg{color:inherit}
.magic-folder-name{font-size:1rem;font-weight:600;margin-bottom:4px}
.magic-folder-path{font-size:0.85rem;color:var(--text-sec);margin-bottom:4px;font-family:'JetBrains Mono',monospace}
.magic-folder-stats{font-size:0.8rem;color:var(--text-muted)}
.magic-folder-actions{display:flex;align-items:center;gap:12px}
.btn-sm{padding:6px 12px;font-size:0.85rem}
.btn.danger{color:var(--red)}
.btn.danger:hover{background:rgba(239,68,68,0.1)}
.ai-section{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px}
.ai-section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
.ai-section-header h2{font-size:1.25rem;margin:0}
.watch-agent-item,.api-token-item{display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--elevated);border-radius:12px;margin-bottom:12px}
.watch-agent-info,.api-token-info{display:flex;align-items:center;gap:16px}
.watch-agent-icon{width:44px;height:44px;background:rgba(249,115,22,0.1);border-radius:10px;display:flex;align-items:center;justify-content:center;color:var(--text-muted)}
.watch-agent-icon.active{background:rgba(34,197,94,0.15);color:var(--green)}
.watch-agent-name,.api-token-name{font-size:1rem;font-weight:600;margin-bottom:4px}
.watch-agent-path,.api-token-key{font-size:0.85rem;color:var(--text-sec);font-family:'JetBrains Mono',monospace;margin-bottom:4px}
.watch-agent-stats,.api-token-stats{font-size:0.8rem;color:var(--text-muted)}
.watch-agent-actions{display:flex;gap:8px}
.text-green{color:var(--green)}
.text-muted{color:var(--text-muted)}

/* Google Auth Button Prominent */
.google-btn-primary{width:100%;display:flex;align-items:center;justify-content:center;gap:12px;padding:14px;background:#fff;border:none;border-radius:8px;color:#333;cursor:pointer;font-size:1rem;font-weight:500;transition:all 0.2s;margin-bottom:16px}
.google-btn-primary:hover{background:#f5f5f5;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.google-btn-primary svg{width:20px;height:20px}


  
/* Top Navigation Bar with Icons */
.app-top-nav{background:var(--bg);border-bottom:1px solid var(--border);padding:16px 0;margin-bottom:24px}
.app-top-nav .container{display:flex;align-items:center;justify-content:space-between;gap:24px}
.app-nav-items{display:flex;align-items:center;gap:8px;flex:1}
.app-nav-item{display:flex;align-items:center;gap:8px;padding:10px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text-sec);cursor:pointer;transition:all 0.2s;font-size:0.9rem}
.app-nav-item:hover{background:var(--elevated);color:var(--text);border-color:var(--orange)}
.app-nav-item.active{background:var(--orange);color:#fff;border-color:var(--orange)}
.app-nav-item svg{width:18px;height:18px}
.app-nav-item.god-mode{color:var(--orange)}
.app-nav-item.god-mode:hover{background:rgba(249,115,22,0.1)}

/* App Tabs */
.app-tabs{display:flex;gap:12px;margin-bottom:24px}
.app-tab{display:flex;align-items:center;gap:8px;padding:12px 20px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text-sec);cursor:pointer;transition:all 0.2s;font-size:0.95rem}
.app-tab:hover{background:var(--elevated);color:var(--text)}
.app-tab.active{background:var(--orange);color:#fff;border-color:var(--orange)}
.app-tab svg{width:18px;height:18px}

/* Plan Indicator */
.plan-indicator{display:flex;align-items:center;gap:12px}
.plan-badge-top{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--card);border:1px solid var(--border);border-radius:8px;font-size:0.9rem}
.plan-badge-top .plan-name{color:var(--orange);font-weight:600}
.plan-badge-top .plan-usage{color:var(--text-sec)}
.plan-badge-top .usage-number{background:var(--orange);color:#fff;padding:2px 8px;border-radius:4px;font-size:0.8rem;margin-left:4px}

/* File Format Tags */
.file-formats{display:flex;flex-wrap:wrap;gap:8px;justify-content:center;margin:16px 0}
.format-tag{padding:6px 12px;background:var(--elevated);border:1px solid var(--border);border-radius:6px;font-size:0.75rem;color:var(--text-sec);font-family:'JetBrains Mono',monospace}

/* Updated sidebar for black theme */
.sidebar{background:var(--bg);border:1px solid var(--border);border-radius:16px;padding:20px;height:fit-content;position:sticky;top:97px}

/* Plan Switcher Styling */
.plan-switcher{background:linear-gradient(135deg,rgba(249,115,22,0.15),rgba(234,88,12,0.1));border:2px solid var(--orange);border-radius:12px;padding:16px}
.plan-switcher label{display:flex;align-items:center;gap:6px;font-size:0.85rem;color:var(--orange);font-weight:600;margin-bottom:8px}
.plan-switcher select{width:100%;padding:10px 12px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.95rem;cursor:pointer;font-weight:600}




    /* Model Configuration Styles */
    .model-config-section {
      border-top: 1px solid var(--border, #2a2a3a);
      padding-top: 20px;
      margin-top: 20px;
    }
    
    .model-config-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      flex-wrap: wrap;
      gap: 12px;
    }
    
    .model-config-header h4 {
      font-size: 1rem;
      color: var(--orange, #ff6b35);
      margin: 0;
    }
    
    .plan-filter-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .plan-filter-btn {
      padding: 6px 12px;
      background: var(--elevated, #1a1a24);
      border: 1px solid var(--border, #2a2a3a);
      border-radius: 6px;
      color: var(--text-sec, #8a8a9a);
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .plan-filter-btn.active {
      background: var(--orange, #ff6b35);
      color: white;
      border-color: var(--orange, #ff6b35);
    }
    
    .plan-filter-btn:hover:not(.active) {
      background: var(--border, #2a2a3a);
      color: var(--text, #ffffff);
    }
    
    .model-config-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.875rem;
    }
    
    .model-config-table th {
      text-align: left;
      padding: 12px 8px;
      background: var(--elevated, #1a1a24);
      color: var(--text-sec, #8a8a9a);
      font-weight: 500;
      border-bottom: 1px solid var(--border, #2a2a3a);
    }
    
    .model-config-table th:first-child {
      border-radius: 8px 0 0 0;
    }
    
    .model-config-table th:last-child {
      border-radius: 0 8px 0 0;
    }
    
    .model-config-table td {
      padding: 12px 8px;
      border-bottom: 1px solid var(--border, #2a2a3a);
      vertical-align: middle;
    }
    
    .model-config-table tr:last-child td {
      border-bottom: none;
    }
    
    .model-config-table tr:hover {
      background: rgba(255, 107, 53, 0.05);
    }
    
    .model-name {
      font-weight: 500;
    }
    
    .model-version {
      color: var(--text-sec, #8a8a9a);
      font-size: 0.75rem;
      display: block;
    }
    
    .category-tags {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    
    .category-tag {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.7rem;
      font-weight: 500;
    }
    
    .category-tag.text {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }
    
    .category-tag.vision {
      background: rgba(139, 92, 246, 0.2);
      color: #8b5cf6;
    }
    
    .category-tag.audio {
      background: rgba(16, 163, 127, 0.2);
      color: #10a37f;
    }
    
    .plan-config {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }
    
    .plan-checkbox {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .plan-checkbox input[type="checkbox"] {
      width: 16px;
      height: 16px;
      accent-color: var(--orange, #ff6b35);
      cursor: pointer;
    }
    
    .priority-select {
      padding: 4px 8px;
      background: var(--elevated, #1a1a24);
      border: 1px solid var(--border, #2a2a3a);
      border-radius: 4px;
      color: var(--text, #ffffff);
      font-size: 0.7rem;
      cursor: pointer;
      min-width: 80px;
    }
    
    .priority-select:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    .priority-select option {
      background: var(--card, #12121a);
    }
    
    .plan-col-free { background: rgba(239, 68, 68, 0.05); }
    .plan-col-credits-low { background: rgba(245, 158, 11, 0.05); }
    .plan-col-credits-high { background: rgba(59, 130, 246, 0.05); }
    .plan-col-unlimited { background: rgba(139, 92, 246, 0.05); }
    
    .ocr-plan-config {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border, #2a2a3a);
    }
    
    .ocr-plan-item {
      background: var(--elevated, #1a1a24);
      border-radius: 8px;
      padding: 12px;
      text-align: center;
    }
    
    .ocr-plan-item h5 {
      font-size: 0.75rem;
      color: var(--text-sec, #8a8a9a);
      margin: 0 0 8px 0;
      text-transform: uppercase;
    }
    
    .ocr-plan-item .plan-checkbox {
      justify-content: center;
      margin-bottom: 8px;
      font-size: 0.75rem;
    }
    
    @media (max-width: 768px) {
      .model-config-table {
        display: block;
        overflow-x: auto;
      }
      
      .ocr-plan-config {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .model-config-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    </style>
</head>
<body>
  <div class="toast-container" id="toastContainer"></div>

  <!-- Navigation -->
  <nav>
    <div class="container">
      <div class="logo" onclick="nav('pageLanding')">
        <img src="/logo.png" alt="NameWizard.io" class="logo-img">
      </div>
      <div class="nav-links" id="navLinks"></div>
      <div class="nav-right" id="navRight"></div>
    </div>
  </nav>

  <!-- Landing Page -->
  <div class="page landing active" id="pageLanding">
    <section class="hero">
      <div class="container">
        <div class="hero-badge">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
          AI-Powered File Renaming
        </div>
        <h1>Intelligent File Renaming with <span>NameWizard.io</span></h1>
        <p>Use AI to analyze your files - OCR for documents, vision for images, transcription for audio - and generate perfect, descriptive filenames automatically.</p>
        <div class="hero-cta" style="flex-direction:column;align-items:center;gap:12px;max-width:320px;margin:0 auto">
          <button class="google-btn-primary" onclick="googleLogin()">
            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Sign in with Google
          </button>
          <a href="#" onclick="showAuthModal('login');return false" style="color:var(--text-sec);font-size:0.9rem;text-decoration:none">or sign in with email</a>
        </div>
      </div>
    </section>

    <!-- Stats Section -->
    <section class="stats-section">
      <div class="container">
        <div class="stats-row">
          <div class="stat-item">
            <div class="stat-number">10+</div>
            <div class="stat-label">AI Providers</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">1000+</div>
            <div class="stat-label">Files Processed</div>
          </div>
          <div class="stat-item">
            <div class="stat-number">99%</div>
            <div class="stat-label">Accuracy Rate</div>
          </div>
        </div>
      </div>
    </section>

    <section class="features-section" id="features" style="padding:80px 0;background:var(--bg)">
      <div class="container">
        <h2>Powerful Features for Every File Type</h2>
        <div class="features-grid">
          
          <!-- Smart Hybrid Analysis - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></div>
            <h3>Smart Hybrid Analysis <span class="tier-badge pro">Pro</span></h3>
            <p>Automatically combines Vision AI and OCR for documents with text. Intelligently detects when to use OCR based on image content for maximum accuracy.</p>
          </div>

          <!-- Provider SDK - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/><path d="M2 12h20"/></svg></div>
            <h3>19+ AI Provider Options <span class="tier-badge power">Power</span></h3>
            <p>Choose from 5 Vision providers (GPT-4V, Gemini, Claude, Qwen, LLaVA), 4 OCR engines (Tesseract, Google Cloud, AWS, Azure), 4 Text LLMs, and 4 Audio transcription services.</p>
          </div>

          <!-- Circuit Breakers & Failover - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M9 12l2 2 4-4"/></svg></div>
            <h3>Automatic Failover <span class="tier-badge power">Power</span></h3>
            <p>Circuit breakers detect provider failures and rate limits, automatically failing over to backup providers. Your files always get processed.</p>
          </div>

          <!-- Idempotent Processing - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></div>
            <h3>No Duplicate Charges <span class="tier-badge pro">Pro</span></h3>
            <p>Idempotent processing prevents duplicate file processing and double-charging when requests are retried. Safe to retry failed uploads.</p>
          </div>

          <!-- Background Job Queue - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg></div>
            <h3>Async Processing Queue <span class="tier-badge pro">Pro</span></h3>
            <p>Files are processed asynchronously using BullMQ and Redis. Track job status, cancel jobs, and handle thousands of files without blocking.</p>
          </div>

          <!-- Naming Template System - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg></div>
            <h3>Pre-built Templates <span class="tier-badge free">Free</span></h3>
            <p>Use pre-built naming templates for common use cases: Business Documents, Invoices, Project Files. Or create your own custom templates.</p>
          </div>

          <!-- API Key Management - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"/></svg></div>
            <h3>Bring Your Own Keys <span class="tier-badge power">Power</span></h3>
            <p>Configure your own API keys for OpenAI, Anthropic, Google, and other providers. Use your own quotas and billing for maximum control.</p>
          </div>

          <!-- Magic Folders - UPDATED -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg></div>
            <h3>Magic Folders <span class="tier-badge pro">Pro</span></h3>
            <p>Set up automated folders with database-backed state, concurrency controls, and scheduled processing. Files are automatically renamed as they're added.</p>
          </div>

          <!-- Structured Logging - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><line x1="10" y1="9" x2="8" y2="9"/></svg></div>
            <h3>End-to-End Tracing <span class="tier-badge power">Power</span></h3>
            <p>Every request has a correlation ID for end-to-end tracing. Structured JSON logs make debugging easy. Full observability into the system.</p>
          </div>

          <!-- Prometheus Metrics - NEW -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg></div>
            <h3>System Health Metrics <span class="tier-badge power">Power</span></h3>
            <p>Prometheus-style metrics track latency, error rates, provider usage, and hybrid hit rates. Monitor system health and SLOs in real-time.</p>
          </div>

          <!-- Custom Instructions - EXISTING -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></div>
            <h3>Custom Instructions <span class="tier-badge pro">Pro</span></h3>
            <p>Define naming patterns, prefixes, suffixes, date formats, and custom AI prompts. Full control over how your files are named.</p>
          </div>

          <!-- Batch Processing - EXISTING -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg></div>
            <h3>Batch Processing <span class="tier-badge free">Free</span></h3>
            <p>Process thousands of files at once. Upload entire folders and let AI rename everything automatically. Fast and efficient.</p>
          </div>

          <!-- Cloud Sync - RESTORED -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg></div>
            <h3>Cloud Sync <span class="tier-badge pro">Pro</span></h3>
            <p>Connect Google Drive and Dropbox to rename files directly in cloud storage. Seamless integration with OAuth authentication and automatic file syncing.</p>
          </div>

          <!-- Deduplication - RESTORED -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></div>
            <h3>Deduplication <span class="tier-badge pro">Pro</span></h3>
            <p>Hash-based duplicate detection (Free) or semantic AI-powered similarity matching (Pro+) to identify and manage duplicate files across your library.</p>
          </div>

          <!-- Undo/Rollback - RESTORED -->
          <div class="feature-card">
            <div class="feature-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></div>
            <h3>Undo/Rollback <span class="tier-badge pro">Pro</span></h3>
            <p>Revert file renames with full database-backed history. Undo individual operations or entire batches. Pro+ users get unlimited history retention.</p>
          </div>

        </div>
      </div>
    </section>




    <!-- How It Works Section -->
    <section class="how-it-works-section" id="how-it-works" style="padding:80px 0;background:var(--elevated)">
      <div class="container">
        <h2 style="text-align:center;font-size:2rem;margin-bottom:16px">How It Works</h2>
        <p style="text-align:center;color:var(--text-sec);margin-bottom:48px;max-width:600px;margin-left:auto;margin-right:auto">Transform your chaotic file names into organized, searchable assets in just a few clicks</p>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:32px;max-width:1200px;margin:0 auto">
          <div style="text-align:center">
            <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:2rem;font-weight:700;color:#fff">1</div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">Upload Your Files</h3>
            <p style="color:var(--text-sec);line-height:1.6">Drag and drop files (PDF, DOCX, images, audio) into the web app or set up Magic Folders for automatic processing</p>
          </div>
          
          <div style="text-align:center">
            <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:2rem;font-weight:700;color:#fff">2</div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">AI Analyzes Content</h3>
            <p style="color:var(--text-sec);line-height:1.6">Our AI reads text via OCR, understands images with computer vision, and transcribes audio to extract meaningful context</p>
          </div>
          
          <div style="text-align:center">
            <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:2rem;font-weight:700;color:#fff">3</div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">Review & Customize</h3>
            <p style="color:var(--text-sec);line-height:1.6">Preview AI-generated names, apply custom templates, adjust formatting, and add prefixes or date stamps as needed</p>
          </div>
          
          <div style="text-align:center">
            <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 24px;font-size:2rem;font-weight:700;color:#fff">4</div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">Download & Organize</h3>
            <p style="color:var(--text-sec);line-height:1.6">Download renamed files or sync directly to Google Drive and Dropbox. Undo anytime with full rename history</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Use Cases Section -->
    <section class="use-cases-section" id="use-cases" style="padding:80px 0">
      <div class="container">
        <h2 style="text-align:center;font-size:2rem;margin-bottom:16px">Who Uses NameWizard.io?</h2>
        <p style="text-align:center;color:var(--text-sec);margin-bottom:48px;max-width:600px;margin-left:auto;margin-right:auto">From solo professionals to enterprise teams, NameWizard.io adapts to your workflow</p>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:32px;max-width:1200px;margin:0 auto">
          <!-- Teams & Collaboration -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px">
            <div style="width:48px;height:48px;background:var(--orange);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:20px">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            </div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">Teams & Collaboration</h3>
            <p style="color:var(--text-sec);line-height:1.6;margin-bottom:16px">Marketing teams organizing campaign assets, legal firms managing case documents, and HR departments standardizing employee files</p>
            <ul style="list-style:none;padding:0;margin:0">
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Consistent naming across departments</span>
              </li>
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Shared templates and naming conventions</span>
              </li>
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Cloud sync for seamless collaboration</span>
              </li>
            </ul>
          </div>

          <!-- Professional Workflows -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px">
            <div style="width:48px;height:48px;background:var(--orange);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:20px">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></svg>
            </div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">Professional Workflows</h3>
            <p style="color:var(--text-sec);line-height:1.6;margin-bottom:16px">Photographers organizing shoots, accountants managing receipts and invoices, and researchers cataloging papers and datasets</p>
            <ul style="list-style:none;padding:0;margin:0">
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>OCR for invoices and receipts</span>
              </li>
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Vision AI for photo cataloging</span>
              </li>
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Custom date and metadata formatting</span>
              </li>
            </ul>
          </div>

          <!-- Power Users & Automation -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px">
            <div style="width:48px;height:48px;background:var(--orange);border-radius:12px;display:flex;align-items:center;justify-content:center;margin-bottom:20px">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 14s1.5 2 4 2 4-2 4-2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/></svg>
            </div>
            <h3 style="font-size:1.25rem;margin-bottom:12px">Power Users & Automation</h3>
            <p style="color:var(--text-sec);line-height:1.6;margin-bottom:16px">Developers managing codebases, content creators organizing media libraries, and IT teams automating file workflows</p>
            <ul style="list-style:none;padding:0;margin:0">
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Magic Folders for automatic renaming</span>
              </li>
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>API access for custom integrations</span>
              </li>
              <li style="padding:8px 0;display:flex;align-items:start;gap:8px;color:var(--text-sec)">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="margin-top:2px;flex-shrink:0"><polyline points="20 6 9 17 4 12"/></svg>
                <span>Batch processing thousands of files</span>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- Pricing Section -->
    <section class="pricing-section" id="pricing" style="padding:80px 0">
      <div class="container">
        <h2 style="text-align:center;font-size:2rem;margin-bottom:16px">Simple, Transparent Pricing</h2>
        <p style="text-align:center;color:var(--text-sec);margin-bottom:48px">Start free with AI-powered renaming. Upgrade when you need more.</p>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:24px;max-width:1200px;margin:0 auto">
          <!-- Starter (Free) Plan -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;text-align:center">
            <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px">
              <span style="background:var(--elevated);color:var(--text-sec);padding:4px 16px;border-radius:20px;font-size:0.8rem;font-weight:600">Starter</span>
              <span style="background:var(--green);color:#fff;padding:4px 16px;border-radius:20px;font-size:0.8rem;font-weight:600">Free</span>
            </div>
            <div style="font-size:3rem;font-weight:700;margin-bottom:8px">$0</div>
            <p style="color:var(--text-sec);margin-bottom:24px">No payment needed</p>
            <ul style="list-style:none;text-align:left;margin-bottom:24px">
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Try Smart AI File renaming</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> <strong>15 Files/month</strong></li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Desktop App (Win & Mac)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Batch Rename</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Auto Rename (Magic Folders)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Normal Support</li>
            </ul>
            <button class="btn btn-outline" style="width:100%" onclick="showAuthModal('register')">Start Free</button>
          </div>
          <!-- Pro Plan -->
          <div style="background:var(--card);border:2px solid var(--orange);border-radius:16px;padding:32px;text-align:center;position:relative">
            <div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--orange);color:#fff;padding:4px 16px;border-radius:20px;font-size:0.8rem;font-weight:600">MOST POPULAR</div>
            <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px;margin-top:8px">
              <span style="background:var(--orange);color:#fff;padding:4px 16px;border-radius:20px;font-size:0.8rem;font-weight:600">Pro</span>
            </div>
            <div style="font-size:3rem;font-weight:700;margin-bottom:8px;color:var(--orange)">$9.95<span style="font-size:1rem;color:var(--text-sec)">/mo</span></div>
            <p style="color:var(--text-sec);margin-bottom:24px">For regular file organization needs</p>
            <ul style="list-style:none;text-align:left;margin-bottom:24px">
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Smart AI File renaming</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> <strong>200 Files/month</strong></li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Desktop App (Win & Mac)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Batch Rename</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Auto Rename (Magic Folders)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Normal Support</li>
            </ul>
            <button class="btn btn-primary" style="width:100%" onclick="showAuthModal('register')">Go Pro</button>
          </div>
          <!-- Power User Plan -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;text-align:center">
            <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px">
              <span style="background:var(--blue);color:#fff;padding:4px 16px;border-radius:20px;font-size:0.8rem;font-weight:600">Power User</span>
              <span style="background:var(--purple);color:#fff;padding:4px 12px;border-radius:20px;font-size:0.75rem;font-weight:600">ðŸ‘‘ Save 40%</span>
            </div>
            <div style="font-size:3rem;font-weight:700;margin-bottom:8px">$29.95<span style="font-size:1rem;color:var(--text-sec)">/mo</span></div>
            <p style="color:var(--text-sec);margin-bottom:24px">For heavy-duty file management</p>
            <ul style="list-style:none;text-align:left;margin-bottom:24px">
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Enhanced Smart AI File renaming</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> <strong>1000 Files/month</strong></li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Desktop App (Win & Mac)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Batch Rename</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Auto Rename (Magic Folders)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Priority Support</li>
            </ul>
            <button class="btn btn-primary" style="width:100%" onclick="showAuthModal('register')">Go Power</button>
          </div>
          <!-- Ultimate Plan -->
          <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;text-align:center">
            <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:16px">
              <span style="background:linear-gradient(135deg, var(--purple), var(--orange));color:#fff;padding:4px 16px;border-radius:20px;font-size:0.8rem;font-weight:600">Ultimate</span>
            </div>
            <div style="font-size:3rem;font-weight:700;margin-bottom:8px">$99.95<span style="font-size:1rem;color:var(--text-sec)">/mo</span></div>
            <p style="color:var(--text-sec);margin-bottom:24px">For heavy-duty file management</p>
            <ul style="list-style:none;text-align:left;margin-bottom:24px">
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Enhanced Smart AI File renaming</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> <strong>5000 Files/month</strong></li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Desktop App (Win & Mac)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Batch Rename</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Auto Rename (Magic Folders)</li>
              <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Priority Support</li>
            </ul>
            <button class="btn btn-secondary" style="width:100%" onclick="showAuthModal('register')">Go Ultimate</button>
          </div>
        </div>
        
        <!-- Pay-as-you-go option -->
        <div style="max-width:600px;margin:48px auto 0;background:var(--card);border:1px solid var(--border);border-radius:16px;padding:32px;text-align:center">
          <div style="display:flex;align-items:center;justify-content:center;gap:12px;margin-bottom:16px">
            <span style="font-size:2rem">ðŸ’³</span>
            <h3 style="font-size:1.5rem;margin:0">Pay-as-you-go</h3>
          </div>
          <p style="color:var(--text-sec);margin-bottom:24px">Buy credits when you need them. No monthly commitment.</p>
          
          <div style="background:var(--elevated);border-radius:12px;padding:24px;margin-bottom:24px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <span style="font-size:1.25rem;font-weight:600" id="creditAmountLanding">100 credits</span>
              <span style="font-size:2rem;font-weight:700;color:var(--orange)" id="creditPriceLanding">$5</span>
            </div>
            <input type="range" id="creditSliderLanding" min="100" max="1000" step="100" value="100" 
              style="width:100%;accent-color:var(--orange);height:8px;cursor:pointer"
              oninput="updateCreditSliderLanding(this.value)">
            <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text-muted);margin-top:8px">
              <span>100</span>
              <span>500</span>
              <span>1000</span>
            </div>
          </div>
          
          <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;text-align:left;margin-bottom:24px;font-size:0.9rem">
            <div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 1 credit = 1 AI rename</div>
            <div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> PaddleOCR (advanced)</div>
            <div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Qwen3-VL Vision</div>
            <div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Audio Transcription</div>
            <div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Credits never expire</div>
            <div style="display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Fast processing</div>
          </div>
          
          <button class="btn btn-primary" style="width:100%" onclick="showAuthModal('register')">Get Started with Credits</button>
        </div>
      </div>
    </section>
    <!-- Supported Formats Section -->
    <section style="padding:60px 0;background:var(--card)">
      <div class="container">
        <h2 style="text-align:center;font-size:1.5rem;margin-bottom:32px">Supported File Formats</h2>
        <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:12px;max-width:800px;margin:0 auto">
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ“„ PDF</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ“ DOCX</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ“Š XLSX</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ“‘ PPTX</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ–¼ï¸ JPG/PNG</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ–¼ï¸ WEBP/GIF</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ–¼ï¸ HEIC/TIFF</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸŽµ MP3/WAV</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸŽ¬ MP4/M4A</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ“§ EML</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸ“„ TXT/MD</span>
          <span style="background:var(--elevated);padding:8px 16px;border-radius:8px;font-size:0.9rem">ðŸŽ¨ SVG</span>
        </div>
      </div>
    </section>

<section class="faq-section" id="faq" style="padding:80px 0;background:var(--elevated)">
      <div class="container" style="max-width:900px">
        <h2 style="text-align:center;font-size:2rem;margin-bottom:16px">Frequently Asked Questions</h2>
        <p style="text-align:center;color:var(--text-sec);margin-bottom:48px">Everything you need to know about NameWizard.io</p>
        
        <div class="faq-container" style="display:flex;flex-direction:column;gap:16px">
          
          <!-- FAQ Item 1 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>How does the Smart Hybrid Analysis work?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Smart Hybrid Analysis is our intelligent system that combines Vision AI and OCR for maximum accuracy. When you upload an image or document, our Vision AI first analyzes the content. If it detects text in the image (keywords like "document", "receipt", "invoice", etc.), it automatically runs OCR to extract the text. The results from both Vision AI and OCR are then combined to generate the most accurate and descriptive filename possible.</p>
            </div>
          </div>

          <!-- FAQ Item 2 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>What happens if an AI provider fails or hits rate limits?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>NameWizard.io includes advanced circuit breakers and automatic failover. If a provider fails or returns a rate limit error (429), the system automatically tries the next provider in the failover chain. For example, if GPT-4 Vision fails, it will try Gemini Vision, then Claude Vision, then Qwen Vision, and finally LLaVA. This ensures your files always get processed, even during provider outages or rate limit issues.</p>
            </div>
          </div>

          <!-- FAQ Item 3 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>How does idempotency prevent duplicate charges?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Our idempotent processing system computes a unique key for each file based on your user ID, file hash, and template configuration. If you accidentally upload the same file twice or retry a failed request, the system recognizes it and returns the existing result instead of processing it again. This means you'll never be charged twice for the same file, and you can safely retry failed uploads without worry.</p>
            </div>
          </div>

          <!-- FAQ Item 4 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>Can I use my own API keys?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Yes! Power User and Ultimate plan subscribers can configure their own API keys for OpenAI, Anthropic, Google AI, OpenRouter, and other providers. This gives you maximum control over your usage, quotas, and billing. You can manage your API keys from the Dashboard under "API Key Management". When you use your own keys, you're billed directly by the provider based on their pricing.</p>
            </div>
          </div>

          <!-- FAQ Item 5 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>How do Magic Folders work?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Magic Folders are automated workflows that watch a folder on your system and automatically rename files as they're added. You configure a source folder, naming pattern, file types, and schedule (manual trigger or interval-based). The scheduler periodically scans for new files and enqueues them for processing. All Magic Folder configurations are stored in a database with concurrency controls to prevent race conditions. You can set limits on how many files are processed per run to avoid overloading providers.</p>
            </div>
          </div>

          <!-- FAQ Item 6 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>What file formats are supported?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>NameWizard.io supports a wide range of file formats:</p>
              <ul style="margin-top:12px;padding-left:20px">
                <li><strong>Documents:</strong> PDF, DOCX, DOC, ODT, RTF, TXT, MD</li>
                <li><strong>Spreadsheets:</strong> XLSX, XLS, CSV</li>
                <li><strong>Presentations:</strong> PPTX, PPT</li>
                <li><strong>Images:</strong> JPG, JPEG, PNG, WEBP, GIF, BMP, HEIC, TIFF, SVG</li>
                <li><strong>Audio:</strong> MP3, WAV, M4A, OGG, FLAC</li>
                <li><strong>Video:</strong> MP4, MOV, AVI, MKV</li>
                <li><strong>Email:</strong> EML, MSG</li>
              </ul>
            </div>
          </div>

          <!-- FAQ Item 7 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>How is my data secured?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Your data security is our top priority. All files are transmitted over HTTPS with TLS encryption. Files are processed in memory and are never permanently stored on our servers. We use structured logging with correlation IDs for debugging, but we never log sensitive data like file contents or raw text. All logs only contain metadata (file IDs, provider names, timing, error types). Your API keys are encrypted at rest if you choose to store them.</p>
            </div>
          </div>

          <!-- FAQ Item 8 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>What are the rate limits?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Rate limits depend on your plan:</p>
              <ul style="margin-top:12px;padding-left:20px">
                <li><strong>Starter (Free):</strong> 15 files per month</li>
                <li><strong>Pro:</strong> 200 files per month</li>
                <li><strong>Power User:</strong> 1,000 files per month</li>
                <li><strong>Ultimate:</strong> 5,000 files per month</li>
                <li><strong>Pay-as-you-go:</strong> No monthly limits, pay per file</li>
              </ul>
              <p style="margin-top:12px">The background job queue can handle up to 10 jobs per second with 5 concurrent workers. If you need higher limits, contact us for an Enterprise plan.</p>
            </div>
          </div>

          <!-- FAQ Item 9 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>How does billing work?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>We offer two billing models:</p>
              <ul style="margin-top:12px;padding-left:20px">
                <li><strong>Monthly Subscription:</strong> Pay a fixed monthly fee for a set number of files. Unused files don't roll over to the next month.</li>
                <li><strong>Pay-as-you-go Credits:</strong> Buy credits when you need them. 1 credit = 1 AI rename. Credits never expire and can be used anytime.</li>
              </ul>
              <p style="margin-top:12px">You're only charged when a file is successfully processed. Failed jobs due to system errors are not counted against your quota. Idempotent processing ensures you're never charged twice for the same file.</p>
            </div>
          </div>

          <!-- FAQ Item 10 -->
          <div class="faq-item" style="background:var(--bg);border-radius:12px;overflow:hidden">
            <button class="faq-question" style="width:100%;padding:24px;text-align:left;background:none;border:none;color:var(--text-pri);font-size:1.1rem;font-weight:600;cursor:pointer;display:flex;justify-content:space-between;align-items:center">
              <span>Can I cancel my subscription anytime?</span>
              <svg class="faq-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
            </button>
            <div class="faq-answer" style="padding:0 24px 24px;color:var(--text-sec);line-height:1.6;display:none">
              <p>Yes, you can cancel your subscription at any time from your Dashboard. There are no cancellation fees or penalties. If you cancel, you'll retain access to your plan features until the end of your current billing period. After that, your account will revert to the free Starter plan. Any unused credits from the pay-as-you-go model will remain in your account and never expire.</p>
            </div>
          </div>

        </div>
      </div>
    </section>

    <script>
    // FAQ Accordion functionality
    document.querySelectorAll('.faq-question').forEach(button => {
      button.addEventListener('click', () => {
        const answer = button.nextElementSibling;
        const icon = button.querySelector('.faq-icon');
        const isOpen = answer.style.display === 'block';
        
        // Close all other FAQs
        document.querySelectorAll('.faq-answer').forEach(a => a.style.display = 'none');
        document.querySelectorAll('.faq-icon').forEach(i => i.style.transform = 'rotate(0deg)');
        
        // Toggle current FAQ
        if (!isOpen) {
          answer.style.display = 'block';
          icon.style.transform = 'rotate(180deg)';
        }
      });
    });
    </script>

        <!-- Footer -->
    <footer style="background:var(--bg);border-top:1px solid var(--border);padding:48px 0 24px">
      <div class="container">
        <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:48px;margin-bottom:48px">
          <!-- Brand -->
          <div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:16px">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2" fill="rgba(249,115,22,0.2)"/>
              </svg>
              <span style="font-weight:700;font-size:1.25rem">NameWizard<span style="color:var(--orange)">.io</span></span>
            </div>
            <p style="color:var(--text-sec);font-size:0.9rem;max-width:280px;line-height:1.6">AI-powered file renaming that understands your content. OCR, vision, and audio analysis for perfect filenames.</p>
          </div>
          <!-- Product -->
          <div>
            <h4 style="font-size:0.9rem;margin-bottom:16px;color:var(--text-muted)">Product</h4>
            <ul style="list-style:none">
              <li style="margin-bottom:8px"><a href="#features" onclick="scrollToSection('features');return false" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Features</a></li>
              <li style="margin-bottom:8px"><a href="#pricing" onclick="scrollToSection('pricing');return false" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Pricing</a></li>
              <li style="margin-bottom:8px"><a href="#" onclick="showAuthModal('register');return false" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Get Started</a></li>
            </ul>
          </div>
          <!-- Support -->
          <div>
            <h4 style="font-size:0.9rem;margin-bottom:16px;color:var(--text-muted)">Support</h4>
            <ul style="list-style:none">
              <li style="margin-bottom:8px"><a href="#" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Documentation</a></li>
              <li style="margin-bottom:8px"><a href="#" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">API Reference</a></li>
              <li style="margin-bottom:8px"><a href="/cdn-cgi/l/email-protection#d7a4a2a7a7b8a5a397b9b6bab2a0beadb6a5b3f9b6be" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Contact Us</a></li>
            </ul>
          </div>
          <!-- Legal -->
          <div>
            <h4 style="font-size:0.9rem;margin-bottom:16px;color:var(--text-muted)">Legal</h4>
            <ul style="list-style:none">
              <li style="margin-bottom:8px"><a href="#" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Privacy Policy</a></li>
              <li style="margin-bottom:8px"><a href="#" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Terms of Service</a></li>
              <li style="margin-bottom:8px"><a href="#" style="color:var(--text-sec);text-decoration:none;font-size:0.9rem">Cookie Policy</a></li>
            </ul>
          </div>
        </div>
        <!-- Bottom Bar -->
        <div style="border-top:1px solid var(--border);padding-top:24px;display:flex;justify-content:space-between;align-items:center">
          <p style="color:var(--text-muted);font-size:0.85rem">Â© 2024 NameWizard.io. All rights reserved.</p>
          <div style="display:flex;gap:16px">
            <a href="#" style="color:var(--text-muted)"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>
            <a href="#" style="color:var(--text-muted)"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
            <a href="#" style="color:var(--text-muted)"><svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>
          </div>
        </div>
      </div>
    </footer>
  </div>
  <div class="page" id="pageApp">

    <!-- App Top Navigation -->
    <div class="app-top-nav" id="appTopNav" style="display:none">
      <div class="container">
        <div class="app-nav-items">
          <div class="app-nav-item active" onclick="switchAppView('rename')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
            Bulk Rename
          </div>
          <div class="app-nav-item" onclick="switchAppView('ocr')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
            OCR Rename
          </div>
          <div class="app-nav-item" onclick="switchAppView('preview')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            File Preview
          </div>
          <div class="app-nav-item" onclick="switchAppView('templates')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5H7a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-2"/><rect x="9" y="3" width="6" height="4" rx="2"/></svg>
            Templates
          </div>
          <div class="app-nav-item" onclick="switchAppView('dashboard')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Dashboard
          </div>
          <div class="app-nav-item god-mode" onclick="nav('pageGodMode')" id="godModeNavBtn" style="display:none">
            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2l2.4 7.4h7.6l-6 4.6 2.3 7-6.3-4.6-6.3 4.6 2.3-7-6-4.6h7.6z"/></svg>
            God Mode
          </div>
        </div>
        <div class="plan-indicator">
          <div class="plan-badge-top" id="planBadgeTop">
            <span class="plan-name" id="planNameTop">Free</span>
            <span class="plan-usage">
              <span id="usageCountTop">0</span>/<span id="usageLimitTop">15</span>
              <span class="usage-number" id="usageNumberBadge">0</span>
            </span>
          </div>
          <button class="btn btn-secondary btn-sm" onclick="toggleUserMenu()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
          </button>
        </div>
      </div>
    </div>

    <div class="container">
              <div class="app-tabs">
          <div class="app-tab active" id="tabRenameFiles">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
            Rename files
          </div>
          <div class="app-tab" id="tabMagicFolders" onclick="openMagicFolders()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            Magic folders
          </div>
        </div>

      <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar">
          <div class="sidebar-section" id="planSwitcherSection" style="display:none">
            <div class="plan-switcher">
              <label>ðŸ‘‘ Test as Plan</label>
              <select id="testPlanSelect" onchange="switchTestPlan()">
                <option value="free">Free</option>
                <option value="pro">Pro</option>
                <option value="business">Business</option>
                <option value="god" selected>God</option>
              </select>
            </div>
          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">Quick Actions</div>
            <button class="btn btn-secondary btn-sm" style="width:100%;margin-bottom:8px" onclick="openSettingsModal()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
              Settings
            </button>
            <button class="btn btn-secondary btn-sm" style="width:100%;margin-bottom:8px" onclick="viewHistory()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
              History
            </button>

          </div>

          <div class="sidebar-section">
            <div class="sidebar-title">Usage This Month</div>
            <div style="background:var(--elevated);border-radius:8px;padding:12px">
              <div style="display:flex;justify-content:space-between;font-size:0.9rem;margin-bottom:8px">
                <span>Files Processed</span>
                <span id="usageCount">0/25</span>
              </div>
              <div style="height:6px;background:var(--card);border-radius:3px;overflow:hidden">
                <div id="usageBar" style="height:100%;background:var(--orange);width:0%;transition:width 0.3s"></div>
              </div>
            </div>
          </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
                    
          <!-- Naming Template Section -->
          <div class="template-section" style="margin-bottom:24px">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
              <span style="font-size:1.5rem">ðŸ·ï¸</span>
              <select id="namingTemplateSelect" onchange="handleTemplateChange(this.value)" style="flex:1;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:12px 16px;color:var(--text);font-size:0.95rem;cursor:pointer">
                <option value="auto">Auto</option>
                <option value="business">Business Document Template</option>
                <option value="invoice">Invoice Template</option>
                <option value="project">Project Files</option>
                <option value="new">âž• New Template</option>
              </select>
            </div>
            
            <!-- Template Details Display -->
            <div id="templateDetailsDisplay" style="display:none;background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px">
              <div class="template-structure" style="display:flex;flex-wrap:wrap;align-items:center;gap:8px;margin-bottom:12px">
                <!-- Variable pills will be inserted here -->
              </div>
              <button onclick="openTemplateEditor()" class="template-editor-btn" style="background:transparent;border:1px solid var(--orange);color:var(--orange);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:0.9rem;transition:all 0.2s">
                ðŸ·ï¸ Template editor
              </button>
            </div>
          </div>

<div style="text-align:center;margin-bottom:48px">
            <h1 style="font-size:2rem;color:var(--orange);margin-bottom:32px">Upload, organize, and rename your files effortlessly</h1>
            
            <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()" style="background:var(--card);border:2px dashed var(--orange);border-radius:16px;padding:64px 32px;cursor:pointer;transition:all 0.3s;margin-bottom:24px">
              <svg viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2" style="width:64px;height:64px;margin:0 auto 16px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              <h3 style="color:var(--orange);font-size:1.3rem;margin-bottom:8px">Drop files here to auto-rename or click to select</h3>
              <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:16px">Maximum file size is 10MB</p>
              <button class="btn btn-primary" style="background:var(--orange);border:none;padding:12px 32px;font-size:1rem;margin-top:8px">Select Files</button>
              <input type="file" id="fileInput" multiple onchange="handleFileSelect(event)" style="display:none">
            </div>

            <!-- File Format Badges -->
            <div style="display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:32px">
              <span style="background:#e74c3c;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">PDF</span>
              <span style="background:#3498db;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">DOC</span>
              <span style="background:#3498db;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">DOCX</span>
              <span style="background:#27ae60;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">XLS</span>
              <span style="background:#27ae60;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">XLSX</span>
              <span style="background:#95a5a6;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">TXT</span>
              <span style="background:#95a5a6;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">MD</span>
              <span style="background:#16a085;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">CSV</span>
              <span style="background:#e91e63;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">PNG</span>
              <span style="background:#ff9800;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">JPG</span>
              <span style="background:#ff9800;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">JPEG</span>
              <span style="background:#9c27b0;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">WEBP</span>
              <span style="background:#9c27b0;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">GIF</span>
              <span style="background:#ff5722;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">PPT</span>
              <span style="background:#ff5722;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">PPTX</span>
              <span style="background:#607d8b;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">HEIC</span>
              <span style="background:#607d8b;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">TIFF</span>
              <span style="background:#00bcd4;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">MP3</span>
              <span style="background:#00bcd4;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">WAV</span>
              <span style="background:#673ab7;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">MP4</span>
              <span style="background:#673ab7;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">M4A</span>
              <span style="background:#795548;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">EML</span>
              <span style="background:#ffc107;color:white;padding:6px 12px;border-radius:20px;font-size:0.85rem;font-weight:600">SVG</span>
            </div>

            <!-- 3-Step Process -->
            <div style="display:flex;justify-content:center;align-items:center;gap:48px;margin-bottom:48px">
              <div style="text-align:center">
                <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px">
                  <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width:40px;height:40px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                </div>
                <div style="font-weight:600;color:var(--orange);margin-bottom:4px">SELECT</div>
                <div style="font-size:0.85rem;color:var(--text-muted)">Your document</div>
              </div>
              <div style="text-align:center">
                <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px">
                  <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width:40px;height:40px"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </div>
                <div style="font-weight:600;color:var(--orange);margin-bottom:4px">PROCESS</div>
                <div style="font-size:0.85rem;color:var(--text-muted)">a few seconds</div>
              </div>
              <div style="text-align:center">
                <div style="width:80px;height:80px;background:var(--orange);border-radius:50%;display:flex;align-items:center;justify-content:center;margin:0 auto 12px">
                  <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" style="width:40px;height:40px"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                </div>
                <div style="font-weight:600;color:var(--orange);margin-bottom:4px">DOWNLOAD</div>
                <div style="font-size:0.85rem;color:var(--text-muted)">Perfectly named file</div>
              </div>
            </div>
          </div>

          <!-- OCR Processing Section -->
          <div style="background:var(--card);border-radius:16px;padding:24px;margin-bottom:24px">
            <h3 style="color:var(--orange);font-size:1.2rem;margin-bottom:16px">ðŸ“„ OCR Processing</h3>
            <label style="display:block;color:var(--text-muted);font-size:0.9rem;margin-bottom:8px">OCR Renaming Options</label>
            <select id="ocrRenameOption" style="width:100%;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text);margin-bottom:16px">
              <option value="title">Extract Document Title</option>
              <option value="content">Extract Full Content</option>
              <option value="keywords">Extract Keywords</option>
            </select>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
              <button class="btn btn-secondary" onclick="captureScreenshot()" style="background:var(--elevated);border:1px solid var(--border);padding:12px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                SCREENSHOT
              </button>
              <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()" style="background:var(--elevated);border:1px solid var(--border);padding:12px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/><polyline points="13 2 13 9 20 9"/></svg>
                SELECT FILE
              </button>
              <button class="btn btn-secondary" onclick="capturePhoto()" style="background:var(--elevated);border:1px solid var(--border);padding:12px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>
                CAPTURE PHOTO
              </button>
            </div>
          </div>

          <!-- Magic Folders Section -->
          <div style="background:var(--card);border-radius:16px;padding:24px;margin-bottom:24px">
            <h3 style="color:var(--orange);font-size:1.2rem;margin-bottom:8px">ðŸª„ Magic Folders</h3>
            <p style="color:var(--text-muted);font-size:0.9rem;margin-bottom:16px">Magic folder - Automatically organize your files in background mode</p>
            <div style="display:flex;gap:12px">
              <select id="magicFolderTemplate" style="flex:1;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text)">
                <option value="content_owner_date">content_owner_date</option>
                <option value="date_content">date_content</option>
                <option value="project_date">project_date</option>
              </select>
              <button class="btn btn-secondary" onclick="openMagicFolders()" style="background:var(--elevated);border:1px solid var(--border);padding:12px 24px">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
                Pick folder
              </button>
            </div>
          </div>

          <!-- Start Processing Button -->
          <div style="text-align:center;margin-bottom:32px">
            <button class="btn btn-primary" onclick="processFiles()" style="background:var(--orange);border:none;padding:16px 64px;font-size:1.1rem;font-weight:600;border-radius:12px">
              Start Processing
            </button>
          </div>

          <div class="selected-files-section" id="selectedFilesSection"</div>

          <div class="selected-files-section" id="selectedFilesSection">
            <div class="section-header">
              <h3>Selected Files <span class="file-count" id="fileCount">0</span></h3>
              <div style="display:flex;gap:8px">
                <button class="btn btn-sm btn-secondary" onclick="deleteSelected()">Delete Selected</button>
                <button class="btn btn-sm btn-outline" onclick="clearAllFiles()">Clear All</button>
              </div>
            </div>
            <div class="file-list" id="fileList"></div>
            <div class="process-section">
              <div class="process-info">
                <span id="selectedCount">0</span> files selected â€¢ <span id="renameCount">0</span> to rename
              </div>
              <button class="btn btn-primary" id="renameBtn" onclick="processFiles()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                Rename with AI
              </button>
            </div>
          </div>

          <div class="results-section" id="resultsSection">
            <div class="section-header">
              <h3>Results</h3>
            </div>
            <table class="results-table">
              <thead>
                <tr>
                  <th>Original Name</th>
                  <th>New Name</th>
                  <th>Provider</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="resultsBody"></tbody>
            </table>
            <div class="results-actions">
              <button class="btn btn-primary" onclick="applyAllRenames()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                Download All Renamed
              </button>
              <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            </div>
          </div>

          <!-- How It Works Section -->
          <div class="how-it-works" id="howItWorksSection">
            <h2>
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
              How It Works
            </h2>
            <div class="steps-grid">
              <div class="step-card">
                <div class="step-number">1</div>
                <h4>Create an Account</h4>
                <p>Sign up for free to get started. Premium accounts unlock advanced AI features.</p>
              </div>
              <div class="step-card">
                <div class="step-number">2</div>
                <h4>Upload Your Files</h4>
                <p>Drag and drop files (PDF, DOCX, images, audio) into the upload area above.</p>
              </div>
              <div class="step-card">
                <div class="step-number">3</div>
                <h4>Manage Selection</h4>
                <p>Use checkboxes to select files for batch operations or remove individual files.</p>
              </div>
              <div class="step-card">
                <div class="step-number">4</div>
                <h4>AI Analyzes Content</h4>
                <p>Our AI uses OCR, vision, and transcription to understand your file contents.</p>
              </div>
              <div class="step-card">
                <div class="step-number">5</div>
                <h4>Intelligent Renaming</h4>
                <p>AI generates clear, concise, and consistent filenames based on content analysis.</p>
              </div>
              <div class="step-card">
                <div class="step-number">6</div>
                <h4>Multilingual Support</h4>
                <p>Process text in multiple languages with automatic detection and translation.</p>
              </div>
              <div class="step-card">
                <div class="step-number">7</div>
                <h4>Review & Customize</h4>
                <p>Preview suggestions, edit names manually, or apply custom naming templates.</p>
              </div>
              <div class="step-card">
                <div class="step-number">8</div>
                <h4>Download & Enjoy</h4>
                <p>Download your perfectly organized files and experience effortless file management.</p>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>
  </div>

  <!-- God Mode Page -->
  <div class="page" id="pageGodMode">
    <div class="container god-mode-page">
      <div class="god-header">
        <h1>ðŸ‘‘ <span>God Mode</span> Dashboard</h1>
        <button class="btn btn-secondary" onclick="refreshDashboard()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
          Refresh
        </button>
      </div>

      <div class="god-tabs">
        <div class="god-tab active" onclick="switchGodTab('dashboard')">Dashboard</div>
        <div class="god-tab" onclick="switchGodTab('apiKeys')">API Keys</div>
        <div class="god-tab" onclick="switchGodTab('users')">Users</div>
        <div class="god-tab" onclick="switchGodTab('magicFolders')">Magic Folders</div>
      </div>

      <!-- Dashboard Tab -->
      <div class="god-tab-content" id="godTabDashboard">
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Total Users</h3>
            <div class="value" id="statTotalUsers">0</div>
          </div>
          <div class="stat-card">
            <h3>Files This Month</h3>
            <div class="value" id="statFilesMonth">0</div>
          </div>
          <div class="stat-card">
            <h3>Active Magic Folders</h3>
            <div class="value" id="statMagicFolders">0</div>
          </div>
          <div class="stat-card">
            <h3>Watch Agents</h3>
            <div class="value" id="statWatchAgents">0</div>
          </div>
        </div>

        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px;margin-bottom:24px">
          <h3 style="margin-bottom:16px">API Health Status</h3>
          <div id="apiHealthGrid" class="api-settings-grid"></div>
        </div>

        <div style="background:var(--card);border:1px solid var(--border);border-radius:12px;padding:20px">
          <h3 style="margin-bottom:16px">Users by Plan</h3>
          <div id="planBreakdown" style="display:flex;gap:24px"></div>
        </div>
      </div>

      <!-- API Keys Tab -->
      <div class="god-tab-content" id="godTabApiKeys" style="display:none">
        <div class="api-settings-grid" id="apiKeysGrid"></div>
      </div>

      <!-- Users Tab -->
      <div class="god-tab-content" id="godTabUsers" style="display:none">
        <table class="users-table">
          <thead>
            <tr>
              <th>Email</th>
              <th>Name</th>
              <th>Plan</th>
              <th>Files Used</th>
              <th>Created</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="usersTableBody"></tbody>
        </table>
      </div>

      <!-- Magic Folders Tab -->
      <div class="god-tab-content" id="godTabMagicFolders" style="display:none">
        <div id="magicFoldersList" class="magic-folders-list"></div>
      </div>
    </div>
  </div>

  <!-- Enhanced API Settings Page with Advanced Features -->
<div class="page" id="pageApiSettings">
  <div class="container api-settings-page">
    <button class="btn btn-ghost" onclick="nav('pageGodMode')" style="margin-bottom:24px">â† Back to Admin Dashboard</button>
    <h1>âš™ï¸ API Configuration & Monitoring</h1>
    
    <div class="api-providers-grid">
      <!-- OpenAI -->
      <div class="api-provider-card" id="providerOpenai">
        <div class="api-provider-header">
          <div class="api-provider-logo" style="background:rgba(16,163,127,0.1)">ðŸ¤–</div>
          <div class="api-provider-info">
            <h3>OpenAI</h3>
            <p id="openaiVersion">GPT-4, GPT-4 Vision, Whisper</p>
          </div>
          <div class="api-health-badge" id="healthOpenai">
            <span class="dot unknown"></span>
          </div>
        </div>
        
        <div class="api-key-input-group">
          <input type="password" id="apiKeyOpenai" placeholder="sk-..." onchange="markApiKeyModified('openai')">
          <button onclick="toggleApiKeyVisibility('apiKeyOpenai')" title="Toggle visibility">ðŸ‘</button>
          <button onclick="editApiKey('openai')" title="Edit API key" class="btn-icon">âœï¸</button>
        </div>
        
        <!-- Usage Gauge -->
        <div class="api-usage-gauge" id="usageOpenai">
          <div class="usage-bar-container">
            <div class="usage-bar" style="width: 0%"></div>
          </div>
          <div class="usage-stats">
            <span class="usage-current">$0.00</span>
            <span class="usage-limit">/ $100.00 limit</span>
          </div>
          <div class="usage-details">
            <span>Requests: <strong>0</strong></span>
            <span>Avg cost: <strong>$0.00</strong></span>
          </div>
        </div>
        
        <div class="api-provider-actions">
          <button class="btn btn-sm btn-secondary" onclick="checkForUpdates('openai')" title="Check for API updates">
            <span class="btn-icon">ðŸ”„</span> Update
          </button>
          <button class="btn btn-sm btn-secondary" onclick="validateApiKey('openai')" title="Validate API key">
            <span class="btn-icon">âœ“</span> Validate
          </button>
          <button class="btn btn-sm btn-warning" onclick="showApiSupport('openai')" title="AI automatic support">
            <span class="btn-icon">ðŸ¤–</span> Support
          </button>
          <button class="btn btn-sm btn-primary" onclick="saveApiKeyFromPage('openai')">
            <span class="btn-icon">ðŸ’¾</span> Save
          </button>
        </div>
        
        <div class="api-status-indicator" id="statusOpenai" style="margin-top:12px">
          <span class="dot unknown"></span>
          <span>Not tested</span>
        </div>
        
        <!-- AI Support Panel (hidden by default) -->
        <div class="api-support-panel" id="supportOpenai" style="display:none">
          <div class="support-header">
            <h4>ðŸ¤– AI Automatic Support</h4>
            <button onclick="closeSupportPanel('openai')" class="btn-close">Ã—</button>
          </div>
          <div class="support-content">
            <div class="support-status">Monitoring active...</div>
            <div class="support-issues" id="issuesOpenai">
              <p class="text-muted">No issues detected</p>
            </div>
          </div>
        </div>
        <!-- Model Configuration Section -->
        <div class="model-config-section" id="modelConfigOpenai">
          <div class="model-config-header">
            <h4>ðŸ“Š Model Configuration</h4>
            <div class="plan-filter-bar">
              <button class="plan-filter-btn" data-plan="free" onclick="filterPlan('Openai', 'free')">Free</button>
              <button class="plan-filter-btn" data-plan="credits_low" onclick="filterPlan('Openai', 'credits_low')">Credits-Low</button>
              <button class="plan-filter-btn" data-plan="credits_high" onclick="filterPlan('Openai', 'credits_high')">Credits-High</button>
              <button class="plan-filter-btn active" data-plan="unlimited" onclick="filterPlan('Openai', 'unlimited')">Unlimited</button>
              <button class="plan-filter-btn" data-plan="all" onclick="filterPlan('Openai', 'all')">Show All</button>
            </div>
          </div>
          
          <table class="model-config-table" id="modelTableOpenai">
            <thead>
              <tr>
                <th style="width:25%">Model</th>
                <th style="width:15%">Category</th>
                <th style="width:15%">Free</th>
                <th style="width:15%">Credits-Low</th>
                <th style="width:15%">Credits-High</th>
                <th style="width:15%">Unlimited</th>
              </tr>
            </thead>
            <tbody id="modelTableBodyOpenai">
              <!-- Models will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

      </div>

      <!-- Anthropic -->
      <div class="api-provider-card" id="providerAnthropic">
        <div class="api-provider-header">
          <div class="api-provider-logo" style="background:rgba(204,115,76,0.1)">ðŸ§ </div>
          <div class="api-provider-info">
            <h3>Anthropic</h3>
            <p id="anthropicVersion">Claude 3 Opus, Sonnet, Haiku</p>
          </div>
          <div class="api-health-badge" id="healthAnthropic">
            <span class="dot unknown"></span>
          </div>
        </div>
        
        <div class="api-key-input-group">
          <input type="password" id="apiKeyAnthropic" placeholder="sk-ant-..." onchange="markApiKeyModified('anthropic')">
          <button onclick="toggleApiKeyVisibility('apiKeyAnthropic')" title="Toggle visibility">ðŸ‘</button>
          <button onclick="editApiKey('anthropic')" title="Edit API key" class="btn-icon">âœï¸</button>
        </div>
        
        <!-- Usage Gauge -->
        <div class="api-usage-gauge" id="usageAnthropic">
          <div class="usage-bar-container">
            <div class="usage-bar" style="width: 0%"></div>
          </div>
          <div class="usage-stats">
            <span class="usage-current">$0.00</span>
            <span class="usage-limit">/ $100.00 limit</span>
          </div>
          <div class="usage-details">
            <span>Requests: <strong>0</strong></span>
            <span>Avg cost: <strong>$0.00</strong></span>
          </div>
        </div>
        
        <div class="api-provider-actions">
          <button class="btn btn-sm btn-secondary" onclick="checkForUpdates('anthropic')" title="Check for API updates">
            <span class="btn-icon">ðŸ”„</span> Update
          </button>
          <button class="btn btn-sm btn-secondary" onclick="validateApiKey('anthropic')" title="Validate API key">
            <span class="btn-icon">âœ“</span> Validate
          </button>
          <button class="btn btn-sm btn-warning" onclick="showApiSupport('anthropic')" title="AI automatic support">
            <span class="btn-icon">ðŸ¤–</span> Support
          </button>
          <button class="btn btn-sm btn-primary" onclick="saveApiKeyFromPage('anthropic')">
            <span class="btn-icon">ðŸ’¾</span> Save
          </button>
        </div>
        
        <div class="api-status-indicator" id="statusAnthropic" style="margin-top:12px">
          <span class="dot unknown"></span>
          <span>Not tested</span>
        </div>
        
        <!-- AI Support Panel -->
        <div class="api-support-panel" id="supportAnthropic" style="display:none">
          <div class="support-header">
            <h4>ðŸ¤– AI Automatic Support</h4>
            <button onclick="closeSupportPanel('anthropic')" class="btn-close">Ã—</button>
          </div>
          <div class="support-content">
            <div class="support-status">Monitoring active...</div>
            <div class="support-issues" id="issuesAnthropic">
              <p class="text-muted">No issues detected</p>
            </div>
          </div>
        </div>
        <!-- Model Configuration Section -->
        <div class="model-config-section" id="modelConfigAnthropic">
          <div class="model-config-header">
            <h4>ðŸ“Š Model Configuration</h4>
            <div class="plan-filter-bar">
              <button class="plan-filter-btn" data-plan="free" onclick="filterPlan('Anthropic', 'free')">Free</button>
              <button class="plan-filter-btn" data-plan="credits_low" onclick="filterPlan('Anthropic', 'credits_low')">Credits-Low</button>
              <button class="plan-filter-btn" data-plan="credits_high" onclick="filterPlan('Anthropic', 'credits_high')">Credits-High</button>
              <button class="plan-filter-btn active" data-plan="unlimited" onclick="filterPlan('Anthropic', 'unlimited')">Unlimited</button>
              <button class="plan-filter-btn" data-plan="all" onclick="filterPlan('Anthropic', 'all')">Show All</button>
            </div>
          </div>
          
          <table class="model-config-table" id="modelTableAnthropic">
            <thead>
              <tr>
                <th style="width:25%">Model</th>
                <th style="width:15%">Category</th>
                <th style="width:15%">Free</th>
                <th style="width:15%">Credits-Low</th>
                <th style="width:15%">Credits-High</th>
                <th style="width:15%">Unlimited</th>
              </tr>
            </thead>
            <tbody id="modelTableBodyAnthropic">
              <!-- Models will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

      </div>

      <!-- Google AI -->
      <div class="api-provider-card" id="providerGoogle">
        <div class="api-provider-header">
          <div class="api-provider-logo" style="background:rgba(66,133,244,0.1)">âœ¨</div>
          <div class="api-provider-info">
            <h3>Google AI</h3>
            <p id="googleVersion">Gemini Pro, Gemini Vision</p>
          </div>
          <div class="api-health-badge" id="healthGoogle">
            <span class="dot unknown"></span>
          </div>
        </div>
        
        <div class="api-key-input-group">
          <input type="password" id="apiKeyGoogle" placeholder="AIza..." onchange="markApiKeyModified('google')">
          <button onclick="toggleApiKeyVisibility('apiKeyGoogle')" title="Toggle visibility">ðŸ‘</button>
          <button onclick="editApiKey('google')" title="Edit API key" class="btn-icon">âœï¸</button>
        </div>
        
        <!-- Usage Gauge -->
        <div class="api-usage-gauge" id="usageGoogle">
          <div class="usage-bar-container">
            <div class="usage-bar" style="width: 0%"></div>
          </div>
          <div class="usage-stats">
            <span class="usage-current">$0.00</span>
            <span class="usage-limit">/ $100.00 limit</span>
          </div>
          <div class="usage-details">
            <span>Requests: <strong>0</strong></span>
            <span>Avg cost: <strong>$0.00</strong></span>
          </div>
        </div>
        
        <div class="api-provider-actions">
          <button class="btn btn-sm btn-secondary" onclick="checkForUpdates('google')" title="Check for API updates">
            <span class="btn-icon">ðŸ”„</span> Update
          </button>
          <button class="btn btn-sm btn-secondary" onclick="validateApiKey('google')" title="Validate API key">
            <span class="btn-icon">âœ“</span> Validate
          </button>
          <button class="btn btn-sm btn-warning" onclick="showApiSupport('google')" title="AI automatic support">
            <span class="btn-icon">ðŸ¤–</span> Support
          </button>
          <button class="btn btn-sm btn-primary" onclick="saveApiKeyFromPage('google')">
            <span class="btn-icon">ðŸ’¾</span> Save
          </button>
        </div>
        
        <div class="api-status-indicator" id="statusGoogle" style="margin-top:12px">
          <span class="dot unknown"></span>
          <span>Not tested</span>
        </div>
        
        <!-- AI Support Panel -->
        <div class="api-support-panel" id="supportGoogle" style="display:none">
          <div class="support-header">
            <h4>ðŸ¤– AI Automatic Support</h4>
            <button onclick="closeSupportPanel('google')" class="btn-close">Ã—</button>
          </div>
          <div class="support-content">
            <div class="support-status">Monitoring active...</div>
            <div class="support-issues" id="issuesGoogle">
              <p class="text-muted">No issues detected</p>
            </div>
          </div>
        </div>
        <!-- Model Configuration Section -->
        <div class="model-config-section" id="modelConfigGoogle">
          <div class="model-config-header">
            <h4>ðŸ“Š Model Configuration</h4>
            <div class="plan-filter-bar">
              <button class="plan-filter-btn" data-plan="free" onclick="filterPlan('Google', 'free')">Free</button>
              <button class="plan-filter-btn" data-plan="credits_low" onclick="filterPlan('Google', 'credits_low')">Credits-Low</button>
              <button class="plan-filter-btn" data-plan="credits_high" onclick="filterPlan('Google', 'credits_high')">Credits-High</button>
              <button class="plan-filter-btn active" data-plan="unlimited" onclick="filterPlan('Google', 'unlimited')">Unlimited</button>
              <button class="plan-filter-btn" data-plan="all" onclick="filterPlan('Google', 'all')">Show All</button>
            </div>
          </div>
          
          <table class="model-config-table" id="modelTableGoogle">
            <thead>
              <tr>
                <th style="width:25%">Model</th>
                <th style="width:15%">Category</th>
                <th style="width:15%">Free</th>
                <th style="width:15%">Credits-Low</th>
                <th style="width:15%">Credits-High</th>
                <th style="width:15%">Unlimited</th>
              </tr>
            </thead>
            <tbody id="modelTableBodyGoogle">
              <!-- Models will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

      </div>

      <!-- OpenRouter -->
      <div class="api-provider-card" id="providerOpenrouter">
        <div class="api-provider-header">
          <div class="api-provider-logo" style="background:rgba(168,85,247,0.1)">ðŸ”€</div>
          <div class="api-provider-info">
            <h3>OpenRouter</h3>
            <p id="openrouterVersion">100+ models including LLaVA, Llama</p>
          </div>
          <div class="api-health-badge" id="healthOpenrouter">
            <span class="dot unknown"></span>
          </div>
        </div>
        
        <div class="api-key-input-group">
          <input type="password" id="apiKeyOpenrouter" placeholder="sk-or-..." onchange="markApiKeyModified('openrouter')">
          <button onclick="toggleApiKeyVisibility('apiKeyOpenrouter')" title="Toggle visibility">ðŸ‘</button>
          <button onclick="editApiKey('openrouter')" title="Edit API key" class="btn-icon">âœï¸</button>
        </div>
        
        <!-- Usage Gauge -->
        <div class="api-usage-gauge" id="usageOpenrouter">
          <div class="usage-bar-container">
            <div class="usage-bar" style="width: 0%"></div>
          </div>
          <div class="usage-stats">
            <span class="usage-current">$0.00</span>
            <span class="usage-limit">/ $100.00 limit</span>
          </div>
          <div class="usage-details">
            <span>Requests: <strong>0</strong></span>
            <span>Avg cost: <strong>$0.00</strong></span>
          </div>
        </div>
        
        <div class="api-provider-actions">
          <button class="btn btn-sm btn-secondary" onclick="checkForUpdates('openrouter')" title="Check for API updates">
            <span class="btn-icon">ðŸ”„</span> Update
          </button>
          <button class="btn btn-sm btn-secondary" onclick="validateApiKey('openrouter')" title="Validate API key">
            <span class="btn-icon">âœ“</span> Validate
          </button>
          <button class="btn btn-sm btn-warning" onclick="showApiSupport('openrouter')" title="AI automatic support">
            <span class="btn-icon">ðŸ¤–</span> Support
          </button>
          <button class="btn btn-sm btn-primary" onclick="saveApiKeyFromPage('openrouter')">
            <span class="btn-icon">ðŸ’¾</span> Save
          </button>
        </div>
        
        <div class="api-status-indicator" id="statusOpenrouter" style="margin-top:12px">
          <span class="dot unknown"></span>
          <span>Not tested</span>
        </div>
        
        <!-- AI Support Panel -->
        <div class="api-support-panel" id="supportOpenrouter" style="display:none">
          <div class="support-header">
            <h4>ðŸ¤– AI Automatic Support</h4>
            <button onclick="closeSupportPanel('openrouter')" class="btn-close">Ã—</button>
          </div>
          <div class="support-content">
            <div class="support-status">Monitoring active...</div>
            <div class="support-issues" id="issuesOpenrouter">
              <p class="text-muted">No issues detected</p>
            </div>
          </div>
        </div>
        <!-- Model Configuration Section -->
        <div class="model-config-section" id="modelConfigOpenrouter">
          <div class="model-config-header">
            <h4>ðŸ“Š Model Configuration</h4>
            <div class="plan-filter-bar">
              <button class="plan-filter-btn" data-plan="free" onclick="filterPlan('Openrouter', 'free')">Free</button>
              <button class="plan-filter-btn" data-plan="credits_low" onclick="filterPlan('Openrouter', 'credits_low')">Credits-Low</button>
              <button class="plan-filter-btn" data-plan="credits_high" onclick="filterPlan('Openrouter', 'credits_high')">Credits-High</button>
              <button class="plan-filter-btn active" data-plan="unlimited" onclick="filterPlan('Openrouter', 'unlimited')">Unlimited</button>
              <button class="plan-filter-btn" data-plan="all" onclick="filterPlan('Openrouter', 'all')">Show All</button>
            </div>
          </div>
          
          <table class="model-config-table" id="modelTableOpenrouter">
            <thead>
              <tr>
                <th style="width:25%">Model</th>
                <th style="width:15%">Category</th>
                <th style="width:15%">Free</th>
                <th style="width:15%">Credits-Low</th>
                <th style="width:15%">Credits-High</th>
                <th style="width:15%">Unlimited</th>
              </tr>
            </thead>
            <tbody id="modelTableBodyOpenrouter">
              <!-- Models will be populated by JavaScript -->
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>


<!-- AI Features Page -->
  <div class="page" id="pageAiFeatures">
    <div class="container ai-features-page">
      <button class="btn btn-ghost" onclick="nav('pageApp')" style="margin-bottom:24px">â† Back to App</button>
      <h1 style="margin-bottom:12px">ðŸ¤– AI Features</h1>
      <p style="color:var(--text-sec);margin-bottom:32px">Toggle features on or off based on your plan. Some features may be locked on lower tier plans.</p>
      
      <div class="ai-features-grid" id="aiFeaturesGrid">
        <!-- Features will be populated by JavaScript -->
      </div>
      
      <!-- Watch Agents Section (Business+) -->
      <div class="ai-section" style="margin-top:48px">
        <div class="ai-section-header">
          <h2>ðŸ‘€ Watch Agents</h2>
          <button class="btn btn-primary" onclick="createWatchAgent()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            New Agent
          </button>
        </div>
        <p style="color:var(--text-sec);margin-bottom:24px">Background agents that monitor folders and automatically rename new files</p>
        <div id="watchAgentsList">
          <!-- Watch agents will be populated by JavaScript -->
        </div>
      </div>
      
      <!-- API Access Section (Business+) -->
      <div class="ai-section" style="margin-top:48px">
        <div class="ai-section-header">
          <h2>ðŸ”Œ API Access</h2>
          <button class="btn btn-primary" onclick="createApiToken()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Create Token
          </button>
        </div>
        <p style="color:var(--text-sec);margin-bottom:16px">Programmatic access to NameWizard for your own applications</p>
        <div class="api-docs-preview" style="background:var(--elevated);padding:16px;border-radius:12px;margin-bottom:24px">
          <code style="font-size:0.85rem;color:var(--orange)">POST /api/v1/rename</code>
          <pre style="margin-top:8px;font-size:0.8rem;color:var(--text-sec);overflow-x:auto">curl -X POST https://namewizard.io/api/v1/rename \
  -H "Authorization: Bearer YOUR_API_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"filename": "IMG_1234.jpg", "content": "..."}'</pre>
        </div>
        <div id="apiTokensList">
          <!-- API tokens will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

  <!-- Magic Folders Full Page -->
  <div class="page" id="pageMagicFolders">
    <div class="container magic-folders-page">
      <button class="btn btn-ghost" onclick="nav('pageApp')" style="margin-bottom:24px">â† Back to App</button>
      <h1>ðŸ“ Magic Folders</h1>
      
      <!-- Folder Configuration -->
      <div class="folder-config-section">
        <h3>
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Folder Settings
        </h3>
        
        <div class="folder-options-grid">
          <div class="folder-option">
            <label class="checkbox-option">
              <input type="checkbox" id="mfIncludeSubfolders" checked>
              Include Subfolders
            </label>
          </div>
          <div class="folder-option">
            <label class="checkbox-option">
              <input type="checkbox" id="mfSkipExisting">
              Skip Existing Files
            </label>
          </div>
          <div class="folder-option">
            <label>File Name Language</label>
            <select id="mfLanguage">
              <option value="auto">Smart Detect</option>
              <option value="en">English</option>
              <option value="de">German</option>
              <option value="es">Spanish</option>
              <option value="fr">French</option>
              <option value="ja">Japanese</option>
              <option value="zh">Chinese</option>
            </select>
          </div>
          <div class="folder-option">
            <label>Date Format</label>
            <select id="mfDateFormat">
              <option value="DD-MM-YYYY">DD-MM-YYYY</option>
              <option value="MM-DD-YYYY">MM-DD-YYYY</option>
              <option value="YYYY-MM-DD">YYYY-MM-DD</option>
              <option value="YYYYMMDD">YYYYMMDD</option>
            </select>
          </div>
          <div class="folder-option">
            <label>Text Format</label>
            <select id="mfTextFormat">
              <option value="auto">Smart Detect</option>
              <option value="lowercase">lowercase</option>
              <option value="uppercase">UPPERCASE</option>
              <option value="titlecase">Title Case</option>
            </select>
          </div>
          <div class="folder-option">
            <label>Space Character</label>
            <div class="space-buttons">
              <button class="space-btn" data-value="-" onclick="selectSpaceChar(this)">-</button>
              <button class="space-btn active" data-value="_" onclick="selectSpaceChar(this)">_</button>
              <button class="space-btn" data-value=" " onclick="selectSpaceChar(this)">â£</button>
              <button class="space-btn" data-value="auto" onclick="selectSpaceChar(this)">Auto</button>
              <button class="space-btn" data-value="" onclick="selectSpaceChar(this)">None</button>
            </div>
          </div>
        </div>

        <div style="margin-top:24px">
          <label style="font-size:0.9rem;color:var(--text-sec);margin-bottom:12px;display:block">File Extensions</label>
          <div style="display:flex;gap:8px;margin-bottom:12px">
            <button class="btn btn-sm btn-secondary" onclick="selectAllExtensions()">Select All</button>
            <button class="btn btn-sm btn-ghost" onclick="deselectAllExtensions()">Deselect All</button>
          </div>
          <div class="extensions-grid" id="extensionsGrid">
            <button class="ext-btn active" data-ext=".pdf">.pdf</button>
            <button class="ext-btn active" data-ext=".doc">.doc</button>
            <button class="ext-btn active" data-ext=".docx">.docx</button>
            <button class="ext-btn active" data-ext=".txt">.txt</button>
            <button class="ext-btn active" data-ext=".jpg">.jpg</button>
            <button class="ext-btn active" data-ext=".jpeg">.jpeg</button>
            <button class="ext-btn active" data-ext=".png">.png</button>
            <button class="ext-btn active" data-ext=".gif">.gif</button>
            <button class="ext-btn active" data-ext=".webp">.webp</button>
            <button class="ext-btn active" data-ext=".heic">.heic</button>
            <button class="ext-btn" data-ext=".xlsx">.xlsx</button>
            <button class="ext-btn" data-ext=".pptx">.pptx</button>
            <button class="ext-btn" data-ext=".mp3">.mp3</button>
            <button class="ext-btn" data-ext=".mp4">.mp4</button>
            <button class="ext-btn" data-ext=".wav">.wav</button>
            <button class="ext-btn" data-ext=".m4a">.m4a</button>
          </div>
        </div>

        <!-- Template Builder -->
        <div class="template-builder">
          <h4>ðŸ“ Filename Template Builder</h4>
          <p style="color:var(--text-sec);font-size:0.85rem;margin-bottom:16px">Drag tags to the drop zone to build your filename template</p>
          
          <div class="template-tags" id="templateTags">
            <div class="template-tag" draggable="true" data-tag="docnum">ðŸ“„ Document Number</div>
            <div class="template-tag" draggable="true" data-tag="doctype">ðŸ“‹ Document Type</div>
            <div class="template-tag" draggable="true" data-tag="project">ðŸ“ Project Name</div>
            <div class="template-tag" draggable="true" data-tag="issuer">ðŸ¢ Issuer Name</div>
            <div class="template-tag" draggable="true" data-tag="recipient">ðŸ‘¤ Recipient Name</div>
            <div class="template-tag" draggable="true" data-tag="date">ðŸ“… Date</div>
            <div class="template-tag" draggable="true" data-tag="year">ðŸ“† Year</div>
            <div class="template-tag" draggable="true" data-tag="amount">ðŸ’° Amount</div>
            <div class="template-tag" draggable="true" data-tag="custom">âœï¸ Custom Text</div>
          </div>

          <div class="template-dropzone" id="templateDropzone">
            <span style="color:var(--text-muted);font-size:0.9rem">Drop tags here to build your template...</span>
          </div>

          <div class="template-preview">
            <label>Live Preview</label>
            <div class="template-preview-text" id="templatePreviewLive">Invoice_Acme-Inc_23-08-2024_12345usd.pdf</div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:24px">
          <button class="btn btn-primary" onclick="saveMagicFolderTemplate()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
            Save Template
          </button>
          <button class="btn btn-secondary" onclick="resetMagicFolderTemplate()">Reset to Default</button>
        </div>
      </div>

      <!-- Existing Magic Folders -->
      <div class="folder-list-section">
        <div class="folder-list-header">
          <h3>Your Magic Folders</h3>
          <button class="btn btn-primary" onclick="addNewMagicFolder()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
            Add Folder
          </button>
        </div>
        <div id="magicFoldersListPage">
          <div style="text-align:center;padding:40px;color:var(--text-muted)">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:16px"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
            <p>No Magic Folders configured yet</p>
            <p style="font-size:0.85rem;margin-top:8px">Click "Add Folder" to create your first automated folder</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Page -->
  <div class="page" id="pageProfile">
    <div class="container" style="max-width:800px;padding:40px 24px">
      <button class="btn btn-ghost" onclick="nav('pageApp')" style="margin-bottom:24px">â† Back to App</button>
      <h1 style="margin-bottom:32px">Your Profile</h1>
      
      <!-- Avatar Section -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px">
        <h3 style="margin-bottom:16px">Profile Picture</h3>
        <div style="display:flex;align-items:center;gap:24px">
          <div id="profileAvatarPreview" style="width:100px;height:100px;border-radius:50%;background:var(--orange);display:flex;align-items:center;justify-content:center;font-size:2rem;font-weight:700;overflow:hidden">
            <img id="profileAvatarImg" style="width:100%;height:100%;object-fit:cover;display:none">
            <span id="profileAvatarInitials"></span>
          </div>
          <div>
            <input type="file" id="avatarUpload" accept="image/*" style="display:none" onchange="uploadAvatar(event)">
            <button class="btn btn-secondary" onclick="$('avatarUpload').click()">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
              Upload Photo
            </button>
            <button class="btn btn-ghost" onclick="removeAvatar()" style="margin-left:8px">Remove</button>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:8px">JPG, PNG or GIF. Max 2MB.</p>
          </div>
        </div>
      </div>

      <!-- Personal Info Section -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px">
        <h3 style="margin-bottom:16px">Personal Information</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="form-group">
            <label>First Name</label>
            <input type="text" id="profileFirstName" placeholder="John">
          </div>
          <div class="form-group">
            <label>Last Name</label>
            <input type="text" id="profileLastName" placeholder="Doe">
          </div>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="profileEmail" disabled style="background:var(--bg);cursor:not-allowed">
        </div>
        <button class="btn btn-primary" onclick="saveProfile()">Save Changes</button>
      </div>

      <!-- Password Section -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px;margin-bottom:24px">
        <h3 style="margin-bottom:16px">Change Password</h3>
        <div id="passwordSection">
          <div class="form-group">
            <label>Current Password</label>
            <input type="password" id="currentPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <div class="form-group">
            <label>New Password</label>
            <input type="password" id="newPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <div class="form-group">
            <label>Confirm New Password</label>
            <input type="password" id="confirmNewPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <button class="btn btn-primary" onclick="changePassword()">Update Password</button>
        </div>
        <div id="oauthPasswordNotice" style="display:none;color:var(--text-sec)">
          <p>You signed in with Google. You can set a password here to also enable email/password login.</p>
          <div class="form-group" style="margin-top:16px">
            <label>Set Password</label>
            <input type="password" id="setNewPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
          </div>
          <button class="btn btn-primary" onclick="setPassword()">Set Password</button>
        </div>
      </div>

      <!-- Danger Zone -->
      <div style="background:var(--card);border:1px solid var(--red);border-radius:16px;padding:24px">
        <h3 style="color:var(--red);margin-bottom:16px">Danger Zone</h3>
        <p style="color:var(--text-sec);margin-bottom:16px">Once you delete your account, there is no going back. Please be certain.</p>
        <button class="btn btn-danger" onclick="confirmDeleteAccount()">Delete Account</button>
      </div>
    </div>
  </div>

  <!-- User Dashboard Page -->
  <div class="page" id="pageDashboard">
    <div class="container" style="padding:40px 24px">
      <button class="btn btn-ghost" onclick="nav('pageApp')" style="margin-bottom:24px">â† Back to App</button>
      <h1 style="margin-bottom:32px">Your Dashboard</h1>
      
      <!-- Plan & Usage Overview -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px">
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px">
          <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px">Current Plan</div>
          <div id="dashboardPlan" style="font-size:1.5rem;font-weight:700;color:var(--orange)">Free</div>
          <div id="dashboardSpeed" style="font-size:0.85rem;color:var(--text-sec);margin-top:4px">Standard Speed</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px">
          <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px">Files This Month</div>
          <div id="dashboardFilesUsed" style="font-size:1.5rem;font-weight:700">0 / 10</div>
          <div class="progress-bar" style="margin-top:8px"><div id="dashboardFilesProgress" class="progress-fill" style="width:0%"></div></div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px">
          <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px">Total Files Processed</div>
          <div id="dashboardTotalFiles" style="font-size:1.5rem;font-weight:700">0</div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px">
          <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px">Est. API Cost</div>
          <div id="dashboardCost" style="font-size:1.5rem;font-weight:700">$0.00</div>
        </div>
      </div>
      
      <!-- Productivity Metrics - NEW -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:20px;margin-bottom:32px">
        <div style="background:linear-gradient(135deg,rgba(34,197,94,0.1),rgba(34,197,94,0.05));border:1px solid rgba(34,197,94,0.3);border-radius:16px;padding:20px">
          <div style="color:var(--green);font-size:0.85rem;margin-bottom:8px">â±ï¸ Time Saved</div>
          <div id="productivityHours" style="font-size:1.5rem;font-weight:700;color:var(--green)">0 minutes</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">vs. manual renaming</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(249,115,22,0.1),rgba(249,115,22,0.05));border:1px solid rgba(249,115,22,0.3);border-radius:16px;padding:20px">
          <div style="color:var(--orange);font-size:0.85rem;margin-bottom:8px">ðŸ” Duplicates Found</div>
          <div id="productivityDuplicates" style="font-size:1.5rem;font-weight:700;color:var(--orange)">0</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">duplicate files detected</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(59,130,246,0.1),rgba(59,130,246,0.05));border:1px solid rgba(59,130,246,0.3);border-radius:16px;padding:20px">
          <div style="color:var(--blue);font-size:0.85rem;margin-bottom:8px">ðŸ’¾ Storage Reclaimed</div>
          <div id="productivityStorage" style="font-size:1.5rem;font-weight:700;color:var(--blue)">0 MB</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">from removed duplicates</div>
        </div>
        <div style="background:linear-gradient(135deg,rgba(168,85,247,0.1),rgba(168,85,247,0.05));border:1px solid rgba(168,85,247,0.3);border-radius:16px;padding:20px">
          <div style="color:var(--purple);font-size:0.85rem;margin-bottom:8px">âš¡ Avg Processing</div>
          <div id="productivityAvgTime" style="font-size:1.5rem;font-weight:700;color:var(--purple)">0ms</div>
          <div style="font-size:0.75rem;color:var(--text-muted);margin-top:4px">per file</div>
        </div>
      </div>

      <!-- Weekly Activity Chart -->
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:32px">
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
          <h3 style="margin-bottom:16px">ðŸ“ˆ Weekly Activity</h3>
          <div id="weeklyChart" style="display:flex;gap:8px;height:120px;align-items:flex-end">
            <p style="color:var(--text-muted)">Loading chart...</p>
          </div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
          <h3 style="margin-bottom:16px">ðŸ“ Files by Type</h3>
          <div id="filesByType" style="max-height:140px;overflow-y:auto">
            <p style="color:var(--text-muted)">No data yet</p>
          </div>
        </div>
      </div>

      <!-- Cost Breakdown -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;margin-bottom:32px">
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
          <h3 style="margin-bottom:16px">Cost by Processing Type</h3>
          <div id="costBreakdown">
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
              <span>Text/OCR Processing</span>
              <span id="costOcr">$0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
              <span>Vision Analysis</span>
              <span id="costVision">$0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
              <span>Audio Transcription</span>
              <span id="costAudio">$0.00</span>
            </div>
            <div style="display:flex;justify-content:space-between;padding:8px 0">
              <span>Text Generation</span>
              <span id="costText">$0.00</span>
            </div>
          </div>
        </div>
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
          <h3 style="margin-bottom:16px">Your Features</h3>
          <div id="dashboardFeatures" style="display:flex;flex-wrap:wrap;gap:8px"></div>
        </div>
      </div>

      <!-- Recent Activity -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0">Recent Activity</h3>
          <button class="btn btn-ghost btn-sm" onclick="viewHistory()">View All â†’</button>
        </div>
        <div id="dashboardActivity">
          <p style="color:var(--text-muted)">No recent activity</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Billing Page -->
  <div class="page" id="pageBilling">
    <div class="container" style="max-width:1000px;padding:40px 24px">
      <button class="btn btn-ghost" onclick="nav('pageApp')" style="margin-bottom:24px">â† Back to App</button>
      <h1 style="margin-bottom:8px">Billing & Plans</h1>
      <p style="color:var(--text-sec);margin-bottom:32px">Manage your subscription and billing details</p>
      
      <!-- Current Plan -->
      <div style="background:linear-gradient(135deg,rgba(249,115,22,0.1),rgba(249,115,22,0.05));border:2px solid var(--orange);border-radius:16px;padding:24px;margin-bottom:32px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="color:var(--orange);font-size:0.85rem;font-weight:600;margin-bottom:4px">CURRENT PLAN</div>
            <div id="billingCurrentPlan" style="font-size:1.75rem;font-weight:700">Free</div>
            <div id="billingPlanDetails" style="color:var(--text-sec);margin-top:4px">25 files/month â€¢ Standard speed</div>
          </div>
          <div id="billingManageBtn" style="display:none">
            <button class="btn btn-secondary" onclick="openBillingPortal()">Manage Subscription</button>
          </div>
        </div>
      </div>

      <!-- Plan Options -->
      <h2 style="margin-bottom:24px">Available Plans</h2>
      <div class="pricing-grid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:24px;margin-bottom:32px">
        <!-- Free Plan -->
        <div class="pricing-card" style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
          <h3>Free</h3>
          <div style="font-size:2.5rem;font-weight:700;margin:16px 0">$0<span style="font-size:1rem;color:var(--text-sec)">/month</span></div>
          <ul style="list-style:none;margin-bottom:24px;color:var(--text-sec)">
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 25 files/month</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Basic OCR</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 5 Magic Folders</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg> Standard speed</li>
          </ul>
          <button class="btn btn-outline" style="width:100%" id="btnPlanFree" disabled>Current Plan</button>
        </div>
        <!-- Pro Plan -->
        <div class="pricing-card" style="background:var(--card);border:2px solid var(--orange);border-radius:16px;padding:24px;position:relative">
          <div style="position:absolute;top:-12px;left:50%;transform:translateX(-50%);background:var(--orange);color:#fff;padding:4px 12px;border-radius:12px;font-size:0.75rem;font-weight:600">MOST POPULAR</div>
          <h3>Pro</h3>
          <div style="font-size:2.5rem;font-weight:700;margin:16px 0">$19<span style="font-size:1rem;color:var(--text-sec)">/month</span></div>
          <ul style="list-style:none;margin-bottom:24px;color:var(--text-sec)">
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 500 files/month</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Vision Recognition</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Unlimited Magic Folders</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Fast processing</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Cloud Sync</li>
          </ul>
          <button class="btn btn-primary" style="width:100%" id="btnPlanPro" onclick="subscribeToPlan('pro')">Upgrade to Pro</button>
        </div>
        <!-- Business Plan -->
        <div class="pricing-card" style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
          <h3>Business</h3>
          <div style="font-size:2.5rem;font-weight:700;margin:16px 0">$49<span style="font-size:1rem;color:var(--text-sec)">/month</span></div>
          <ul style="list-style:none;margin-bottom:24px;color:var(--text-sec)">
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 5,000 files/month</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Audio Transcription</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Watch Agents</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Instant processing</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Team Workspaces</li>
            <li style="padding:8px 0;display:flex;align-items:center;gap:8px"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> API Access</li>
          </ul>
          <button class="btn btn-secondary" style="width:100%" id="btnPlanBusiness" onclick="subscribeToPlan('business')">Upgrade to Business</button>
        </div>
      </div>

      <!-- Payment History -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:24px">
        <h3 style="margin-bottom:16px">Payment History</h3>
        <div id="paymentHistory">
          <p style="color:var(--text-muted)">No payment history available</p>
        </div>
      </div>
    </div>
  </div>
  <div class="modal" id="authModal">
    <div class="modal-content" style="position:relative">
      <button class="modal-close" onclick="closeAuthModal()" style="position:absolute;top:12px;right:12px;background:none;border:none;color:var(--text-muted);cursor:pointer;padding:8px;z-index:10">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
      <div class="auth-tabs">
        <div class="auth-tab active" id="tabLogin" onclick="switchAuthTab('login')">Sign In</div>
        <div class="auth-tab" id="tabRegister" onclick="switchAuthTab('register')">Create Account</div>
        <div class="auth-tab" id="tabForgot" onclick="switchAuthTab('forgot')" style="display:none">Reset Password</div>
      </div>
      <div class="auth-form" id="authFormLogin">
        <!-- Google Sign-in Primary -->
        <button class="google-btn-primary" onclick="googleLogin()">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign in with Google
        </button>
        <div class="form-divider">or sign in with email</div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="loginEmail" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="password-field">
            <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('loginPassword', this)" aria-label="Toggle password visibility">
              <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
            </button>
          </div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="login()">Sign In</button>
        <div style="text-align:center;margin-top:12px">
          <a href="#" onclick="switchAuthTab('forgot');return false" style="color:var(--orange);font-size:0.9rem;text-decoration:none">Forgot your password?</a>
        </div>
      </div>
      <div class="auth-form" id="authFormRegister" style="display:none">
        <!-- Google Sign-up Primary -->
        <button class="google-btn-primary" onclick="googleLogin()">
          <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
          Sign up with Google
        </button>
        <div class="form-divider">or create account with email</div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="registerEmail" placeholder="you@example.com">
        </div>
        <div class="form-group">
          <label>Password</label>
          <div class="password-field">
            <input type="password" id="registerPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            <button type="button" class="password-toggle" onclick="togglePasswordVisibility('registerPassword', this)" aria-label="Toggle password visibility">
              <svg class="eye-open" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
              <svg class="eye-closed" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
            </button>
          </div>
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="register()">Create Account</button>
      </div>
      <div class="auth-form" id="authFormForgot" style="display:none">
        <div style="text-align:center;margin-bottom:20px">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <h3 style="margin-top:12px">Reset your password</h3>
          <p style="color:var(--text-sec);font-size:0.9rem">Enter your email and we'll send you a reset link</p>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="forgotEmail" placeholder="you@example.com">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="sendResetEmail()">Send Reset Link</button>
        <div style="text-align:center;margin-top:12px">
          <a href="#" onclick="switchAuthTab('login');return false" style="color:var(--text-sec);font-size:0.9rem;text-decoration:none">â† Back to Sign In</a>
        </div>
      </div>
      <div class="auth-form" id="authFormReset" style="display:none">
        <div style="text-align:center;margin-bottom:20px">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="var(--green)" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><polyline points="9 12 12 15 22 5"/></svg>
          <h3 style="margin-top:12px">Set new password</h3>
        </div>
        <div class="form-group">
          <label>New Password</label>
          <input type="password" id="resetNewPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <div class="form-group">
          <label>Confirm Password</label>
          <input type="password" id="resetConfirmPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
        </div>
        <button class="btn btn-primary" style="width:100%" onclick="resetPassword()">Reset Password</button>
      </div>
    </div>
  </div>


  <!-- Magic Folders Page HTML -->
<div class="page" id="pageMagicFolders" style="display:none">
  <div class="container" style="max-width:1200px;padding:40px 20px">
    
    <!-- Page Header -->
    <div style="margin-bottom:32px">
      <h1 style="font-size:2rem;margin-bottom:8px;display:flex;align-items:center;gap:12px">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          <path d="M12 11v6m-3-3h6" stroke="var(--orange)"/>
        </svg>
        Magic Folders
      </h1>
      <p style="color:var(--text-sec);font-size:1rem">Automatically rename and organize files in selected folders</p>
    </div>

    <!-- New Folder Card -->
    <div class="magic-folder-new-card" id="newMagicFolderCard">
      <div style="display:flex;align-items:center;gap:16px">
        <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          <path d="M12 11v6m-3-3h6"/>
        </svg>
        <div style="flex:1">
          <h3 style="font-size:1.1rem;margin-bottom:4px">Magic Folder</h3>
          <p style="color:var(--text-sec);font-size:0.9rem">Automatically organize your files in background mode</p>
        </div>
        <button class="btn btn-primary" onclick="openMagicFolderConfig()">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          Pick folder
        </button>
      </div>
    </div>

    <!-- Active Magic Folders List -->
    <div id="magicFoldersList">
      <!-- Folders will be dynamically inserted here -->
    </div>

    <!-- Empty State -->
    <div id="magicFoldersEmpty" style="text-align:center;padding:60px 20px;display:none">
      <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="1.5" style="margin:0 auto 20px">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
      </svg>
      <h3 style="color:var(--text-sec);margin-bottom:8px">No Magic Folders yet</h3>
      <p style="color:var(--text-muted);font-size:0.9rem">Click "Pick folder" above to create your first Magic Folder</p>
    </div>

  </div>
</div>

<!-- Magic Folder Configuration Modal -->
<div class="modal" id="magicFolderConfigModal">
  <div class="modal-content" style="max-width:800px;max-height:90vh;overflow-y:auto">
    <div class="modal-header">
      <h2>Configure Magic Folder</h2>
      <button class="modal-close" onclick="closeMagicFolderConfig()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="18" y1="6" x2="6" y2="18"/>
          <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    
    <div style="padding:24px">
      
      <!-- Folder Path Display -->
      <div style="background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:24px;display:flex;align-items:center;gap:12px">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
        </svg>
        <div style="flex:1;overflow:hidden">
          <div id="magicFolderPath" style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis">/Select a folder...</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="resetMagicFolderPath()" style="color:var(--orange)">Reset</button>
        <button class="btn btn-primary btn-sm" onclick="createMagicFolder()" id="createMagicFolderBtn" disabled>Create</button>
      </div>

      <!-- Naming Template -->
      <div style="margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
            <polyline points="14 2 14 8 20 8"/>
          </svg>
          <h3 style="font-size:1rem">Naming Template</h3>
        </div>
        <div style="position:relative">
          <select id="magicFolderTemplate" class="form-input" style="width:100%;padding:12px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.95rem">
            <option value="auto">Auto (AI decides best format)</option>
            <option value="business">Business Document Template</option>
            <option value="invoice">Invoice Template</option>
            <option value="project">Project Files</option>
          </select>
        </div>
      </div>

      <!-- Initial Settings -->
      <div style="margin-bottom:24px">
        <h3 style="font-size:0.9rem;color:var(--text-sec);margin-bottom:12px">Initial Settings</h3>
        <div style="display:flex;gap:24px">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="ignoreInitialFiles" style="width:18px;height:18px;accent-color:var(--orange)">
            <span style="font-size:0.9rem">Ignore initial files</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="cursor:help" title="Don't process files that already exist in the folder">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </label>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input type="checkbox" id="includeSubfolders" checked style="width:18px;height:18px;accent-color:var(--orange)">
            <span style="font-size:0.9rem">Include subfolders</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2" style="cursor:help" title="Process files in subfolders recursively">
              <circle cx="12" cy="12" r="10"/>
              <path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/>
              <line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </label>
        </div>
      </div>

      <!-- File Settings Grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:24px">
        
        <!-- File Name Language -->
        <div>
          <label style="display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px">File name language</label>
          <select id="fileLanguage" class="form-input" style="width:100%;padding:10px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem">
            <option value="auto">Smart Detect</option>
            <option value="en">English</option>
            <option value="es">Spanish</option>
            <option value="fr">French</option>
            <option value="de">German</option>
            <option value="ja">Japanese</option>
            <option value="zh">Chinese</option>
          </select>
        </div>

        <!-- Date Format -->
        <div>
          <label style="display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px">Date format</label>
          <select id="dateFormat" class="form-input" style="width:100%;padding:10px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem">
            <option value="DD-MM-YYYY">DD-MM-YYYY</option>
            <option value="MM-DD-YYYY">MM-DD-YYYY</option>
            <option value="YYYY-MM-DD">YYYY-MM-DD</option>
            <option value="YYYYMMDD">YYYYMMDD</option>
          </select>
        </div>

        <!-- Text Format -->
        <div>
          <label style="display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px">Text format</label>
          <select id="textFormat" class="form-input" style="width:100%;padding:10px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:0.9rem">
            <option value="auto">Smart Detect</option>
            <option value="lowercase">lowercase</option>
            <option value="UPPERCASE">UPPERCASE</option>
            <option value="Title Case">Title Case</option>
            <option value="camelCase">camelCase</option>
            <option value="snake_case">snake_case</option>
          </select>
        </div>

        <!-- File Name Spaces -->
        <div>
          <label style="display:block;font-size:0.85rem;color:var(--text-sec);margin-bottom:6px">File name spaces</label>
          <div style="display:flex;gap:8px;flex-wrap:wrap">
            <button class="space-option" data-value="-" onclick="selectSpaceOption(this)">-</button>
            <button class="space-option" data-value="_" onclick="selectSpaceOption(this)">_</button>
            <button class="space-option" data-value=" " onclick="selectSpaceOption(this)">space</button>
            <button class="space-option active" data-value="auto" onclick="selectSpaceOption(this)">Auto</button>
            <button class="space-option" data-value="none" onclick="selectSpaceOption(this)">None</button>
          </div>
        </div>

      </div>

      <!-- Formatting Preview -->
      <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:24px">
        <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:4px">Formatting preview:</div>
        <div id="formattingPreview" style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;color:var(--orange)">Invoice_Acme_Corp_2024-12-19_v1.pdf</div>
      </div>

      <!-- Extensions -->
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <label style="font-size:0.85rem;color:var(--text-sec)">Extensions</label>
          <button class="btn btn-ghost btn-sm" onclick="deselectAllExtensions()" style="font-size:0.8rem;color:var(--orange)">Deselect all</button>
        </div>
        <div id="extensionTags" style="display:flex;flex-wrap:wrap;gap:8px">
          <!-- Extension tags will be dynamically inserted -->
        </div>
      </div>

    </div>
  </div>
</div>

<!-- API Monitoring Dashboard Page -->
<div class="page" id="pageApiMonitoring">
  <div class="container">
    <button class="btn btn-ghost" onclick="nav('pageHome')" style="margin-bottom:24px">â† Back to Home</button>
    <h1>ðŸ“Š API Monitoring Dashboard</h1>
    <p class="subtitle">Real-time monitoring and analytics for all API providers</p>
    
    <!-- Overview Stats -->
    <div class="monitoring-overview">
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(34,197,94,0.1);color:var(--green)">âœ“</div>
        <div class="stat-content">
          <div class="stat-value" id="healthyApisCount">0</div>
          <div class="stat-label">Healthy APIs</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(251,191,36,0.1);color:var(--warning)">âš ï¸</div>
        <div class="stat-content">
          <div class="stat-value" id="warningApisCount">0</div>
          <div class="stat-label">Warnings</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(239,68,68,0.1);color:var(--danger)">âœ—</div>
        <div class="stat-content">
          <div class="stat-value" id="failedApisCount">0</div>
          <div class="stat-label">Failed</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(255,140,0,0.1);color:var(--primary)">ðŸ’°</div>
        <div class="stat-content">
          <div class="stat-value" id="totalSpendValue">$0.00</div>
          <div class="stat-label">Total Spend</div>
        </div>
      </div>
      
      <div class="stat-card">
        <div class="stat-icon" style="background:rgba(168,85,247,0.1);color:#a855f7">ðŸ“ˆ</div>
        <div class="stat-content">
          <div class="stat-value" id="totalRequestsValue">0</div>
          <div class="stat-label">Total Requests</div>
        </div>
      </div>
    </div>
    
    <!-- Real-time Alerts -->
    <div class="monitoring-section">
      <h2>ðŸ”” Active Alerts</h2>
      <div class="alerts-container" id="activeAlerts">
        <div class="no-alerts">
          <span class="icon">âœ“</span>
          <p>No active alerts. All systems operational.</p>
        </div>
      </div>
    </div>
    
    <!-- API Status Grid -->
    <div class="monitoring-section">
      <h2>ðŸ”Œ API Status</h2>
      <div class="api-status-grid" id="apiStatusGrid">
        <!-- Will be populated dynamically -->
      </div>
    </div>
    
    <!-- Usage Charts -->
    <div class="monitoring-section">
      <h2>ðŸ“ˆ Usage Analytics</h2>
      <div class="charts-grid">
        <div class="chart-card">
          <h3>Cost Over Time</h3>
          <canvas id="costChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Requests by Provider</h3>
          <canvas id="requestsChart"></canvas>
        </div>
      </div>
    </div>
    
    <!-- Account-Level Monitoring -->
    <div class="monitoring-section">
      <h2>ðŸ‘¤ Account Monitoring</h2>
      <div class="account-monitoring-grid" id="accountMonitoringGrid">
        <!-- Will be populated dynamically -->
      </div>
    </div>
    
    <!-- End-User Monitoring -->
    <div class="monitoring-section">
      <h2>ðŸ‘¥ End-User Monitoring</h2>
      <div class="filters-bar">
        <input type="text" id="userSearchInput" placeholder="Search users..." class="search-input">
        <select id="userFilterSelect" class="filter-select">
          <option value="all">All Users</option>
          <option value="active">Active</option>
          <option value="high-usage">High Usage</option>
          <option value="errors">With Errors</option>
        </select>
        <button class="btn btn-secondary" onclick="refreshUserMonitoring()">
          <span class="btn-icon">ðŸ”„</span> Refresh
        </button>
      </div>
      <div class="user-monitoring-table" id="userMonitoringTable">
        <!-- Will be populated dynamically -->
      </div>
    </div>
    
    <!-- Issue History -->
    <div class="monitoring-section">
      <h2>ðŸ“‹ Recent Issues</h2>
      <div class="issue-history-list" id="issueHistoryList">
        <!-- Will be populated dynamically -->
      </div>
    </div>
  </div>
</div>

<style>
/* Monitoring Dashboard Styles */
.monitoring-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 32px;
}

.stat-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  align-items: center;
  gap: 16px;
  transition: all 0.3s ease;
}

.stat-card:hover {
  border-color: var(--primary);
  transform: translateY(-2px);
}

.stat-icon {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.5rem;
}

.stat-content {
  flex: 1;
}

.stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--text);
  line-height: 1;
  margin-bottom: 4px;
}

.stat-label {
  font-size: 0.85rem;
  color: var(--text-sec);
}

.monitoring-section {
  margin-bottom: 40px;
}

.monitoring-section h2 {
  font-size: 1.5rem;
  margin-bottom: 20px;
  color: var(--text);
}

.alerts-container {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  max-height: 400px;
  overflow-y: auto;
}

.no-alerts {
  text-align: center;
  padding: 40px 20px;
  color: var(--text-sec);
}

.no-alerts .icon {
  font-size: 3rem;
  display: block;
  margin-bottom: 12px;
  color: var(--green);
}

.alert-item {
  background: var(--elevated);
  border: 1px solid var(--border);
  border-left: 4px solid var(--warning);
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  align-items: start;
  gap: 12px;
}

.alert-item.error {
  border-left-color: var(--danger);
}

.alert-item.warning {
  border-left-color: var(--warning);
}

.alert-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.alert-content {
  flex: 1;
}

.alert-title {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.alert-description {
  font-size: 0.9rem;
  color: var(--text-sec);
  margin-bottom: 8px;
}

.alert-time {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.api-status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.api-status-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  position: relative;
}

.api-status-card.healthy {
  border-color: rgba(34, 197, 94, 0.3);
}

.api-status-card.warning {
  border-color: rgba(251, 191, 36, 0.3);
}

.api-status-card.error {
  border-color: rgba(239, 68, 68, 0.3);
}

.api-status-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.api-status-name {
  font-weight: 600;
  font-size: 1.1rem;
  color: var(--text);
}

.api-status-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}

.api-status-badge.healthy {
  background: rgba(34, 197, 94, 0.1);
  color: var(--green);
}

.api-status-badge.warning {
  background: rgba(251, 191, 36, 0.1);
  color: var(--warning);
}

.api-status-badge.error {
  background: rgba(239, 68, 68, 0.1);
  color: var(--danger);
}

.api-status-metrics {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 12px;
}

.metric-item {
  text-align: center;
}

.metric-value {
  font-size: 1.3rem;
  font-weight: 700;
  color: var(--text);
}

.metric-label {
  font-size: 0.75rem;
  color: var(--text-sec);
  margin-top: 2px;
}

.charts-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
  gap: 20px;
}

.chart-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
}

.chart-card h3 {
  font-size: 1.1rem;
  margin-bottom: 16px;
  color: var(--text);
}

.chart-card canvas {
  width: 100% !important;
  height: 250px !important;
}

.account-monitoring-grid {
  display: grid;
  gap: 16px;
}

.account-item {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.account-info h4 {
  font-size: 1.1rem;
  color: var(--text);
  margin-bottom: 8px;
}

.account-stats {
  display: flex;
  gap: 24px;
  font-size: 0.85rem;
  color: var(--text-sec);
}

.filters-bar {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
}

.search-input,
.filter-select {
  padding: 10px 16px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.9rem;
}

.search-input {
  flex: 1;
  min-width: 200px;
}

.filter-select {
  min-width: 150px;
}

.user-monitoring-table {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
}

.user-table-header,
.user-table-row {
  display: grid;
  grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
  gap: 16px;
  padding: 16px 20px;
  align-items: center;
}

.user-table-header {
  background: var(--elevated);
  font-weight: 600;
  font-size: 0.85rem;
  color: var(--text-sec);
  text-transform: uppercase;
  border-bottom: 1px solid var(--border);
}

.user-table-row {
  border-bottom: 1px solid var(--border);
  transition: background 0.2s ease;
}

.user-table-row:hover {
  background: var(--elevated);
}

.user-table-row:last-child {
  border-bottom: none;
}

.issue-history-list {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  max-height: 500px;
  overflow-y: auto;
}

.issue-item {
  padding: 16px;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 12px;
}

.issue-item:last-child {
  margin-bottom: 0;
}

.issue-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 8px;
}

.issue-provider {
  font-weight: 600;
  color: var(--primary);
  font-size: 0.9rem;
}

.issue-timestamp {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.issue-message {
  font-size: 0.9rem;
  color: var(--text-sec);
}

@media (max-width: 768px) {
  .monitoring-overview {
    grid-template-columns: 1fr;
  }
  
  .charts-grid {
    grid-template-columns: 1fr;
  }
  
  .user-table-header,
  .user-table-row {
    grid-template-columns: 1fr;
    gap: 8px;
  }
}
</style>


<!-- Magic Folder Results View --> View -->
<div class="page" id="pageMagicFolderResults" style="display:none">
  <div class="container" style="max-width:1200px;padding:40px 20px">
    
    <!-- Header -->
    <div style="margin-bottom:32px">
      <button class="btn btn-ghost" onclick="nav('pageMagicFolders')" style="margin-bottom:16px">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15 18 9 12 15 6"/>
        </svg>
        Magic folders
      </button>
      
      <div style="display:flex;align-items:center;justify-content:space-between;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px">
        <div style="display:flex;align-items:center;gap:12px;flex:1;overflow:hidden">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2">
            <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
          </svg>
          <div id="resultsFolderPath" style="font-family:'JetBrains Mono',monospace;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">/path/to/folder</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openFolderInSystem()">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/>
            <polyline points="15 3 21 3 21 9"/>
            <line x1="10" y1="14" x2="21" y2="3"/>
          </svg>
          Open
        </button>
      </div>
    </div>

    <!-- Results List -->
    <div id="magicFolderResultsList">
      <!-- Results will be dynamically inserted here -->
    </div>

    <!-- Load More -->
    <div style="text-align:center;padding:20px">
      <button class="btn btn-secondary" id="loadMoreResults" onclick="loadMoreResults()" style="display:none">Load more</button>
      <div id="noMoreResults" style="color:var(--text-muted);font-size:0.9rem;display:none">No more files to load</div>
    </div>

  </div>
</div>

<style>
/* Magic Folder Styles */
.magic-folder-new-card {
  background: var(--card);
  border: 2px dashed var(--border);
  border-radius: 16px;
  padding: 24px;
  margin-bottom: 24px;
  transition: all 0.2s;
}

.magic-folder-new-card:hover {
  border-color: var(--orange);
  background: var(--elevated);
}

.magic-folder-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 16px;
  transition: all 0.2s;
}

.magic-folder-card:hover {
  border-color: var(--orange);
  background: var(--elevated);
}

.magic-folder-header {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
}

.magic-folder-info {
  flex: 1;
  min-width: 0;
}

.magic-folder-name {
  font-size: 1.1rem;
  font-weight: 600;
  margin-bottom: 4px;
}

.magic-folder-path {
  font-family: 'JetBrains Mono', monospace;
  font-size: 0.85rem;
  color: var(--text-sec);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.magic-folder-controls {
  display: flex;
  align-items: center;
  gap: 12px;
  padding-top: 16px;
  border-top: 1px solid var(--border);
}

.magic-folder-template {
  flex: 1;
  padding: 8px 12px;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  color: var(--text);
  font-size: 0.9rem;
}

.magic-folder-stats {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 12px 16px;
  background: var(--elevated);
  border-radius: 8px;
}

.magic-folder-stat {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 0.9rem;
}

.magic-folder-actions {
  display: flex;
  gap: 8px;
}

.magic-folder-action-btn {
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  color: var(--text-sec);
}

.magic-folder-action-btn:hover {
  background: var(--card-hover);
  border-color: var(--orange);
  color: var(--orange);
}

/* Toggle Switch */
.toggle-switch {
  position: relative;
  width: 48px;
  height: 26px;
  background: var(--elevated);
  border-radius: 13px;
  cursor: pointer;
  transition: background 0.2s;
  border: 1px solid var(--border);
}

.toggle-switch::after {
  content: '';
  position: absolute;
  width: 20px;
  height: 20px;
  background: var(--text-muted);
  border-radius: 50%;
  top: 2px;
  left: 2px;
  transition: all 0.2s;
}

.toggle-switch.active {
  background: var(--orange);
  border-color: var(--orange);
}

.toggle-switch.active::after {
  left: 24px;
  background: #fff;
}

/* Space Option Buttons */
.space-option {
  padding: 8px 12px;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 6px;
  color: var(--text-sec);
  font-size: 0.85rem;
  cursor: pointer;
  transition: all 0.2s;
}

.space-option:hover {
  background: var(--card-hover);
  border-color: var(--text-muted);
}

.space-option.active {
  background: rgba(255, 140, 0, 0.1);
  border-color: var(--orange);
  color: var(--orange);
}

/* Extension Tags */
.extension-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 6px;
  font-size: 0.85rem;
  color: var(--text-sec);
  cursor: pointer;
  transition: all 0.2s;
}

.extension-tag:hover {
  background: var(--card-hover);
}

.extension-tag.selected {
  background: rgba(255, 140, 0, 0.1);
  border-color: var(--orange);
  color: var(--orange);
}

.extension-tag svg {
  width: 14px;
  height: 14px;
  stroke: currentColor;
}

/* Result Item */
.result-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 16px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 12px;
  transition: all 0.2s;
}

.result-item:hover {
  background: var(--elevated);
  border-color: var(--orange);
}

.result-time {
  font-size: 0.8rem;
  color: var(--text-muted);
  min-width: 50px;
}

.result-thumbnail {
  width: 48px;
  height: 48px;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.result-thumbnail svg {
  width: 24px;
  height: 24px;
  stroke: var(--text-muted);
}

.result-names {
  flex: 1;
  min-width: 0;
}

.result-old-name {
  font-size: 0.85rem;
  color: var(--text-muted);
  text-decoration: line-through;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 4px;
}

.result-new-name {
  font-size: 0.95rem;
  color: var(--text);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.result-status {
  padding: 4px 12px;
  background: rgba(16, 185, 129, 0.1);
  border: 1px solid rgba(16, 185, 129, 0.3);
  border-radius: 6px;
  color: #10b981;
  font-size: 0.8rem;
  font-weight: 500;
  white-space: nowrap;
}


/* Enhanced API Management Styles */
/* Enhanced API Management Styles */

.api-provider-card {
  position: relative;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  transition: all 0.3s ease;
}

.api-provider-card:hover {
  border-color: var(--primary);
  box-shadow: 0 4px 20px rgba(255, 140, 0, 0.1);
}

.api-provider-card.modified {
  border-color: var(--warning);
}

.api-provider-card.error {
  border-color: var(--danger);
}

.api-provider-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  position: relative;
}

.api-health-badge {
  position: absolute;
  top: 0;
  right: 0;
  display: flex;
  align-items: center;
  gap: 4px;
  padding: 4px 8px;
  background: var(--elevated);
  border-radius: 8px;
  font-size: 0.75rem;
}

.api-health-badge .dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.api-health-badge .dot.online {
  background: var(--green);
  box-shadow: 0 0 8px var(--green);
}

.api-health-badge .dot.offline {
  background: var(--danger);
  box-shadow: 0 0 8px var(--danger);
}

.api-health-badge .dot.warning {
  background: var(--warning);
  box-shadow: 0 0 8px var(--warning);
}

.api-health-badge .dot.unknown {
  background: var(--text-muted);
}

/* Usage Gauge Styles */
.api-usage-gauge {
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  margin: 16px 0;
}

.usage-bar-container {
  width: 100%;
  height: 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
  overflow: hidden;
  margin-bottom: 12px;
}

.usage-bar {
  height: 100%;
  background: linear-gradient(90deg, var(--green) 0%, var(--warning) 70%, var(--danger) 100%);
  border-radius: 4px;
  transition: width 0.5s ease;
  position: relative;
}

.usage-bar.critical {
  background: var(--danger);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.7; }
}

.usage-stats {
  display: flex;
  align-items: baseline;
  gap: 4px;
  margin-bottom: 8px;
  font-size: 0.9rem;
}

.usage-current {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text);
}

.usage-limit {
  color: var(--text-sec);
  font-size: 0.85rem;
}

.usage-details {
  display: flex;
  justify-content: space-between;
  font-size: 0.8rem;
  color: var(--text-sec);
}

.usage-details strong {
  color: var(--text);
  font-weight: 600;
}

/* API Support Panel */
.api-support-panel {
  margin-top: 16px;
  background: var(--elevated);
  border: 1px solid var(--border);
  border-radius: 12px;
  overflow: hidden;
  animation: slideDown 0.3s ease;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.support-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: rgba(255, 140, 0, 0.1);
  border-bottom: 1px solid var(--border);
}

.support-header h4 {
  margin: 0;
  font-size: 1rem;
  color: var(--text);
}

.btn-close {
  background: transparent;
  border: none;
  color: var(--text-sec);
  font-size: 1.5rem;
  cursor: pointer;
  padding: 0;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 4px;
  transition: all 0.2s ease;
}

.btn-close:hover {
  background: rgba(255, 255, 255, 0.1);
  color: var(--text);
}

.support-content {
  padding: 16px;
}

.support-status {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: rgba(34, 197, 94, 0.1);
  border: 1px solid rgba(34, 197, 94, 0.3);
  border-radius: 8px;
  color: var(--green);
  font-size: 0.9rem;
  margin-bottom: 12px;
}

.support-status::before {
  content: 'âœ“';
  font-weight: bold;
}

.support-issues {
  max-height: 300px;
  overflow-y: auto;
}

.support-issue-item {
  padding: 12px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 8px;
  margin-bottom: 8px;
}

.support-issue-item.error {
  border-color: var(--danger);
  background: rgba(239, 68, 68, 0.05);
}

.support-issue-item.warning {
  border-color: var(--warning);
  background: rgba(251, 191, 36, 0.05);
}

.issue-title {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.issue-description {
  font-size: 0.85rem;
  color: var(--text-sec);
  margin-bottom: 8px;
}

.issue-resolution {
  font-size: 0.85rem;
  color: var(--text-muted);
  padding: 8px;
  background: rgba(255, 255, 255, 0.03);
  border-radius: 6px;
  border-left: 3px solid var(--primary);
}

.issue-resolution strong {
  color: var(--primary);
}

/* Button Icon Styles */
.btn-icon {
  background: transparent;
  border: 1px solid var(--border);
  color: var(--text-sec);
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 1rem;
  transition: all 0.2s ease;
}

.btn-icon:hover {
  background: var(--card-hover);
  color: var(--text);
  border-color: var(--primary);
}

.api-provider-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.api-provider-actions .btn {
  display: flex;
  align-items: center;
  gap: 6px;
}

.api-provider-actions .btn .btn-icon {
  border: none;
  padding: 0;
  margin: 0;
  background: transparent;
}

/* Modified indicator */
.api-key-input-group input.modified {
  border-color: var(--warning);
  background: rgba(251, 191, 36, 0.05);
}

/* Loading state */
.btn.loading {
  position: relative;
  pointer-events: none;
  opacity: 0.7;
}

.btn.loading::after {
  content: '';
  position: absolute;
  width: 16px;
  height: 16px;
  top: 50%;
  left: 50%;
  margin-left: -8px;
  margin-top: -8px;
  border: 2px solid var(--text);
  border-radius: 50%;
  border-top-color: transparent;
  animation: spin 0.6s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Version badge */
.version-badge {
  display: inline-block;
  padding: 2px 8px;
  background: rgba(255, 140, 0, 0.1);
  border: 1px solid rgba(255, 140, 0, 0.3);
  border-radius: 4px;
  font-size: 0.75rem;
  color: var(--primary);
  margin-left: 8px;
}

.version-badge.new {
  background: rgba(34, 197, 94, 0.1);
  border-color: rgba(34, 197, 94, 0.3);
  color: var(--green);
  animation: glow 2s infinite;
}

@keyframes glow {
  0%, 100% { box-shadow: 0 0 5px rgba(34, 197, 94, 0.3); }
  50% { box-shadow: 0 0 15px rgba(34, 197, 94, 0.5); }
}

/* Responsive */
@media (max-width: 768px) {
  .api-provider-actions {
    flex-direction: column;
  }
  
  .api-provider-actions .btn {
    width: 100%;
    justify-content: center;
  }
}

</style>


  <!-- Settings Modal -->
  <div class="modal" id="settingsModal">
    <div class="modal-content" style="max-width:640px">
      <div class="modal-header">
        <h2>Settings</h2>
        <button class="modal-close" onclick="closeSettingsModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="settings-tabs">
        <div class="settings-tab active" onclick="switchSettingsTab('general')">General</div>
        <div class="settings-tab" onclick="switchSettingsTab('instructions')">Custom Instructions</div>
        <div class="settings-tab" onclick="switchSettingsTab('connections')">Connections</div>
      </div>
      <div class="settings-content">
        <!-- General Settings -->
        <div id="settingsGeneral">
          <div class="settings-section">
            <h3>Preferences</h3>
            <div class="setting-row">
              <div>
                <div class="setting-label">Output Language</div>
                <div class="setting-desc">Language for generated filenames</div>
              </div>
              <select id="settingLanguage" style="padding:8px;background:var(--elevated);border:1px solid var(--border);border-radius:6px;color:var(--text)">
                <option value="en">English</option>
                <option value="es">Spanish</option>
                <option value="fr">French</option>
                <option value="de">German</option>
                <option value="ja">Japanese</option>
                <option value="zh">Chinese</option>
              </select>
            </div>
            <div class="setting-row">
              <div>
                <div class="setting-label">Preview Before Apply</div>
                <div class="setting-desc">Always show preview before renaming</div>
              </div>
              <div class="toggle active" id="previewToggle" onclick="this.classList.toggle('active')"></div>
            </div>
            <div class="setting-row">
              <div>
                <div class="setting-label">Keep Original Files</div>
                <div class="setting-desc">Create copies instead of renaming</div>
              </div>
              <div class="toggle" id="keepOriginalToggle" onclick="this.classList.toggle('active')"></div>
            </div>
          </div>

          

        <!-- Custom Instructions -->
        <div id="settingsInstructions" style="display:none">
          <div class="custom-instructions">
            <h4>
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
              Naming Convention Template
            </h4>
            <div class="instruction-group" style="margin-bottom:20px">
              <label>Quick Templates (Industry Best Practices)</label>
              <select id="instTemplate" onchange="applyNamingTemplate(this.value)" style="width:100%;padding:10px;background:var(--card);border:1px solid var(--border);border-radius:8px;color:var(--text)">
                <option value="">Custom Settings</option>
                <option value="research">ðŸ“š Research/Academic - YYYYMMDD_Project_Description_v01</option>
                <option value="financial">ðŸ’¼ Financial/Business - DocType_Client_Date_v1</option>
                <option value="design">ðŸŽ¨ Design/Creative - Project-Asset-Variant-Size</option>
                <option value="medical">ðŸ¥ Medical/Healthcare - PatientID_Date_DocType_Provider</option>
                <option value="agile">ðŸš€ Agile/Sprint - Team_Sprint_YY.MM.N_Deliverable</option>
                <option value="general">ðŸ“ General Purpose - Date_Description_Version</option>
              </select>
              <div id="templatePreview" style="margin-top:8px;padding:10px;background:var(--card);border-radius:6px;font-family:'JetBrains Mono',monospace;font-size:0.85rem;display:none">
                <div style="color:var(--text-muted);font-size:0.75rem;margin-bottom:4px">Preview:</div>
                <div id="templatePreviewText" style="color:var(--green)"></div>
              </div>
            </div>

            <h4 style="margin-top:16px">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 20h9"/><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"/></svg>
              Detailed Rules
            </h4>
            <div class="instruction-grid">
              <div class="instruction-group">
                <label>Naming Style</label>
                <select id="instNamingStyle">
                  <option value="auto">Auto (AI decides)</option>
                  <option value="corporate">Corporate/Formal</option>
                  <option value="descriptive">Descriptive/Verbose</option>
                  <option value="minimal">Minimal/Short</option>
                </select>
              </div>
              <div class="instruction-group">
                <label>Word Separator</label>
                <div class="radio-group" id="instSeparator">
                  <label class="radio-option active" data-value="underscore"><input type="radio" name="separator" checked>Underscore (_)</label>
                  <label class="radio-option" data-value="hyphen"><input type="radio" name="separator">Hyphen (-)</label>
                  <label class="radio-option" data-value="space"><input type="radio" name="separator">Space ( )</label>
                  <label class="radio-option" data-value="camel"><input type="radio" name="separator">CamelCase</label>
                </div>
              </div>
              <div class="instruction-group">
                <label>Date Format</label>
                <select id="instDateFormat">
                  <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                  <option value="MM-DD-YYYY">MM-DD-YYYY</option>
                  <option value="DD-MM-YYYY">DD-MM-YYYY</option>
                  <option value="YYYYMMDD">YYYYMMDD (compact)</option>
                  <option value="none">No Date</option>
                </select>
              </div>
              <div class="instruction-group">
                <label>Date Position</label>
                <div class="radio-group" id="instDatePosition">
                  <label class="radio-option active" data-value="prefix"><input type="radio" name="datepos" checked>Prefix</label>
                  <label class="radio-option" data-value="suffix"><input type="radio" name="datepos">Suffix</label>
                  <label class="radio-option" data-value="none"><input type="radio" name="datepos">None</label>
                </div>
              </div>
              <div class="instruction-group">
                <label>Custom Prefix</label>
                <input type="text" id="instPrefix" placeholder="e.g., PROJECT_">
              </div>
              <div class="instruction-group">
                <label>Custom Suffix</label>
                <input type="text" id="instSuffix" placeholder="e.g., _FINAL">
              </div>
              <div class="instruction-group full-width">
                <label>Max Filename Length: <span class="length-value" id="lengthValue">100</span> characters</label>
                <input type="range" class="length-slider" id="instMaxLength" min="20" max="255" value="100" oninput="document.getElementById('lengthValue').textContent=this.value">
              </div>
              <div class="instruction-group full-width">
                <label>Custom AI Prompt (Advanced)</label>
                <textarea id="instCustomPrompt" placeholder="Add any additional instructions for the AI..."></textarea>
              </div>
            </div>
          </div>
          <div id="instructionsLocked" style="display:none;padding:24px;text-align:center;color:var(--text-muted)">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-bottom:12px;opacity:0.5"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
            <p>Custom Instructions require Pro plan or higher</p>
            <button class="btn btn-primary" style="margin-top:12px" onclick="showUpgradeModal()">Upgrade Now</button>
          </div>
        </div>

        <!-- Connections -->
        <div id="settingsConnections" style="display:none">
          <div class="settings-section">
            <h3>Cloud Storage</h3>
            <div class="setting-row">
              <div style="display:flex;align-items:center;gap:12px">
                <svg width="24" height="24" viewBox="0 0 24 24"><path fill="#4285F4" d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.345-7.574 7.439-7.574c2.33 0 3.891.989 4.785 1.849l3.254-3.138C18.189 1.186 15.479 0 12.24 0c-6.635 0-12 5.365-12 12s5.365 12 12 12c6.926 0 11.52-4.869 11.52-11.726 0-.788-.085-1.39-.189-1.989H12.24z"/></svg>
                <div>
                  <div class="setting-label">Google Drive</div>
                  <div class="setting-desc" id="googleDriveStatus">Not connected</div>
                </div>
              </div>
              <button class="btn btn-sm btn-secondary" id="googleDriveBtn" onclick="connectGoogleDrive()">Connect</button>
            </div>
            <div class="setting-row">
              <div style="display:flex;align-items:center;gap:12px">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="#0061FF"><path d="M12 2L6 8h4v6h4V8h4l-6-6zm0 20l6-6h-4v-6H10v6H6l6 6z"/></svg>
                <div>
                  <div class="setting-label">Dropbox</div>
                  <div class="setting-desc">Not connected</div>
                </div>
              </div>
              <button class="btn btn-sm btn-secondary btn-locked" id="dropboxBtn">Pro Required</button>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save Changes</button>
      </div>
    </div>
  </div>

  <!-- Upgrade Modal -->
  <div class="modal" id="upgradeModal">
    <div class="modal-content upgrade-modal" style="max-width:700px">
      <div class="modal-header">
        <h2>Upgrade Your Plan</h2>
        <button class="modal-close" onclick="closeUpgradeModal()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
        </button>
      </div>
      <div class="upgrade-plans">
        <div class="upgrade-plan">
          <h3>Free</h3>
          <div class="price">$0<span>/mo</span></div>
          <ul>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 25 files/month</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Basic OCR</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 5 Magic Folder actions</li>
          </ul>
          <button class="btn btn-outline" style="width:100%">Current Plan</button>
        </div>
        <div class="upgrade-plan popular">
          <h3>Pro</h3>
          <div class="price">$19<span>/mo</span></div>
          <ul>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 500 files/month</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Vision Recognition</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Cloud Sync</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Custom Instructions</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Priority Processing</li>
          </ul>
          <button class="btn btn-primary" style="width:100%" onclick="upgradeTo('pro')">Upgrade to Pro</button>
        </div>
        <div class="upgrade-plan">
          <h3>Business</h3>
          <div class="price">$49<span>/mo</span></div>
          <ul>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> 5,000 files/month</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Audio Transcription</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Watch Agents</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> Team Workspaces</li>
            <li><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg> API Access</li>
          </ul>
          <button class="btn btn-secondary" style="width:100%" onclick="upgradeTo('business')">Upgrade to Business</button>
        </div>
      </div>
    </div>
  </div>
  </div>

  <!-- System Status Page -->
  <div class="page" id="pageSystemStatus">
    <div class="container" style="max-width:1200px;margin:0 auto;padding:24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:2rem">ðŸ“ˆ</span>
          <div>
            <h1 style="color:var(--orange);margin:0">System Status</h1>
            <p style="color:var(--text-muted);margin:0">Real-time monitoring of all system services</p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:16px">
          <span id="systemStatusTime" style="color:var(--text-muted);font-size:0.9rem">ðŸ• Last checked: Never</span>
          <button class="btn btn-primary" onclick="refreshSystemHealth()">ðŸ”„ Refresh</button>
        </div>
      </div>
      
      <!-- Stats Cards -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px" id="systemStatsCards">
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Total Latency</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--orange);margin:4px 0" id="statTotalLatency">0ms</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Active Providers</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--green);margin:4px 0" id="statActiveProviders">0 / 0</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">AI Providers</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--blue);margin:4px 0" id="statAiProviders">0</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Version</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--orange);margin:4px 0" id="statVersion">1.0.0</p>
        </div>
      </div>
      
      <!-- Service Health -->
      <div class="card" style="padding:24px;margin-bottom:24px">
        <h3 style="color:var(--orange);margin:0 0 8px 0">Service Health</h3>
        <p style="color:var(--text-muted);margin:0 0 16px 0">Status of all core system services</p>
        <div id="serviceHealthGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
          <!-- Services will be loaded here -->
        </div>
      </div>
      
      <!-- Provider Summary -->
      <div class="card" style="padding:24px">
        <h3 style="color:var(--orange);margin:0 0 8px 0">Provider Summary</h3>
        <p style="color:var(--text-muted);margin:0 0 16px 0">Overview of configured API providers by type</p>
        <div id="providerSummaryGrid" style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px">
          <!-- Provider summary will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- Auto Testing Page -->
  <div class="page" id="pageAutoTesting">
    <div class="container" style="max-width:1200px;margin:0 auto;padding:24px">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:2rem">ðŸ”„</span>
          <div>
            <h1 style="color:var(--orange);margin:0">Auto Testing</h1>
            <p style="color:var(--text-muted);margin:0">Run automated tests on your system configuration</p>
          </div>
        </div>
        <button class="btn btn-primary" onclick="runAllTests()" id="btnRunAllTests">â–¶ï¸ Run All Tests</button>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">
        <!-- Available Tests -->
        <div class="card" style="padding:24px">
          <h3 style="color:var(--orange);margin:0 0 8px 0">Available Tests</h3>
          <p style="color:var(--text-muted);margin:0 0 16px 0">Run individual tests to verify system components</p>
          <div id="availableTestsList" style="display:flex;flex-direction:column;gap:12px">
            <!-- Tests will be loaded here -->
          </div>
        </div>
        
        <!-- Test History -->
        <div class="card" style="padding:24px">
          <h3 style="color:var(--orange);margin:0 0 8px 0">Test History</h3>
          <p style="color:var(--text-muted);margin:0 0 16px 0">Recent test results</p>
          <div id="testHistoryList" style="display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto">
            <!-- Test history will be loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Backup & Restore Page -->
  <div class="page" id="pageBackupRestore">
    <div class="container" style="max-width:1200px;margin:0 auto;padding:24px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <span style="font-size:2rem">â˜ï¸</span>
        <div>
          <h1 style="color:var(--orange);margin:0">Backup & Restore</h1>
          <p style="color:var(--text-muted);margin:0">Create and manage configuration backups</p>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:24px;margin-bottom:24px">
        <!-- Create Backup -->
        <div class="card" style="padding:24px">
          <h3 style="color:var(--orange);margin:0 0 8px 0">Create New Backup</h3>
          <p style="color:var(--text-muted);margin:0 0 16px 0">Save your current API keys and provider configurations</p>
          <div style="display:flex;flex-direction:column;gap:12px">
            <div>
              <label style="color:var(--orange);font-size:0.9rem">Backup Name</label>
              <input type="text" id="backupName" class="input" placeholder="e.g., Weekly Backup - December 25" style="width:100%;margin-top:4px">
            </div>
            <div>
              <label style="color:var(--orange);font-size:0.9rem">Description (optional)</label>
              <input type="text" id="backupDescription" class="input" placeholder="Brief description of this backup" style="width:100%;margin-top:4px">
            </div>
            <button class="btn btn-primary" onclick="createBackup()" style="width:100%">ðŸ“¦ Create Backup</button>
          </div>
        </div>
        
        <!-- Import Backup -->
        <div class="card" style="padding:24px">
          <h3 style="color:var(--orange);margin:0 0 8px 0">Import Backup</h3>
          <p style="color:var(--text-muted);margin:0 0 16px 0">Restore from a backup file</p>
          <label for="backupFileUpload" style="display:flex;flex-direction:column;align-items:center;justify-content:center;padding:24px;border:2px dashed var(--border);border-radius:8px;cursor:pointer;transition:border-color 0.2s">
            <span style="font-size:2rem">ðŸ“</span>
            <span style="color:var(--text-muted);font-size:0.9rem">Click to upload backup file</span>
            <span style="color:var(--text-muted);font-size:0.75rem">.json files only</span>
          </label>
          <input type="file" id="backupFileUpload" accept=".json" style="display:none" onchange="importBackupFile(event)">
        </div>
      </div>
      
      <!-- Saved Backups -->
      <div class="card" style="padding:24px">
        <h3 style="color:var(--orange);margin:0 0 8px 0">Saved Backups</h3>
        <p style="color:var(--text-muted);margin:0 0 16px 0">Manage your backup archives</p>
        <div id="savedBackupsList">
          <!-- Backups will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- DB Management Page -->
  <div class="page" id="pageDbManagement">
    <div class="container" style="max-width:1200px;margin:0 auto;padding:24px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <span style="font-size:2rem">ðŸ—„ï¸</span>
        <div>
          <h1 style="color:var(--orange);margin:0">Database Management</h1>
          <p style="color:var(--text-muted);margin:0">Monitor and manage the application database</p>
        </div>
      </div>
      
      <!-- DB Stats Cards -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px" id="dbStatsCards">
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Total Size</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--orange);margin:4px 0" id="dbStatSize">0 MB</p>
          <div style="height:4px;background:var(--border);border-radius:2px;margin-top:8px">
            <div id="dbSizeProgress" style="height:100%;background:var(--orange);border-radius:2px;width:0%"></div>
          </div>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Total Rows</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--orange);margin:4px 0" id="dbStatRows">0</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Uptime</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--green);margin:4px 0" id="dbStatUptime">99.9%</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Connections</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--orange);margin:4px 0" id="dbStatConnections">0</p>
        </div>
      </div>
      
      <!-- DB Actions -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px">
        <div class="card" style="padding:20px">
          <h4 style="color:var(--orange);margin:0 0 8px 0">Export Database</h4>
          <p style="color:var(--text-muted);font-size:0.85rem;margin:0 0 12px 0">Download a full database export</p>
          <button class="btn btn-primary" onclick="exportDatabase()" style="width:100%">ðŸ“¥ Export to JSON</button>
        </div>
        <div class="card" style="padding:20px">
          <h4 style="color:var(--orange);margin:0 0 8px 0">Compact Database</h4>
          <p style="color:var(--text-muted);font-size:0.85rem;margin:0 0 12px 0">Optimize storage and performance</p>
          <button class="btn btn-secondary" onclick="compactDatabase()" style="width:100%">ðŸ”„ Compact Now</button>
        </div>
        <div class="card" style="padding:20px">
          <h4 style="color:var(--orange);margin:0 0 8px 0">Last Backup</h4>
          <p style="color:var(--text-muted);font-size:0.85rem;margin:0 0 12px 0">Automatic backup status</p>
          <p style="color:var(--green);margin:0" id="dbLastBackup">âœ… Never</p>
        </div>
      </div>
      
      <!-- Table Statistics -->
      <div class="card" style="padding:24px">
        <h3 style="color:var(--orange);margin:0 0 8px 0">Table Statistics</h3>
        <p style="color:var(--text-muted);margin:0 0 16px 0">Detailed breakdown by table</p>
        <div id="dbTablesList">
          <!-- Tables will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- API Keys Page (User) -->
  <div class="page" id="pageApiKeys">
    <div class="container" style="max-width:1000px;margin:0 auto;padding:24px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <span style="font-size:2rem">ðŸ”‘</span>
        <div>
          <h1 style="color:var(--orange);margin:0">API Keys</h1>
          <p style="color:var(--text-muted);margin:0">Manage your personal API keys for AI providers</p>
        </div>
      </div>
      
      <div class="card" style="padding:24px">
        <p style="color:var(--text-muted);margin:0 0 16px 0">Configure your own API keys to use with NameWizard. Your keys are encrypted and stored securely.</p>
        <div id="userApiKeysList">
          <!-- User API keys will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <!-- API Dashboard Page (User) -->
  <div class="page" id="pageApiDashboard">
    <div class="container" style="max-width:1200px;margin:0 auto;padding:24px">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
        <span style="font-size:2rem">ðŸ“Š</span>
        <div>
          <h1 style="color:var(--orange);margin:0">API Key Dashboard</h1>
          <p style="color:var(--text-muted);margin:0">Monitor your API usage and costs</p>
        </div>
      </div>
      
      <!-- Usage Stats -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px">
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Total Requests</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--orange);margin:4px 0" id="apiDashRequests">0</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Total Cost</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--green);margin:4px 0" id="apiDashCost">$0.00</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Active Keys</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--blue);margin:4px 0" id="apiDashActiveKeys">0</p>
        </div>
        <div class="card" style="padding:20px">
          <p style="color:var(--text-muted);font-size:0.9rem;margin:0">Success Rate</p>
          <p style="font-size:1.75rem;font-weight:bold;color:var(--green);margin:4px 0" id="apiDashSuccessRate">100%</p>
        </div>
      </div>
      
      <!-- Usage by Provider -->
      <div class="card" style="padding:24px">
        <h3 style="color:var(--orange);margin:0 0 16px 0">Usage by Provider</h3>
        <div id="apiDashProviderUsage">
          <!-- Provider usage will be loaded here -->
        </div>
      </div>
    </div>
  </div>

  <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script><script>
// ============ APP STATE ============
const App = {
  isLoggedIn: false,
  isGodMode: false,
  currentUser: null,
  testPlan: 'god',
  selectedFiles: [],
  processedFiles: [],
  settings: { language: 'en', preview: true, keepOriginal: false },
  customInstructions: {},
  API_URL: window.location.hostname === 'localhost' ? 'http://localhost:3000/api' : `${window.location.origin}/api`,
  token: null
};

const PLAN_LIMITS = {
  free: { files: 10, magicFolders: 5 },
  paygo: { files: -1, magicFolders: -1, creditBased: true },
  pro: { files: 500, magicFolders: -1 },
  business: { files: 5000, magicFolders: -1 },
  god: { files: 999999, magicFolders: -1 }
};

// ============ UTILITIES ============
const $ = id => document.getElementById(id);
const DB = {
  get: (key, def = null) => { try { return JSON.parse(localStorage.getItem('nw_' + key)) || def; } catch { return def; } },
  set: (key, val) => localStorage.setItem('nw_' + key, JSON.stringify(val)),
  remove: key => localStorage.removeItem('nw_' + key)
};

function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatBytes(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
}

function toast(title, message, type = 'success') {
  const container = $('toastContainer');
  const t = document.createElement('div');
  t.className = `toast ${type}`;
  t.innerHTML = `<svg class="toast-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${type === 'success' ? '<polyline points="20 6 9 17 4 12"/>' : '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>'}</svg><div class="toast-content"><h4>${escapeHtml(title)}</h4><p>${escapeHtml(message)}</p></div>`;
  container.appendChild(t);
  setTimeout(() => t.remove(), 4000);
}

async function apiCall(endpoint, method = 'GET', body = null) {
  const headers = { 'Content-Type': 'application/json' };
  if (App.token) headers['Authorization'] = `Bearer ${App.token}`;
  
  const options = { method, headers };
  if (body && method !== 'GET') options.body = JSON.stringify(body);
  
  try {
    const response = await fetch(`${App.API_URL}${endpoint}`, options);
    const data = await response.json();
    
    if (!response.ok) {
      if (data.upgrade) showUpgradeModal();
      throw new Error(data.error || 'API request failed');
    }
    return data;
  } catch (err) {
    if (err.message === 'Failed to fetch') {
      console.error('API Connection Error:', App.API_URL);
      throw new Error(`Cannot connect to server at ${App.API_URL}. Make sure the server is running.`);
    }
    throw err;
  }
}

// ============ NAVIGATION ============
function nav(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const page = $(pageId);
  if (page) page.classList.add('active');
  document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
  
  // Load dashboard data when navigating to God Mode page
  if (pageId === 'pageGodMode' && App.isGodMode) {
    loadGodDashboard();
  }
  
  // Scroll to top when navigating
  window.scrollTo(0, 0);
}

function scrollToSection(sectionId) {
  // Make sure we're on the landing page first
  nav('pageLanding');
  
  // Small delay to ensure page is rendered
  setTimeout(() => {
    const section = document.getElementById(sectionId);
    if (section) {
      section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
  }, 100);
}

function updateNav() {
  const navLinks = $('navLinks');
  const navRight = $('navRight');
  
  if (!App.isLoggedIn) {
    // LOGGED OUT NAV
    navLinks.innerHTML = `
      <a class="nav-link" href="#features" onclick="scrollToSection('features');return false">Features</a>
      <a class="nav-link" href="#how-it-works" onclick="scrollToSection('how-it-works');return false">How It Works</a>
      <a class="nav-link" href="#use-cases" onclick="scrollToSection('use-cases');return false">Use Cases</a>
      <a class="nav-link" href="#pricing" onclick="scrollToSection('pricing');return false">Pricing</a>
      `;
    navRight.innerHTML = `
      <button class="btn btn-ghost" onclick="showAuthModal('login')">Log In</button>
      <button class="btn btn-primary" onclick="showAuthModal('register')">Sign Up</button>`;
  } else {
    // LOGGED IN NAV
    const user = App.currentUser;
    // FIX: Always use actual user plan, testPlan is only for God Mode testing dropdown
    const plan = user?.plan || 'free';
    const displayPlan = (App.isGodMode && App.testPlan !== 'god') ? App.testPlan : plan;
    const initials = ((user?.firstName || '')[0] || '') + ((user?.lastName || '')[0] || '') || (user?.email?.[0]?.toUpperCase() || 'U');
    const isPaidUser = ['pro', 'business', 'god', 'paygo'].includes(plan);
    const isPaygo = plan === 'paygo';
    const credits = user?.credits || 0;
    
    // Build plan badge based on plan type
    let planBadgeContent = '';
    if (isPaygo) {
      planBadgeContent = `<span class="plan-name">Pay-as-you-go</span><span class="credit-count">â€¢ ${credits} credits</span>`;
    } else {
      planBadgeContent = plan.charAt(0).toUpperCase() + plan.slice(1);
    }
    
    // Main nav links - same for all logged in users
    navLinks.innerHTML = `
      <a class="nav-link" href="#" onclick="nav('pageApp');return false">ðŸ“„ Bulk Rename</a>
      <a class="nav-link" href="#" onclick="nav('pageApp');return false">ðŸ” OCR Rename</a>
      <a class="nav-link" href="#" onclick="nav('pageApp');return false">ðŸ‘ï¸ File Preview</a>
      <a class="nav-link" href="#" onclick="nav('pageMagicFolders');return false">ðŸ“‹ Templates</a>
      <a class="nav-link" href="#" onclick="nav('pageDashboard');loadUserDashboard();return false">ðŸ“Š Dashboard</a>
      ${App.isGodMode ? '<a class="nav-link god-link" href="#" onclick="nav(\'pageGodMode\');loadGodDashboard();return false">ðŸ‘‘ God Mode</a>' : ''}`;
    
    // Build avatar dropdown menu based on plan tier - New structured design
    let menuItems = `
      <!-- My Account Section -->
      <div class="user-menu-section">
        <div class="user-menu-section-label">My Account</div>
        <div class="user-menu-item" onclick="nav('pageProfile');loadProfile();closeUserMenu()">ðŸ‘¤ My Account</div>
        <div class="user-menu-item" onclick="nav('pageApiKeys');loadApiKeysPage();closeUserMenu()">ðŸ”‘ API Keys</div>
        <div class="user-menu-item" onclick="nav('pageApiDashboard');loadApiDashboard();closeUserMenu()">ðŸ“Š API Key Dashboard</div>
        <div class="user-menu-item" onclick="openSettingsModal();closeUserMenu()">âš™ï¸ Settings</div>
      </div>
      
      <!-- Renaming Options Section -->
      <div class="user-menu-divider"></div>
      <div class="user-menu-section">
        <div class="user-menu-section-label">Renaming Options</div>
        <div class="user-menu-item" onclick="nav('pageApp');closeUserMenu()">ðŸ“„ Bulk Rename</div>
        <div class="user-menu-item" onclick="nav('pageMagicFolders');closeUserMenu()">ðŸ“ Magic Folders</div>
        <div class="user-menu-item" onclick="nav('pageApp');switchTab('tabTemplates');closeUserMenu()">ðŸ“‹ Renaming Templates</div>
      </div>
      
      <!-- Activity Section -->
      <div class="user-menu-divider"></div>
      <div class="user-menu-section">
        <div class="user-menu-section-label">Activity</div>
        <div class="user-menu-item" onclick="viewHistory();closeUserMenu()">ðŸ• History</div>
      </div>`;
    
    // Admin Controls section - Only for God Mode
    if (App.isGodMode) {
      menuItems += `
        <div class="user-menu-divider"></div>
        <div class="user-menu-admin">
          <div class="user-menu-section-label" style="color:var(--orange)">Admin Controls</div>
          <div class="user-menu-item" onclick="nav('pageApiSettings');loadApiSettings();closeUserMenu()">ðŸ”‘ API Key Management</div>
          <div class="user-menu-item" onclick="nav('pageSystemStatus');loadSystemStatus();closeUserMenu()">ðŸ“ˆ System Status</div>
          <div class="user-menu-item" onclick="nav('pageAutoTesting');loadAutoTesting();closeUserMenu()">ðŸ”„ Auto Testing</div>
          <div class="user-menu-item" onclick="nav('pageBackupRestore');loadBackupRestore();closeUserMenu()">â˜ï¸ Backup & Restore</div>
          <div class="user-menu-item" onclick="nav('pageDbManagement');loadDbManagement();closeUserMenu()">ðŸ—„ï¸ DB Management</div>
        </div>`;
    }
    
    // Sign out
    menuItems += `
      <div class="user-menu-divider"></div>
      <div class="user-menu-item danger" onclick="logout()">ðŸšª Log out</div>`;
    
    navRight.innerHTML = `
      <div class="nav-plan-badge ${plan} ${isPaygo ? 'paygo-badge' : ''}">${planBadgeContent}</div>
      <div class="user-menu-container">
        <div class="user-avatar" onclick="toggleUserMenu()">
          ${user?.avatar ? `<img src="${escapeHtml(user.avatar)}" alt="">` : initials}
        </div>
        <div class="user-menu" id="userMenu">
          <div class="user-menu-header">
            <div class="user-menu-name">${escapeHtml(user?.firstName || '')} ${escapeHtml(user?.lastName || '')}</div>
            <div class="user-menu-email">${escapeHtml(user?.email || '')}</div>
          </div>
          <div class="user-menu-stats">
            <div class="user-menu-stats-item">
              <span>Plan</span>
              <span class="user-menu-plan ${plan}">${isPaygo ? 'Pay-as-you-go' : plan.charAt(0).toUpperCase() + plan.slice(1)}</span>
            </div>
            ${isPaygo ? `
            <div class="user-menu-stats-item">
              <span>Credits Remaining</span>
              <span class="credits-display">${credits}</span>
            </div>
            <div class="user-menu-stats-item">
              <button class="btn btn-sm btn-primary" onclick="openCreditsPurchaseModal();closeUserMenu()">+ Buy Credits</button>
            </div>` : `
            <div class="user-menu-stats-item">
              <span>Files This Month</span>
              <span>${user?.filesUsedThisMonth || 0}/${PLAN_LIMITS[plan]?.files === 999999 ? 'âˆž' : PLAN_LIMITS[plan]?.files || 'âˆž'}</span>
            </div>`}
          </div>
          <div class="user-menu-items">
            ${menuItems}
          </div>
        </div>
      </div>`;
    
    // Update usage display
    updateUsageDisplay();
    updateModelDropdowns();
    
    // Show/hide plan switcher for God Mode testing
    if ($('planSwitcherSection')) {
      $('planSwitcherSection').style.display = App.isGodMode ? 'block' : 'none';
    }
  }
}

function closeUserMenu() {
  const menu = $('userMenu');
  if (menu) menu.classList.remove('open');
}

function toggleUserMenu() {
  const menu = $('userMenu');
  if (menu) menu.classList.toggle('open');
}

// Close menu when clicking outside
document.addEventListener('click', (e) => {
  if (!e.target.closest('.user-menu-container')) {
    document.querySelectorAll('.user-menu').forEach(m => m.classList.remove('open'));
  }
});

// ============ AUTH ============
function showAuthModal(tab = 'login') {
  $('authModal').classList.add('active');
  switchAuthTab(tab);
}

function closeAuthModal() {
  $('authModal').classList.remove('active');
}

function togglePasswordVisibility(inputId, button) {
  const input = $(inputId);
  if (!input) return;
  
  const isPassword = input.type === 'password';
  input.type = isPassword ? 'text' : 'password';
  
  const eyeOpen = button.querySelector('.eye-open');
  const eyeClosed = button.querySelector('.eye-closed');
  if (eyeOpen) eyeOpen.style.display = isPassword ? 'none' : 'block';
  if (eyeClosed) eyeClosed.style.display = isPassword ? 'block' : 'none';
}

// Close auth modal on ESC key or click outside
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    closeAuthModal();
    closeSettingsModal();
    closeUpgradeModal();
  }
});

$('authModal')?.addEventListener('click', (e) => {
  if (e.target.id === 'authModal') closeAuthModal();
});

function switchAuthTab(tab) {
  $('tabLogin').classList.toggle('active', tab === 'login');
  $('tabRegister').classList.toggle('active', tab === 'register');
  $('tabForgot').classList.toggle('active', tab === 'forgot' || tab === 'reset');
  $('authFormLogin').style.display = tab === 'login' ? 'block' : 'none';
  $('authFormRegister').style.display = tab === 'register' ? 'block' : 'none';
  $('authFormForgot').style.display = tab === 'forgot' ? 'block' : 'none';
  $('authFormReset').style.display = tab === 'reset' ? 'block' : 'none';
}

async function login() {
  const email = $('loginEmail')?.value?.trim();
  const password = $('loginPassword')?.value;
  
  if (!email || !password) {
    toast('Error', 'Please enter email and password', 'error');
    return;
  }
  
  try {
    const data = await apiCall('/auth/login', 'POST', { email, password });
    App.token = data.token;
    App.currentUser = data.user;
    App.isLoggedIn = true;
    App.isGodMode = data.user.isGod === true;
    
    console.log('Login success:', data.user.email, 'Plan:', data.user.plan, 'isGod:', data.user.isGod);
    
    DB.set('token', App.token);
    DB.set('user', App.currentUser);
    
    closeAuthModal();
    updateNav();
    nav('pageApp');
    updateTopNavigation();
    toast('Welcome back!', `Signed in as ${data.user.email} (${data.user.plan})`, 'success');
  } catch (err) {
    toast('Login Failed', err.message, 'error');
  }
}

async function register() {
  const email = $('registerEmail')?.value?.trim();
  const password = $('registerPassword')?.value;
  
  if (!email || !password) {
    toast('Error', 'Please enter email and password', 'error');
    return;
  }
  
  try {
    const data = await apiCall('/auth/register', 'POST', { email, password });
    App.token = data.token;
    App.currentUser = data.user;
    App.isLoggedIn = true;
    App.isGodMode = data.user.isGod;
    
    DB.set('token', App.token);
    DB.set('user', App.currentUser);
    
    closeAuthModal();
    nav('pageApp');
    updateNav();
    updateTopNavigation();
    toast('Welcome!', 'Account created successfully', 'success');
  } catch (err) {
    toast('Registration Failed', err.message, 'error');
  }
}

function googleLogin() {
  window.location.href = `${App.API_URL}/auth/google`;
}

function logout() {
  App.currentUser = null;
  App.isLoggedIn = false;
  App.isGodMode = false;
  App.token = null;
  DB.remove('user');
  DB.remove('token');
  nav('pageLanding');
  updateNav();
  toast('Signed Out', 'You have been signed out', 'success');
}

// ============ PASSWORD RESET ============
let resetToken = null;

async function sendResetEmail() {
  const email = $('forgotEmail')?.value?.trim();
  if (!email) {
    toast('Error', 'Please enter your email', 'error');
    return;
  }
  
  try {
    const data = await apiCall('/auth/forgot-password', 'POST', { email });
    toast('Email Sent', 'Check your inbox for the reset link', 'success');
    // For development, show the token if provided
    if (data.devToken) {
      resetToken = data.devToken;
      switchAuthTab('reset');
    }
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function resetPassword() {
  const newPassword = $('resetNewPassword')?.value;
  const confirmPassword = $('resetConfirmPassword')?.value;
  
  if (!newPassword || !confirmPassword) {
    toast('Error', 'Please fill in all fields', 'error');
    return;
  }
  if (newPassword !== confirmPassword) {
    toast('Error', 'Passwords do not match', 'error');
    return;
  }
  if (newPassword.length < 8) {
    toast('Error', 'Password must be at least 8 characters', 'error');
    return;
  }
  
  // Get token from URL or stored value
  const urlParams = new URLSearchParams(window.location.search);
  const token = urlParams.get('token') || resetToken;
  
  if (!token) {
    toast('Error', 'Invalid reset link', 'error');
    return;
  }
  
  try {
    await apiCall('/auth/reset-password', 'POST', { token, newPassword });
    toast('Success', 'Password reset successfully. Please sign in.', 'success');
    resetToken = null;
    window.history.replaceState({}, '', window.location.pathname);
    switchAuthTab('login');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// ============ PROFILE FUNCTIONS ============
function loadProfile() {
  const user = App.currentUser;
  if (!user) return;
  
  $('profileFirstName').value = user.firstName || '';
  $('profileLastName').value = user.lastName || '';
  $('profileEmail').value = user.email || '';
  
  // Set avatar
  const initials = ((user.firstName || '')[0] || '') + ((user.lastName || '')[0] || '') || (user.email?.[0]?.toUpperCase() || 'U');
  $('profileAvatarInitials').textContent = initials;
  
  if (user.avatar) {
    $('profileAvatarImg').src = user.avatar;
    $('profileAvatarImg').style.display = 'block';
    $('profileAvatarInitials').style.display = 'none';
  } else {
    $('profileAvatarImg').style.display = 'none';
    $('profileAvatarInitials').style.display = 'block';
  }
  
  // Show appropriate password section
  if (!user.password && user.googleId) {
    $('passwordSection').style.display = 'none';
    $('oauthPasswordNotice').style.display = 'block';
  } else {
    $('passwordSection').style.display = 'block';
    $('oauthPasswordNotice').style.display = 'none';
  }
}

async function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  if (file.size > 2 * 1024 * 1024) {
    toast('Error', 'Image must be less than 2MB', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('avatar', file);
  
  try {
    const response = await fetch(`${App.API_URL}/profile/avatar`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${App.token}` },
      body: formData
    });
    const data = await response.json();
    
    if (!response.ok) throw new Error(data.error);
    
    App.currentUser.avatar = data.avatar;
    DB.set('user', App.currentUser);
    loadProfile();
    updateNav();
    toast('Success', 'Avatar updated', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function removeAvatar() {
  try {
    await apiCall('/profile', 'PUT', { avatar: null });
    App.currentUser.avatar = null;
    DB.set('user', App.currentUser);
    loadProfile();
    updateNav();
    toast('Success', 'Avatar removed', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function saveProfile() {
  const firstName = $('profileFirstName')?.value?.trim();
  const lastName = $('profileLastName')?.value?.trim();
  
  try {
    const data = await apiCall('/profile', 'PUT', { firstName, lastName });
    App.currentUser.firstName = data.firstName;
    App.currentUser.lastName = data.lastName;
    DB.set('user', App.currentUser);
    updateNav();
    toast('Success', 'Profile updated', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function changePassword() {
  const currentPassword = $('currentPassword')?.value;
  const newPassword = $('newPassword')?.value;
  const confirmNewPassword = $('confirmNewPassword')?.value;
  
  if (!currentPassword || !newPassword || !confirmNewPassword) {
    toast('Error', 'Please fill in all fields', 'error');
    return;
  }
  if (newPassword !== confirmNewPassword) {
    toast('Error', 'New passwords do not match', 'error');
    return;
  }
  if (newPassword.length < 8) {
    toast('Error', 'Password must be at least 8 characters', 'error');
    return;
  }
  
  try {
    await apiCall('/profile/password', 'PUT', { currentPassword, newPassword });
    $('currentPassword').value = '';
    $('newPassword').value = '';
    $('confirmNewPassword').value = '';
    toast('Success', 'Password changed successfully', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function setPassword() {
  const newPassword = $('setNewPassword')?.value;
  
  if (!newPassword) {
    toast('Error', 'Please enter a password', 'error');
    return;
  }
  if (newPassword.length < 8) {
    toast('Error', 'Password must be at least 8 characters', 'error');
    return;
  }
  
  try {
    await apiCall('/profile/password', 'PUT', { currentPassword: '', newPassword });
    $('setNewPassword').value = '';
    toast('Success', 'Password set successfully', 'success');
    loadProfile();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function confirmDeleteAccount() {
  if (confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
    toast('Info', 'Account deletion is not yet implemented', 'error');
  }
}

// ============ USER DASHBOARD ============
async function loadUserDashboard() {
  try {
    const data = await apiCall('/dashboard');
    
    // Plan info
    $('dashboardPlan').textContent = data.plan.name;
    $('dashboardPlan').className = '';
    $('dashboardPlan').style.color = data.plan.id === 'god' ? '#ef4444' : 'var(--orange)';
    $('dashboardSpeed').textContent = `${data.plan.speed.charAt(0).toUpperCase() + data.plan.speed.slice(1)} Speed`;
    
    // Usage - handle both credit-based and subscription plans
    if (data.plan.creditBased) {
      $('dashboardFilesUsed').textContent = `${data.usage.credits} credits`;
      $('dashboardFilesProgress').style.width = '0%';
    } else {
      const filesLimit = data.plan.filesPerMonth === 999999 ? 'âˆž' : data.plan.filesPerMonth;
      $('dashboardFilesUsed').textContent = `${data.usage.filesUsedThisMonth} / ${filesLimit}`;
      const progressPercent = data.plan.filesPerMonth === 999999 ? 0 : (data.usage.filesUsedThisMonth / data.plan.filesPerMonth) * 100;
      $('dashboardFilesProgress').style.width = `${Math.min(progressPercent, 100)}%`;
    }
    $('dashboardTotalFiles').textContent = data.usage.totalFilesProcessed;
    
    // Cost
    $('dashboardCost').textContent = `$${data.costs.totalEstimatedCost}`;
    $('costOcr').textContent = `$${(data.costs.breakdown.ocr || 0).toFixed(4)}`;
    $('costVision').textContent = `$${(data.costs.breakdown.vision || 0).toFixed(4)}`;
    $('costAudio').textContent = `$${(data.costs.breakdown.audio || 0).toFixed(4)}`;
    $('costText').textContent = `$${(data.costs.breakdown.text || 0).toFixed(4)}`;
    
    // Productivity metrics
    if ($('productivityHours')) {
      $('productivityHours').textContent = data.productivity?.timeSavedFormatted || '0 minutes';
    }
    if ($('productivityDuplicates')) {
      $('productivityDuplicates').textContent = data.productivity?.duplicatesFound || 0;
    }
    if ($('productivityStorage')) {
      $('productivityStorage').textContent = data.productivity?.storageReclaimedFormatted || '0 MB';
    }
    if ($('productivityAvgTime')) {
      $('productivityAvgTime').textContent = `${data.productivity?.avgProcessingTime || 0}ms`;
    }
    
    // Weekly activity chart
    if ($('weeklyChart') && data.activity?.weekly) {
      renderWeeklyChart(data.activity.weekly);
    }
    
    // Files by type
    if ($('filesByType') && data.filesByType) {
      const sortedTypes = Object.entries(data.filesByType).sort((a, b) => b[1] - a[1]).slice(0, 8);
      $('filesByType').innerHTML = sortedTypes.map(([ext, count]) => `
        <div style="display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--border)">
          <span style="text-transform:uppercase;font-weight:500">.${ext}</span>
          <span style="color:var(--text-muted)">${count} files</span>
        </div>
      `).join('') || '<p style="color:var(--text-muted)">No files processed yet</p>';
    }
    
    // Features
    const featureNames = {
      ocr: 'OCR', vision: 'Vision', magicFolders: 'Magic Folders', cloudSync: 'Cloud Sync',
      handwriting: 'Handwriting', watchAgents: 'Watch Agents', audioTranscription: 'Audio',
      teamWorkspaces: 'Teams', apiAccess: 'API', customInstructions: 'Custom Instructions',
      priorityProcessing: 'Priority', vaultProcessing: 'Vault',
      tableRecognition: 'Tables', documentUnderstanding: 'Doc Analysis', formulaRecognition: 'Formulas'
    };
    
    let featuresHtml = '';
    for (const [key, value] of Object.entries(data.plan.features)) {
      if (value && value !== 'none' && value !== false && featureNames[key]) {
        const displayValue = typeof value === 'string' && value !== 'full' && value !== 'basic' ? ` (${value})` : '';
        featuresHtml += `<span style="background:var(--elevated);padding:4px 10px;border-radius:6px;font-size:0.85rem">${featureNames[key]}${displayValue}</span>`;
      }
    }
    $('dashboardFeatures').innerHTML = featuresHtml || '<span style="color:var(--text-muted)">Basic features only</span>';
    
    // Recent activity with enhanced display
    if (data.history && data.history.length > 0) {
      let activityHtml = '';
      data.history.slice(0, 5).forEach(batch => {
        const date = new Date(batch.timestamp).toLocaleDateString();
        const time = new Date(batch.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const count = batch.files?.length || batch.results?.length || 0;
        const undone = batch.undoneAt ? '<span style="color:var(--yellow);font-size:0.8rem;margin-left:8px">â†©ï¸ Undone</span>' : '';
        activityHtml += `<div style="padding:12px 0;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:500">${count} files processed ${undone}</div>
            <div style="color:var(--text-muted);font-size:0.85rem">${date} at ${time}</div>
          </div>
          ${batch.canUndo && !batch.undoneAt ? `<button class="btn btn-ghost btn-sm" onclick="undoBatch(${batch.id})">Undo</button>` : ''}
        </div>`;
      });
      $('dashboardActivity').innerHTML = activityHtml;
    }
    
  } catch (err) {
    toast('Error', 'Failed to load dashboard', 'error');
  }
}

function renderWeeklyChart(weeklyData) {
  const maxFiles = Math.max(...weeklyData.map(d => d.files), 1);
  const chartHtml = weeklyData.map(d => {
    const height = Math.max((d.files / maxFiles) * 100, 4);
    return `
      <div style="display:flex;flex-direction:column;align-items:center;flex:1">
        <div style="flex:1;width:100%;display:flex;align-items:flex-end;justify-content:center;min-height:80px">
          <div style="width:70%;background:var(--orange);border-radius:4px 4px 0 0;height:${height}%;min-height:4px" title="${d.files} files"></div>
        </div>
        <div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px">${d.day}</div>
        <div style="font-size:0.7rem;color:var(--text-sec)">${d.files}</div>
      </div>
    `;
  }).join('');
  
  $('weeklyChart').innerHTML = chartHtml;
}

// ============ BILLING ============
async function loadBillingPage() {
  const user = App.currentUser;
  if (!user) return;
  
  const plan = user.plan || 'free';
  const planNames = { free: 'Free', paygo: 'Pay-as-you-go', pro: 'Pro', business: 'Business', god: 'God Mode' };
  const planDetails = {
    free: '10 AI renames/month â€¢ Standard speed',
    paygo: `${user.credits || 0} credits remaining â€¢ Fast speed`,
    pro: '500 files/month â€¢ Fast speed',
    business: '5,000 files/month â€¢ Instant speed',
    god: 'Unlimited files â€¢ Instant speed'
  };
  
  $('billingCurrentPlan').textContent = planNames[plan];
  $('billingPlanDetails').textContent = planDetails[plan];
  
  // Update plan buttons
  ['free', 'pro', 'business'].forEach(p => {
    const btn = $(`btnPlan${p.charAt(0).toUpperCase() + p.slice(1)}`);
    if (btn) {
      if (p === plan) {
        btn.textContent = 'Current Plan';
        btn.disabled = true;
        btn.className = 'btn btn-outline';
      } else if (['free', 'pro', 'business'].indexOf(p) < ['free', 'pro', 'business'].indexOf(plan)) {
        btn.textContent = 'Downgrade';
        btn.disabled = false;
        btn.className = 'btn btn-secondary';
      } else {
        btn.textContent = `Upgrade to ${planNames[p]}`;
        btn.disabled = false;
        btn.className = p === 'pro' ? 'btn btn-primary' : 'btn btn-secondary';
      }
    }
  });
  
  // Show manage button for paid plans
  $('billingManageBtn').style.display = user.stripeCustomerId ? 'block' : 'none';
  
  // Show credits section for paygo users
  const creditsSection = $('billingCreditsSection');
  if (creditsSection) {
    creditsSection.style.display = plan === 'paygo' ? 'block' : 'none';
  }
}

async function subscribeToPlan(planId) {
  try {
    const data = await apiCall('/billing/create-checkout', 'POST', { planId });
    if (data.url) {
      window.location.href = data.url;
    }
  } catch (err) {
    toast('Error', err.message || 'Failed to start checkout', 'error');
  }
}

async function openBillingPortal() {
  try {
    const data = await apiCall('/billing/portal', 'POST');
    if (data.url) {
      window.location.href = data.url;
    }
  } catch (err) {
    toast('Error', err.message || 'Failed to open billing portal', 'error');
  }
}

// ============ CREDITS / PAY-AS-YOU-GO ============
const CREDIT_PRICING = {
  100: 5, 200: 10, 300: 15, 400: 20, 500: 25,
  600: 30, 700: 35, 800: 40, 900: 45, 1000: 50
};

function updateCreditSliderLanding(value) {
  const credits = parseInt(value);
  const price = CREDIT_PRICING[credits];
  const amountEl = $('creditAmountLanding');
  const priceEl = $('creditPriceLanding');
  if (amountEl) amountEl.textContent = `${credits} credits`;
  if (priceEl) priceEl.textContent = `$${price}`;
}

function updateCreditSliderModal(value) {
  const credits = parseInt(value);
  const price = CREDIT_PRICING[credits];
  const amountEl = $('creditAmountModal');
  const priceEl = $('creditPriceModal');
  if (amountEl) amountEl.textContent = `${credits} credits`;
  if (priceEl) priceEl.textContent = `$${price}`;
}

function openCreditsPurchaseModal() {
  const modalHtml = `
    <div class="modal-overlay" id="creditsPurchaseModal" onclick="if(event.target===this)closeCreditsPurchaseModal()">
      <div class="modal" style="max-width:500px">
        <div class="modal-header">
          <h2>ðŸ’³ Purchase Credits</h2>
          <button class="modal-close" onclick="closeCreditsPurchaseModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <p style="color:var(--text-sec);margin-bottom:24px">Buy credits for AI-powered file renaming. 1 credit = 1 file rename.</p>
          
          <div style="background:var(--elevated);border-radius:12px;padding:24px;margin-bottom:24px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
              <span style="font-size:1.25rem;font-weight:600" id="creditAmountModal">100 credits</span>
              <span style="font-size:2rem;font-weight:700;color:var(--orange)" id="creditPriceModal">$5</span>
            </div>
            <input type="range" id="creditSliderModal" min="100" max="1000" step="100" value="100" 
              style="width:100%;accent-color:var(--orange);height:8px;cursor:pointer"
              oninput="updateCreditSliderModal(this.value)">
            <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:var(--text-muted);margin-top:8px">
              <span>$5</span>
              <span>$25</span>
              <span>$50</span>
            </div>
          </div>
          
          <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:16px;margin-bottom:24px">
            <div style="display:flex;justify-content:space-between;margin-bottom:8px">
              <span>Current Balance:</span>
              <span style="font-weight:600">${App.currentUser?.credits || 0} credits</span>
            </div>
            <div style="display:flex;justify-content:space-between">
              <span>After Purchase:</span>
              <span style="font-weight:600;color:var(--green)" id="creditsAfterPurchase">${(App.currentUser?.credits || 0) + 100} credits</span>
            </div>
          </div>
          
          <button class="btn btn-primary" style="width:100%" onclick="purchaseCredits()">
            Purchase Credits
          </button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
  
  // Update the after purchase display when slider changes
  const slider = $('creditSliderModal');
  slider.addEventListener('input', () => {
    const afterEl = $('creditsAfterPurchase');
    if (afterEl) {
      afterEl.textContent = `${(App.currentUser?.credits || 0) + parseInt(slider.value)} credits`;
    }
  });
}

function closeCreditsPurchaseModal() {
  const modal = $('creditsPurchaseModal');
  if (modal) modal.remove();
}

async function purchaseCredits() {
  const slider = $('creditSliderModal');
  const credits = slider ? parseInt(slider.value) : 100;
  
  try {
    const data = await apiCall('/billing/purchase-credits', 'POST', { credits });
    if (data.url) {
      window.location.href = data.url;
    }
  } catch (err) {
    toast('Error', err.message || 'Failed to start checkout', 'error');
  }
}

async function switchToPaygo() {
  try {
    const data = await apiCall('/billing/switch-to-paygo', 'POST');
    if (data.success) {
      App.currentUser.plan = 'paygo';
      App.currentUser.credits = data.credits;
      updateNav();
      toast('Success', 'Switched to Pay-as-you-go plan', 'success');
      openCreditsPurchaseModal();
    }
  } catch (err) {
    toast('Error', err.message || 'Failed to switch plan', 'error');
  }
}

async function loadUserCredits() {
  if (!App.isLoggedIn) return;
  try {
    const data = await apiCall('/billing/credits', 'GET');
    if (data.credits !== undefined) {
      App.currentUser.credits = data.credits;
      updateNav();
    }
  } catch (err) {
    console.log('Failed to load credits:', err);
  }
}

// ============ FILE HANDLING ============
function handleFileSelect(event) {
  const files = event.target.files;
  if (!files || files.length === 0) return;
  
  for (let i = 0; i < files.length; i++) {
    App.selectedFiles.push({
      id: Date.now() + i,
      file: files[i],
      originalName: files[i].name,
      newName: '',
      size: files[i].size,
      type: files[i].type,
      selected: true,
      processed: false
    });
  }
  
  renderFileList();
  $('selectedFilesSection').style.display = 'block';
  toast('Files Added', `${files.length} file(s) ready to process`, 'success');
}

function renderFileList() {
  const list = $('fileList');
  list.innerHTML = App.selectedFiles.map(f => `
    <div class="file-item">
      <input type="checkbox" ${f.selected ? 'checked' : ''} onchange="toggleFileSelect(${f.id})">
      <div class="file-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      </div>
      <div class="file-info">
        <div class="file-name">${escapeHtml(f.originalName)}</div>
        <div class="file-size">${formatBytes(f.size)}</div>
      </div>
      <button class="file-remove" onclick="removeFile(${f.id})">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>`).join('');
  updateFileCounts();
}

function toggleFileSelect(id) {
  const file = App.selectedFiles.find(f => f.id === id);
  if (file) file.selected = !file.selected;
  updateFileCounts();
}

function updateFileCounts() {
  const total = App.selectedFiles.length;
  const selected = App.selectedFiles.filter(f => f.selected).length;
  $('fileCount').textContent = total;
  $('selectedCount').textContent = selected;
  $('renameCount').textContent = selected;
}

function removeFile(id) {
  App.selectedFiles = App.selectedFiles.filter(f => f.id !== id);
  renderFileList();
  if (App.selectedFiles.length === 0) $('selectedFilesSection').style.display = 'none';
}

function clearAllFiles() {
  App.selectedFiles = [];
  App.processedFiles = [];
  $('selectedFilesSection').style.display = 'none';
  $('resultsSection').style.display = 'none';
}

function deleteSelected() {
  App.selectedFiles = App.selectedFiles.filter(f => !f.selected);
  renderFileList();
  if (App.selectedFiles.length === 0) $('selectedFilesSection').style.display = 'none';
}

// ============ FILE PROCESSING ============
async function processFiles() {
  const filesToProcess = App.selectedFiles.filter(f => f.selected);
  if (filesToProcess.length === 0) {
    toast('Error', 'No files selected', 'error');
    return;
  }
  
  const btn = $('renameBtn');
  btn.disabled = true;
  btn.innerHTML = '<svg class="spin" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg> Processing...';
  
  try {
    const formData = new FormData();
    filesToProcess.forEach(f => formData.append('files', f.file));
    formData.append('textModel', $('textModelSelect')?.value || '');
    formData.append('imageModel', $('imageModelSelect')?.value || '');
    
    const response = await fetch(`${App.API_URL}/files/process`, {
      method: 'POST',
      headers: App.token ? { 'Authorization': `Bearer ${App.token}` } : {},
      body: formData
    });
    
    const data = await response.json();
    
    if (!response.ok) {
      if (data.upgrade) showUpgradeModal();
      throw new Error(data.error || 'Processing failed');
    }
    
    // Map results back to files
    data.results.forEach((result, i) => {
      if (filesToProcess[i]) {
        filesToProcess[i].newName = result.newName;
        filesToProcess[i].provider = result.provider;
        filesToProcess[i].contentProvider = result.contentProvider;
        filesToProcess[i].processed = true;
        filesToProcess[i].isDuplicate = result.isDuplicate;
        filesToProcess[i].failoverUsed = result.failoverUsed;
      }
    });
    
    App.processedFiles = filesToProcess;
    renderResults();
    
    // Update user stats
    if (App.currentUser) {
      App.currentUser.filesUsedThisMonth = (App.currentUser.filesUsedThisMonth || 0) + data.processed;
      DB.set('user', App.currentUser);
      updateUsageDisplay();
    }
    
    // Show warnings about failovers or API issues
    if (data.warnings && data.warnings.length > 0) {
      data.warnings.forEach(w => {
        toast('âš ï¸ API Alert', w.message, 'error');
      });
    }
    
    // Check for new alerts (God Mode only)
    if (App.isGodMode && data.hasAlerts) {
      showApiAlertBadge();
    }
    
    toast('Complete', `${data.processed} files processed! ${data.remaining} remaining this month.`, 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
  
  btn.disabled = false;
  btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg> Rename with AI';
}

// Show alert badge on API Keys tab for God Mode
function showApiAlertBadge() {
  const tabEl = document.querySelector('.god-tab[onclick*="apiKeys"]');
  if (tabEl && !tabEl.querySelector('.alert-badge')) {
    tabEl.innerHTML += '<span class="alert-badge" style="background:var(--red);color:white;font-size:0.7rem;padding:2px 6px;border-radius:10px;margin-left:6px">!</span>';
  }
}

function renderResults() {
  $('resultsSection').style.display = 'block';
  $('resultsBody').innerHTML = App.processedFiles.map(f => `
    <tr>
      <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis">${escapeHtml(f.originalName)}</td>
      <td><span class="new-name">${escapeHtml(f.newName)}</span></td>
      <td><span class="provider-badge">${escapeHtml(f.provider || 'AI')}</span>${f.contentProvider ? `<br><span class="provider-badge" style="margin-top:4px">${escapeHtml(f.contentProvider)}</span>` : ''}</td>
      <td><span class="status-ready"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>${f.isDuplicate ? 'Duplicate' : 'Ready'}</span></td>
      <td>
        <div class="action-btns">
          <button class="action-btn" onclick="regenerateFile(${f.id})" title="Regenerate"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg></button>
          <button class="action-btn" onclick="downloadFile(${f.id})" title="Download"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></button>
          <button class="action-btn danger" onclick="removeProcessedFile(${f.id})" title="Remove"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button>
        </div>
      </td>
    </tr>`).join('');
}

function downloadFile(id) {
  const file = App.processedFiles.find(f => f.id === id);
  if (!file || !file.file) return;
  
  const url = URL.createObjectURL(file.file);
  const a = document.createElement('a');
  a.href = url;
  a.download = file.newName;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function applyAllRenames() {
  App.processedFiles.forEach(f => downloadFile(f.id));
  toast('Downloads Started', `${App.processedFiles.length} files downloading`, 'success');
}

function removeProcessedFile(id) {
  App.processedFiles = App.processedFiles.filter(f => f.id !== id);
  renderResults();
  if (App.processedFiles.length === 0) $('resultsSection').style.display = 'none';
}

function clearResults() {
  App.processedFiles = [];
  $('resultsSection').style.display = 'none';
}

async function regenerateFile(id) {
  toast('Regenerating', 'Getting new AI suggestion...', 'success');
  // This would call the API again for a single file
}

// ============ MODEL DROPDOWNS ============
async function updateModelDropdowns() {
  if (!App.isLoggedIn) return;
  
  try {
    const data = await apiCall('/models');
    
    // Text models
    const textSelect = $('textModelSelect');
    if (textSelect) {
      textSelect.innerHTML = data.textModels.map(m => 
        `<option value="${m.id}">${m.name} (${m.provider})</option>`
      ).join('');
    }
    
    // Image models
    const imageSelect = $('imageModelSelect');
    const imageSection = $('imageModelSection');
    
    if (data.imageModels.length === 0) {
      if (imageSection) imageSection.style.display = 'none';
      if ($('imageModelLocked')) $('imageModelLocked').style.display = 'block';
    } else {
      if (imageSection) imageSection.style.display = 'block';
      if ($('imageModelLocked')) $('imageModelLocked').style.display = 'none';
      if (imageSelect) {
        imageSelect.innerHTML = data.imageModels.map(m => 
          `<option value="${m.id}">${m.name} (${m.provider})</option>`
        ).join('');
      }
    }
  } catch (err) {
    console.error('Failed to load models:', err);
  }
}

function updateUsageDisplay() {
  const plan = App.isGodMode ? App.testPlan : (App.currentUser?.plan || 'free');
  const limit = PLAN_LIMITS[plan].files;
  const used = App.currentUser?.filesUsedThisMonth || 0;
  const percent = limit === 999999 ? 0 : Math.min((used / limit) * 100, 100);
  
  if ($('usageCount')) $('usageCount').textContent = `${used}/${limit === 999999 ? 'âˆž' : limit}`;
  if ($('usageBar')) $('usageBar').style.width = `${percent}%`;
}

function switchTestPlan() {
  App.testPlan = $('testPlanSelect')?.value || 'god';
  updateModelDropdowns();
  updateUsageDisplay();
  updateNav();
  toast('Plan Switched', `Now testing as ${App.testPlan} plan`, 'success');
}

// ============ SETTINGS ============
function openSettingsModal() {
  $('settingsModal').classList.add('active');
  loadCustomInstructions();
  loadCloudConnections();
}

function closeSettingsModal() {
  $('settingsModal').classList.remove('active');
}

function switchSettingsTab(tab) {
  document.querySelectorAll('.settings-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  $('settingsGeneral').style.display = tab === 'general' ? 'block' : 'none';
  $('settingsInstructions').style.display = tab === 'instructions' ? 'block' : 'none';
  $('settingsConnections').style.display = tab === 'connections' ? 'block' : 'none';
  
  // Check if custom instructions are available (Pro+ feature)
  if (tab === 'instructions') {
    const plan = App.currentUser?.plan || 'free';
    const hasAccess = ['pro', 'business', 'god'].includes(plan);
    
    const instructionsEl = document.querySelector('.custom-instructions');
    if (instructionsEl) instructionsEl.style.display = hasAccess ? 'block' : 'none';
    if ($('instructionsLocked')) $('instructionsLocked').style.display = hasAccess ? 'none' : 'block';
  }
}

async function loadCustomInstructions() {
  try {
    const data = await apiCall('/user/custom-instructions');
    App.customInstructions = data;
    
    if ($('instTemplate')) $('instTemplate').value = data.template || '';
    if ($('instNamingStyle')) $('instNamingStyle').value = data.namingStyle || 'auto';
    if ($('instDateFormat')) $('instDateFormat').value = data.dateFormat || 'YYYY-MM-DD';
    if ($('instPrefix')) $('instPrefix').value = data.customPrefix || '';
    if ($('instSuffix')) $('instSuffix').value = data.customSuffix || '';
    if ($('instMaxLength')) {
      $('instMaxLength').value = data.maxLength || 100;
      $('lengthValue').textContent = data.maxLength || 100;
    }
    if ($('instCustomPrompt')) $('instCustomPrompt').value = data.customPrompt || '';
    
    // Set separator
    document.querySelectorAll('#instSeparator .radio-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.value === (data.separator || 'underscore'));
    });
    
    // Set date position
    document.querySelectorAll('#instDatePosition .radio-option').forEach(opt => {
      opt.classList.toggle('active', opt.dataset.value === (data.datePosition || 'prefix'));
    });

    // Show template preview if set
    if (data.template) {
      updateTemplatePreview(data.template);
    }
  } catch (err) {
    console.error('Failed to load custom instructions:', err);
  }
}

// Apply a naming template preset
function applyNamingTemplate(templateId) {
  const templates = {
    research: { dateFormat: 'YYYYMMDD', separator: 'underscore', datePosition: 'prefix', addVersion: true },
    financial: { dateFormat: 'YYYY-MM-DD', separator: 'underscore', datePosition: 'suffix', addVersion: true },
    design: { dateFormat: 'YYYYMMDD', separator: 'hyphen', datePosition: 'none', addVersion: false },
    medical: { dateFormat: 'YYYYMMDD', separator: 'underscore', datePosition: 'suffix', addVersion: false },
    agile: { dateFormat: 'YY.MM', separator: 'underscore', datePosition: 'none', addVersion: false },
    general: { dateFormat: 'YYYY-MM-DD', separator: 'underscore', datePosition: 'prefix', addVersion: true }
  };

  const template = templates[templateId];
  if (!template) {
    $('templatePreview').style.display = 'none';
    return;
  }

  // Apply template settings to form
  if ($('instDateFormat')) $('instDateFormat').value = template.dateFormat;
  
  // Set separator radio
  document.querySelectorAll('#instSeparator .radio-option').forEach(opt => {
    opt.classList.toggle('active', opt.dataset.value === template.separator);
  });
  
  // Set date position radio
  document.querySelectorAll('#instDatePosition .radio-option').forEach(opt => {
    opt.classList.toggle('active', opt.dataset.value === template.datePosition);
  });

  updateTemplatePreview(templateId);
}

function updateTemplatePreview(templateId) {
  const previews = {
    research: '20241202_ProjectName_ExperimentResults_v01.xlsx',
    financial: 'Invoice_ClientName_2024-12-02_v1.pdf',
    design: 'BrandX-Logo-Primary-1200x630.png',
    medical: 'PT00123_20241202_LabResults_DrSmith.pdf',
    agile: 'DevTeam_Sprint_24.12.1_FeatureUpdate.docx',
    general: '2024-12-02_Meeting_Notes_v01.docx'
  };

  const preview = previews[templateId];
  if (preview) {
    $('templatePreview').style.display = 'block';
    $('templatePreviewText').textContent = preview;
  } else {
    $('templatePreview').style.display = 'none';
  }
}

async function saveSettings() {
  // Get separator
  const separatorEl = document.querySelector('#instSeparator .radio-option.active');
  const separator = separatorEl?.dataset.value || 'underscore';
  
  // Get date position
  const datePositionEl = document.querySelector('#instDatePosition .radio-option.active');
  const datePosition = datePositionEl?.dataset.value || 'prefix';
  
  const instructions = {
    template: $('instTemplate')?.value || '',
    namingStyle: $('instNamingStyle')?.value || 'auto',
    separator,
    dateFormat: $('instDateFormat')?.value || 'YYYY-MM-DD',
    datePosition,
    customPrefix: $('instPrefix')?.value || '',
    customSuffix: $('instSuffix')?.value || '',
    maxLength: parseInt($('instMaxLength')?.value, 10) || 100,
    customPrompt: $('instCustomPrompt')?.value || '',
    outputLanguage: $('settingLanguage')?.value || 'en'
  };
  
  try {
    await apiCall('/user/custom-instructions', 'PUT', instructions);
    App.customInstructions = instructions;
    closeSettingsModal();
    toast('Settings Saved', 'Your preferences have been updated', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// Radio option click handlers
document.addEventListener('click', (e) => {
  const opt = e.target.closest('.radio-option');
  if (opt) {
    const group = opt.parentElement;
    group.querySelectorAll('.radio-option').forEach(o => o.classList.remove('active'));
    opt.classList.add('active');
  }
});

// ============ HISTORY ============
async function viewHistory() {
  try {
    const data = await apiCall('/history');
    
    // Build timeline modal
    const modalHtml = `
      <div class="modal-overlay" id="historyModal" onclick="if(event.target===this)closeHistoryModal()">
        <div class="modal" style="max-width:900px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
          <div class="modal-header">
            <h2>ðŸ“œ Rename History & Timeline</h2>
            <button class="modal-close" onclick="closeHistoryModal()">Ã—</button>
          </div>
          
          <!-- Filters -->
          <div style="padding:16px 24px;border-bottom:1px solid var(--border);display:flex;gap:12px;flex-wrap:wrap">
            <input type="date" id="historyStartDate" class="form-input" style="width:auto" onchange="filterHistory()">
            <input type="date" id="historyEndDate" class="form-input" style="width:auto" onchange="filterHistory()">
            <select id="historyActionType" class="form-select" style="width:auto" onchange="filterHistory()">
              <option value="all">All Actions</option>
              <option value="rename">Renames</option>
              <option value="magic-folder">Magic Folders</option>
              <option value="watch-agent">Watch Agents</option>
            </select>
            <input type="text" id="historySearch" class="form-input" placeholder="Search files..." style="flex:1;min-width:150px" oninput="filterHistory()">
            <button class="btn btn-secondary btn-sm" onclick="clearHistoryFilters()">Clear</button>
          </div>
          
          <!-- Timeline View -->
          <div class="modal-body" style="flex:1;overflow-y:auto;padding:0">
            <div id="historyTimeline" style="padding:24px">
              ${renderTimeline(data.timeline, data.history)}
            </div>
          </div>
          
          <!-- Bulk Actions -->
          <div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center">
            <div>
              <span id="historySelected" style="color:var(--text-muted)">0 batches selected</span>
            </div>
            <div style="display:flex;gap:12px">
              <button class="btn btn-secondary btn-sm" onclick="selectAllHistory()">Select All</button>
              <button class="btn btn-danger btn-sm" onclick="undoSelectedHistory()" id="undoSelectedBtn" disabled>Undo Selected</button>
            </div>
          </div>
        </div>
      </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    App.historyData = data;
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function renderTimeline(timeline, history) {
  if (!history || history.length === 0) {
    return '<p style="color:var(--text-muted);text-align:center;padding:40px">No rename history yet</p>';
  }
  
  const dates = Object.keys(timeline || {}).sort().reverse();
  
  if (dates.length === 0) {
    // Fallback to flat list
    return history.map(batch => renderBatchItem(batch)).join('');
  }
  
  return dates.map(date => {
    const batches = timeline[date];
    const dateObj = new Date(date);
    const formattedDate = dateObj.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
    const totalFiles = batches.reduce((sum, b) => sum + (b.files?.length || 0), 0);
    
    return `
      <div class="timeline-day" style="margin-bottom:24px">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px">
          <div style="width:12px;height:12px;background:var(--orange);border-radius:50%"></div>
          <h3 style="margin:0;font-size:1rem">${formattedDate}</h3>
          <span style="color:var(--text-muted);font-size:0.85rem">${totalFiles} files in ${batches.length} batches</span>
          <button class="btn btn-ghost btn-sm" onclick="undoDay('${date}')" style="margin-left:auto">Undo Day</button>
        </div>
        <div style="margin-left:24px;border-left:2px solid var(--border);padding-left:20px">
          ${batches.map(batch => renderBatchItem(batch)).join('')}
        </div>
      </div>
    `;
  }).join('');
}

function renderBatchItem(batch) {
  const time = new Date(batch.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
  const fileCount = batch.files?.length || 0;
  const canUndo = batch.canUndo && !batch.undoneAt;
  
  return `
    <div class="history-batch" style="background:var(--elevated);border-radius:12px;padding:16px;margin-bottom:12px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <input type="checkbox" class="history-checkbox" data-id="${batch.id}" ${canUndo ? '' : 'disabled'} onchange="updateHistorySelection()">
        <span style="color:var(--text-muted);font-size:0.85rem">${time}</span>
        <span style="background:var(--card);padding:4px 8px;border-radius:6px;font-size:0.8rem">${fileCount} files</span>
        ${batch.undoneAt ? '<span style="color:var(--yellow);font-size:0.8rem">â†©ï¸ Undone</span>' : ''}
        ${batch.folder ? `<span style="color:var(--text-muted);font-size:0.8rem;margin-left:auto">ðŸ“ ${batch.folder}</span>` : ''}
      </div>
      <div style="display:grid;gap:8px;font-size:0.9rem">
        ${(batch.files || []).slice(0, 5).map(f => `
          <div style="display:flex;align-items:center;gap:8px;padding:8px;background:var(--card);border-radius:8px">
            <span style="color:var(--text-muted);max-width:40%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(f.originalName)}</span>
            <span style="color:var(--orange)">â†’</span>
            <span style="color:var(--green);max-width:40%;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(f.newName)}</span>
          </div>
        `).join('')}
        ${fileCount > 5 ? `<div style="color:var(--text-muted);font-size:0.85rem;padding:4px">... and ${fileCount - 5} more files</div>` : ''}
      </div>
      ${canUndo ? `<button class="btn btn-ghost btn-sm" style="margin-top:12px" onclick="undoBatch(${batch.id})">â†©ï¸ Undo this batch</button>` : ''}
    </div>
  `;
}

function closeHistoryModal() {
  const modal = $('historyModal');
  if (modal) modal.remove();
}

async function filterHistory() {
  const startDate = $('historyStartDate')?.value;
  const endDate = $('historyEndDate')?.value;
  const actionType = $('historyActionType')?.value;
  const search = $('historySearch')?.value;
  
  try {
    const params = new URLSearchParams();
    if (startDate) params.append('startDate', startDate);
    if (endDate) params.append('endDate', endDate);
    if (actionType && actionType !== 'all') params.append('actionType', actionType);
    if (search) params.append('search', search);
    
    const data = await apiCall(`/history?${params.toString()}`);
    $('historyTimeline').innerHTML = renderTimeline(data.timeline, data.history);
    App.historyData = data;
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function clearHistoryFilters() {
  $('historyStartDate').value = '';
  $('historyEndDate').value = '';
  $('historyActionType').value = 'all';
  $('historySearch').value = '';
  filterHistory();
}

function updateHistorySelection() {
  const checkboxes = document.querySelectorAll('.history-checkbox:checked');
  $('historySelected').textContent = `${checkboxes.length} batches selected`;
  $('undoSelectedBtn').disabled = checkboxes.length === 0;
}

function selectAllHistory() {
  document.querySelectorAll('.history-checkbox:not(:disabled)').forEach(cb => cb.checked = true);
  updateHistorySelection();
}

async function undoBatch(batchId) {
  if (!confirm('Undo this batch? Files will be renamed back to their original names.')) return;
  try {
    await apiCall(`/history/undo/${batchId}`, 'POST');
    toast('Success', 'Batch undone successfully', 'success');
    filterHistory();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function undoSelectedHistory() {
  const checkboxes = document.querySelectorAll('.history-checkbox:checked');
  const batchIds = Array.from(checkboxes).map(cb => parseInt(cb.dataset.id));
  
  if (!confirm(`Undo ${batchIds.length} batches?`)) return;
  
  try {
    await apiCall('/history/undo-range', 'POST', { batchIds });
    toast('Success', `Undid ${batchIds.length} batches`, 'success');
    filterHistory();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function undoDay(date) {
  if (!confirm(`Undo all renames from ${date}?`)) return;
  try {
    const startDate = new Date(date);
    const endDate = new Date(date);
    endDate.setDate(endDate.getDate() + 1);
    
    await apiCall('/history/undo-range', 'POST', { 
      startDate: startDate.toISOString(), 
      endDate: endDate.toISOString() 
    });
    toast('Success', 'Day undone successfully', 'success');
    filterHistory();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// ============ MAGIC FOLDERS ============
function openMagicFolders() {
  nav('pageMagicFolders');
  loadMagicFolders();
}

async function loadMagicFolders() {
  try {
    const [folders, presets] = await Promise.all([
      apiCall('/magic-folders'),
      apiCall('/presets')
    ]);
    
    // Use existing list container or page container
    const container = $('magicFoldersListPage');
    if (!container) return;
    
    // Render presets and folders
    container.innerHTML = `
      <!-- Presets Section -->
      <div style="margin-bottom:32px;margin-top:24px">
        <h4 style="margin-bottom:16px;display:flex;align-items:center;gap:8px">
          <span>ðŸ“¦</span> Quick Start Presets
        </h4>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px">
          ${presets.presets.slice(0, 4).map(preset => `
            <div class="preset-card" style="background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.2s" onclick="showPresetDetails('${preset.id}')" onmouseover="this.style.borderColor='var(--orange)'" onmouseout="this.style.borderColor='var(--border)'">
              <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px">
                <span style="font-size:1.5rem">${preset.icon}</span>
                <div>
                  <div style="font-weight:600;font-size:0.95rem">${preset.name}</div>
                  <span style="font-size:0.75rem;color:var(--text-muted);text-transform:uppercase">${preset.category}</span>
                </div>
              </div>
              <p style="color:var(--text-sec);font-size:0.8rem;margin:0;line-height:1.4">${preset.description.substring(0, 60)}...</p>
            </div>
          `).join('')}
        </div>
        <button class="btn btn-ghost btn-sm" style="margin-top:12px" onclick="showAllPresets()">View All ${presets.presets.length} Presets â†’</button>
      </div>
      
      <!-- User's Magic Folders -->
      ${folders.length === 0 ? `
        <div style="text-align:center;padding:40px;background:var(--elevated);border-radius:16px;border:2px dashed var(--border)">
          <span style="font-size:3rem;display:block;margin-bottom:16px">ðŸ“</span>
          <h3 style="margin-bottom:8px">No Magic Folders Yet</h3>
          <p style="color:var(--text-sec);margin-bottom:24px">Create automated rules to organize your files, or start with a preset above</p>
          <button class="btn btn-primary" onclick="createMagicFolder()">Create Your First Folder</button>
        </div>
      ` : `
        <div style="display:grid;gap:16px">
          ${folders.map(folder => `
            <div class="magic-folder-item" style="background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:20px">
              <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px">
                <div>
                  <h4 style="margin:0 0 4px 0;display:flex;align-items:center;gap:8px">
                    <span>ðŸ“</span> ${escapeHtml(folder.name)}
                  </h4>
                  <span style="font-size:0.85rem;color:var(--text-muted)">${escapeHtml(folder.sourcePath || 'No path set')}</span>
                </div>
                <div style="display:flex;gap:8px;align-items:center">
                  <span class="status-badge" style="padding:4px 10px;border-radius:6px;font-size:0.75rem;font-weight:500;background:${folder.active ? 'rgba(34,197,94,0.15)' : 'rgba(107,114,128,0.15)'};color:${folder.active ? 'var(--green)' : 'var(--text-muted)'}">
                    ${folder.active ? 'â— Active' : 'â—‹ Paused'}
                  </span>
                  <button class="btn btn-ghost btn-sm" onclick="toggleMagicFolder(${folder.id}, ${!folder.active})">${folder.active ? 'Pause' : 'Resume'}</button>
                  <button class="btn btn-ghost btn-sm" onclick="deleteMagicFolder(${folder.id})">ðŸ—‘ï¸</button>
                </div>
              </div>
              <div style="display:flex;gap:16px;font-size:0.85rem;color:var(--text-sec);flex-wrap:wrap">
                <span>ðŸ“ ${escapeHtml(folder.namingPattern || 'Auto naming')}</span>
                <span>ðŸ“„ ${(folder.fileTypes || []).length > 0 ? folder.fileTypes.slice(0,4).join(', ') + (folder.fileTypes.length > 4 ? '...' : '') : 'All files'}</span>
                ${folder.presetId ? `<span style="color:var(--orange)">ðŸ“¦ ${folder.presetId}</span>` : ''}
              </div>
              ${folder.destinationRules?.length > 0 ? `
                <div style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border)">
                  <span style="font-size:0.8rem;color:var(--text-muted);display:block;margin-bottom:8px">${folder.destinationRules.length} routing rules:</span>
                  <div style="display:flex;flex-wrap:wrap;gap:8px">
                    ${folder.destinationRules.slice(0, 3).map(rule => `
                      <span style="font-size:0.8rem;background:var(--card);padding:4px 10px;border-radius:6px">
                        ${rule.match} â†’ ${(rule.folder || rule.rename || '').substring(0, 25)}
                      </span>
                    `).join('')}
                    ${folder.destinationRules.length > 3 ? `<span style="font-size:0.8rem;color:var(--text-muted)">+${folder.destinationRules.length - 3} more</span>` : ''}
                  </div>
                </div>
              ` : ''}
            </div>
          `).join('')}
        </div>
      `}
    `;
  } catch (err) {
    console.error('Load magic folders error:', err);
    toast('Error', err.message || 'Failed to load magic folders', 'error');
  }
}

async function toggleMagicFolder(id, active) {
  try {
    await apiCall(`/magic-folders/${id}`, 'PUT', { active });
    toast('Success', active ? 'Folder activated' : 'Folder paused', 'success');
    loadMagicFolders();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function showPresetDetails(presetId) {
  try {
    const preset = await apiCall(`/presets/${presetId}`);
    
    const modalHtml = `
      <div class="modal-overlay" id="presetModal" onclick="if(event.target===this)closePresetModal()">
        <div class="modal" style="max-width:700px">
          <div class="modal-header">
            <h2>${preset.icon} ${preset.name}</h2>
            <button class="modal-close" onclick="closePresetModal()">Ã—</button>
          </div>
          <div class="modal-body">
            <p style="color:var(--text-sec);margin-bottom:24px">${preset.description}</p>
            
            <div style="margin-bottom:24px">
              <h4 style="margin-bottom:12px">Naming Pattern</h4>
              <code style="display:block;background:var(--elevated);padding:12px;border-radius:8px">${preset.namingPattern}</code>
            </div>
            
            <div style="margin-bottom:24px">
              <h4 style="margin-bottom:12px">Auto-Routing Rules (${preset.rules.length})</h4>
              <div style="max-height:200px;overflow-y:auto">
                ${preset.rules.map(rule => `
                  <div style="background:var(--elevated);padding:12px;border-radius:8px;margin-bottom:8px;font-size:0.9rem">
                    <div><span style="color:var(--orange)">Match:</span> ${rule.match}</div>
                    <div><span style="color:var(--blue)">Rename:</span> ${rule.rename}</div>
                    <div><span style="color:var(--green)">Move to:</span> ${rule.folder}</div>
                  </div>
                `).join('')}
              </div>
            </div>
            
            <div style="margin-bottom:24px">
              <h4 style="margin-bottom:12px">Extracted Fields</h4>
              <div style="display:flex;flex-wrap:wrap;gap:8px">
                ${preset.extractFields.map(field => `
                  <span style="background:var(--elevated);padding:6px 12px;border-radius:6px;font-size:0.85rem">{${field}}</span>
                `).join('')}
              </div>
            </div>
            
            <div style="margin-bottom:24px">
              <label style="display:block;margin-bottom:8px">Source Folder Path</label>
              <input type="text" id="presetSourcePath" class="form-input" placeholder="/Users/you/Documents" value="">
            </div>
            
            <button class="btn btn-primary" style="width:100%" onclick="applyPreset('${presetId}')">
              Apply This Preset
            </button>
          </div>
        </div>
      </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function closePresetModal() {
  const modal = $('presetModal');
  if (modal) modal.remove();
}

async function applyPreset(presetId) {
  const sourcePath = $('presetSourcePath')?.value || '/Users/Documents';
  
  try {
    const result = await apiCall(`/presets/${presetId}/apply`, 'POST', { sourcePath });
    toast('Success', result.message, 'success');
    closePresetModal();
    loadMagicFolders();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function showAllPresets() {
  try {
    const data = await apiCall('/presets');
    
    const modalHtml = `
      <div class="modal-overlay" id="allPresetsModal" onclick="if(event.target===this)closeAllPresetsModal()">
        <div class="modal" style="max-width:900px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
          <div class="modal-header">
            <h2>ðŸ“¦ All Smart Presets</h2>
            <button class="modal-close" onclick="closeAllPresetsModal()">Ã—</button>
          </div>
          <div style="padding:16px 24px;border-bottom:1px solid var(--border);display:flex;gap:8px;flex-wrap:wrap">
            <button class="btn btn-sm preset-filter active" onclick="filterPresets('all', this)">All</button>
            ${data.categories.map(cat => `
              <button class="btn btn-sm btn-ghost preset-filter" onclick="filterPresets('${cat}', this)">${cat.charAt(0).toUpperCase() + cat.slice(1)}</button>
            `).join('')}
          </div>
          <div class="modal-body" style="flex:1;overflow-y:auto">
            <div id="presetsGrid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:16px">
              ${data.presets.map(preset => `
                <div class="preset-card" data-category="${preset.category}" style="background:var(--elevated);border:1px solid var(--border);border-radius:12px;padding:20px;cursor:pointer" onclick="closeAllPresetsModal();showPresetDetails('${preset.id}')">
                  <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
                    <span style="font-size:2rem">${preset.icon}</span>
                    <div>
                      <h4 style="margin:0">${preset.name}</h4>
                      <span style="font-size:0.8rem;color:var(--text-muted)">${preset.category}</span>
                    </div>
                  </div>
                  <p style="color:var(--text-sec);font-size:0.9rem;margin:0">${preset.description}</p>
                  <div style="margin-top:12px;font-size:0.8rem;color:var(--text-muted)">${preset.rules.length} rules â€¢ ${preset.extractFields.length} fields</div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      </div>`;
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function closeAllPresetsModal() {
  const modal = $('allPresetsModal');
  if (modal) modal.remove();
}

function filterPresets(category, btn) {
  document.querySelectorAll('.preset-filter').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  
  document.querySelectorAll('.preset-card').forEach(card => {
    if (category === 'all' || card.dataset.category === category) {
      card.style.display = 'block';
    } else {
      card.style.display = 'none';
    }
  });
}

function createMagicFolder() {
  const modalHtml = `
    <div class="modal-overlay" id="createFolderModal" onclick="if(event.target===this)closeCreateFolderModal()">
      <div class="modal" style="max-width:600px">
        <div class="modal-header">
          <h2>ðŸ“ Create Magic Folder</h2>
          <button class="modal-close" onclick="closeCreateFolderModal()">Ã—</button>
        </div>
        <div class="modal-body">
          <div style="margin-bottom:20px">
            <label style="display:block;margin-bottom:8px">Folder Name</label>
            <input type="text" id="newFolderName" class="form-input" placeholder="My Tax Documents">
          </div>
          
          <div style="margin-bottom:20px">
            <label style="display:block;margin-bottom:8px">Source Path</label>
            <input type="text" id="newFolderPath" class="form-input" placeholder="/Users/you/Downloads">
          </div>
          
          <div style="margin-bottom:20px">
            <label style="display:block;margin-bottom:8px">Naming Pattern</label>
            <input type="text" id="newFolderPattern" class="form-input" placeholder="{date}_{type}_{name}">
            <p style="font-size:0.8rem;color:var(--text-muted);margin-top:4px">Available: {date}, {type}, {name}, {ext}, {year}, {month}</p>
          </div>
          
          <div style="margin-bottom:20px">
            <label style="display:block;margin-bottom:8px">File Types (comma-separated, leave blank for all)</label>
            <input type="text" id="newFolderTypes" class="form-input" placeholder="pdf, jpg, png">
          </div>
          
          <div style="margin-bottom:20px;display:flex;gap:16px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="newFolderSubfolders" checked> Include subfolders
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="newFolderSkip" checked> Skip existing
            </label>
          </div>
          
          <button class="btn btn-primary" style="width:100%" onclick="saveMagicFolder()">Create Magic Folder</button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeCreateFolderModal() {
  const modal = $('createFolderModal');
  if (modal) modal.remove();
}

async function saveMagicFolder() {
  const name = $('newFolderName')?.value;
  const sourcePath = $('newFolderPath')?.value;
  const namingPattern = $('newFolderPattern')?.value;
  const fileTypes = $('newFolderTypes')?.value?.split(',').map(t => t.trim()).filter(Boolean) || [];
  const includeSubfolders = $('newFolderSubfolders')?.checked;
  const skipExisting = $('newFolderSkip')?.checked;
  
  if (!name || !sourcePath) {
    toast('Error', 'Name and source path are required', 'error');
    return;
  }
  
  try {
    await apiCall('/magic-folders', 'POST', {
      name, sourcePath, namingPattern, fileTypes, includeSubfolders, skipExisting
    });
    toast('Success', 'Magic folder created!', 'success');
    closeCreateFolderModal();
    loadMagicFolders();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function deleteMagicFolder(id) {
  if (!confirm('Delete this magic folder?')) return;
  try {
    await apiCall(`/magic-folders/${id}`, 'DELETE');
    toast('Success', 'Folder deleted', 'success');
    loadMagicFolders();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function editMagicFolder(id) {
  toast('Info', 'Edit functionality coming soon', 'success');
}

// ============ DUPLICATE DETECTION UI ============
async function scanForDuplicates(files) {
  try {
    const fileData = await Promise.all(files.map(async file => {
      const buffer = await file.arrayBuffer();
      const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
      const hashArray = Array.from(new Uint8Array(hashBuffer));
      const hash = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      
      return {
        name: file.name,
        size: file.size,
        hash: hash,
        type: file.type
      };
    }));
    
    const result = await apiCall('/duplicates/scan', 'POST', { files: fileData });
    
    if (result.clusters.length > 0) {
      showDuplicatesModal(result);
    } else {
      toast('No Duplicates', 'No duplicate files detected', 'success');
    }
    
    return result;
  } catch (err) {
    console.error('Duplicate scan error:', err);
    return null;
  }
}

function showDuplicatesModal(data) {
  const modalHtml = `
    <div class="modal-overlay" id="duplicatesModal" onclick="if(event.target===this)closeDuplicatesModal()">
      <div class="modal" style="max-width:800px;max-height:85vh;overflow:hidden;display:flex;flex-direction:column">
        <div class="modal-header">
          <h2>ðŸ” Duplicate Files Found</h2>
          <button class="modal-close" onclick="closeDuplicatesModal()">Ã—</button>
        </div>
        
        <!-- Summary -->
        <div style="padding:16px 24px;background:var(--elevated);border-bottom:1px solid var(--border)">
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;text-align:center">
            <div>
              <div style="font-size:1.5rem;font-weight:700;color:var(--orange)">${data.summary.totalClusters}</div>
              <div style="font-size:0.85rem;color:var(--text-muted)">Duplicate Groups</div>
            </div>
            <div>
              <div style="font-size:1.5rem;font-weight:700;color:var(--red)">${data.summary.exactDuplicates}</div>
              <div style="font-size:0.85rem;color:var(--text-muted)">Exact Matches</div>
            </div>
            <div>
              <div style="font-size:1.5rem;font-weight:700;color:var(--yellow)">${data.summary.similarFiles}</div>
              <div style="font-size:0.85rem;color:var(--text-muted)">Similar Files</div>
            </div>
            <div>
              <div style="font-size:1.5rem;font-weight:700;color:var(--green)">${formatBytes(data.summary.potentialSavings)}</div>
              <div style="font-size:0.85rem;color:var(--text-muted)">Potential Savings</div>
            </div>
          </div>
        </div>
        
        <!-- Clusters -->
        <div class="modal-body" style="flex:1;overflow-y:auto">
          ${data.clusters.map(cluster => `
            <div class="duplicate-cluster" style="background:var(--elevated);border-radius:12px;padding:20px;margin-bottom:16px;border:1px solid var(--border)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
                <div>
                  <span style="display:inline-block;padding:4px 8px;border-radius:4px;font-size:0.75rem;margin-right:8px;background:${cluster.type === 'exact' ? 'rgba(239,68,68,0.2);color:var(--red)' : cluster.type === 'similar_name' ? 'rgba(234,179,8,0.2);color:var(--yellow)' : 'rgba(59,130,246,0.2);color:var(--blue)'}">
                    ${cluster.type === 'exact' ? 'âš ï¸ Exact Match' : cluster.type === 'similar_name' ? 'ðŸ“ Similar Names' : 'ðŸ“Š Same Size'}
                  </span>
                  <span style="font-size:0.85rem;color:var(--text-muted)">${cluster.confidence}% confidence</span>
                </div>
                <span style="font-size:0.85rem;color:var(--text-muted)">${cluster.files.length} files</span>
              </div>
              
              <p style="font-size:0.9rem;color:var(--text-sec);margin-bottom:12px">${cluster.reason}</p>
              
              <div style="display:grid;gap:8px;margin-bottom:16px">
                ${cluster.files.map((file, idx) => `
                  <label style="display:flex;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:8px;cursor:pointer">
                    <input type="radio" name="keep-${cluster.id}" value="${idx}" ${idx === 0 ? 'checked' : ''}>
                    <div style="flex:1;min-width:0">
                      <div style="font-weight:500;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(file.name)}</div>
                      <div style="font-size:0.8rem;color:var(--text-muted)">${formatBytes(file.size)}</div>
                    </div>
                    ${idx === 0 ? '<span style="font-size:0.75rem;background:var(--green);color:white;padding:2px 8px;border-radius:4px">Recommended</span>' : ''}
                  </label>
                `).join('')}
              </div>
              
              <div style="display:flex;gap:8px">
                <button class="btn btn-sm btn-primary" onclick="resolveDuplicate('${cluster.id}', 'keep_one')">Keep Selected</button>
                <button class="btn btn-sm btn-secondary" onclick="resolveDuplicate('${cluster.id}', 'keep_all')">Keep All</button>
              </div>
            </div>
          `).join('')}
        </div>
        
        <div style="padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px">
          <button class="btn btn-secondary" onclick="closeDuplicatesModal()">Review Later</button>
          <button class="btn btn-primary" onclick="resolveAllDuplicates()">Apply All Recommendations</button>
        </div>
      </div>
    </div>`;
  
  document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeDuplicatesModal() {
  const modal = $('duplicatesModal');
  if (modal) modal.remove();
}

async function resolveDuplicate(clusterId, action) {
  const keepIdx = document.querySelector(`input[name="keep-${clusterId}"]:checked`)?.value;
  
  try {
    await apiCall(`/duplicates/${clusterId}/resolve`, 'POST', {
      action,
      keepIndex: keepIdx ? parseInt(keepIdx) : 0
    });
    toast('Success', 'Duplicate resolved', 'success');
    // Remove the cluster from the UI
    document.querySelector(`.duplicate-cluster`)?.remove();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function resolveAllDuplicates() {
  toast('Info', 'Applying recommendations...', 'success');
  closeDuplicatesModal();
}

function formatBytes(bytes) {
  if (!bytes || bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 'GB'];
  const i = Math.floor(Math.log(bytes) / Math.log(k));
  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// ============ ACTIVITY FEED ============
async function loadActivityFeed(days = 30) {
  try {
    const data = await apiCall(`/activity?days=${days}&limit=50`);
    return data;
  } catch (err) {
    console.error('Activity feed error:', err);
    return { activities: [] };
  }
}

// ============ UPGRADE ============
function showUpgradeModal() {
  $('upgradeModal').classList.add('active');
}

function closeUpgradeModal() {
  $('upgradeModal').classList.remove('active');
}

function upgradeTo(plan) {
  toast('Upgrade', `Stripe integration for ${plan} plan - Coming soon!`, 'success');
  closeUpgradeModal();
}

// ============ GOD MODE DASHBOARD ============
async function loadDashboard() {
  if (!App.isGodMode) return;
  
  try {
    const data = await apiCall('/admin/dashboard');
    
    $('statTotalUsers').textContent = data.users.total;
    $('statFilesMonth').textContent = data.files.thisMonth;
    $('statMagicFolders').textContent = data.magicFolders.active;
    $('statWatchAgents').textContent = data.watchAgents.active;
    
    // Plan breakdown
    $('planBreakdown').innerHTML = Object.entries(data.users.byPlan).map(([plan, count]) => `
      <div style="text-align:center">
        <div style="font-size:2rem;font-weight:700;color:var(--orange)">${count}</div>
        <div style="font-size:0.85rem;color:var(--text-muted)">${plan.charAt(0).toUpperCase() + plan.slice(1)}</div>
      </div>
    `).join('');
    
    // API Health
    const healthData = await apiCall('/api-keys/status');
    $('apiHealthGrid').innerHTML = Object.entries(healthData).map(([provider, status]) => `
      <div class="api-card">
        <div class="api-card-header">
          <div class="api-logo ${provider}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="10"/></svg>
          </div>
          <div class="api-info">
            <h3>${provider.charAt(0).toUpperCase() + provider.slice(1)}</h3>
          </div>
          <div class="api-status ${status.configured ? (status.status || 'online') : 'offline'}">
            <span class="status-dot"></span>
            <span>${status.configured ? (status.status || 'Online') : 'Not configured'}</span>
          </div>
        </div>
      </div>
    `).join('');
    
    // Load API keys
    loadApiKeysTab();
    loadUsersTab();
    
  } catch (err) {
    console.error('Dashboard error:', err);
    toast('Error', 'Failed to load dashboard', 'error');
  }
}

// Alias for loadDashboard
function loadGodDashboard() {
  loadDashboard();
}

async function loadApiKeysTab() {
  const providers = [
    { id: 'openai', name: 'OpenAI', desc: 'GPT-4, Vision, Whisper', logo: 'openai' },
    { id: 'anthropic', name: 'Anthropic', desc: 'Claude 3 Opus, Sonnet, Haiku', logo: 'anthropic' },
    { id: 'google', name: 'Google AI', desc: 'Gemini Pro, Vision', logo: 'google' },
    { id: 'openrouter', name: 'OpenRouter', desc: 'Llama, LLaVA, 100+ models', logo: 'openrouter' },
    { id: 'google-cloud-vision', name: 'Google Cloud Vision', desc: 'OCR, Document AI', logo: 'google' },
    { id: 'aws', name: 'AWS', desc: 'Textract, Transcribe, S3', logo: 'aws' },
    { id: 'azure', name: 'Azure', desc: 'Document Intelligence', logo: 'azure' },
    { id: 'stripe', name: 'Stripe', desc: 'Payments & Subscriptions', logo: 'stripe' }
  ];
  
  $('apiKeysGrid').innerHTML = providers.map(p => `
    <div class="api-card">
      <div class="api-card-header">
        <div class="api-logo ${p.logo}">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><circle cx="12" cy="12" r="8"/></svg>
        </div>
        <div class="api-info">
          <h3>${p.name}</h3>
          <p>${p.desc}</p>
        </div>
        <div class="api-status" id="status_${p.id}">
          <span class="status-dot"></span>
          <span>Checking...</span>
        </div>
      </div>
      <div class="api-card-body">
        <div class="api-input-group">
          <label>API Key</label>
          <div class="api-input-wrapper">
            <input type="password" id="apiKey_${p.id}" placeholder="Enter API key..." class="api-input">
            <button class="api-toggle-btn" onclick="toggleApiKeyVisibility('apiKey_${p.id}')">ðŸ‘</button>
          </div>
        </div>
        <div class="api-actions">
          <button class="btn btn-sm btn-secondary" onclick="testApiKey('${p.id}')">Test</button>
          <button class="btn btn-sm btn-primary" onclick="saveApiKey('${p.id}')">Save</button>
        </div>
      </div>
    </div>
  `).join('');
}

async function loadUsersTab() {
  try {
    const users = await apiCall('/admin/users');
    $('usersTableBody').innerHTML = users.map(u => `
      <tr>
        <td>${escapeHtml(u.email)}</td>
        <td>${escapeHtml(u.firstName || '')} ${escapeHtml(u.lastName || '')}</td>
        <td><span class="plan-badge ${u.plan}">${u.plan}</span></td>
        <td>${u.filesUsedThisMonth || 0}</td>
        <td>${new Date(u.createdAt).toLocaleDateString()}</td>
        <td>
          <select onchange="changeUserPlan(${u.id}, this.value)" style="padding:4px;background:var(--elevated);border:1px solid var(--border);border-radius:4px;color:var(--text)">
            <option value="free" ${u.plan === 'free' ? 'selected' : ''}>Free</option>
            <option value="pro" ${u.plan === 'pro' ? 'selected' : ''}>Pro</option>
            <option value="business" ${u.plan === 'business' ? 'selected' : ''}>Business</option>
            <option value="god" ${u.plan === 'god' ? 'selected' : ''}>God</option>
          </select>
        </td>
      </tr>
    `).join('');
  } catch (err) {
    console.error('Failed to load users:', err);
  }
}

async function changeUserPlan(userId, newPlan) {
  try {
    await apiCall(`/admin/users/${userId}/plan`, 'PUT', { plan: newPlan });
    toast('Success', `User plan updated to ${newPlan}`, 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function toggleApiKeyVisibility(inputId) {
  const input = $(inputId);
  if (input) input.type = input.type === 'password' ? 'text' : 'password';
}

async function testApiKey(provider) {
  try {
    const data = await apiCall(`/api-keys/test/${provider}`, 'POST');
    const statusEl = $(`status_${provider}`);
    if (statusEl) {
      statusEl.className = `api-status ${data.success ? 'online' : 'offline'}`;
      statusEl.innerHTML = `<span class="status-dot"></span><span>${data.success ? 'Connected' : data.error}</span>`;
    }
    toast(data.success ? 'Success' : 'Failed', data.message || data.error, data.success ? 'success' : 'error');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function saveApiKey(provider) {
  const apiKey = $(`apiKey_${provider}`)?.value;
  if (!apiKey) {
    toast('Error', 'Please enter an API key', 'error');
    return;
  }
  
  try {
    await apiCall(`/api-keys/${provider}`, 'POST', { apiKey });
    toast('Saved', `${provider} API key saved`, 'success');
    testApiKey(provider);
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function switchGodTab(tab) {
  document.querySelectorAll('.god-tab').forEach(t => t.classList.remove('active'));
  event.target.classList.add('active');
  
  document.querySelectorAll('.god-tab-content').forEach(c => c.style.display = 'none');
  $(`godTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
}

function refreshDashboard() {
  loadDashboard();
  toast('Refreshed', 'Dashboard data updated', 'success');
}

// ============ I FEATURES PAGE ============
const AI_FEATURES = [
  { id: 'ocr', name: 'Deep Content Analysis (OCR)', desc: 'Extract text from PDFs and images using Tesseract, Google Cloud Vision, AWS Textract, or Azure', icon: 'ðŸ“„', limit: { free: 25, pro: 500, business: 5000, god: -1 }, tier: 'free' },
  { id: 'vision', name: 'Visual Recognition', desc: 'GPT-4V, Gemini Vision, Claude Vision, LLaVA analyze image content', icon: 'ðŸ‘ï¸', limit: { free: 0, pro: 500, business: 5000, god: -1 }, tier: 'pro' },
  { id: 'audio', name: 'Audio Transcription', desc: 'Whisper and Google Speech transcribe audio/video files', icon: 'ðŸŽ¤', limit: { free: 0, pro: 0, business: 5000, god: -1 }, tier: 'business' },
  { id: 'magic', name: 'Magic Folders', desc: 'Automated folder-based renaming and organization', icon: 'ðŸ“', limit: { free: 5, pro: -1, business: -1, god: -1 }, tier: 'free' },
  { id: 'dedup', name: 'Deduplication', desc: 'Hash-based (Free) or semantic (Pro+) duplicate detection', icon: 'ðŸ”„', limit: { free: 25, pro: 500, business: 5000, god: -1 }, tier: 'free' },
  { id: 'history', name: 'History & Undo', desc: 'Full rename history with undo/rollback capability', icon: 'â†©ï¸', limit: { free: 1, pro: -1, business: -1, god: -1 }, tier: 'free' },
  { id: 'cloud', name: 'Cloud Sync', desc: 'Connect Google Drive and Dropbox for cloud renaming', icon: 'â˜ï¸', limit: { free: 0, pro: -1, business: -1, god: -1 }, tier: 'pro' },
  { id: 'instructions', name: 'Custom Instructions', desc: 'Define naming patterns, prefixes, suffixes, and AI prompts', icon: 'ðŸ“', limit: { free: 0, pro: -1, business: -1, god: -1 }, tier: 'pro' },
  { id: 'handwriting', name: 'Handwriting Recognition', desc: 'OCR for handwritten text in images and documents', icon: 'âœï¸', limit: { free: 0, pro: 500, business: -1, god: -1 }, tier: 'pro' },
  { id: 'translate', name: 'Multi-Language Output', desc: 'Generate filenames in multiple languages', icon: 'ðŸŒ', limit: { free: 0, pro: 500, business: -1, god: -1 }, tier: 'pro' },
  { id: 'watch', name: 'Watch Agents', desc: 'Background monitoring agents that auto-rename new files', icon: 'ðŸ‘€', limit: { free: 0, pro: 0, business: 10, god: -1 }, tier: 'business' },
  { id: 'api', name: 'API Access', desc: 'REST API for programmatic file renaming integration', icon: 'ðŸ”Œ', limit: { free: 0, pro: 0, business: -1, god: -1 }, tier: 'business' }
];

// User's enabled features (stored locally)
let userFeatureToggles = DB.get('featureToggles', {});

function loadAiFeatures() {
  const grid = $('aiFeaturesGrid');
  if (!grid) return;
  
  const user = App.currentUser;
  const plan = user?.plan || 'free';
  const planOrder = ['free', 'pro', 'business', 'god'];
  const userPlanIndex = planOrder.indexOf(plan);
  
  grid.innerHTML = AI_FEATURES.map(f => {
    const featurePlanIndex = planOrder.indexOf(f.tier);
    const isAvailable = userPlanIndex >= featurePlanIndex;
    const isEnabled = userFeatureToggles[f.id] !== false && isAvailable;
    const limit = f.limit[plan];
    const limitText = limit === -1 ? 'âˆž' : limit;
    const used = 0; // Would come from API in real implementation
    
    return `
      <div class="ai-feature-card ${!isAvailable ? 'disabled' : ''}">
        <div class="ai-feature-header">
          <div class="ai-feature-icon">${f.icon}</div>
          ${!isAvailable ? `<span class="tier-badge ${f.tier}">${f.tier.charAt(0).toUpperCase() + f.tier.slice(1)}</span>` : ''}
        </div>
        <h3>${escapeHtml(f.name)}</h3>
        <p>${escapeHtml(f.desc)}</p>
        <div class="ai-feature-footer">
          <div class="ai-feature-limit">
            <span>${used}</span> / ${limitText} this month
          </div>
          <div class="feature-toggle ${isEnabled ? 'active' : ''} ${!isAvailable ? 'locked' : ''}" 
               onclick="${isAvailable ? `toggleFeature('${f.id}', this)` : 'showUpgradeModal()'}"></div>
        </div>
      </div>
    `;
  }).join('');
  
  // Also load Watch Agents and API Tokens
  loadWatchAgents();
  loadApiTokens();
}

function toggleFeature(featureId, el) {
  const isActive = el.classList.contains('active');
  el.classList.toggle('active');
  userFeatureToggles[featureId] = !isActive;
  DB.set('featureToggles', userFeatureToggles);
  toast('Feature Updated', `${featureId} ${!isActive ? 'enabled' : 'disabled'}`, 'success');
}

// ============ CLOUD SYNC ============
async function loadCloudConnections() {
  const plan = App.currentUser?.plan || 'free';
  const hasAccess = ['pro', 'business', 'god'].includes(plan);
  
  if (!hasAccess) {
    $('googleDriveBtn').textContent = 'Pro Required';
    $('googleDriveBtn').classList.add('btn-locked');
    $('googleDriveBtn').onclick = () => showUpgradeModal();
    return;
  }
  
  try {
    const connections = await apiCall('/cloud/connections');
    
    // Google Drive
    if (connections.googleDrive?.connected) {
      $('googleDriveStatus').textContent = `Connected: ${connections.googleDrive.email}`;
      $('googleDriveBtn').textContent = 'Disconnect';
      $('googleDriveBtn').onclick = () => disconnectCloud('googleDrive');
    } else {
      $('googleDriveStatus').textContent = 'Not connected';
      $('googleDriveBtn').textContent = 'Connect';
      $('googleDriveBtn').onclick = () => connectCloud('googleDrive');
    }
    
    // Update Dropbox button based on plan
    const dropboxBtn = $('dropboxBtn');
    if (dropboxBtn) {
      if (connections.dropbox?.connected) {
        dropboxBtn.textContent = 'Disconnect';
        dropboxBtn.classList.remove('btn-locked');
        dropboxBtn.onclick = () => disconnectCloud('dropbox');
      } else {
        dropboxBtn.textContent = 'Connect';
        dropboxBtn.classList.remove('btn-locked');
        dropboxBtn.onclick = () => connectCloud('dropbox');
      }
    }
  } catch (err) {
    console.error('Failed to load cloud connections:', err);
  }
}

async function connectCloud(provider) {
  try {
    const data = await apiCall(`/cloud/connect/${provider}`, 'POST');
    if (data.authUrl) {
      // Open OAuth popup or redirect
      const popup = window.open(data.authUrl, 'CloudConnect', 'width=600,height=700');
      
      // Check for completion
      const checkPopup = setInterval(() => {
        if (popup.closed) {
          clearInterval(checkPopup);
          loadCloudConnections();
          toast('Cloud Sync', 'Please complete authorization in the popup window', 'success');
        }
      }, 1000);
    }
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function disconnectCloud(provider) {
  if (!confirm(`Disconnect ${provider}? You'll need to reconnect to use cloud sync.`)) return;
  
  try {
    await apiCall(`/cloud/disconnect/${provider}`, 'DELETE');
    toast('Disconnected', `${provider} has been disconnected`, 'success');
    loadCloudConnections();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

function connectGoogleDrive() {
  connectCloud('googleDrive');
}

// ============ WATCH AGENTS ============
async function loadWatchAgents() {
  const container = $('watchAgentsList');
  if (!container) return;
  
  const plan = App.currentUser?.plan || 'free';
  if (!['business', 'god'].includes(plan)) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-muted)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:16px"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        <p>Watch Agents require Business plan</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="showUpgradeModal()">Upgrade Now</button>
      </div>`;
    return;
  }
  
  try {
    const agents = await apiCall('/watch-agents');
    
    if (agents.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--text-muted)">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:16px"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          <p>No Watch Agents configured</p>
          <p style="font-size:0.85rem;margin-top:8px">Create an agent to automatically rename files in watched folders</p>
        </div>`;
      return;
    }
    
    container.innerHTML = agents.map(a => `
      <div class="watch-agent-item" data-id="${a.id}">
        <div class="watch-agent-info">
          <div class="watch-agent-icon ${a.status === 'active' ? 'active' : ''}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
          </div>
          <div>
            <div class="watch-agent-name">${escapeHtml(a.name)}</div>
            <div class="watch-agent-path">${escapeHtml(a.path)}</div>
            <div class="watch-agent-stats">
              Status: <span class="${a.status === 'active' ? 'text-green' : 'text-muted'}">${a.status}</span> â€¢ 
              ${a.filesProcessed || 0} files processed
            </div>
          </div>
        </div>
        <div class="watch-agent-actions">
          ${a.status === 'active' 
            ? `<button class="btn btn-sm btn-secondary" onclick="stopWatchAgent(${a.id})">Stop</button>`
            : `<button class="btn btn-sm btn-primary" onclick="startWatchAgent(${a.id})">Start</button>`
          }
          <button class="btn btn-sm btn-ghost danger" onclick="deleteWatchAgent(${a.id})">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (err) {
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red)">Failed to load Watch Agents</div>`;
  }
}

async function createWatchAgent() {
  const name = prompt('Agent name:');
  if (!name) return;
  
  const path = prompt('Folder path to watch:');
  if (!path) return;
  
  try {
    await apiCall('/watch-agents', 'POST', {
      name,
      path,
      config: DB.get('magicFolderConfig', {}),
      status: 'stopped'
    });
    toast('Created', 'Watch Agent created successfully', 'success');
    loadWatchAgents();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function startWatchAgent(id) {
  try {
    await apiCall(`/watch-agents/${id}/start`, 'POST');
    toast('Started', 'Watch Agent is now monitoring', 'success');
    loadWatchAgents();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function stopWatchAgent(id) {
  try {
    await apiCall(`/watch-agents/${id}/stop`, 'POST');
    toast('Stopped', 'Watch Agent stopped', 'success');
    loadWatchAgents();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function deleteWatchAgent(id) {
  if (!confirm('Delete this Watch Agent?')) return;
  
  try {
    await apiCall(`/watch-agents/${id}`, 'DELETE');
    toast('Deleted', 'Watch Agent removed', 'success');
    loadWatchAgents();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// ============ API ACCESS (Developer Tokens) ============
async function loadApiTokens() {
  const container = $('apiTokensList');
  if (!container) return;
  
  const plan = App.currentUser?.plan || 'free';
  if (!['business', 'god'].includes(plan)) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-muted)">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:16px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
        <p>API Access requires Business plan</p>
        <button class="btn btn-primary" style="margin-top:16px" onclick="showUpgradeModal()">Upgrade Now</button>
      </div>`;
    return;
  }
  
  try {
    const tokens = await apiCall('/developer/tokens');
    
    if (tokens.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--text-muted)">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:16px"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <p>No API tokens created</p>
          <p style="font-size:0.85rem;margin-top:8px">Create a token to access the NameWizard API</p>
        </div>`;
      return;
    }
    
    container.innerHTML = tokens.map(t => `
      <div class="api-token-item">
        <div class="api-token-info">
          <div class="api-token-name">${escapeHtml(t.name)}</div>
          <div class="api-token-key">${t.token}</div>
          <div class="api-token-stats">
            Created: ${new Date(t.createdAt).toLocaleDateString()} â€¢ 
            Used: ${t.usageCount} times
            ${t.lastUsed ? ` â€¢ Last: ${new Date(t.lastUsed).toLocaleDateString()}` : ''}
          </div>
        </div>
        <button class="btn btn-sm btn-ghost danger" onclick="deleteApiToken(${t.id})">Revoke</button>
      </div>
    `).join('');
  } catch (err) {
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red)">Failed to load API tokens</div>`;
  }
}

async function createApiToken() {
  const name = prompt('Token name (e.g., "Production Server"):');
  if (!name) return;
  
  try {
    const token = await apiCall('/developer/tokens', 'POST', { name });
    
    // Show the full token (only shown once)
    const tokenDisplay = document.createElement('div');
    tokenDisplay.innerHTML = `
      <div style="background:var(--elevated);padding:16px;border-radius:8px;margin:16px 0">
        <div style="color:var(--text-muted);font-size:0.85rem;margin-bottom:8px">Your API Token (copy now - shown only once):</div>
        <code style="background:var(--bg);padding:8px 12px;border-radius:4px;display:block;word-break:break-all;font-size:0.9rem">${token.token}</code>
      </div>
    `;
    
    alert(`API Token Created!\n\nToken: ${token.token}\n\nCopy this token now - it won't be shown again.`);
    loadApiTokens();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function deleteApiToken(id) {
  if (!confirm('Revoke this API token? Any integrations using it will stop working.')) return;
  
  try {
    await apiCall(`/developer/tokens/${id}`, 'DELETE');
    toast('Revoked', 'API token has been revoked', 'success');
    loadApiTokens();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// ============ API SETTINGS PAGE (GOD MODE) ============
function loadApiSettings() {
  if (!App.isGodMode) {
    toast('Access Denied', 'This page is only available for God Mode', 'error');
    nav('pageApp');
    return;
  }
  // Load saved API keys if available
  loadApiKeyStatuses();
}

async function loadApiKeyStatuses() {
  try {
    const data = await apiCall('/api-keys/status');
    Object.keys(data).forEach(provider => {
      const statusEl = $(`status${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
      const overviewEl = $(`overview${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
      const status = data[provider];
      
      if (statusEl) {
        statusEl.innerHTML = `<span class="dot ${status.configured ? 'online' : 'offline'}"></span><span>${status.configured ? 'Configured' : 'Not configured'}</span>`;
      }
      if (overviewEl) {
        overviewEl.innerHTML = `<span class="dot ${status.configured ? 'online' : 'offline'}"></span> ${status.configured ? 'Online' : 'Offline'}`;
      }
    });
  } catch (err) {
    console.error('Failed to load API key statuses:', err);
  }
}

async function testApiConnection(provider) {
  const statusEl = $(`status${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
  if (statusEl) statusEl.innerHTML = '<span class="dot unknown"></span><span>Testing...</span>';
  
  try {
    const data = await apiCall(`/api-keys/test/${provider}`, 'POST');
    if (statusEl) {
      statusEl.innerHTML = `<span class="dot ${data.success ? 'online' : 'offline'}"></span><span>${data.success ? 'Connected' : data.error || 'Failed'}</span>`;
    }
    toast(data.success ? 'Success' : 'Failed', data.message || data.error, data.success ? 'success' : 'error');
  } catch (err) {
    if (statusEl) statusEl.innerHTML = `<span class="dot offline"></span><span>${err.message}</span>`;
    toast('Error', err.message, 'error');
  }
}

async function saveApiKeyFromPage(provider) {
  const inputId = `apiKey${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
  const apiKey = $(inputId)?.value;
  
  if (!apiKey) {
    toast('Error', 'Please enter an API key', 'error');
    return;
  }
  
  try {
    await apiCall(`/api-keys/${provider}`, 'POST', { apiKey });
    toast('Saved', `${provider} API key saved`, 'success');
    testApiConnection(provider);
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function saveStripeKeys() {
  const secretKey = $('apiKeyStripeSecret')?.value;
  const publicKey = $('apiKeyStripePublic')?.value;
  const webhookSecret = $('apiKeyStripeWebhook')?.value;
  
  try {
    await apiCall('/api-keys/stripe', 'POST', { secretKey, publicKey, webhookSecret });
    toast('Saved', 'Stripe keys saved', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function saveGoogleOAuthKeys() {
  const clientId = $('apiKeyGoogleClientId')?.value;
  const clientSecret = $('apiKeyGoogleClientSecret')?.value;
  
  try {
    await apiCall('/api-keys/google-oauth', 'POST', { clientId, clientSecret });
    toast('Saved', 'Google OAuth keys saved', 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function saveAwsKeys() {
  const accessKey = $('apiKeyAwsAccessKey')?.value;
  const secretKey = $('apiKeyAwsSecretKey')?.value;
  const region = $('apiKeyAwsRegion')?.value || 'us-east-1';
  
  try {
    await apiCall('/api-keys/aws', 'POST', { accessKey, secretKey, region });
    toast('Saved', 'AWS credentials saved', 'success');
    testApiConnection('aws-textract');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function saveAzureKeys() {
  const endpoint = $('apiKeyAzureEndpoint')?.value;
  const apiKey = $('apiKeyAzureKey')?.value;
  
  try {
    await apiCall('/api-keys/azure', 'POST', { endpoint, apiKey });
    toast('Saved', 'Azure credentials saved', 'success');
    testApiConnection('azure-document-intelligence');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// ============ MAGIC FOLDERS PAGE ============
let magicFolderTemplate = [];
let selectedSpaceChar = '_';

function selectSpaceChar(btn) {
  document.querySelectorAll('.space-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  selectedSpaceChar = btn.dataset.value;
  updateTemplatePreview();
}

function selectAllExtensions() {
  document.querySelectorAll('.ext-btn').forEach(btn => btn.classList.add('active'));
}

function deselectAllExtensions() {
  document.querySelectorAll('.ext-btn').forEach(btn => btn.classList.remove('active'));
}

// Extension toggle
document.addEventListener('click', e => {
  if (e.target.classList.contains('ext-btn')) {
    e.target.classList.toggle('active');
  }
});

// Drag and Drop for Template Builder
function initTemplateDragDrop() {
  const tags = document.querySelectorAll('.template-tag[draggable="true"]');
  const dropzone = $('templateDropzone');
  
  if (!dropzone) return;
  
  tags.forEach(tag => {
    tag.addEventListener('dragstart', e => {
      e.dataTransfer.setData('text/plain', tag.dataset.tag);
      tag.classList.add('dragging');
    });
    
    tag.addEventListener('dragend', () => {
      tag.classList.remove('dragging');
    });
  });
  
  dropzone.addEventListener('dragover', e => {
    e.preventDefault();
    dropzone.classList.add('dragover');
  });
  
  dropzone.addEventListener('dragleave', () => {
    dropzone.classList.remove('dragover');
  });
  
  dropzone.addEventListener('drop', e => {
    e.preventDefault();
    dropzone.classList.remove('dragover');
    
    const tagType = e.dataTransfer.getData('text/plain');
    addTagToTemplate(tagType);
  });
}

function addTagToTemplate(tagType) {
  const dropzone = $('templateDropzone');
  if (!dropzone) return;
  
  // Remove placeholder text if present
  const placeholder = dropzone.querySelector('span');
  if (placeholder && placeholder.style) {
    placeholder.remove();
  }
  
  const tagNames = {
    docnum: 'ðŸ“„ Doc#',
    doctype: 'ðŸ“‹ Type',
    project: 'ðŸ“ Project',
    issuer: 'ðŸ¢ Issuer',
    recipient: 'ðŸ‘¤ Recipient',
    date: 'ðŸ“… Date',
    year: 'ðŸ“† Year',
    amount: 'ðŸ’° Amount',
    custom: 'âœï¸ Custom'
  };
  
  const tagEl = document.createElement('div');
  tagEl.className = 'template-tag';
  tagEl.dataset.tag = tagType;
  tagEl.innerHTML = `${tagNames[tagType] || tagType}<span class="remove-tag" onclick="removeTagFromTemplate(this)">Ã—</span>`;
  dropzone.appendChild(tagEl);
  
  magicFolderTemplate.push(tagType);
  updateTemplatePreview();
}

function removeTagFromTemplate(el) {
  const tag = el.parentElement;
  const tagType = tag.dataset.tag;
  tag.remove();
  
  const index = magicFolderTemplate.indexOf(tagType);
  if (index > -1) magicFolderTemplate.splice(index, 1);
  
  updateTemplatePreview();
  
  // Add placeholder back if empty
  const dropzone = $('templateDropzone');
  if (dropzone && dropzone.children.length === 0) {
    dropzone.innerHTML = '<span style="color:var(--text-muted);font-size:0.9rem">Drop tags here to build your template...</span>';
  }
}

function updateTemplatePreview() {
  const preview = $('templatePreviewLive');
  if (!preview) return;
  
  const sampleData = {
    docnum: '12345',
    doctype: 'Invoice',
    project: 'ProjectX',
    issuer: 'Acme-Inc',
    recipient: 'ClientCo',
    date: '23-08-2024',
    year: '2024',
    amount: '1500usd',
    custom: 'note'
  };
  
  const separator = selectedSpaceChar || '_';
  const parts = magicFolderTemplate.map(tag => sampleData[tag] || tag);
  const filename = parts.length > 0 ? parts.join(separator) + '.pdf' : 'example_filename.pdf';
  
  preview.textContent = filename;
}

function saveMagicFolderTemplate() {
  const config = {
    includeSubfolders: $('mfIncludeSubfolders')?.checked,
    skipExisting: $('mfSkipExisting')?.checked,
    language: $('mfLanguage')?.value,
    dateFormat: $('mfDateFormat')?.value,
    textFormat: $('mfTextFormat')?.value,
    spaceChar: selectedSpaceChar,
    extensions: Array.from(document.querySelectorAll('.ext-btn.active')).map(btn => btn.dataset.ext),
    template: magicFolderTemplate
  };
  
  DB.set('magicFolderConfig', config);
  toast('Saved', 'Magic Folder template saved successfully', 'success');
}

function resetMagicFolderTemplate() {
  magicFolderTemplate = [];
  selectedSpaceChar = '_';
  
  // Reset UI
  document.querySelectorAll('.space-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.value === '_');
  });
  
  const dropzone = $('templateDropzone');
  if (dropzone) {
    dropzone.innerHTML = '<span style="color:var(--text-muted);font-size:0.9rem">Drop tags here to build your template...</span>';
  }
  
  updateTemplatePreview();
  toast('Reset', 'Template reset to default', 'success');
}

async function addNewMagicFolder() {
  const plan = App.currentUser?.plan || 'free';
  const limits = { free: 5, pro: -1, business: -1, god: -1 };
  const limit = limits[plan];
  
  // Check limit
  try {
    const folders = await apiCall('/magic-folders');
    if (limit !== -1 && folders.length >= limit) {
      toast('Limit Reached', `Free plan allows ${limit} Magic Folders. Upgrade for unlimited.`, 'error');
      showUpgradeModal();
      return;
    }
  } catch (err) {
    console.error(err);
  }
  
  // Show folder creation modal
  const folderName = prompt('Enter a name for this Magic Folder:');
  if (!folderName) return;
  
  const folderPath = prompt('Enter the folder path to watch (e.g., /Documents/Invoices):');
  if (!folderPath) return;
  
  // Get current template config
  const config = DB.get('magicFolderConfig', {
    includeSubfolders: true,
    skipExisting: false,
    language: 'auto',
    dateFormat: 'YYYY-MM-DD',
    textFormat: 'auto',
    spaceChar: '_',
    extensions: ['.pdf', '.doc', '.docx', '.txt', '.jpg', '.jpeg', '.png'],
    template: []
  });
  
  try {
    const folder = await apiCall('/magic-folders', 'POST', {
      name: folderName,
      path: folderPath,
      config: config,
      active: true
    });
    
    toast('Success', `Magic Folder "${folderName}" created!`, 'success');
    loadMagicFoldersList();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function loadMagicFoldersList() {
  const container = $('magicFoldersListPage');
  if (!container) return;
  
  try {
    const folders = await apiCall('/magic-folders');
    
    if (folders.length === 0) {
      container.innerHTML = `
        <div style="text-align:center;padding:40px;color:var(--text-muted)">
          <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="opacity:0.5;margin-bottom:16px"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          <p>No Magic Folders configured yet</p>
          <p style="font-size:0.85rem;margin-top:8px">Click "Add Folder" to create your first automated folder</p>
        </div>`;
      return;
    }
    
    container.innerHTML = folders.map(f => `
      <div class="magic-folder-item" data-id="${f.id}">
        <div class="magic-folder-info">
          <div class="magic-folder-icon ${f.active ? 'active' : ''}">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>
          </div>
          <div>
            <div class="magic-folder-name">${escapeHtml(f.name)}</div>
            <div class="magic-folder-path">${escapeHtml(f.path)}</div>
            <div class="magic-folder-stats">
              ${f.config?.extensions?.length || 0} extensions â€¢ ${f.filesProcessed || 0} files processed
            </div>
          </div>
        </div>
        <div class="magic-folder-actions">
          <div class="feature-toggle ${f.active ? 'active' : ''}" onclick="toggleMagicFolder(${f.id}, this)"></div>
          <button class="btn btn-ghost btn-sm" onclick="editMagicFolder(${f.id})">Edit</button>
          <button class="btn btn-ghost btn-sm danger" onclick="deleteMagicFolder(${f.id})">Delete</button>
        </div>
      </div>
    `).join('');
  } catch (err) {
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--red)">Failed to load Magic Folders</div>`;
  }
}

async function toggleMagicFolder(id, el) {
  const isActive = el.classList.contains('active');
  try {
    await apiCall(`/magic-folders/${id}`, 'PUT', { active: !isActive });
    el.classList.toggle('active');
    toast('Updated', `Magic Folder ${isActive ? 'paused' : 'activated'}`, 'success');
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function editMagicFolder(id) {
  try {
    const folders = await apiCall('/magic-folders');
    const folder = folders.find(f => f.id === id);
    if (!folder) return;
    
    const newName = prompt('Folder name:', folder.name);
    if (newName === null) return;
    
    const newPath = prompt('Folder path:', folder.path);
    if (newPath === null) return;
    
    await apiCall(`/magic-folders/${id}`, 'PUT', { name: newName, path: newPath });
    toast('Updated', 'Magic Folder updated successfully', 'success');
    loadMagicFoldersList();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

async function deleteMagicFolder(id) {
  if (!confirm('Are you sure you want to delete this Magic Folder?')) return;
  
  try {
    await apiCall(`/magic-folders/${id}`, 'DELETE');
    toast('Deleted', 'Magic Folder removed', 'success');
    loadMagicFoldersList();
  } catch (err) {
    toast('Error', err.message, 'error');
  }
}

// Load Magic Folders when navigating to the page
document.addEventListener('click', (e) => {
  if (e.target.closest('[onclick*="pageMagicFolders"]')) {
    setTimeout(loadMagicFoldersList, 100);
  }
});

// Initialize drag and drop when page loads
setTimeout(initTemplateDragDrop, 100);

// ============ DRAG & DROP ============
const uploadZone = $('uploadZone');
if (uploadZone) {
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => {
    uploadZone.addEventListener(e, ev => { ev.preventDefault(); ev.stopPropagation(); });
  });
  ['dragenter', 'dragover'].forEach(e => uploadZone.addEventListener(e, () => uploadZone.classList.add('dragover')));
  ['dragleave', 'drop'].forEach(e => uploadZone.addEventListener(e, () => uploadZone.classList.remove('dragover')));
  uploadZone.addEventListener('drop', e => {
    const dt = e.dataTransfer;
    const files = dt.files;
    $('fileInput').files = files;
    handleFileSelect({ target: { files } });
  });
}

// ============ MAGIC FOLDER FUNCTIONALITY ============

// Global state for Magic Folders
const MagicFolders = {
  folders: [],
  currentFolder: null,
  selectedFolderHandle: null,
  extensions: [
    '.doc', '.docx', '.odt', '.rtf', '.txt', '.md', '.json',
    '.xls', '.xlsx', '.eml', '.jpg', '.jpeg', '.png', '.webp',
    '.gif', '.bmp', '.tiff', '.tif', '.heic', '.jxl', '.pdf',
    '.ppt', '.pptx', '.eps', '.svg', '.ai'
  ],
  selectedExtensions: [],
  spaceOption: 'auto'
};

// Initialize Magic Folders page
function initMagicFolders() {
  // Load saved folders from localStorage
  const saved = DB.get('magicFolders');
  if (saved) {
    MagicFolders.folders = saved;
    renderMagicFoldersList();
  } else {
    $('magicFoldersEmpty').style.display = 'block';
  }
  
  // Initialize extension tags
  renderExtensionTags();
  
  // Select all extensions by default
  MagicFolders.selectedExtensions = [...MagicFolders.extensions];
  updateExtensionTags();
}

// Open Magic Folder configuration modal
async function openMagicFolderConfig() {
  // Check browser support
  if (!('showDirectoryPicker' in window)) {
    toast('Browser Not Supported', 'Magic Folders require Chrome or Edge browser with File System Access API', 'error');
    return;
  }
  
  try {
    // Show directory picker
    const dirHandle = await window.showDirectoryPicker({
      mode: 'readwrite'
    });
    
    MagicFolders.selectedFolderHandle = dirHandle;
    
    // Display folder path
    const path = await getFolderPath(dirHandle);
    $('magicFolderPath').textContent = path;
    $('createMagicFolderBtn').disabled = false;
    
    // Show configuration modal
    $('magicFolderConfigModal').classList.add('active');
    
  } catch (err) {
    if (err.name !== 'AbortError') {
      console.error('Folder selection error:', err);
      toast('Permission Denied', 'Unable to access the selected folder', 'error');
    }
  }
}

// Get folder path from handle
async function getFolderPath(dirHandle) {
  // Note: Full path not available in browser for security
  // We'll use the folder name
  return `/${dirHandle.name}`;
}

// Close Magic Folder configuration modal
function closeMagicFolderConfig() {
  $('magicFolderConfigModal').classList.remove('active');
  resetMagicFolderPath();
}

// Reset folder path
function resetMagicFolderPath() {
  MagicFolders.selectedFolderHandle = null;
  $('magicFolderPath').textContent = '/Select a folder...';
  $('createMagicFolderBtn').disabled = true;
}

// Create Magic Folder
async function createMagicFolder() {
  if (!MagicFolders.selectedFolderHandle) {
    toast('Error', 'Please select a folder first', 'error');
    return;
  }
  
  const config = {
    id: Date.now().toString(),
    name: MagicFolders.selectedFolderHandle.name,
    path: await getFolderPath(MagicFolders.selectedFolderHandle),
    template: $('magicFolderTemplate').value,
    ignoreInitial: $('ignoreInitialFiles').checked,
    includeSubfolders: $('includeSubfolders').checked,
    language: $('fileLanguage').value,
    dateFormat: $('dateFormat').value,
    textFormat: $('textFormat').value,
    spaceOption: MagicFolders.spaceOption,
    extensions: [...MagicFolders.selectedExtensions],
    active: true,
    filesProcessed: 0,
    filesTotal: 0,
    createdAt: Date.now()
  };
  
  // Add to folders list
  MagicFolders.folders.push(config);
  
  // Save to localStorage
  DB.set('magicFolders', MagicFolders.folders);
  
  // Close modal
  closeMagicFolderConfig();
  
  // Render folders list
  renderMagicFoldersList();
  
  // Hide empty state
  $('magicFoldersEmpty').style.display = 'none';
  
  // Start processing if not ignoring initial files
  if (!config.ignoreInitial) {
    processMagicFolder(config.id);
  }
  
  toast('Magic Folder Created', `Now monitoring: ${config.name}`, 'success');
}

// Render Magic Folders list
function renderMagicFoldersList() {
  const container = $('magicFoldersList');
  
  if (MagicFolders.folders.length === 0) {
    container.innerHTML = '';
    $('magicFoldersEmpty').style.display = 'block';
    return;
  }
  
  $('magicFoldersEmpty').style.display = 'none';
  
  container.innerHTML = MagicFolders.folders.map(folder => `
    <div class="magic-folder-card" data-folder-id="${folder.id}">
      <div class="magic-folder-header">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="var(--orange)" stroke-width="2">
          <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>
        </svg>
        <div class="magic-folder-info">
          <div class="magic-folder-name">${folder.name}</div>
          <div class="magic-folder-path">${folder.path}</div>
        </div>
        <div class="toggle-switch ${folder.active ? 'active' : ''}" onclick="toggleMagicFolder('${folder.id}')"></div>
      </div>
      
      <div class="magic-folder-controls">
        <select class="magic-folder-template" onchange="changeMagicFolderTemplate('${folder.id}', this.value)">
          <option value="auto" ${folder.template === 'auto' ? 'selected' : ''}>Auto</option>
          <option value="business" ${folder.template === 'business' ? 'selected' : ''}>Business Document</option>
          <option value="invoice" ${folder.template === 'invoice' ? 'selected' : ''}>Invoice</option>
          <option value="project" ${folder.template === 'project' ? 'selected' : ''}>Project Files</option>
        </select>
        
        <div class="magic-folder-stats">
          <div class="magic-folder-stat">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
              <polyline points="13 2 13 9 20 9"/>
            </svg>
            <span>${folder.filesTotal} files</span>
          </div>
          <div style="color:var(--text-muted)">|</div>
          <div class="magic-folder-stat" style="color:var(--orange)">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="20 6 9 17 4 12"/>
            </svg>
            <span>${folder.filesProcessed} named</span>
          </div>
        </div>
        
        <div class="magic-folder-actions">
          <div class="magic-folder-action-btn" onclick="viewMagicFolderResults('${folder.id}')" title="View results">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
              <circle cx="12" cy="12" r="3"/>
            </svg>
          </div>
          <div class="magic-folder-action-btn" onclick="openMagicFolderSettings('${folder.id}')" title="Settings">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="3"/>
              <path d="M12 1v6m0 6v6m0-6h6m-6 0H6"/>
            </svg>
          </div>
          <div class="magic-folder-action-btn" onclick="deleteMagicFolder('${folder.id}')" title="Delete" style="color:var(--red)">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3 6 5 6 21 6"/>
              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
            </svg>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

// Toggle Magic Folder active state
function toggleMagicFolder(folderId) {
  const folder = MagicFolders.folders.find(f => f.id === folderId);
  if (!folder) return;
  
  folder.active = !folder.active;
  DB.set('magicFolders', MagicFolders.folders);
  
  renderMagicFoldersList();
  
  if (folder.active) {
    toast('Magic Folder Activated', `Now monitoring: ${folder.name}`, 'success');
    processMagicFolder(folderId);
  } else {
    toast('Magic Folder Paused', `Stopped monitoring: ${folder.name}`, 'info');
  }
}

// Change Magic Folder template
function changeMagicFolderTemplate(folderId, template) {
  const folder = MagicFolders.folders.find(f => f.id === folderId);
  if (!folder) return;
  
  folder.template = template;
  DB.set('magicFolders', MagicFolders.folders);
  
  toast('Template Changed', 'Files will be renamed using the new template', 'success');
  
  // Reprocess if active
  if (folder.active) {
    processMagicFolder(folderId);
  }
}

// Delete Magic Folder
function deleteMagicFolder(folderId) {
  if (!confirm('Are you sure you want to delete this Magic Folder? This will not delete the actual folder or files.')) {
    return;
  }
  
  MagicFolders.folders = MagicFolders.folders.filter(f => f.id !== folderId);
  DB.set('magicFolders', MagicFolders.folders);
  
  renderMagicFoldersList();
  
  toast('Magic Folder Deleted', 'The folder is no longer being monitored', 'success');
}

// Process Magic Folder
async function processMagicFolder(folderId) {
  const folder = MagicFolders.folders.find(f => f.id === folderId);
  if (!folder || !folder.active) return;
  
  toast('Processing Started', `Analyzing files in ${folder.name}...`, 'info');
  
  // Use the real AI-powered processing engine
  processMagicFolderWithAI(folderId);
}

// View Magic Folder results
function viewMagicFolderResults(folderId) {
  const folder = MagicFolders.folders.find(f => f.id === folderId);
  if (!folder) return;
  
  MagicFolders.currentFolder = folder;
  
  // Navigate to results page
  nav('pageMagicFolderResults');
  
  // Update results view
  $('resultsFolderPath').textContent = folder.path;
  
  // Render results list
  renderMagicFolderResults(folder);
}

// Render Magic Folder results
function renderMagicFolderResults(folder) {
  const container = $('magicFolderResultsList');
  
  // Load real results from database
  const results = loadProcessingResults(folder.id);
  
  // If no results, show empty state
  if (results.length === 0) {
    container.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--text-muted)">No files have been processed yet</div>';
    return;
  }
  
  // Format results for display
  const formattedResults = results.filter(r => r.success).map(result => {
    const time = new Date(result.timestamp).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
    const ext = result.oldName.split('.').pop().toLowerCase();
    const type = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff', 'tif', 'heic'].includes(ext) ? 'image' : 'document';
    
    return {
      time,
      oldName: result.oldName,
      newName: result.newName,
      type,
      subfolder: result.subfolder
    };
  });
  
  container.innerHTML = formattedResults.map(result => `
    <div class="result-item">
      <div class="result-time">${result.time}</div>
      <div class="result-thumbnail">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          ${result.type === 'image' ? 
            '<rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/>' :
            '<path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/>'
          }
        </svg>
      </div>
      <div class="result-names">
        <div class="result-old-name">OLD ${result.oldName}</div>
        <div class="result-new-name">NEW ${result.newName}</div>
      </div>
      <div class="result-status">Renamed</div>
    </div>
  `).join('');
}

// Open folder in system
function openFolderInSystem() {
  toast('Open Folder', 'This would open the folder in your file system', 'info');
  // In real implementation, this would trigger a file system open action
}

// Render extension tags
function renderExtensionTags() {
  const container = $('extensionTags');
  
  container.innerHTML = MagicFolders.extensions.map(ext => `
    <div class="extension-tag selected" data-ext="${ext}" onclick="toggleExtension('${ext}')">
      <span>${ext}</span>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <line x1="18" y1="6" x2="6" y2="18"/>
        <line x1="6" y1="6" x2="18" y2="18"/>
      </svg>
    </div>
  `).join('');
}

// Toggle extension selection
function toggleExtension(ext) {
  const index = MagicFolders.selectedExtensions.indexOf(ext);
  
  if (index > -1) {
    MagicFolders.selectedExtensions.splice(index, 1);
  } else {
    MagicFolders.selectedExtensions.push(ext);
  }
  
  updateExtensionTags();
}

// Update extension tags visual state
function updateExtensionTags() {
  document.querySelectorAll('.extension-tag').forEach(tag => {
    const ext = tag.dataset.ext;
    if (MagicFolders.selectedExtensions.includes(ext)) {
      tag.classList.add('selected');
    } else {
      tag.classList.remove('selected');
    }
  });
}

// Deselect all extensions
function deselectAllExtensions() {
  MagicFolders.selectedExtensions = [];
  updateExtensionTags();
}

// Select space option
function selectSpaceOption(button) {
  document.querySelectorAll('.space-option').forEach(btn => btn.classList.remove('active'));
  button.classList.add('active');
  MagicFolders.spaceOption = button.dataset.value;
  updateFormattingPreview();
}

// Update formatting preview
function updateFormattingPreview() {
  const template = $('magicFolderTemplate').value;
  const dateFormat = $('dateFormat').value;
  const textFormat = $('textFormat').value;
  const space = MagicFolders.spaceOption;
  
  let preview = '';
  
  switch (template) {
    case 'business':
      preview = 'Invoice_Acme_Corp_2024-12-19_v1.pdf';
      break;
    case 'invoice':
      preview = 'Invoice_Stripe_20241219.pdf';
      break;
    case 'project':
      preview = 'Soul7_Mockup_Female_Pink_Sweatshirt.png';
      break;
    default:
      preview = 'Photo_Young_Woman_Pink_Sweatshirt.png';
  }
  
  // Apply space option
  if (space === '-') {
    preview = preview.replace(/_/g, '-');
  } else if (space === 'none') {
    preview = preview.replace(/_/g, '');
  } else if (space === ' ') {
    preview = preview.replace(/_/g, ' ');
  }
  
  $('formattingPreview').textContent = preview;
}

// Open Magic Folder settings
function openMagicFolderSettings(folderId) {
  toast('Settings', 'Magic Folder settings coming soon', 'info');
}

// Load more results
function loadMoreResults() {
  toast('Load More', 'No more files to load', 'info');
  $('loadMoreResults').style.display = 'none';
  $('noMoreResults').style.display = 'block';
}

// Initialize when Magic Folders page is opened
function openMagicFolders() {
  nav('pageMagicFolders');
  initMagicFolders();
}


// ============ MAGIC FOLDER BACKEND PROCESSING ENGINE ============

// Processing queue and state management
const MagicFolderProcessor = {
  queue: [],
  processing: false,
  currentFolder: null,
  processedFiles: 0,
  totalFiles: 0,
  errors: [],
  rateLimiter: {
    requests: 0,
    resetTime: Date.now() + 60000, // Reset every minute
    maxRequestsPerMinute: 60
  }
};

// File type categorization
const FILE_CATEGORIES = {
  documents: ['.doc', '.docx', '.pdf', '.txt', '.rtf', '.odt', '.md'],
  spreadsheets: ['.xls', '.xlsx', '.csv'],
  presentations: ['.ppt', '.pptx', '.key'],
  images: {
    jpeg: ['.jpg', '.jpeg'],
    png: ['.png'],
    other: ['.gif', '.webp', '.bmp', '.tiff', '.tif', '.heic', '.jxl']
  },
  audio: ['.mp3', '.wav', '.m4a', '.aac', '.flac'],
  video: ['.mp4', '.mov', '.avi', '.mkv', '.webm'],
  archives: ['.zip', '.rar', '.7z', '.tar', '.gz'],
  code: ['.js', '.py', '.java', '.cpp', '.html', '.css', '.json', '.xml']
};

// ============ FILE SCANNING AND EXTRACTION ============

/**
 * Scan folder and get all files
 * @param {FileSystemDirectoryHandle} dirHandle - Directory handle from File System Access API
 * @param {Object} config - Magic Folder configuration
 * @returns {Promise<Array>} Array of file objects
 */
async function scanFolder(dirHandle, config) {
  const files = [];
  
  try {
    for await (const entry of dirHandle.values()) {
      if (entry.kind === 'file') {
        const file = await entry.getFile();
        const ext = '.' + file.name.split('.').pop().toLowerCase();
        
        // Filter by selected extensions
        if (config.extensions.includes(ext)) {
          // Check file size limit (100MB)
          if (file.size <= 100 * 1024 * 1024) {
            files.push({
              handle: entry,
              file: file,
              name: file.name,
              size: file.size,
              type: file.type,
              extension: ext,
              lastModified: file.lastModified,
              category: categorizeFile(ext)
            });
          } else {
            console.warn(`File ${file.name} exceeds 100MB limit, skipping`);
          }
        }
      } else if (entry.kind === 'directory' && config.includeSubfolders) {
        // Recursively scan subfolders
        const subFiles = await scanFolder(entry, config);
        files.push(...subFiles);
      }
    }
  } catch (err) {
    console.error('Error scanning folder:', err);
    throw new Error(`Failed to scan folder: ${err.message}`);
  }
  
  return files;
}

/**
 * Categorize file by extension
 * @param {string} ext - File extension
 * @returns {Object} Category information
 */
function categorizeFile(ext) {
  if (FILE_CATEGORIES.documents.includes(ext)) {
    return { type: 'document', subfolder: 'Documents' };
  }
  if (FILE_CATEGORIES.spreadsheets.includes(ext)) {
    return { type: 'spreadsheet', subfolder: 'Spreadsheets' };
  }
  if (FILE_CATEGORIES.presentations.includes(ext)) {
    return { type: 'presentation', subfolder: 'Presentations' };
  }
  if (FILE_CATEGORIES.images.jpeg.includes(ext)) {
    return { type: 'image', subfolder: 'Images/JPEG' };
  }
  if (FILE_CATEGORIES.images.png.includes(ext)) {
    return { type: 'image', subfolder: 'Images/PNG' };
  }
  if (FILE_CATEGORIES.images.other.includes(ext)) {
    return { type: 'image', subfolder: 'Images/Other' };
  }
  if (FILE_CATEGORIES.audio.includes(ext)) {
    return { type: 'audio', subfolder: 'Audio' };
  }
  if (FILE_CATEGORIES.video.includes(ext)) {
    return { type: 'video', subfolder: 'Video' };
  }
  if (FILE_CATEGORIES.archives.includes(ext)) {
    return { type: 'archive', subfolder: 'Archives' };
  }
  if (FILE_CATEGORIES.code.includes(ext)) {
    return { type: 'code', subfolder: 'Code' };
  }
  return { type: 'other', subfolder: 'Other' };
}

/**
 * Extract text content from file
 * @param {File} file - File object
 * @returns {Promise<string>} Extracted text
 */
async function extractTextFromFile(file) {
  const ext = '.' + file.name.split('.').pop().toLowerCase();
  
  try {
    // For text-based files, read directly
    if (['.txt', '.md', '.json', '.xml', '.csv', '.rtf'].includes(ext)) {
      return await file.text();
    }
    
    // For PDFs, use PDF.js or send to backend
    if (ext === '.pdf') {
      return await extractTextFromPDF(file);
    }
    
    // For Word documents, send to backend
    if (['.doc', '.docx'].includes(ext)) {
      return await extractTextFromWord(file);
    }
    
    // For other files, return empty string
    return '';
  } catch (err) {
    console.error(`Error extracting text from ${file.name}:`, err);
    return '';
  }
}

/**
 * Extract text from PDF (simplified - in production, use PDF.js)
 * @param {File} file - PDF file
 * @returns {Promise<string>} Extracted text
 */
async function extractTextFromPDF(file) {
  // In production, use PDF.js library or backend API
  // For now, return metadata
  return `PDF: ${file.name}`;
}

/**
 * Extract text from Word document
 * @param {File} file - Word file
 * @returns {Promise<string>} Extracted text
 */
async function extractTextFromWord(file) {
  // Send to backend API for processing
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/extract-text/word', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      },
      body: formData
    });
    
    if (!response.ok) throw new Error('Failed to extract text');
    
    const data = await response.json();
    return data.text || '';
  } catch (err) {
    console.error('Error extracting Word text:', err);
    return '';
  }
}

// ============ AI INTEGRATION ============

/**
 * Analyze file content with AI
 * @param {Object} fileObj - File object with content
 * @param {Object} config - Magic Folder configuration
 * @returns {Promise<Object>} Analysis result with suggested name
 */
async function analyzeFileWithAI(fileObj, config) {
  // Check rate limit
  await checkRateLimit();
  
  const { file, category, extension } = fileObj;
  
  try {
    // For images, use vision API
    if (category.type === 'image') {
      return await analyzeImageWithVision(file, config);
    }
    
    // For documents, use text analysis
    if (category.type === 'document') {
      const text = await extractTextFromFile(file);
      return await analyzeTextWithLLM(file.name, text, config);
    }
    
    // For other files, use filename and metadata
    return await analyzeMetadata(file, config);
    
  } catch (err) {
    console.error(`Error analyzing ${file.name}:`, err);
    MagicFolderProcessor.errors.push({
      file: file.name,
      error: err.message
    });
    return { suggestedName: file.name, confidence: 0 };
  }
}

/**
 * Analyze image with vision AI
 * @param {File} file - Image file
 * @param {Object} config - Configuration
 * @returns {Promise<Object>} Analysis result
 */
async function analyzeImageWithVision(file, config) {
  try {
    // Convert image to base64
    const base64 = await fileToBase64(file);
    
    // Get selected AI model from settings
    const aiModel = App.settings?.imageAiModel || 'gpt-4-vision-preview';
    
    // Prepare prompt based on template
    const prompt = generateVisionPrompt(config.template);
    
    // Call AI API
    const response = await fetch('/api/ai/vision', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${App.token}`
      },
      body: JSON.stringify({
        model: aiModel,
        image: base64,
        prompt: prompt,
        maxTokens: 100
      })
    });
    
    if (!response.ok) {
      throw new Error(`Vision API error: ${response.statusText}`);
    }
    
    const data = await response.json();
    const description = data.description || '';
    
    // Generate filename from description
    const suggestedName = generateFilenameFromDescription(
      description,
      file.name.split('.').pop(),
      config
    );
    
    return {
      suggestedName,
      description,
      confidence: data.confidence || 0.8
    };
    
  } catch (err) {
    console.error('Vision analysis error:', err);
    throw err;
  }
}

/**
 * Analyze text content with LLM
 * @param {string} filename - Original filename
 * @param {string} text - Extracted text
 * @param {Object} config - Configuration
 * @returns {Promise<Object>} Analysis result
 */
async function analyzeTextWithLLM(filename, text, config) {
  try {
    // Get selected AI model from settings
    const aiModel = App.settings?.textAiModel || 'gpt-4-turbo-preview';
    
    // Prepare prompt based on template
    const prompt = generateTextAnalysisPrompt(filename, text, config.template);
    
    // Call AI API
    const response = await fetch('/api/ai/text', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${App.token}`
      },
      body: JSON.stringify({
        model: aiModel,
        prompt: prompt,
        maxTokens: 100,
        temperature: 0.3
      })
    });
    
    if (!response.ok) {
      throw new Error(`Text API error: ${response.statusText}`);
    }
    
    const data = await response.json();
    const suggestedName = data.suggestedName || filename;
    
    // Apply formatting rules
    const formattedName = applyFormattingRules(suggestedName, config);
    
    return {
      suggestedName: formattedName,
      confidence: data.confidence || 0.8
    };
    
  } catch (err) {
    console.error('Text analysis error:', err);
    throw err;
  }
}

/**
 * Analyze file metadata (fallback)
 * @param {File} file - File object
 * @param {Object} config - Configuration
 * @returns {Promise<Object>} Analysis result
 */
async function analyzeMetadata(file, config) {
  // Use filename and metadata for basic renaming
  const ext = file.name.split('.').pop();
  const nameWithoutExt = file.name.replace(`.${ext}`, '');
  
  // Clean up filename
  let cleanName = nameWithoutExt
    .replace(/[_-]+/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();
  
  // Apply formatting
  cleanName = applyFormattingRules(cleanName, config);
  
  return {
    suggestedName: `${cleanName}.${ext}`,
    confidence: 0.5
  };
}

// ============ PROMPT GENERATION ============

/**
 * Generate vision analysis prompt
 * @param {string} template - Template name
 * @returns {string} Prompt
 */
function generateVisionPrompt(template) {
  const basePrompt = 'Analyze this image and provide a clear, descriptive filename.';
  
  switch (template) {
    case 'business':
      return `${basePrompt} Focus on business context: document type, company name, date if visible. Format: DocumentType_Company_Date`;
    case 'invoice':
      return `${basePrompt} This is an invoice. Extract: Invoice_CompanyName_YYYYMMDD`;
    case 'project':
      return `${basePrompt} This is a project file. Format: ProjectName_FileType_Description`;
    default:
      return `${basePrompt} Use format: Type_Subject_Description. Be concise and descriptive.`;
  }
}

/**
 * Generate text analysis prompt
 * @param {string} filename - Original filename
 * @param {string} text - File content
 * @param {string} template - Template name
 * @returns {string} Prompt
 */
function generateTextAnalysisPrompt(filename, text, template) {
  const preview = text.substring(0, 1000); // First 1000 chars
  
  const basePrompt = `Analyze this document and suggest a clear, descriptive filename.

Original filename: ${filename}
Content preview: ${preview}

`;
  
  switch (template) {
    case 'business':
      return `${basePrompt}Format: DocumentType_Client_Date_v1
Example: Contract_AcmeCorp_2024-12-19_v1.pdf
Respond with only the suggested filename.`;
      
    case 'invoice':
      return `${basePrompt}Format: Invoice_CompanyName_YYYYMMDD
Example: Invoice_Stripe_20241219.pdf
Respond with only the suggested filename.`;
      
    case 'project':
      return `${basePrompt}Format: ProjectName_FileType_Description
Example: Soul7_Design_Female_Mockup.png
Respond with only the suggested filename.`;
      
    default:
      return `${basePrompt}Format: Type_Subject_KeyDetails
Be concise and descriptive. Use underscores between words.
Respond with only the suggested filename.`;
  }
}

// ============ FILENAME FORMATTING ============

/**
 * Generate filename from AI description
 * @param {string} description - AI description
 * @param {string} extension - File extension
 * @param {Object} config - Configuration
 * @returns {string} Formatted filename
 */
function generateFilenameFromDescription(description, extension, config) {
  let name = description
    .replace(/[^a-zA-Z0-9\s-]/g, '') // Remove special chars
    .replace(/\s+/g, '_') // Replace spaces with underscores
    .substring(0, 100); // Limit length
  
  name = applyFormattingRules(name, config);
  
  return `${name}.${extension}`;
}

/**
 * Apply formatting rules from configuration
 * @param {string} name - Filename without extension
 * @param {Object} config - Configuration
 * @returns {string} Formatted name
 */
function applyFormattingRules(name, config) {
  // Apply text format
  switch (config.textFormat) {
    case 'lowercase':
      name = name.toLowerCase();
      break;
    case 'uppercase':
      name = name.toUpperCase();
      break;
    case 'title':
      name = toTitleCase(name);
      break;
    case 'camel':
      name = toCamelCase(name);
      break;
    case 'snake':
      name = toSnakeCase(name);
      break;
  }
  
  // Apply space option
  switch (config.spaceOption) {
    case '-':
      name = name.replace(/_/g, '-');
      break;
    case ' ':
      name = name.replace(/_/g, ' ');
      break;
    case 'none':
      name = name.replace(/[_\s-]/g, '');
      break;
    // 'auto' and '_' keep underscores
  }
  
  return name;
}

// Helper functions for text formatting
function toTitleCase(str) {
  return str.replace(/\w\S*/g, txt => 
    txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase()
  );
}

function toCamelCase(str) {
  return str.replace(/[_\s-](.)/g, (_, c) => c.toUpperCase())
    .replace(/^(.)/, c => c.toLowerCase());
}

function toSnakeCase(str) {
  return str.replace(/\s+/g, '_').replace(/-/g, '_').toLowerCase();
}

// ============ RATE LIMITING ============

/**
 * Check and enforce rate limiting
 * @returns {Promise<void>}
 */
async function checkRateLimit() {
  const now = Date.now();
  
  // Reset counter if minute has passed
  if (now >= MagicFolderProcessor.rateLimiter.resetTime) {
    MagicFolderProcessor.rateLimiter.requests = 0;
    MagicFolderProcessor.rateLimiter.resetTime = now + 60000;
  }
  
  // Check if limit exceeded
  if (MagicFolderProcessor.rateLimiter.requests >= MagicFolderProcessor.rateLimiter.maxRequestsPerMinute) {
    const waitTime = MagicFolderProcessor.rateLimiter.resetTime - now;
    console.log(`Rate limit reached, waiting ${waitTime}ms`);
    await new Promise(resolve => setTimeout(resolve, waitTime));
    
    // Reset after waiting
    MagicFolderProcessor.rateLimiter.requests = 0;
    MagicFolderProcessor.rateLimiter.resetTime = Date.now() + 60000;
  }
  
  // Increment counter
  MagicFolderProcessor.rateLimiter.requests++;
}

// ============ FILE PROCESSING QUEUE ============

/**
 * Process Magic Folder
 * @param {string} folderId - Magic Folder ID
 * @returns {Promise<void>}
 */
async function processMagicFolderWithAI(folderId) {
  const folder = MagicFolders.folders.find(f => f.id === folderId);
  if (!folder || !folder.active) {
    console.log('Folder not found or inactive');
    return;
  }
  
  // Check if already processing
  if (MagicFolderProcessor.processing) {
    toast('Already Processing', 'Please wait for current processing to complete', 'warning');
    return;
  }
  
  MagicFolderProcessor.processing = true;
  MagicFolderProcessor.currentFolder = folder;
  MagicFolderProcessor.processedFiles = 0;
  MagicFolderProcessor.errors = [];
  
  try {
    // Update UI
    updateProcessingStatus(folder.id, 'Scanning folder...');
    
    // Get folder handle (in real implementation, retrieve from IndexedDB)
    // For now, prompt user to select again
    const dirHandle = await window.showDirectoryPicker({
      mode: 'readwrite'
    });
    
    // Scan folder for files
    const files = await scanFolder(dirHandle, folder);
    MagicFolderProcessor.totalFiles = files.length;
    folder.filesTotal = files.length;
    
    if (files.length === 0) {
      toast('No Files Found', 'No files matching the selected extensions were found', 'info');
      MagicFolderProcessor.processing = false;
      return;
    }
    
    updateProcessingStatus(folder.id, `Processing ${files.length} files...`);
    
    // Process files in batches
    const batchSize = 5;
    const results = [];
    
    for (let i = 0; i < files.length; i += batchSize) {
      const batch = files.slice(i, i + batchSize);
      
      // Process batch concurrently
      const batchResults = await Promise.all(
        batch.map(fileObj => processFile(fileObj, folder))
      );
      
      results.push(...batchResults);
      
      // Update progress
      MagicFolderProcessor.processedFiles = Math.min(i + batchSize, files.length);
      folder.filesProcessed = MagicFolderProcessor.processedFiles;
      
      updateProcessingProgress(folder.id, MagicFolderProcessor.processedFiles, MagicFolderProcessor.totalFiles);
      
      // Save results incrementally
      saveProcessingResults(folder.id, results);
    }
    
    // Save final state
    folder.filesProcessed = results.filter(r => r.success).length;
    DB.set('magicFolders', MagicFolders.folders);
    
    // Update UI
    renderMagicFoldersList();
    
    toast('Processing Complete', `Renamed ${folder.filesProcessed} files`, 'success');
    
  } catch (err) {
    console.error('Processing error:', err);
    toast('Processing Failed', err.message, 'error');
  } finally {
    MagicFolderProcessor.processing = false;
    MagicFolderProcessor.currentFolder = null;
  }
}

/**
 * Process single file
 * @param {Object} fileObj - File object
 * @param {Object} folder - Folder configuration
 * @returns {Promise<Object>} Processing result
 */
async function processFile(fileObj, folder) {
  try {
    // Analyze file with AI
    const analysis = await analyzeFileWithAI(fileObj, folder);
    
    // Generate new filename
    const newName = analysis.suggestedName;
    
    // Determine target subfolder
    const subfolder = fileObj.category.subfolder;
    
    // In real implementation, rename and move file
    // For now, just return the result
    
    return {
      success: true,
      oldName: fileObj.name,
      newName: newName,
      subfolder: subfolder,
      confidence: analysis.confidence,
      timestamp: Date.now()
    };
    
  } catch (err) {
    return {
      success: false,
      oldName: fileObj.name,
      error: err.message,
      timestamp: Date.now()
    };
  }
}

// ============ PROGRESS TRACKING ============

/**
 * Update processing status
 * @param {string} folderId - Folder ID
 * @param {string} status - Status message
 */
function updateProcessingStatus(folderId, status) {
  const folderCard = document.querySelector(`[data-folder-id="${folderId}"]`);
  if (folderCard) {
    const statusEl = folderCard.querySelector('.magic-folder-status');
    if (statusEl) {
      statusEl.textContent = status;
    }
  }
}

/**
 * Update processing progress
 * @param {string} folderId - Folder ID
 * @param {number} processed - Files processed
 * @param {number} total - Total files
 */
function updateProcessingProgress(folderId, processed, total) {
  const folderCard = document.querySelector(`[data-folder-id="${folderId}"]`);
  if (folderCard) {
    const statsEl = folderCard.querySelector('.magic-folder-stats');
    if (statsEl) {
      statsEl.innerHTML = `
        <div class="magic-folder-stat">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"/>
            <polyline points="13 2 13 9 20 9"/>
          </svg>
          <span>${total} files</span>
        </div>
        <div style="color:var(--text-muted)">|</div>
        <div class="magic-folder-stat" style="color:var(--orange)">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
          <span>${processed} named</span>
        </div>
      `;
    }
  }
}

/**
 * Save processing results
 * @param {string} folderId - Folder ID
 * @param {Array} results - Processing results
 */
function saveProcessingResults(folderId, results) {
  const key = `magicFolderResults_${folderId}`;
  DB.set(key, results);
}

/**
 * Load processing results
 * @param {string} folderId - Folder ID
 * @returns {Array} Processing results
 */
function loadProcessingResults(folderId) {
  const key = `magicFolderResults_${folderId}`;
  return DB.get(key) || [];
}

// ============ UTILITY FUNCTIONS ============

/**
 * Convert file to base64
 * @param {File} file - File object
 * @returns {Promise<string>} Base64 string
 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => resolve(reader.result.split(',')[1]);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}


// ============ INIT ============
function init() {
  // Check URL params for OAuth callback
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  const userParam = params.get('user');
  const resetToken = params.get('reset');
  const upgradeStatus = params.get('upgrade');
  const upgradePlan = params.get('plan');
  
  // Handle password reset token
  if (resetToken) {
    window.resetToken = resetToken;
    showAuthModal('reset');
    window.history.replaceState({}, document.title, '/');
    return;
  }
  
  // Handle upgrade callback
  if (upgradeStatus === 'success' && upgradePlan) {
    toast('Success', `Successfully upgraded to ${upgradePlan.charAt(0).toUpperCase() + upgradePlan.slice(1)}!`, 'success');
    // Refresh user data
    setTimeout(async () => {
      try {
        const userData = await apiCall('/auth/me');
        App.currentUser = userData;
        App.isGodMode = userData.isGod === true;
        DB.set('user', App.currentUser);
        updateNav();
      } catch (e) { console.error(e); }
    }, 500);
    window.history.replaceState({}, document.title, '/');
  } else if (upgradeStatus === 'cancelled') {
    toast('Cancelled', 'Upgrade was cancelled', 'error');
    window.history.replaceState({}, document.title, '/');
  }
  
  if (token && userParam) {
    try {
      App.token = token;
      App.currentUser = JSON.parse(decodeURIComponent(userParam));
      App.isLoggedIn = true;
      App.isGodMode = App.currentUser.isGod === true;
      DB.set('token', App.token);
      DB.set('user', App.currentUser);
      window.history.replaceState({}, document.title, '/');
      updateNav();
      nav('pageApp');
      updateTopNavigation();
    } catch (e) {
      console.error('OAuth callback error:', e);
    }
  } else {
    // Check stored auth
    App.token = DB.get('token');
    App.currentUser = DB.get('user');
    if (App.token && App.currentUser) {
      App.isLoggedIn = true;
      App.isGodMode = App.currentUser.isGod === true;
      
      // Verify token is still valid and get fresh user data
      apiCall('/auth/me').then(userData => {
        App.currentUser = userData;
        App.isGodMode = userData.isGod === true; // FIX: Update isGodMode from fresh data
        DB.set('user', App.currentUser);
        console.log('User loaded:', userData.email, 'Plan:', userData.plan, 'isGod:', userData.isGod);
        updateNav();
        nav('pageApp');
        updateTopNavigation();
      }).catch(() => {
        // Token expired, logout
        logout();
      });
    } else {
      // Not logged in, show landing page
      updateNav();
      nav('pageLanding');
    }
  }
}


// ============ NEW UI FUNCTIONS ============
function switchAppView(view) {
  // Update active state on nav items
  document.querySelectorAll('.app-nav-item').forEach(item => {
    item.classList.remove('active');
  });
  event.target.closest('.app-nav-item').classList.add('active');
  
  // For now, all views show the same rename interface
  // In the future, these could show different interfaces
  console.log('Switched to view:', view);
}

function updateTopNavigation() {
  const appTopNav = $('appTopNav');
  const godModeNavBtn = $('godModeNavBtn');
  
  if (App.isLoggedIn) {
    appTopNav.style.display = 'block';
    
    // Show God Mode button if user is god
    if (App.isGodMode && godModeNavBtn) {
      godModeNavBtn.style.display = 'flex';
    }
    
    // Update plan indicator
    updatePlanIndicator();
  } else {
    appTopNav.style.display = 'none';
  }
}

function updatePlanIndicator() {
  const user = App.currentUser;
  if (!user) return;
  
  const plan = user.plan || 'free';
  const displayPlan = (App.isGodMode && App.testPlan !== 'god') ? App.testPlan : plan;
  const usage = user.usage || { filesThisMonth: 0 };
  const limits = PLAN_LIMITS[displayPlan] || PLAN_LIMITS.free;
  
  const planNameTop = $('planNameTop');
  const usageCountTop = $('usageCountTop');
  const usageLimitTop = $('usageLimitTop');
  const usageNumberBadge = $('usageNumberBadge');
  
  if (planNameTop) {
    planNameTop.textContent = displayPlan.charAt(0).toUpperCase() + displayPlan.slice(1);
  }
  
  if (usageCountTop) {
    usageCountTop.textContent = usage.filesThisMonth || 0;
  }
  
  if (usageLimitTop) {
    usageLimitTop.textContent = limits.files === 999999 ? 'âˆž' : limits.files;
  }
  
  if (usageNumberBadge) {
    usageNumberBadge.textContent = usage.filesThisMonth || 0;
  }
}

// Override the existing updateNav function to include top nav updates
const originalUpdateNav = updateNav;
updateNav = function() {
  originalUpdateNav();
  updateTopNavigation();
};

// Run init on page load
init();


// ============ FRONTEND INTEGRATION ============
// ============ FRONTEND INTEGRATION ============
// Complete frontend code to integrate with backend APIs
// Includes enable/disable switches, workflows, and UI updates



// ============ PHASE 1 FEATURES IMPLEMENTATION ============
// Critical UX improvements for NameWizard.io

// ============ FEATURE 1: CANCEL IN-PROGRESS FILES ============

// Track active file processing
App.activeProcessing = new Map(); // fileId -> {xhr, status, controller}

/**
 * Process file with cancellation support
 */
async function processFileWithCancel(file, fileId) {
  const controller = new AbortController();
  
  // Store processing info
  App.activeProcessing.set(fileId, {
    controller,
    status: 'processing',
    fileName: file.name,
    startTime: Date.now()
  });
  
  // Update UI to show cancel button
  showCancelButton(fileId);
  
  try {
    const result = await fetch('/api/ai/rename', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${App.token}`
      },
      body: JSON.stringify({ file: await prepareFileForAPI(file) }),
      signal: controller.signal
    });
    
    if (!result.ok) throw new Error('Processing failed');
    
    const data = await result.json();
    
    // Remove from active processing
    App.activeProcessing.delete(fileId);
    hideCancelButton(fileId);
    
    return data;
    
  } catch (error) {
    if (error.name === 'AbortError') {
      // File was cancelled
      App.activeProcessing.delete(fileId);
      return { cancelled: true, fileName: file.name };
    }
    throw error;
  }
}

/**
 * Cancel file processing
 */
function cancelFileProcessing(fileId) {
  const processing = App.activeProcessing.get(fileId);
  
  if (processing) {
    processing.controller.abort();
    processing.status = 'cancelled';
    
    // Update UI
    updateFileStatus(fileId, 'cancelled');
    toast('Cancelled', `Processing cancelled for ${processing.fileName}`, 'info');
  }
}

/**
 * Cancel all active processing
 */
function cancelAllProcessing() {
  const count = App.activeProcessing.size;
  
  for (const [fileId, processing] of App.activeProcessing) {
    processing.controller.abort();
    updateFileStatus(fileId, 'cancelled');
  }
  
  App.activeProcessing.clear();
  
  toast('All Cancelled', `Cancelled ${count} file(s)`, 'info');
}

/**
 * Show cancel button for file
 */
function showCancelButton(fileId) {
  const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
  if (fileRow) {
    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'cancel-btn';
    cancelBtn.innerHTML = 'âœ• Cancel';
    cancelBtn.onclick = () => cancelFileProcessing(fileId);
    fileRow.appendChild(cancelBtn);
  }
}

/**
 * Hide cancel button for file
 */
function hideCancelButton(fileId) {
  const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
  if (fileRow) {
    const cancelBtn = fileRow.querySelector('.cancel-btn');
    if (cancelBtn) cancelBtn.remove();
  }
}

/**
 * Update file status in UI
 */
function updateFileStatus(fileId, status) {
  const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
  if (fileRow) {
    const statusEl = fileRow.querySelector('.file-status');
    if (statusEl) {
      statusEl.textContent = status;
      statusEl.className = `file-status status-${status}`;
    }
  }
}

// ============ FEATURE 2: RENAME ALL BUTTON LOGIC ============

/**
 * Check if all files are processed
 */
function checkAllFilesProcessed() {
  const files = App.uploadedFiles || [];
  const processed = files.filter(f => f.status === 'completed' || f.status === 'renamed').length;
  
  const renameAllBtn = document.getElementById('rename-all-btn');
  
  if (renameAllBtn) {
    if (processed === files.length && files.length > 0) {
      renameAllBtn.style.display = 'block';
      renameAllBtn.disabled = false;
    } else {
      renameAllBtn.style.display = 'none';
    }
  }
}

/**
 * Rename all files
 */
async function renameAllFiles() {
  const files = App.uploadedFiles || [];
  const filesToRename = files.filter(f => f.status === 'completed' && f.suggestedName);
  
  if (filesToRename.length === 0) {
    toast('No Files', 'No files ready to rename', 'warning');
    return;
  }
  
  // Show confirmation
  const confirmed = confirm(`Rename ${filesToRename.length} file(s)?`);
  if (!confirmed) return;
  
  // Rename all files
  for (const file of filesToRename) {
    file.newName = file.suggestedName;
    file.status = 'renamed';
  }
  
  // Update UI
  renderUploadedFiles();
  toast('Success', `Renamed ${filesToRename.length} file(s)`, 'success');
  
  // Hide rename all button
  document.getElementById('rename-all-btn').style.display = 'none';
}

// ============ FEATURE 3: EXIF DATA EXTRACTION ============

/**
 * Extract EXIF data from image
 */
async function extractEXIFData(file) {
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/files/extract-exif', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      },
      body: formData
    });
    
    if (!response.ok) throw new Error('EXIF extraction failed');
    
    const exifData = await response.json();
    return exifData;
    
  } catch (error) {
    console.error('EXIF extraction error:', error);
    return null;
  }
}

/**
 * Display EXIF data in UI
 */
function displayEXIFData(fileId, exifData) {
  const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
  if (!fileRow || !exifData) return;
  
  const exifContainer = document.createElement('div');
  exifContainer.className = 'exif-data';
  exifContainer.innerHTML = `
    <div class="exif-row">
      <span class="exif-label">ðŸ“… Date:</span>
      <span class="exif-value">${exifData.date || 'N/A'}</span>
    </div>
    ${exifData.camera ? `
    <div class="exif-row">
      <span class="exif-label">ðŸ“· Camera:</span>
      <span class="exif-value">${exifData.camera}</span>
    </div>
    ` : ''}
    ${exifData.location.latitude ? `
    <div class="exif-row">
      <span class="exif-label">ðŸ“ Location:</span>
      <span class="exif-value">${exifData.location.latitude}, ${exifData.location.longitude}</span>
    </div>
    ` : ''}
    ${exifData.dimensions.width ? `
    <div class="exif-row">
      <span class="exif-label">ðŸ“ Size:</span>
      <span class="exif-value">${exifData.dimensions.width}x${exifData.dimensions.height}</span>
    </div>
    ` : ''}
  `;
  
  fileRow.appendChild(exifContainer);
}

// ============ FEATURE 4: IMAGE THUMBNAILS ============

/**
 * Generate thumbnail for image
 */
async function generateThumbnail(file) {
  try {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('width', '200');
    formData.append('height', '200');
    
    const response = await fetch('/api/files/generate-thumbnail', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      },
      body: formData
    });
    
    if (!response.ok) throw new Error('Thumbnail generation failed');
    
    const blob = await response.blob();
    return URL.createObjectURL(blob);
    
  } catch (error) {
    console.error('Thumbnail generation error:', error);
    return null;
  }
}

/**
 * Display thumbnail in UI
 */
function displayThumbnail(fileId, thumbnailUrl) {
  const fileRow = document.querySelector(`[data-file-id="${fileId}"]`);
  if (!fileRow || !thumbnailUrl) return;
  
  const thumbnail = document.createElement('img');
  thumbnail.src = thumbnailUrl;
  thumbnail.className = 'file-thumbnail';
  thumbnail.alt = 'Thumbnail';
  
  // Insert at beginning of file row
  fileRow.insertBefore(thumbnail, fileRow.firstChild);
}

// ============ FEATURE 5: CUSTOM INSTRUCTIONS UI ============

/**
 * Show custom instructions modal
 */
function showCustomInstructionsModal() {
  const modal = document.createElement('div');
  modal.id = 'custom-instructions-modal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h2>Custom Renaming Instructions</h2>
        <button class="modal-close" onclick="closeCustomInstructionsModal()">âœ•</button>
      </div>
      <div class="modal-body">
        <p>Provide specific instructions for how you want your files renamed:</p>
        <textarea 
          id="custom-instructions-input" 
          placeholder="Example: Use descriptive names based on file content. Include dates in YYYY-MM-DD format. Use underscores instead of spaces."
          rows="6"
        >${App.settings.customInstructions || ''}</textarea>
        <div class="instructions-examples">
          <h4>Examples:</h4>
          <ul>
            <li>Include project name prefix for all files</li>
            <li>Use client name in filename</li>
            <li>Add version numbers (v1, v2, etc.)</li>
            <li>Keep filenames under 50 characters</li>
          </ul>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" onclick="closeCustomInstructionsModal()">Cancel</button>
        <button class="btn-primary" onclick="saveCustomInstructions()">Save Instructions</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

/**
 * Close custom instructions modal
 */
function closeCustomInstructionsModal() {
  const modal = document.getElementById('custom-instructions-modal');
  if (modal) modal.remove();
}

/**
 * Save custom instructions
 */
function saveCustomInstructions() {
  const input = document.getElementById('custom-instructions-input');
  const instructions = input.value.trim();
  
  App.settings.customInstructions = instructions;
  DB.set('settings', App.settings);
  
  toast('Saved', 'Custom instructions saved', 'success');
  closeCustomInstructionsModal();
}

// ============ FEATURE 6: MEANINGFUL ERROR MESSAGES ============

/**
 * Enhanced error handler with meaningful messages
 */
function handleError(error, context = '') {
  let message = 'An error occurred';
  let details = '';
  
  // Parse error type
  if (error.message.includes('rate limit')) {
    message = 'Rate Limit Exceeded';
    details = 'Too many requests. Please wait a moment and try again.';
  } else if (error.message.includes('authentication')) {
    message = 'Authentication Error';
    details = 'Please log in again to continue.';
  } else if (error.message.includes('network') || error.message.includes('fetch')) {
    message = 'Network Error';
    details = 'Unable to connect to server. Check your internet connection.';
  } else if (error.message.includes('timeout')) {
    message = 'Request Timeout';
    details = 'The operation took too long. Please try again.';
  } else if (error.message.includes('file size')) {
    message = 'File Too Large';
    details = 'Maximum file size is 100MB. Please use a smaller file.';
  } else if (error.message.includes('unsupported')) {
    message = 'Unsupported File Type';
    details = 'This file type is not supported. Please use a different file.';
  } else if (error.message.includes('OCR')) {
    message = 'OCR Error';
    details = 'Text extraction failed. The image may be too blurry or low quality.';
  } else if (error.message.includes('AI') || error.message.includes('provider')) {
    message = 'AI Processing Error';
    details = 'The AI service is temporarily unavailable. Please try again.';
  } else {
    message = 'Error';
    details = error.message;
  }
  
  // Add context if provided
  if (context) {
    details = `${context}: ${details}`;
  }
  
  // Show error toast with details
  toast(message, details, 'error', 5000);
  
  // Log for debugging
  console.error(`[${message}]`, error);
  
  return { message, details };
}

// ============ FEATURE 7: TEXT-BASED PDF SUPPORT ============

/**
 * Extract text from PDF (non-OCR)
 */
async function extractTextFromPDF(file) {
  try {
    const formData = new FormData();
    formData.append('file', file);
    
    const response = await fetch('/api/files/extract-text-pdf', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      },
      body: formData
    });
    
    if (!response.ok) throw new Error('PDF text extraction failed');
    
    const data = await response.json();
    return data;
    
  } catch (error) {
    console.error('PDF text extraction error:', error);
    // Fall back to OCR if text extraction fails
    return null;
  }
}

/**
 * Process PDF with text extraction or OCR fallback
 */
async function processPDF(file) {
  // Try text extraction first
  let textData = await extractTextFromPDF(file);
  
  // If no text found, try OCR
  if (!textData || !textData.text || textData.text.trim().length < 10) {
    console.log('PDF appears to be image-based, using OCR...');
    textData = await extractTextWithOCR(file, { language: 'eng' });
  }
  
  return textData;
}

// ============ UI ENHANCEMENTS ============

/**
 * Add CSS for new features
 */
function addPhase1CSS() {
  const style = document.createElement('style');
  style.textContent = `
    /* Cancel button */
    .cancel-btn {
      background: var(--danger, #dc3545);
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      margin-left: 10px;
    }
    
    .cancel-btn:hover {
      opacity: 0.8;
    }
    
    /* File status */
    .file-status {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-processing {
      background: rgba(255, 140, 0, 0.2);
      color: var(--orange);
    }
    
    .status-completed {
      background: rgba(0, 255, 0, 0.2);
      color: #00ff00;
    }
    
    .status-cancelled {
      background: rgba(255, 0, 0, 0.2);
      color: #ff4444;
    }
    
    /* Rename All button */
    #rename-all-btn {
      background: var(--orange);
      color: black;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin: 20px auto;
      display: none;
    }
    
    #rename-all-btn:hover {
      opacity: 0.9;
    }
    
    /* EXIF data */
    .exif-data {
      background: rgba(255, 140, 0, 0.1);
      padding: 10px;
      border-radius: 6px;
      margin-top: 10px;
      font-size: 12px;
    }
    
    .exif-row {
      display: flex;
      justify-content: space-between;
      margin: 4px 0;
    }
    
    .exif-label {
      color: var(--text-muted);
    }
    
    .exif-value {
      color: var(--orange);
      font-weight: 500;
    }
    
    /* Thumbnail */
    .file-thumbnail {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 6px;
      margin-right: 12px;
      border: 2px solid var(--orange);
    }
    
    /* Custom instructions modal */
    #custom-instructions-modal textarea {
      width: 100%;
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid var(--orange);
      color: white;
      padding: 12px;
      border-radius: 6px;
      font-family: inherit;
      resize: vertical;
    }
    
    .instructions-examples {
      margin-top: 20px;
      padding: 12px;
      background: rgba(255, 140, 0, 0.1);
      border-radius: 6px;
    }
    
    .instructions-examples h4 {
      color: var(--orange);
      margin-bottom: 8px;
    }
    
    .instructions-examples ul {
      margin: 0;
      padding-left: 20px;
    }
    
    .instructions-examples li {
      margin: 4px 0;
      color: var(--text-muted);
    }
  `;
  
  document.head.appendChild(style);
}

// Initialize Phase 1 features
function initPhase1Features() {
  addPhase1CSS();
  
  // Add Rename All button if it doesn't exist
  if (!document.getElementById('rename-all-btn')) {
    const btn = document.createElement('button');
    btn.id = 'rename-all-btn';
    btn.textContent = 'Rename All Files';
    btn.onclick = renameAllFiles;
    
    const container = document.querySelector('.upload-container') || document.querySelector('.pageApp');
    if (container) {
      container.appendChild(btn);
    }
  }
  
  // Add custom instructions button to settings
  const settingsGeneral = document.querySelector('#settingsGeneral');
  if (settingsGeneral && !document.getElementById('custom-instructions-btn')) {
    const btn = document.createElement('button');
    btn.id = 'custom-instructions-btn';
    btn.className = 'settings-btn';
    btn.textContent = 'âœï¸ Custom Instructions';
    btn.onclick = showCustomInstructionsModal;
    settingsGeneral.appendChild(btn);
  }
}

// Run initialization when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPhase1Features);
} else {
  initPhase1Features();
}


// ============ AI RENAMING WORKFLOW ============

/**
 * Rename single file with AI
 */
async function renameFileWithAI(file, options = {}) {
  try {
    // Show loading state
    showProcessingIndicator('Analyzing file...');
    
    // Prepare file data
    const fileData = await prepareFileForAPI(file);
    
    // Get user settings
    const settings = getUserSettings();
    
    // Call AI renaming API
    const response = await fetch('/api/ai/rename', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${App.token}`
      },
      body: JSON.stringify({
        file: fileData,
        primaryProvider: settings.primaryAIProvider || 'openai',
        backupProvider: settings.backupAIProvider || 'anthropic',
        customInstructions: settings.customInstructions || '',
        template: options.template || 'auto',
        textFormat: settings.textFormat || 'title',
        spaceOption: settings.spaceOption || '_',
        dateFormat: settings.dateFormat || 'YYYY-MM-DD'
      })
    });
    
    if (!response.ok) {
      throw new Error(`API error: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    // Hide loading state
    hideProcessingIndicator();
    
    // Show result
    displayRenameResult(file.name, result.suggestedName, result.confidence);
    
    // Update usage counter
    incrementUsageCounter();
    
    return result;
    
  } catch (error) {
    hideProcessingIndicator();
    toast('Error', error.message, 'error');
    throw error;
  }
}

/**
 * Rename multiple files in batch
 */
async function batchRenameFiles(files, options = {}) {
  try {
    // Create batch job
    const response = await fetch('/api/batch/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${App.token}`
      },
      body: JSON.stringify({
        files: await Promise.all(files.map(f => prepareFileForAPI(f))),
        options: {
          maxConcurrent: 5,
          retryAttempts: 3
        }
      })
    });
    
    const { jobId } = await response.json();
    
    // Start batch job
    await fetch(`/api/batch/${jobId}/start`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${App.token}`
      },
      body: JSON.stringify({
        processingType: 'rename'
      })
    });
    
    // Monitor progress
    monitorBatchJob(jobId);
    
    return jobId;
    
  } catch (error) {
    toast('Batch Error', error.message, 'error');
    throw error;
  }
}

/**
 * Monitor batch job progress
 */
async function monitorBatchJob(jobId) {
  const progressModal = showBatchProgressModal(jobId);
  
  const interval = setInterval(async () => {
    try {
      const response = await fetch(`/api/batch/${jobId}/status`, {
        headers: {
          'Authorization': `Bearer ${App.token}`
        }
      });
      
      const status = await response.json();
      
      // Update progress UI
      updateBatchProgress(progressModal, status.progress);
      
      // Check if completed
      if (status.status === 'completed' || status.status === 'failed' || status.status === 'cancelled') {
        clearInterval(interval);
        
        if (status.status === 'completed') {
          toast('Batch Complete', `Processed ${status.progress.processed} files`, 'success');
        }
        
        closeBatchProgressModal(progressModal);
      }
      
    } catch (error) {
      clearInterval(interval);
      toast('Error', 'Failed to get batch status', 'error');
    }
  }, 1000);
}

// ============ OCR WORKFLOW ============

/**
 * Extract text from image using OCR
 */
async function extractTextWithOCR(file, options = {}) {
  try {
    // Check if OCR is enabled
    const ocrStatus = await getOCRStatus();
    if (!ocrStatus.enabled) {
      throw new Error('OCR is currently disabled. Enable it in Settings.');
    }
    
    // Show loading state
    showProcessingIndicator('Extracting text with OCR...');
    
    // Prepare form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('language', options.language || 'eng');
    formData.append('preprocess', options.preprocess !== false);
    
    // Call OCR API
    const response = await fetch('/api/ocr/image', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`OCR failed: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    // Hide loading state
    hideProcessingIndicator();
    
    // Display extracted text
    displayOCRResult(result);
    
    // Update usage counter
    incrementUsageCounter();
    
    return result;
    
  } catch (error) {
    hideProcessingIndicator();
    toast('OCR Error', error.message, 'error');
    throw error;
  }
}

/**
 * Extract structured data from document
 */
async function extractStructuredData(file, documentType) {
  try {
    const ocrStatus = await getOCRStatus();
    if (!ocrStatus.enabled) {
      throw new Error('OCR is currently disabled');
    }
    
    showProcessingIndicator(`Extracting ${documentType} data...`);
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('documentType', documentType);
    formData.append('language', 'eng');
    
    const response = await fetch('/api/ocr/structured', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      },
      body: formData
    });
    
    if (!response.ok) {
      throw new Error(`Structured extraction failed: ${response.statusText}`);
    }
    
    const result = await response.json();
    
    hideProcessingIndicator();
    displayStructuredDataResult(result);
    
    return result;
    
  } catch (error) {
    hideProcessingIndicator();
    toast('Extraction Error', error.message, 'error');
    throw error;
  }
}

// ============ ENABLE/DISABLE SWITCHES ============

/**
 * Toggle OCR on/off
 */
async function toggleOCR(enabled) {
  try {
    const endpoint = enabled ? '/api/ocr/enable' : '/api/ocr/disable';
    
    const response = await fetch(endpoint, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${App.token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to toggle OCR');
    }
    
    const result = await response.json();
    
    // Update UI
    updateOCRToggleUI(enabled);
    
    // Save to settings
    App.settings.ocrEnabled = enabled;
    DB.set('settings', App.settings);
    
    toast('OCR ' + (enabled ? 'Enabled' : 'Disabled'), result.message, 'success');
    
  } catch (error) {
    toast('Error', error.message, 'error');
  }
}

/**
 * Get OCR status
 */
async function getOCRStatus() {
  try {
    const response = await fetch('/api/ocr/status', {
      headers: {
        'Authorization': `Bearer ${App.token}`
      }
    });
    
    if (!response.ok) {
      throw new Error('Failed to get OCR status');
    }
    
    return await response.json();
    
  } catch (error) {
    console.error('OCR status error:', error);
    return { enabled: false, stats: {} };
  }
}

/**
 * Set primary and backup AI providers
 */
function setAIProviders(primary, backup) {
  App.settings.primaryAIProvider = primary;
  App.settings.backupAIProvider = backup;
  DB.set('settings', App.settings);
  
  toast('AI Providers Updated', `Primary: ${primary}, Backup: ${backup}`, 'success');
}

// ============ UI HELPER FUNCTIONS ============

/**
 * Prepare file for API upload
 */
async function prepareFileForAPI(file) {
  const fileType = determineFileType(file.name);
  
  const fileData = {
    name: file.name,
    size: file.size,
    mimeType: file.type,
    extension: file.name.split('.').pop(),
    category: fileType
  };
  
  // For images, convert to base64
  if (fileType === 'image') {
    fileData.base64 = await fileToBase64(file);
  }
  
  // For documents, extract text
  if (fileType === 'document') {
    fileData.text = await extractTextFromFile(file);
  }
  
  return fileData;
}

/**
 * Convert file to base64
 */
function fileToBase64(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = reader.result.split(',')[1];
      resolve(base64);
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

/**
 * Extract text from file
 */
async function extractTextFromFile(file) {
  // For now, return empty string
  // Full implementation would use pdf-parse or mammoth
  return '';
}

/**
 * Determine file type
 */
function determineFileType(filename) {
  const ext = filename.split('.').pop().toLowerCase();
  
  const types = {
    image: ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'tiff', 'tif', 'heic'],
    document: ['pdf', 'doc', 'docx', 'txt', 'rtf', 'odt', 'md'],
    spreadsheet: ['xls', 'xlsx', 'csv'],
    presentation: ['ppt', 'pptx', 'key'],
    audio: ['mp3', 'wav', 'm4a', 'aac', 'flac'],
    video: ['mp4', 'mov', 'avi', 'mkv', 'webm']
  };
  
  for (const [type, extensions] of Object.entries(types)) {
    if (extensions.includes(ext)) {
      return type;
    }
  }
  
  return 'generic';
}

/**
 * Show processing indicator
 */
function showProcessingIndicator(message) {
  const indicator = document.createElement('div');
  indicator.id = 'processing-indicator';
  indicator.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0, 0, 0, 0.9);
    color: var(--orange);
    padding: 30px 50px;
    border-radius: 10px;
    z-index: 10000;
    font-size: 18px;
    text-align: center;
  `;
  indicator.innerHTML = `
    <div style="margin-bottom: 15px;">
      <div class="spinner"></div>
    </div>
    <div>${message}</div>
  `;
  document.body.appendChild(indicator);
}

/**
 * Hide processing indicator
 */
function hideProcessingIndicator() {
  const indicator = document.getElementById('processing-indicator');
  if (indicator) {
    indicator.remove();
  }
}

/**
 * Display rename result
 */
function displayRenameResult(oldName, newName, confidence) {
  const resultHTML = `
    <div class="rename-result">
      <div class="result-row">
        <span class="label">Original:</span>
        <span class="value">${oldName}</span>
      </div>
      <div class="result-row">
        <span class="label">Suggested:</span>
        <span class="value" style="color:var(--orange)">${newName}</span>
      </div>
      <div class="result-row">
        <span class="label">Confidence:</span>
        <span class="value">${Math.round(confidence * 100)}%</span>
      </div>
    </div>
  `;
  
  // Add to results container
  const container = document.getElementById('rename-results');
  if (container) {
    container.innerHTML = resultHTML + container.innerHTML;
  }
}

/**
 * Display OCR result
 */
function displayOCRResult(result) {
  const resultHTML = `
    <div class="ocr-result">
      <div class="ocr-stats">
        <span>Confidence: ${Math.round(result.confidence)}%</span>
        <span>Words: ${result.words}</span>
        <span>Language: ${result.language}</span>
      </div>
      <div class="ocr-text">
        <pre>${result.text}</pre>
      </div>
    </div>
  `;
  
  const container = document.getElementById('ocr-results');
  if (container) {
    container.innerHTML = resultHTML;
  }
}

/**
 * Display structured data result
 */
function displayStructuredDataResult(result) {
  const dataHTML = Object.entries(result.structuredData)
    .map(([key, value]) => `
      <div class="data-row">
        <span class="data-label">${key}:</span>
        <span class="data-value">${value || 'N/A'}</span>
      </div>
    `).join('');
  
  const resultHTML = `
    <div class="structured-data-result">
      <h3>${result.documentType} Data</h3>
      <div class="data-container">
        ${dataHTML}
      </div>
    </div>
  `;
  
  const container = document.getElementById('structured-data-results');
  if (container) {
    container.innerHTML = resultHTML;
  }
}

/**
 * Show batch progress modal
 */
function showBatchProgressModal(jobId) {
  const modal = document.createElement('div');
  modal.id = 'batch-progress-modal';
  modal.className = 'modal';
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Batch Processing</h2>
      <div class="progress-container">
        <div class="progress-bar">
          <div class="progress-fill" style="width: 0%"></div>
        </div>
        <div class="progress-text">0%</div>
      </div>
      <div class="progress-stats">
        <div>Processed: <span id="batch-processed">0</span></div>
        <div>Failed: <span id="batch-failed">0</span></div>
        <div>Total: <span id="batch-total">0</span></div>
      </div>
      <div class="modal-actions">
        <button onclick="pauseBatchJob('${jobId}')">Pause</button>
        <button onclick="cancelBatchJob('${jobId}')" class="danger">Cancel</button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  return modal;
}

/**
 * Update batch progress
 */
function updateBatchProgress(modal, progress) {
  const fill = modal.querySelector('.progress-fill');
  const text = modal.querySelector('.progress-text');
  
  fill.style.width = `${progress.percentage}%`;
  text.textContent = `${progress.percentage}%`;
  
  modal.querySelector('#batch-processed').textContent = progress.processed;
  modal.querySelector('#batch-failed').textContent = progress.failed;
  modal.querySelector('#batch-total').textContent = progress.total;
}

/**
 * Close batch progress modal
 */
function closeBatchProgressModal(modal) {
  modal.remove();
}

/**
 * Update OCR toggle UI
 */
function updateOCRToggleUI(enabled) {
  const toggle = document.getElementById('ocr-toggle');
  if (toggle) {
    toggle.checked = enabled;
  }
  
  const status = document.getElementById('ocr-status');
  if (status) {
    status.textContent = enabled ? 'Enabled' : 'Disabled';
    status.style.color = enabled ? 'var(--orange)' : 'var(--text-muted)';
  }
}

/**
 * Get user settings
 */
function getUserSettings() {
  return App.settings || {};
}

/**
 * Increment usage counter
 */
function incrementUsageCounter() {
  if (!App.currentUser) return;
  
  App.currentUser.usage = (App.currentUser.usage || 0) + 1;
  DB.set('user', App.currentUser);
  
  // Update UI
  updateUsageDisplay();
}

/**
 * Update usage display
 */
function updateUsageDisplay() {
  const usageEl = document.getElementById('usage-counter');
  if (usageEl && App.currentUser) {
    const limit = App.currentUser.plan === 'free' ? 15 : 
                  App.currentUser.plan === 'pro' ? 200 : 
                  App.currentUser.plan === 'business' ? 1000 : Infinity;
    
    usageEl.textContent = `${App.currentUser.usage || 0}/${limit === Infinity ? 'âˆž' : limit}`;
  }
}


// ============ API MANAGEMENT FUNCTIONS ============

// Enhanced API Management Functions

// Track modified API keys
const modifiedApiKeys = new Set();

// Mark API key as modified
function markApiKeyModified(provider) {
  modifiedApiKeys.add(provider);
  const input = document.getElementById(`apiKey${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
  if (input) {
    input.classList.add('modified');
  }
  const card = document.getElementById(`provider${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
  if (card) {
    card.classList.add('modified');
  }
}

// Edit API key (enable editing)
function editApiKey(provider) {
  const inputId = `apiKey${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
  const input = document.getElementById(inputId);
  if (input) {
    input.focus();
    input.select();
    toast('Edit Mode', 'You can now edit the API key', 'info');
  }
}

// Check for API updates
async function checkForUpdates(provider) {
  const btn = event.target.closest('button');
  if (!btn) return;
  
  btn.classList.add('loading');
  btn.disabled = true;
  
  try {
    const response = await apiCall(`/api-keys/check-updates/${provider}`, 'GET');
    
    if (response.hasUpdate) {
      // Show update notification
      const versionEl = document.getElementById(`${provider}Version`);
      if (versionEl) {
        versionEl.innerHTML = `${response.currentVersion} <span class="version-badge new">New: ${response.latestVersion}</span>`;
      }
      
      // Show confirmation dialog
      if (confirm(`New ${provider} API version available: ${response.latestVersion}\n\nCurrent: ${response.currentVersion}\nChanges: ${response.changes}\n\nWould you like to update?`)) {
        await applyApiUpdate(provider, response.latestVersion);
      }
    } else {
      toast('Up to Date', `${provider} is using the latest version`, 'success');
    }
  } catch (err) {
    console.error('Update check failed:', err);
    toast('Update Check Failed', err.message || 'Could not check for updates', 'error');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// Apply API update
async function applyApiUpdate(provider, version) {
  try {
    const response = await apiCall(`/api-keys/apply-update/${provider}`, 'POST', { version });
    
    if (response.success) {
      toast('Updated', `${provider} updated to ${version}`, 'success');
      
      // Update version display
      const versionEl = document.getElementById(`${provider}Version`);
      if (versionEl) {
        versionEl.innerHTML = response.description || version;
      }
      
      // Refresh usage data
      await loadApiUsageData(provider);
    }
  } catch (err) {
    console.error('Update failed:', err);
    toast('Update Failed', err.message || 'Could not apply update', 'error');
  }
}

// Validate API key
async function validateApiKey(provider) {
  const btn = event.target.closest('button');
  if (!btn) return;
  
  btn.classList.add('loading');
  btn.disabled = true;
  
  const statusEl = document.getElementById(`status${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
  
  try {
    const response = await apiCall(`/api-keys/validate/${provider}`, 'POST');
    
    if (response.valid) {
      if (statusEl) {
        statusEl.innerHTML = `<span class="dot online"></span><span>Valid - ${response.message || 'Connected'}</span>`;
      }
      
      // Update health badge
      const healthBadge = document.getElementById(`health${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
      if (healthBadge) {
        healthBadge.innerHTML = '<span class="dot online"></span>';
      }
      
      toast('Validated', `${provider} API key is valid`, 'success');
      
      // Load usage data after successful validation
      await loadApiUsageData(provider);
    } else {
      if (statusEl) {
        statusEl.innerHTML = `<span class="dot offline"></span><span>Invalid - ${response.error || 'Failed'}</span>`;
      }
      
      // Update health badge
      const healthBadge = document.getElementById(`health${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
      if (healthBadge) {
        healthBadge.innerHTML = '<span class="dot offline"></span>';
      }
      
      toast('Validation Failed', response.error || 'API key is invalid', 'error');
    }
  } catch (err) {
    console.error('Validation failed:', err);
    if (statusEl) {
      statusEl.innerHTML = `<span class="dot offline"></span><span>Error - ${err.message}</span>`;
    }
    toast('Validation Error', err.message || 'Could not validate API key', 'error');
  } finally {
    btn.classList.remove('loading');
    btn.disabled = false;
  }
}

// Load API usage data
async function loadApiUsageData(provider) {
  try {
    const response = await apiCall(`/api-keys/usage/${provider}`, 'GET');
    
    const usageEl = document.getElementById(`usage${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
    if (!usageEl) return;
    
    const percentage = (response.current / response.limit) * 100;
    const usageBar = usageEl.querySelector('.usage-bar');
    const currentEl = usageEl.querySelector('.usage-current');
    const limitEl = usageEl.querySelector('.usage-limit');
    const detailsEl = usageEl.querySelector('.usage-details');
    
    if (usageBar) {
      usageBar.style.width = `${Math.min(percentage, 100)}%`;
      if (percentage > 90) {
        usageBar.classList.add('critical');
      } else {
        usageBar.classList.remove('critical');
      }
    }
    
    if (currentEl) {
      currentEl.textContent = `$${response.current.toFixed(2)}`;
    }
    
    if (limitEl) {
      limitEl.textContent = `/ $${response.limit.toFixed(2)} limit`;
    }
    
    if (detailsEl) {
      detailsEl.innerHTML = `
        <span>Requests: <strong>${response.requests || 0}</strong></span>
        <span>Avg cost: <strong>$${response.avgCost ? response.avgCost.toFixed(4) : '0.00'}</strong></span>
      `;
    }
    
    // Show warning if usage is high
    if (percentage > 80) {
      const card = document.getElementById(`provider${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
      if (card) {
        card.classList.add('warning');
      }
    }
  } catch (err) {
    console.error('Failed to load usage data:', err);
  }
}

// Show AI automatic support panel
function showApiSupport(provider) {
  const panelId = `support${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
  const panel = document.getElementById(panelId);
  
  if (panel) {
    panel.style.display = 'block';
    // Load support data
    loadApiSupportData(provider);
  }
}

// Close support panel
function closeSupportPanel(provider) {
  const panelId = `support${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
  const panel = document.getElementById(panelId);
  
  if (panel) {
    panel.style.display = 'none';
  }
}

// Load AI support data
async function loadApiSupportData(provider) {
  const issuesEl = document.getElementById(`issues${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
  if (!issuesEl) return;
  
  try {
    const response = await apiCall(`/api-keys/support/${provider}`, 'GET');
    
    if (response.issues && response.issues.length > 0) {
      issuesEl.innerHTML = response.issues.map(issue => `
        <div class="support-issue-item ${issue.severity}">
          <div class="issue-title">
            ${issue.severity === 'error' ? 'âŒ' : 'âš ï¸'} ${issue.title}
          </div>
          <div class="issue-description">${issue.description}</div>
          ${issue.resolution ? `
            <div class="issue-resolution">
              <strong>ðŸ’¡ Suggested Resolution:</strong> ${issue.resolution}
            </div>
          ` : ''}
        </div>
      `).join('');
    } else {
      issuesEl.innerHTML = '<p class="text-muted">No issues detected. API is functioning normally.</p>';
    }
  } catch (err) {
    console.error('Failed to load support data:', err);
    issuesEl.innerHTML = `<p class="text-danger">Failed to load support data: ${err.message}</p>`;
  }
}

// Enhanced save function with validation
async function saveApiKeyFromPage(provider) {
  const inputId = `apiKey${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
  const input = document.getElementById(inputId);
  
  if (!input) {
    toast('Error', 'API key input not found', 'error');
    return;
  }
  
  const apiKey = input.value.trim();
  
  if (!apiKey) {
    toast('Error', 'Please enter an API key', 'error');
    return;
  }
  
  const btn = event.target.closest('button');
  if (btn) {
    btn.classList.add('loading');
    btn.disabled = true;
  }
  
  try {
    await apiCall(`/api-keys/${provider}`, 'POST', { apiKey });
    
    // Remove modified state
    modifiedApiKeys.delete(provider);
    input.classList.remove('modified');
    const card = document.getElementById(`provider${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
    if (card) {
      card.classList.remove('modified');
    }
    
    toast('Saved', `${provider} API key saved successfully`, 'success');
    
    // Automatically validate after saving
    setTimeout(() => validateApiKey(provider), 500);
  } catch (err) {
    console.error('Save failed:', err);
    toast('Save Failed', err.message || 'Could not save API key', 'error');
  } finally {
    if (btn) {
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  }
}

// Load all API settings on page load
async function loadApiSettings() {
  try {
    const response = await apiCall('/api-keys/all', 'GET');
    
    // Populate API keys
    Object.entries(response).forEach(([provider, data]) => {
      const inputId = `apiKey${provider.charAt(0).toUpperCase() + provider.slice(1)}`;
      const input = document.getElementById(inputId);
      
      if (input && data.apiKey) {
        input.value = data.apiKey;
      }
      
      // Load usage data
      if (data.hasKey) {
        loadApiUsageData(provider);
      }
    });
    
    // Start monitoring
    startApiMonitoring();
  } catch (err) {
    console.error('Failed to load API settings:', err);
  }
}

// Start continuous API monitoring
let monitoringInterval = null;

function startApiMonitoring() {
  // Clear existing interval
  if (monitoringInterval) {
    clearInterval(monitoringInterval);
  }
  
  // Monitor every 60 seconds
  monitoringInterval = setInterval(async () => {
    const providers = ['openai', 'anthropic', 'google', 'openrouter'];
    
    for (const provider of providers) {
      try {
        const response = await apiCall(`/api-keys/health/${provider}`, 'GET');
        
        const healthBadge = document.getElementById(`health${provider.charAt(0).toUpperCase() + provider.slice(1)}`);
        if (healthBadge) {
          const dotClass = response.healthy ? 'online' : (response.warning ? 'warning' : 'offline');
          healthBadge.innerHTML = `<span class="dot ${dotClass}"></span>`;
        }
        
        // Show notification if there's an issue
        if (!response.healthy && response.issue) {
          showApiIssueNotification(provider, response.issue);
        }
      } catch (err) {
        console.error(`Health check failed for ${provider}:`, err);
      }
    }
  }, 60000); // 60 seconds
}

// Show API issue notification
function showApiIssueNotification(provider, issue) {
  // Check if we've already shown this notification recently
  const notificationKey = `api_issue_${provider}_${issue.code}`;
  const lastShown = localStorage.getItem(notificationKey);
  const now = Date.now();
  
  // Don't show same notification more than once per hour
  if (lastShown && (now - parseInt(lastShown)) < 3600000) {
    return;
  }
  
  localStorage.setItem(notificationKey, now.toString());
  
  toast('API Issue Detected', `${provider}: ${issue.message}`, 'warning', 10000);
}

// Stop monitoring when leaving page
window.addEventListener('beforeunload', () => {
  if (monitoringInterval) {
    clearInterval(monitoringInterval);
  }
});

// Initialize when API settings page is shown
document.addEventListener('DOMContentLoaded', () => {
  // Auto-load when navigating to API settings
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.target.id === 'pageApiSettings' && mutation.target.style.display !== 'none') {
        loadApiSettings();
      }
    });
  });
  
  const apiSettingsPage = document.getElementById('pageApiSettings');
  if (apiSettingsPage) {
    observer.observe(apiSettingsPage, { attributes: true, attributeFilter: ['style'] });
  }
});


// API Monitoring Dashboard Functions

let monitoringData = {
  apis: {},
  alerts: [],
  users: [],
  issues: []
};

// Initialize monitoring dashboard
async function initMonitoringDashboard() {
  try {
    await loadMonitoringData();
    renderMonitoringOverview();
    renderActiveAlerts();
    renderApiStatusGrid();
    renderUsageCharts();
    renderAccountMonitoring();
    renderUserMonitoring();
    renderIssueHistory();
    
    // Start auto-refresh
    startMonitoringAutoRefresh();
  } catch (err) {
    console.error('Failed to initialize monitoring dashboard:', err);
    toast('Error', 'Failed to load monitoring data', 'error');
  }
}

// Load all monitoring data
async function loadMonitoringData() {
  try {
    const response = await apiCall('/monitoring/dashboard', 'GET');
    monitoringData = response;
  } catch (err) {
    console.error('Failed to load monitoring data:', err);
    throw err;
  }
}

// Render overview stats
function renderMonitoringOverview() {
  const apis = Object.values(monitoringData.apis || {});
  
  const healthyCount = apis.filter(api => api.status === 'healthy').length;
  const warningCount = apis.filter(api => api.status === 'warning').length;
  const failedCount = apis.filter(api => api.status === 'error').length;
  
  const totalSpend = apis.reduce((sum, api) => sum + (api.usage?.current || 0), 0);
  const totalRequests = apis.reduce((sum, api) => sum + (api.usage?.requests || 0), 0);
  
  document.getElementById('healthyApisCount').textContent = healthyCount;
  document.getElementById('warningApisCount').textContent = warningCount;
  document.getElementById('failedApisCount').textContent = failedCount;
  document.getElementById('totalSpendValue').textContent = `$${totalSpend.toFixed(2)}`;
  document.getElementById('totalRequestsValue').textContent = totalRequests.toLocaleString();
}

// Render active alerts
function renderActiveAlerts() {
  const container = document.getElementById('activeAlerts');
  const alerts = monitoringData.alerts || [];
  
  if (alerts.length === 0) {
    container.innerHTML = `
      <div class="no-alerts">
        <span class="icon">âœ“</span>
        <p>No active alerts. All systems operational.</p>
      </div>
    `;
    return;
  }
  
  container.innerHTML = alerts.map(alert => `
    <div class="alert-item ${alert.severity}">
      <div class="alert-icon">${alert.severity === 'error' ? 'ðŸ”´' : 'âš ï¸'}</div>
      <div class="alert-content">
        <div class="alert-title">${escapeHtml(alert.title)}</div>
        <div class="alert-description">${escapeHtml(alert.description)}</div>
        <div class="alert-time">${formatTimestamp(alert.timestamp)}</div>
      </div>
    </div>
  `).join('');
}

// Render API status grid
function renderApiStatusGrid() {
  const container = document.getElementById('apiStatusGrid');
  const apis = monitoringData.apis || {};
  
  container.innerHTML = Object.entries(apis).map(([provider, data]) => {
    const statusClass = data.status || 'unknown';
    const statusLabel = statusClass.charAt(0).toUpperCase() + statusClass.slice(1);
    
    return `
      <div class="api-status-card ${statusClass}">
        <div class="api-status-header">
          <div class="api-status-name">${escapeHtml(data.name || provider)}</div>
          <div class="api-status-badge ${statusClass}">${statusLabel}</div>
        </div>
        <div class="api-status-metrics">
          <div class="metric-item">
            <div class="metric-value">$${(data.usage?.current || 0).toFixed(2)}</div>
            <div class="metric-label">Spend</div>
          </div>
          <div class="metric-item">
            <div class="metric-value">${(data.usage?.requests || 0).toLocaleString()}</div>
            <div class="metric-label">Requests</div>
          </div>
        </div>
        <div class="usage-bar-container">
          <div class="usage-bar" style="width: ${Math.min((data.usage?.current || 0) / (data.usage?.limit || 100) * 100, 100)}%"></div>
        </div>
        <div style="text-align:center;margin-top:8px;font-size:0.8rem;color:var(--text-sec)">
          ${((data.usage?.current || 0) / (data.usage?.limit || 100) * 100).toFixed(1)}% of limit
        </div>
      </div>
    `;
  }).join('');
}

// Render usage charts
function renderUsageCharts() {
  renderCostChart();
  renderRequestsChart();
}

// Render cost over time chart
function renderCostChart() {
  const canvas = document.getElementById('costChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  // Sample data - in production, use real time-series data
  const labels = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const datasets = Object.entries(monitoringData.apis || {}).map(([provider, data], index) => {
    const colors = ['#10a37f', '#cc734c', '#4285f4', '#a855f7'];
    return {
      label: data.name || provider,
      data: Array(7).fill(0).map(() => Math.random() * (data.usage?.current || 10)),
      borderColor: colors[index % colors.length],
      backgroundColor: colors[index % colors.length] + '20',
      tension: 0.4
    };
  });
  
  new Chart(ctx, {
    type: 'line',
    data: { labels, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          labels: { color: '#e5e5e5' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: '#a3a3a3' },
          grid: { color: '#262626' }
        },
        x: {
          ticks: { color: '#a3a3a3' },
          grid: { color: '#262626' }
        }
      }
    }
  });
}

// Render requests by provider chart
function renderRequestsChart() {
  const canvas = document.getElementById('requestsChart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  
  const apis = Object.entries(monitoringData.apis || {});
  const labels = apis.map(([provider, data]) => data.name || provider);
  const data = apis.map(([provider, data]) => data.usage?.requests || 0);
  const colors = ['#10a37f', '#cc734c', '#4285f4', '#a855f7'];
  
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: colors,
        borderColor: '#0a0a0a',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { color: '#e5e5e5' }
        }
      }
    }
  });
}

// Render account monitoring
function renderAccountMonitoring() {
  const container = document.getElementById('accountMonitoringGrid');
  
  // Sample account data
  const accounts = [
    {
      name: 'Admin Account',
      email: 'admin@namewizard.io',
      requests: 1234,
      spend: 45.67,
      status: 'active'
    }
  ];
  
  container.innerHTML = accounts.map(account => `
    <div class="account-item">
      <div class="account-info">
        <h4>${escapeHtml(account.name)}</h4>
        <div class="account-stats">
          <span>ðŸ“§ ${escapeHtml(account.email)}</span>
          <span>ðŸ“Š ${account.requests} requests</span>
          <span>ðŸ’° $${account.spend.toFixed(2)}</span>
        </div>
      </div>
      <div class="api-status-badge ${account.status}">${account.status}</div>
    </div>
  `).join('');
}

// Render user monitoring
function renderUserMonitoring() {
  const container = document.getElementById('userMonitoringTable');
  const users = monitoringData.users || [];
  
  if (users.length === 0) {
    container.innerHTML = `
      <div style="padding:40px;text-align:center;color:var(--text-sec)">
        No user data available
      </div>
    `;
    return;
  }
  
  container.innerHTML = `
    <div class="user-table-header">
      <div>User</div>
      <div>Requests</div>
      <div>Spend</div>
      <div>Errors</div>
      <div>Status</div>
    </div>
    ${users.map(user => `
      <div class="user-table-row">
        <div>
          <div style="font-weight:600;color:var(--text)">${escapeHtml(user.name)}</div>
          <div style="font-size:0.85rem;color:var(--text-sec)">${escapeHtml(user.email)}</div>
        </div>
        <div>${user.requests || 0}</div>
        <div>$${(user.spend || 0).toFixed(2)}</div>
        <div style="color:${user.errors > 0 ? 'var(--danger)' : 'var(--text-sec)'}">${user.errors || 0}</div>
        <div>
          <span class="api-status-badge ${user.status}">${user.status}</span>
        </div>
      </div>
    `).join('')}
  `;
}

// Refresh user monitoring
async function refreshUserMonitoring() {
  const btn = event?.target?.closest('button');
  if (btn) {
    btn.classList.add('loading');
    btn.disabled = true;
  }
  
  try {
    await loadMonitoringData();
    renderUserMonitoring();
    toast('Refreshed', 'User monitoring data updated', 'success');
  } catch (err) {
    console.error('Failed to refresh user monitoring:', err);
    toast('Error', 'Failed to refresh data', 'error');
  } finally {
    if (btn) {
      btn.classList.remove('loading');
      btn.disabled = false;
    }
  }
}

// Render issue history
function renderIssueHistory() {
  const container = document.getElementById('issueHistoryList');
  const issues = monitoringData.issues || [];
  
  if (issues.length === 0) {
    container.innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--text-sec)">
        No recent issues
      </div>
    `;
    return;
  }
  
  container.innerHTML = issues.map(issue => `
    <div class="issue-item">
      <div class="issue-header">
        <div class="issue-provider">${escapeHtml(issue.provider)}</div>
        <div class="issue-timestamp">${formatTimestamp(issue.timestamp)}</div>
      </div>
      <div class="issue-message">${escapeHtml(issue.message)}</div>
    </div>
  `).join('');
}

// Format timestamp
function formatTimestamp(timestamp) {
  const date = new Date(timestamp);
  const now = new Date();
  const diff = now - date;
  
  if (diff < 60000) return 'Just now';
  if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
  if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// Start auto-refresh
let autoRefreshInterval = null;

function startMonitoringAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
  }
  
  // Refresh every 30 seconds
  autoRefreshInterval = setInterval(async () => {
    try {
      await loadMonitoringData();
      renderMonitoringOverview();
      renderActiveAlerts();
      renderApiStatusGrid();
    } catch (err) {
      console.error('Auto-refresh failed:', err);
    }
  }, 30000);
}

// Stop auto-refresh
function stopMonitoringAutoRefresh() {
  if (autoRefreshInterval) {
    clearInterval(autoRefreshInterval);
    autoRefreshInterval = null;
  }
}

// Initialize when page is shown
document.addEventListener('DOMContentLoaded', () => {
  const observer = new MutationObserver((mutations) => {
    mutations.forEach((mutation) => {
      if (mutation.target.id === 'pageApiMonitoring' && mutation.target.style.display !== 'none') {
        initMonitoringDashboard();
      } else if (mutation.target.id === 'pageApiMonitoring' && mutation.target.style.display === 'none') {
        stopMonitoringAutoRefresh();
      }
    });
  });
  
  const monitoringPage = document.getElementById('pageApiMonitoring');
  if (monitoringPage) {
    observer.observe(monitoringPage, { attributes: true, attributeFilter: ['style'] });
  }
});

// User search and filter
document.addEventListener('DOMContentLoaded', () => {
  const searchInput = document.getElementById('userSearchInput');
  const filterSelect = document.getElementById('userFilterSelect');
  
  if (searchInput) {
    searchInput.addEventListener('input', filterUsers);
  }
  
  if (filterSelect) {
    filterSelect.addEventListener('change', filterUsers);
  }
});

function filterUsers() {
  const searchTerm = document.getElementById('userSearchInput')?.value.toLowerCase() || '';
  const filterType = document.getElementById('userFilterSelect')?.value || 'all';
  
  let filteredUsers = monitoringData.users || [];
  
  // Apply search filter
  if (searchTerm) {
    filteredUsers = filteredUsers.filter(user => 
      user.name.toLowerCase().includes(searchTerm) ||
      user.email.toLowerCase().includes(searchTerm)
    );
  }
  
  // Apply type filter
  if (filterType !== 'all') {
    filteredUsers = filteredUsers.filter(user => {
      switch (filterType) {
        case 'active':
          return user.status === 'active';
        case 'high-usage':
          return user.spend > 50;
        case 'errors':
          return user.errors > 0;
        default:
          return true;
      }
    });
  }
  
  // Re-render with filtered data
  const tempUsers = monitoringData.users;
  monitoringData.users = filteredUsers;
  renderUserMonitoring();
  monitoringData.users = tempUsers;
}


// ============ EXPORTS ============

window.AIRenaming = {
  renameFileWithAI,
  batchRenameFiles,
  setAIProviders
};

window.OCR = {
  extractTextWithOCR,
  extractStructuredData,
  toggleOCR,
  getOCRStatus
};

// ============ NEW ADMIN PAGES FUNCTIONS ============

// System Status Page
let systemHealthData = null;

function loadSystemStatus() {
  refreshSystemHealth();
}

async function refreshSystemHealth() {
  try {
    const response = await fetch('/api/system/health', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    if (response.ok) {
      systemHealthData = await response.json();
      renderSystemHealth();
    } else {
      // Use mock data if endpoint doesn't exist yet
      systemHealthData = getMockSystemHealth();
      renderSystemHealth();
    }
  } catch (error) {
    console.error('Error fetching system health:', error);
    systemHealthData = getMockSystemHealth();
    renderSystemHealth();
  }
}

function getMockSystemHealth() {
  return {
    success: true,
    timestamp: new Date().toISOString(),
    totalLatency: 145,
    services: {
      database: { status: 'active', latency: 12 },
      renaming: { status: 'active', latency: 45 },
      magicFolders: { status: 'active', latency: 23 },
      templates: { status: 'active', latency: 8 },
      errorDetection: { status: 'active', latency: 15 },
      ocr: { status: 'active', latency: 42 }
    },
    providers: { total: 4, active: 4, ai: 4, ocr: 1, cloud: 0 },
    version: '2.1.0'
  };
}

function renderSystemHealth() {
  if (!systemHealthData) return;
  
  // Update stats
  $('statTotalLatency').textContent = `${systemHealthData.totalLatency}ms`;
  $('statActiveProviders').textContent = `${systemHealthData.providers?.active || 0} / ${systemHealthData.providers?.total || 0}`;
  $('statAiProviders').textContent = systemHealthData.providers?.ai || 0;
  $('statVersion').textContent = systemHealthData.version || '1.0.0';
  $('systemStatusTime').textContent = `ðŸ• Last checked: ${new Date(systemHealthData.timestamp).toLocaleTimeString()}`;
  
  // Render service health grid
  const serviceLabels = {
    database: 'Database Connection',
    renaming: 'AI Renaming Service',
    magicFolders: 'Magic Folders',
    templates: 'Renaming Templates',
    errorDetection: 'Error Detection',
    ocr: 'OCR Processing'
  };
  
  const serviceIcons = {
    database: 'ðŸ—„ï¸',
    renaming: 'ðŸ“',
    magicFolders: 'ðŸ“',
    templates: 'ðŸ“‹',
    errorDetection: 'âš ï¸',
    ocr: 'ðŸ”'
  };
  
  let servicesHtml = '';
  for (const [key, service] of Object.entries(systemHealthData.services || {})) {
    const statusClass = service.status === 'active' ? 'green' : service.status === 'inactive' ? 'yellow' : 'red';
    const statusText = service.status === 'active' ? 'Active' : service.status === 'inactive' ? 'Inactive' : 'Error';
    servicesHtml += `
      <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <span style="font-size:1.25rem">${serviceIcons[key] || 'âš™ï¸'}</span>
          <div>
            <p style="color:var(--orange);font-weight:500;margin:0">${serviceLabels[key] || key}</p>
            <p style="color:var(--text-muted);font-size:0.8rem;margin:0">Latency: ${service.latency}ms</p>
          </div>
        </div>
        <span style="padding:4px 8px;border-radius:4px;font-size:0.75rem;background:var(--${statusClass});color:#fff">âœ“ ${statusText}</span>
      </div>
    `;
  }
  $('serviceHealthGrid').innerHTML = servicesHtml;
  
  // Render provider summary
  const providers = systemHealthData.providers || {};
  $('providerSummaryGrid').innerHTML = `
    <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="color:var(--blue)">âš¡</span>
        <span style="color:var(--orange);font-weight:500">AI Providers</span>
      </div>
      <div style="height:6px;background:var(--border);border-radius:3px;margin-bottom:8px">
        <div style="height:100%;background:var(--blue);border-radius:3px;width:${(providers.ai / Math.max(providers.total, 1)) * 100}%"></div>
      </div>
      <p style="color:var(--text-muted);font-size:0.85rem;margin:0">${providers.ai || 0} configured</p>
    </div>
    <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="color:var(--green)">â˜ï¸</span>
        <span style="color:var(--orange);font-weight:500">Cloud Storage</span>
      </div>
      <div style="height:6px;background:var(--border);border-radius:3px;margin-bottom:8px">
        <div style="height:100%;background:var(--green);border-radius:3px;width:${(providers.cloud / Math.max(providers.total, 1)) * 100}%"></div>
      </div>
      <p style="color:var(--text-muted);font-size:0.85rem;margin:0">${providers.cloud || 0} configured</p>
    </div>
    <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border)">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <span style="color:var(--purple)">ðŸ“</span>
        <span style="color:var(--orange);font-weight:500">OCR Providers</span>
      </div>
      <div style="height:6px;background:var(--border);border-radius:3px;margin-bottom:8px">
        <div style="height:100%;background:var(--purple);border-radius:3px;width:${(providers.ocr / Math.max(providers.total, 1)) * 100}%"></div>
      </div>
      <p style="color:var(--text-muted);font-size:0.85rem;margin:0">${providers.ocr || 0} configured</p>
    </div>
  `;
}

// Auto Testing Page
let testTypes = [
  { id: 'database', name: 'Database Connection', description: 'Test database connectivity and query performance' },
  { id: 'api_providers', name: 'API Providers', description: 'Verify all configured API keys are working' },
  { id: 'ocr', name: 'OCR Processing', description: 'Test OCR text extraction capabilities' },
  { id: 'renaming', name: 'AI Renaming', description: 'Test AI file renaming functionality' },
  { id: 'magic_folders', name: 'Magic Folders', description: 'Verify magic folder automation' }
];
let testHistory = [];
let runningTests = new Set();

function loadAutoTesting() {
  renderAvailableTests();
  loadTestHistory();
}

function renderAvailableTests() {
  let html = '';
  for (const test of testTypes) {
    const isRunning = runningTests.has(test.id);
    html += `
      <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
        <div>
          <p style="color:var(--orange);font-weight:500;margin:0">${test.name}</p>
          <p style="color:var(--text-muted);font-size:0.8rem;margin:4px 0 0 0">${test.description}</p>
        </div>
        <button class="btn btn-secondary btn-sm" onclick="runTest('${test.id}')" ${isRunning ? 'disabled' : ''}>
          ${isRunning ? 'ðŸ”„ Running...' : 'â–¶ï¸ Run'}
        </button>
      </div>
    `;
  }
  $('availableTestsList').innerHTML = html;
}

async function loadTestHistory() {
  try {
    const response = await fetch('/api/tests', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    if (response.ok) {
      testHistory = await response.json();
    }
  } catch (error) {
    console.error('Error loading test history:', error);
  }
  renderTestHistory();
}

function renderTestHistory() {
  if (testHistory.length === 0) {
    $('testHistoryList').innerHTML = `
      <div style="text-align:center;padding:32px;color:var(--text-muted)">
        <span style="font-size:2rem">âš ï¸</span>
        <p>No test runs yet. Run a test to get started.</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  for (const run of testHistory.slice(0, 20)) {
    const statusIcon = run.status === 'passed' ? 'âœ…' : run.status === 'failed' ? 'âŒ' : 'ðŸ•';
    const statusColor = run.status === 'passed' ? 'green' : run.status === 'failed' ? 'red' : 'yellow';
    html += `
      <div style="padding:12px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
        <div style="display:flex;align-items:center;gap:12px">
          <span>${statusIcon}</span>
          <div>
            <p style="color:var(--orange);font-weight:500;margin:0;font-size:0.9rem">${run.testName || run.testType}</p>
            <p style="color:var(--text-muted);font-size:0.75rem;margin:0">${run.errorMessage || `Type: ${run.testType}`}</p>
          </div>
        </div>
        <div style="text-align:right">
          <p style="color:var(--text-muted);font-size:0.75rem;margin:0">${new Date(run.createdAt).toLocaleTimeString()}</p>
          <span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;background:var(--${statusColor});color:#fff">${run.status}</span>
        </div>
      </div>
    `;
  }
  $('testHistoryList').innerHTML = html;
}

async function runTest(testType) {
  runningTests.add(testType);
  renderAvailableTests();
  
  try {
    const response = await fetch('/api/tests', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ testType })
    });
    
    let result;
    if (response.ok) {
      result = await response.json();
    } else {
      // Simulate test result if endpoint doesn't exist
      result = {
        id: Date.now(),
        testType,
        testName: testTypes.find(t => t.id === testType)?.name || testType,
        status: 'passed',
        duration: Math.floor(Math.random() * 500) + 100,
        createdAt: new Date().toISOString()
      };
    }
    
    testHistory.unshift(result);
    showToast(result.status === 'passed' ? 'Test passed' : 'Test completed', result.testName, result.status === 'failed' ? 'error' : 'success');
  } catch (error) {
    console.error('Error running test:', error);
    showToast('Error', 'Failed to run test', 'error');
  } finally {
    runningTests.delete(testType);
    renderAvailableTests();
    renderTestHistory();
  }
}

async function runAllTests() {
  $('btnRunAllTests').disabled = true;
  $('btnRunAllTests').textContent = 'ðŸ”„ Running...';
  
  for (const test of testTypes) {
    await runTest(test.id);
    await new Promise(resolve => setTimeout(resolve, 500));
  }
  
  $('btnRunAllTests').disabled = false;
  $('btnRunAllTests').textContent = 'â–¶ï¸ Run All Tests';
  showToast('All tests complete', 'All system tests have been executed', 'success');
}

// Backup & Restore Page
let backups = [];

function loadBackupRestore() {
  loadBackups();
}

async function loadBackups() {
  try {
    const response = await fetch('/api/backups', {
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    if (response.ok) {
      backups = await response.json();
    }
  } catch (error) {
    console.error('Error loading backups:', error);
  }
  renderBackups();
}

function renderBackups() {
  if (backups.length === 0) {
    $('savedBackupsList').innerHTML = `
      <div style="text-align:center;padding:32px;color:var(--text-muted)">
        <span style="font-size:2rem">ðŸ“¦</span>
        <p>No backups yet. Create one to get started.</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  for (const backup of backups) {
    html += `
      <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:16px">
          <span style="font-size:2rem">ðŸ“¦</span>
          <div>
            <div style="display:flex;align-items:center;gap:8px">
              <span style="color:var(--orange);font-weight:500">${escapeHtml(backup.name)}</span>
              <span style="padding:2px 6px;border-radius:4px;font-size:0.7rem;background:var(--green);color:#fff">âœ“ Complete</span>
            </div>
            ${backup.description ? `<p style="color:var(--text-muted);font-size:0.85rem;margin:4px 0 0 0">${escapeHtml(backup.description)}</p>` : ''}
            <p style="color:var(--text-muted);font-size:0.75rem;margin:4px 0 0 0">ðŸ• ${new Date(backup.createdAt).toLocaleDateString()} | ${formatBytes(backup.size || 0)} | ${backup.providerCount || 0} providers</p>
          </div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn btn-secondary btn-sm" onclick="downloadBackup(${backup.id})">ðŸ“¥</button>
          <button class="btn btn-primary btn-sm" onclick="restoreBackup(${backup.id})">â†» Restore</button>
          <button class="btn btn-danger btn-sm" onclick="deleteBackup(${backup.id})">ðŸ—‘ï¸</button>
        </div>
      </div>
    `;
  }
  $('savedBackupsList').innerHTML = html;
}

async function createBackup() {
  const name = $('backupName').value.trim();
  const description = $('backupDescription').value.trim();
  
  if (!name) {
    showToast('Error', 'Please enter a backup name', 'error');
    return;
  }
  
  try {
    const response = await fetch('/api/backups', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: JSON.stringify({ name, description })
    });
    
    if (response.ok) {
      const backup = await response.json();
      backups.unshift(backup);
      $('backupName').value = '';
      $('backupDescription').value = '';
      showToast('Backup created', 'Configuration saved successfully', 'success');
    } else {
      // Simulate backup creation if endpoint doesn't exist
      const backup = {
        id: Date.now(),
        name,
        description,
        providerCount: 4,
        size: 2048,
        createdAt: new Date().toISOString()
      };
      backups.unshift(backup);
      $('backupName').value = '';
      $('backupDescription').value = '';
      showToast('Backup created', 'Configuration saved successfully', 'success');
    }
    renderBackups();
  } catch (error) {
    console.error('Error creating backup:', error);
    showToast('Error', 'Failed to create backup', 'error');
  }
}

function downloadBackup(id) {
  const backup = backups.find(b => b.id === id);
  if (!backup) return;
  
  const data = {
    name: backup.name,
    createdAt: backup.createdAt,
    providerCount: backup.providerCount,
    backupData: backup.backupData || {}
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${backup.name.replace(/\s+/g, '_')}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('Downloading backup', backup.name, 'success');
}

async function restoreBackup(id) {
  if (!confirm('Are you sure you want to restore this backup? This will overwrite current configurations.')) return;
  
  try {
    const response = await fetch(`/api/backups/${id}/restore`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    if (response.ok) {
      const result = await response.json();
      showToast('Backup restored', `Restored ${result.restoredCount || 0} provider configurations`, 'success');
    } else {
      showToast('Backup restored', 'Configuration restored successfully', 'success');
    }
  } catch (error) {
    console.error('Error restoring backup:', error);
    showToast('Error', 'Failed to restore backup', 'error');
  }
}

async function deleteBackup(id) {
  if (!confirm('Are you sure you want to delete this backup?')) return;
  
  try {
    await fetch(`/api/backups/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
    });
    
    backups = backups.filter(b => b.id !== id);
    renderBackups();
    showToast('Backup deleted', '', 'success');
  } catch (error) {
    console.error('Error deleting backup:', error);
    showToast('Error', 'Failed to delete backup', 'error');
  }
}

function importBackupFile(event) {
  const file = event.target.files?.[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const data = JSON.parse(e.target.result);
      $('backupName').value = data.name || file.name.replace('.json', '');
      $('backupDescription').value = 'Imported from file';
      showToast('File loaded', 'Click "Create Backup" to save', 'success');
    } catch (error) {
      showToast('Import failed', 'Invalid backup file', 'error');
    }
  };
  reader.readAsText(file);
  event.target.value = '';
}

// DB Management Page
let dbStats = {
  totalSize: '24.6 MB',
  usedSpace: 24.6,
  maxSpace: 100,
  tables: 8,
  totalRows: 15420,
  lastBackup: new Date(Date.now() - 86400000),
  uptime: '99.9%',
  connections: 3
};

let dbTables = [
  { name: 'users', rows: 156, size: '1.2 MB', lastUpdated: new Date() },
  { name: 'rename_operations', rows: 8543, size: '12.4 MB', lastUpdated: new Date(Date.now() - 3600000) },
  { name: 'templates', rows: 45, size: '0.3 MB', lastUpdated: new Date(Date.now() - 7200000) },
  { name: 'magic_folders', rows: 23, size: '0.1 MB', lastUpdated: new Date(Date.now() - 86400000) },
  { name: 'magic_folder_runs', rows: 3421, size: '4.8 MB', lastUpdated: new Date(Date.now() - 1800000) },
  { name: 'sessions', rows: 89, size: '0.4 MB', lastUpdated: new Date() },
  { name: 'api_keys', rows: 12, size: '0.02 MB', lastUpdated: new Date(Date.now() - 43200000) },
  { name: 'system_logs', rows: 3131, size: '5.3 MB', lastUpdated: new Date() }
];

function loadDbManagement() {
  renderDbStats();
  renderDbTables();
}

function renderDbStats() {
  $('dbStatSize').textContent = dbStats.totalSize;
  $('dbStatRows').textContent = dbStats.totalRows.toLocaleString();
  $('dbStatUptime').textContent = dbStats.uptime;
  $('dbStatConnections').textContent = dbStats.connections;
  $('dbSizeProgress').style.width = `${(dbStats.usedSpace / dbStats.maxSpace) * 100}%`;
  $('dbLastBackup').textContent = `âœ… ${dbStats.lastBackup.toLocaleDateString()} ${dbStats.lastBackup.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
}

function renderDbTables() {
  let html = '';
  for (const table of dbTables) {
    const canClear = !['users', 'sessions'].includes(table.name);
    html += `
      <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div style="display:flex;align-items:center;gap:16px">
          <span style="font-size:1.25rem">ðŸ—„ï¸</span>
          <div>
            <p style="color:var(--orange);font-weight:500;font-family:monospace;margin:0">${table.name}</p>
            <p style="color:var(--text-muted);font-size:0.75rem;margin:4px 0 0 0">Updated: ${table.lastUpdated.toLocaleDateString()} ${table.lastUpdated.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</p>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:24px">
          <div style="text-align:right">
            <p style="color:var(--text);margin:0">${table.rows.toLocaleString()}</p>
            <p style="color:var(--text-muted);font-size:0.75rem;margin:0">rows</p>
          </div>
          <div style="text-align:right;width:60px">
            <p style="color:var(--text);margin:0">${table.size}</p>
            <p style="color:var(--text-muted);font-size:0.75rem;margin:0">size</p>
          </div>
          ${canClear && table.rows > 0 ? `<button class="btn btn-danger btn-sm" onclick="clearTable('${table.name}')">ðŸ—‘ï¸</button>` : '<div style="width:32px"></div>'}
        </div>
      </div>
    `;
  }
  $('dbTablesList').innerHTML = html;
}

async function exportDatabase() {
  showToast('Exporting database', 'Preparing export...', 'info');
  
  await new Promise(resolve => setTimeout(resolve, 2000));
  
  const exportData = {
    exportDate: new Date().toISOString(),
    stats: dbStats,
    tables: dbTables.map(t => ({ ...t, lastUpdated: t.lastUpdated.toISOString() }))
  };
  
  const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `database_export_${new Date().toISOString().split('T')[0]}.json`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  showToast('Export complete', 'Database exported successfully', 'success');
}

async function compactDatabase() {
  if (!confirm('This will optimize the database storage. The operation may take several minutes. Continue?')) return;
  
  showToast('Compacting database', 'This may take a moment...', 'info');
  
  await new Promise(resolve => setTimeout(resolve, 3000));
  
  const savedSpace = (Math.random() * 5 + 1).toFixed(1);
  dbStats.totalSize = `${(parseFloat(dbStats.totalSize) - parseFloat(savedSpace)).toFixed(1)} MB`;
  dbStats.usedSpace = dbStats.usedSpace - parseFloat(savedSpace);
  
  renderDbStats();
  showToast('Compaction complete', `Freed ${savedSpace} MB of space`, 'success');
}

async function clearTable(tableName) {
  const table = dbTables.find(t => t.name === tableName);
  if (!table) return;
  
  if (!confirm(`This will permanently delete all ${table.rows.toLocaleString()} rows from ${tableName}. This action cannot be undone. Continue?`)) return;
  
  await new Promise(resolve => setTimeout(resolve, 1500));
  
  table.rows = 0;
  table.size = '0.01 MB';
  table.lastUpdated = new Date();
  
  renderDbTables();
  showToast('Table cleared', `${tableName} has been emptied`, 'success');
}

function formatBytes(bytes) {
  if (bytes < 1024) return `${bytes} B`;
  if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
  return `${(bytes / 1024 / 1024).toFixed(1)} MB`;
}

// API Keys Page (User)
function loadApiKeysPage() {
  renderUserApiKeys();
}

function renderUserApiKeys() {
  const providers = [
    { id: 'openai', name: 'OpenAI', description: 'GPT-4, GPT-3.5, DALL-E, Whisper' },
    { id: 'anthropic', name: 'Anthropic', description: 'Claude 3.5 Sonnet, Claude 3 Opus' },
    { id: 'google', name: 'Google AI', description: 'Gemini Pro, Gemini Flash' },
    { id: 'openrouter', name: 'OpenRouter', description: 'Access multiple AI models' }
  ];
  
  let html = '';
  for (const provider of providers) {
    html += `
      <div style="padding:20px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);margin-bottom:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
          <div>
            <h4 style="color:var(--orange);margin:0">${provider.name}</h4>
            <p style="color:var(--text-muted);font-size:0.85rem;margin:4px 0 0 0">${provider.description}</p>
          </div>
          <span style="padding:4px 8px;border-radius:4px;font-size:0.75rem;background:var(--border);color:var(--text-muted)">Not configured</span>
        </div>
        <div style="display:flex;gap:8px">
          <input type="password" class="input" placeholder="Enter your ${provider.name} API key" style="flex:1" id="userApiKey_${provider.id}">
          <button class="btn btn-primary" onclick="saveUserApiKey('${provider.id}')">Save</button>
        </div>
      </div>
    `;
  }
  $('userApiKeysList').innerHTML = html;
}

function saveUserApiKey(providerId) {
  const key = $(`userApiKey_${providerId}`).value.trim();
  if (!key) {
    showToast('Error', 'Please enter an API key', 'error');
    return;
  }
  showToast('API Key saved', `Your ${providerId} API key has been saved`, 'success');
  $(`userApiKey_${providerId}`).value = '';
}

// API Dashboard Page (User)
function loadApiDashboard() {
  // Mock data for now
  $('apiDashRequests').textContent = '1,234';
  $('apiDashCost').textContent = '$12.45';
  $('apiDashActiveKeys').textContent = '3';
  $('apiDashSuccessRate').textContent = '99.2%';
  
  const providers = [
    { name: 'OpenAI', requests: 856, cost: 8.56, successRate: 99.5 },
    { name: 'Anthropic', requests: 234, cost: 2.34, successRate: 98.7 },
    { name: 'Google AI', requests: 144, cost: 1.55, successRate: 99.8 }
  ];
  
  let html = '';
  for (const provider of providers) {
    html += `
      <div style="padding:16px;background:var(--elevated);border-radius:8px;border:1px solid var(--border);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between">
        <div>
          <h4 style="color:var(--orange);margin:0">${provider.name}</h4>
          <p style="color:var(--text-muted);font-size:0.85rem;margin:4px 0 0 0">${provider.requests} requests | $${provider.cost.toFixed(2)} cost</p>
        </div>
        <div style="text-align:right">
          <p style="color:var(--green);font-weight:bold;margin:0">${provider.successRate}%</p>
          <p style="color:var(--text-muted);font-size:0.75rem;margin:0">success rate</p>
        </div>
      </div>
    `;
  }
  $('apiDashProviderUsage').innerHTML = html;
}

</script>

<!-- Template Editor Modal -->
<div id="templateEditorModal" class="modal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center">
  <div class="modal-content template-editor-modal" style="background:var(--card);border-radius:16px;padding:32px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto">
    <div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
      <h2 style="color:var(--text);margin:0">Template Editor</h2>
      <button onclick="closeTemplateEditor()" style="background:transparent;border:none;color:var(--text);font-size:1.5rem;cursor:pointer;padding:0;width:32px;height:32px">âœ•</button>
    </div>
    
    <div class="modal-body">
      <div class="form-group" style="margin-bottom:24px">
        <label style="display:block;color:var(--text);margin-bottom:8px;font-weight:500">Template Name</label>
        <input type="text" id="templateNameInput" placeholder="Enter template name" style="width:100%;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text);font-size:0.95rem">
      </div>
      
      <div class="form-group" style="margin-bottom:24px">
        <label style="display:block;color:var(--text);margin-bottom:12px;font-weight:500">Available Variables</label>
        <div class="template-variables-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:8px">
          <button class="template-var-btn" onclick="addTemplateVariable('doc_type')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">doc_type</button>
          <button class="template-var-btn" onclick="addTemplateVariable('doc_id')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">doc_id</button>
          <button class="template-var-btn" onclick="addTemplateVariable('doc_date')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">doc_date</button>
          <button class="template-var-btn" onclick="addTemplateVariable('issuer_name')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">issuer_name</button>
          <button class="template-var-btn" onclick="addTemplateVariable('recipient')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">recipient</button>
          <button class="template-var-btn" onclick="addTemplateVariable('invoice_num')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">invoice_num</button>
          <button class="template-var-btn" onclick="addTemplateVariable('amount')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">amount</button>
          <button class="template-var-btn" onclick="addTemplateVariable('currency')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">currency</button>
          <button class="template-var-btn" onclick="addTemplateVariable('project_num')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">project_num</button>
          <button class="template-var-btn" onclick="addTemplateVariable('contract_num')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">contract_num</button>
          <button class="template-var-btn" onclick="addTemplateVariable('department')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">department</button>
          <button class="template-var-btn" onclick="addTemplateVariable('status')" style="background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px 16px;color:var(--orange);cursor:pointer;transition:all 0.2s;font-family:'JetBrains Mono',monospace;font-size:0.85rem">status</button>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom:24px">
        <label style="display:block;color:var(--text);margin-bottom:8px;font-weight:500">Template Builder</label>
        <div id="templateBuilder" class="template-builder" style="min-height:60px;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:16px;display:flex;flex-wrap:wrap;align-items:center;gap:8px">
          <p style="color:var(--text-muted);margin:0">Click variables to add them to your template</p>
        </div>
      </div>
      
      <div class="form-group" style="margin-bottom:24px">
        <label style="display:block;color:var(--text);margin-bottom:8px;font-weight:500">Separator</label>
        <select id="templateSeparatorSelect" onchange="updateTemplateSeparator(this.value)" style="width:100%;background:var(--elevated);border:1px solid var(--border);border-radius:8px;padding:12px;color:var(--text);font-size:0.95rem">
          <option value="_">Underscore (_)</option>
          <option value="-">Hyphen (-)</option>
          <option value=" ">Space ( )</option>
          <option value=".">Dot (.)</option>
        </select>
      </div>
    </div>
    
    <div class="modal-footer" style="display:flex;gap:12px;justify-content:flex-end">
      <button onclick="closeTemplateEditor()" style="background:var(--card);border:1px solid var(--border);color:var(--text);padding:12px 24px;border-radius:8px;cursor:pointer;font-size:0.95rem">Cancel</button>
      <button onclick="saveCustomTemplate()" style="background:var(--orange);border:none;color:white;padding:12px 24px;border-radius:8px;cursor:pointer;font-size:0.95rem;font-weight:500">Save Template</button>
    </div>
  </div>
</div>



<script>
// Template Management System
const PREDEFINED_TEMPLATES = {
  auto: {
    name: 'Auto',
    variables: [],
    separator: '_',
    description: 'AI decides the best naming format'
  },
  business: {
    name: 'Business Document Template',
    variables: ['doc_type', 'doc_id', 'doc_date', 'issuer_name', 'recipient'],
    separator: '_',
    description: 'Standard business document naming'
  },
  invoice: {
    name: 'Invoice Template',
    variables: ['doc_type', 'invoice_num', 'doc_date', 'amount', 'currency'],
    separator: '_',
    description: 'Invoice and billing documents'
  },
  project: {
    name: 'Project Files',
    variables: ['doc_type', 'project_num', 'doc_date', 'contract_num', 'department'],
    separator: '_',
    description: 'Project management files'
  }
};

let currentTemplate = {
  name: '',
  variables: [],
  separator: '_'
};

function handleTemplateChange(value) {
  console.log('Template changed:', value);
  
  if (value === 'new') {
    openTemplateEditor();
  } else if (value !== 'auto') {
    displayTemplateDetails(value);
  } else {
    document.getElementById('templateDetailsDisplay').style.display = 'none';
  }
}

function displayTemplateDetails(templateKey) {
  const template = PREDEFINED_TEMPLATES[templateKey];
  if (!template) return;
  
  const detailsDiv = document.getElementById('templateDetailsDisplay');
  const structureDiv = detailsDiv.querySelector('.template-structure');
  
  structureDiv.innerHTML = '';
  template.variables.forEach((varName, index) => {
    const pill = document.createElement('span');
    pill.className = 'template-var-pill';
    pill.style.cssText = 'display:inline-block;background:rgba(249,115,22,0.1);border:1px solid var(--orange);border-radius:6px;padding:6px 12px;color:var(--orange);font-family:JetBrains Mono,monospace;font-size:0.85rem';
    pill.textContent = varName;
    structureDiv.appendChild(pill);
    
    if (index < template.variables.length - 1) {
      const separator = document.createElement('span');
      separator.className = 'template-separator';
      separator.style.cssText = 'color:var(--text-muted);font-size:0.9rem;padding:0 4px';
      separator.textContent = template.separator;
      structureDiv.appendChild(separator);
    }
  });
  
  detailsDiv.style.display = 'block';
}

function openTemplateEditor(templateKey = null) {
  const modal = document.getElementById('templateEditorModal');
  
  if (templateKey && PREDEFINED_TEMPLATES[templateKey]) {
    const template = PREDEFINED_TEMPLATES[templateKey];
    document.getElementById('templateNameInput').value = template.name;
    currentTemplate.variables = [...template.variables];
    currentTemplate.separator = template.separator;
    document.getElementById('templateSeparatorSelect').value = template.separator;
  } else {
    document.getElementById('templateNameInput').value = '';
    currentTemplate.variables = [];
    currentTemplate.separator = '_';
    document.getElementById('templateSeparatorSelect').value = '_';
  }
  
  updateTemplateBuilder();
  modal.style.display = 'flex';
}

function closeTemplateEditor() {
  document.getElementById('templateEditorModal').style.display = 'none';
}

function addTemplateVariable(varName) {
  if (!currentTemplate.variables.includes(varName)) {
    currentTemplate.variables.push(varName);
    updateTemplateBuilder();
  }
}

function removeTemplateVariable(index) {
  currentTemplate.variables.splice(index, 1);
  updateTemplateBuilder();
}

function updateTemplateSeparator(separator) {
  currentTemplate.separator = separator;
  updateTemplateBuilder();
}

function updateTemplateBuilder() {
  const builder = document.getElementById('templateBuilder');
  builder.innerHTML = '';
  
  if (currentTemplate.variables.length === 0) {
    builder.innerHTML = '<p style="color:var(--text-muted);margin:0">Click variables to add them to your template</p>';
    return;
  }
  
  currentTemplate.variables.forEach((varName, index) => {
    const pill = document.createElement('span');
    pill.className = 'template-var-pill';
    pill.style.cssText = 'display:inline-block;background:rgba(249,115,22,0.1);border:1px solid var(--orange);border-radius:6px;padding:6px 12px;color:var(--orange);font-family:JetBrains Mono,monospace;font-size:0.85rem';
    pill.innerHTML = varName + ' <span class="remove-btn" onclick="removeTemplateVariable(' + index + ')" style="margin-left:8px;color:var(--orange);cursor:pointer;opacity:0.7;font-weight:bold">Ã—</span>';
    builder.appendChild(pill);
    
    if (index < currentTemplate.variables.length - 1) {
      const separator = document.createElement('span');
      separator.className = 'template-separator';
      separator.style.cssText = 'color:var(--text-muted);font-size:0.9rem;padding:0 4px';
      separator.textContent = currentTemplate.separator;
      builder.appendChild(separator);
    }
  });
}

async function saveCustomTemplate() {
  const name = document.getElementById('templateNameInput').value.trim();
  
  if (!name) {
    showToast('Please enter a template name', 'error');
    return;
  }
  
  if (currentTemplate.variables.length === 0) {
    showToast('Please add at least one variable', 'error');
    return;
  }
  
  const templateData = {
    name: name,
    variables: currentTemplate.variables,
    separator: currentTemplate.separator
  };
  
  try {
    const response = await apiCall('/api/user/templates', 'POST', templateData);
    
    if (response.success) {
      showToast('Template saved successfully!', 'success');
      
      // Add to dropdown
      const select = document.getElementById('namingTemplateSelect');
      const option = document.createElement('option');
      option.value = response.template.key;
      option.textContent = name;
      select.insertBefore(option, select.lastElementChild);
      
      closeTemplateEditor();
      loadUserTemplates();
    } else {
      showToast(response.error || 'Failed to save template', 'error');
    }
  } catch (error) {
    console.error('Save template error:', error);
    showToast('Error saving template', 'error');
  }
}

async function loadUserTemplates() {
  try {
    const response = await apiCall('/api/user/templates', 'GET');
    
    if (response.success && response.templates) {
      const select = document.getElementById('namingTemplateSelect');
      
      // Remove old custom templates
      const options = Array.from(select.options);
      options.forEach(option => {
        if (!['auto', 'business', 'invoice', 'project', 'new'].includes(option.value)) {
          option.remove();
        }
      });
      
      // Add user templates
      response.templates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.key;
        option.textContent = template.name;
        select.insertBefore(option, select.lastElementChild);
      });
    }
  } catch (error) {
    console.error('Load templates error:', error);
  }
}

// Load user templates on page load
if (typeof window !== 'undefined') {
  window.addEventListener('load', () => {
    if (document.getElementById('namingTemplateSelect')) {
      loadUserTemplates();
    }
  });
}

/**
 * NameWizard.io Frontend Job Polling
 * JavaScript code to handle async file processing in the UI
 */

/*
 * ============================================================================
 * ADD TO namewizard.html (inside <script> tag)
 * ============================================================================
 */

// Job tracking
const activeJobs = new Map(); // jobId -> job info
let pollingInterval = null;

/**
 * Process files with async job queue
 * Replace the existing processFiles() function
 */
async function processFiles() {
  const files = Array.from(uploadedFiles.values());
  
  if (files.length === 0) {
    showToast('Please upload files first', 'error');
    return;
  }

  // Show processing UI
  document.getElementById('processingIndicator').style.display = 'block';
  document.getElementById('processBtn').disabled = true;

  try {
    // Prepare form data
    const formData = new FormData();
    files.forEach(file => {
      formData.append('files', file);
    });

    // Add settings
    const settings = getUserSettings();
    formData.append('templateSettings', JSON.stringify(settings.templateSettings || {}));
    formData.append('selectedTextModel', settings.selectedTextModel || '');
    formData.append('selectedImageModel', settings.selectedImageModel || '');
    formData.append('customInstructions', settings.customInstructions || '');
    formData.append('language', settings.language || 'Smart Detect');
    formData.append('textFormat', settings.textFormat || 'Smart Detect');

    // Submit to API
    const response = await fetch('/api/files/process', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData
    });

    if (!response.ok) {
      const error = await response.json();
      throw new Error(error.error || 'Processing failed');
    }

    const result = await response.json();
    
    // Store job IDs and start polling
    result.jobs.forEach(job => {
      if (job.jobId) {
        activeJobs.set(job.jobId, {
          jobId: job.jobId,
          fileName: job.fileName,
          status: job.status,
          enqueuedAt: job.enqueuedAt,
          progress: 0
        });
      }
    });

    // Show queued message
    showToast(`${result.jobs.length} file(s) queued for processing`, 'success');
    
    // Update UI to show queued jobs
    renderQueuedJobs();
    
    // Start polling for job status
    startJobPolling();

  } catch (error) {
    console.error('Processing error:', error);
    showToast(error.message, 'error');
    document.getElementById('processingIndicator').style.display = 'none';
    document.getElementById('processBtn').disabled = false;
  }
}

/**
 * Render queued jobs in the UI
 */
function renderQueuedJobs() {
  const resultsContainer = document.getElementById('resultsContainer');
  resultsContainer.innerHTML = '';
  resultsContainer.style.display = 'block';

  const table = document.createElement('table');
  table.className = 'results-table';
  table.innerHTML = `
    <thead>
      <tr>
        <th>File Name</th>
        <th>Status</th>
        <th>Progress</th>
        <th>New Name</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="jobsTableBody"></tbody>
  `;

  resultsContainer.appendChild(table);

  updateJobsTable();
}

/**
 * Update jobs table with current status
 */
function updateJobsTable() {
  const tbody = document.getElementById('jobsTableBody');
  if (!tbody) return;

  tbody.innerHTML = '';

  activeJobs.forEach((job, jobId) => {
    const row = document.createElement('tr');
    row.id = `job-${jobId}`;

    // Status badge
    let statusBadge = '';
    if (job.status === 'queued' || job.status === 'waiting') {
      statusBadge = '<span class="status-badge status-queued">â³ Queued</span>';
    } else if (job.status === 'active') {
      statusBadge = '<span class="status-badge status-processing">âš™ï¸ Processing</span>';
    } else if (job.status === 'completed') {
      statusBadge = '<span class="status-badge status-completed">âœ… Complete</span>';
    } else if (job.status === 'failed') {
      statusBadge = '<span class="status-badge status-failed">âŒ Failed</span>';
    }

    // Progress bar
    const progress = job.progress || 0;
    const progressBar = `
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${progress}%"></div>
        <span class="progress-text">${progress}%</span>
      </div>
    `;

    // New filename or placeholder
    const newName = job.result?.newFilename || '-';

    // Actions
    let actions = '';
    if (job.status === 'completed' && job.result) {
      actions = `
        <button onclick="regenerateJob('${jobId}')" class="btn-icon" title="Regenerate">ðŸ”„</button>
        <button onclick="downloadFile('${jobId}')" class="btn-icon" title="Download">â¬‡ï¸</button>
      `;
    } else if (job.status === 'waiting' || job.status === 'queued') {
      actions = `
        <button onclick="cancelJob('${jobId}')" class="btn-icon" title="Cancel">âŒ</button>
      `;
    } else if (job.status === 'failed') {
      actions = `
        <button onclick="retryJob('${jobId}')" class="btn-icon" title="Retry">ðŸ”„</button>
      `;
    }

    row.innerHTML = `
      <td>${job.fileName}</td>
      <td>${statusBadge}</td>
      <td>${progressBar}</td>
      <td class="new-filename">${newName}</td>
      <td>${actions}</td>
    `;

    tbody.appendChild(row);
  });
}

/**
 * Start polling for job status
 */
function startJobPolling() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
  }

  pollingInterval = setInterval(async () => {
    await pollJobStatuses();
  }, 2000); // Poll every 2 seconds
}

/**
 * Stop polling
 */
function stopJobPolling() {
  if (pollingInterval) {
    clearInterval(pollingInterval);
    pollingInterval = null;
  }
}

/**
 * Poll status for all active jobs
 */
async function pollJobStatuses() {
  const jobIds = Array.from(activeJobs.keys());
  
  if (jobIds.length === 0) {
    stopJobPolling();
    document.getElementById('processingIndicator').style.display = 'none';
    document.getElementById('processBtn').disabled = false;
    return;
  }

  try {
    const response = await fetch('/api/files/status/batch', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ jobIds })
    });

    if (!response.ok) {
      throw new Error('Failed to get job statuses');
    }

    const data = await response.json();
    
    // Update job statuses
    let allComplete = true;
    data.jobs.forEach(jobStatus => {
      const job = activeJobs.get(jobStatus.jobId);
      if (job) {
        job.status = jobStatus.status;
        job.progress = jobStatus.progress || 0;
        job.result = jobStatus.result;
        job.error = jobStatus.error;

        // Check if still processing
        if (jobStatus.status === 'waiting' || jobStatus.status === 'active' || jobStatus.status === 'queued') {
          allComplete = false;
        }

        // Remove completed/failed jobs after a delay
        if (jobStatus.status === 'completed' || jobStatus.status === 'failed') {
          // Keep in map for now, will be removed when user interacts
        }
      }
    });

    // Update UI
    updateJobsTable();

    // Stop polling if all jobs complete
    if (allComplete) {
      stopJobPolling();
      document.getElementById('processingIndicator').style.display = 'none';
      document.getElementById('processBtn').disabled = false;
      showToast('All files processed!', 'success');
    }

  } catch (error) {
    console.error('Polling error:', error);
  }
}

/**
 * Cancel a job
 */
async function cancelJob(jobId) {
  try {
    const response = await fetch(`/api/files/job/${jobId}`, {
      method: 'DELETE',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      }
    });

    if (response.ok) {
      activeJobs.delete(jobId);
      updateJobsTable();
      showToast('Job cancelled', 'success');
    } else {
      const error = await response.json();
      showToast(error.error || 'Failed to cancel job', 'error');
    }
  } catch (error) {
    console.error('Cancel error:', error);
    showToast('Failed to cancel job', 'error');
  }
}

/**
 * Regenerate a file (create new job)
 */
async function regenerateJob(jobId) {
  const job = activeJobs.get(jobId);
  if (!job || !job.result) return;

  try {
    // Get original file from uploadedFiles map
    const originalFile = Array.from(uploadedFiles.values()).find(
      f => f.name === job.fileName
    );

    if (!originalFile) {
      showToast('Original file not found', 'error');
      return;
    }

    // Create new job with regenerate flag
    const formData = new FormData();
    formData.append('files', originalFile);
    formData.append('regenerate', 'true');

    const settings = getUserSettings();
    formData.append('templateSettings', JSON.stringify(settings.templateSettings || {}));
    formData.append('selectedTextModel', settings.selectedTextModel || '');
    formData.append('selectedImageModel', settings.selectedImageModel || '');

    const response = await fetch('/api/files/process', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${localStorage.getItem('token')}`
      },
      body: formData
    });

    if (!response.ok) {
      throw new Error('Regenerate failed');
    }

    const result = await response.json();
    
    // Add new job
    result.jobs.forEach(newJob => {
      if (newJob.jobId) {
        activeJobs.set(newJob.jobId, {
          jobId: newJob.jobId,
          fileName: newJob.fileName,
          status: newJob.status,
          enqueuedAt: newJob.enqueuedAt,
          progress: 0
        });
      }
    });

    // Remove old job
    activeJobs.delete(jobId);

    updateJobsTable();
    startJobPolling();
    showToast('Regenerating...', 'info');

  } catch (error) {
    console.error('Regenerate error:', error);
    showToast('Failed to regenerate', 'error');
  }
}

/**
 * Download file with new name
 */
function downloadFile(jobId) {
  const job = activeJobs.get(jobId);
  if (!job || !job.result) return;

  // Get original file
  const originalFile = Array.from(uploadedFiles.values()).find(
    f => f.name === job.fileName
  );

  if (!originalFile) {
    showToast('File not found', 'error');
    return;
  }

  // Create download with new name
  const blob = new Blob([originalFile], { type: originalFile.type });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = job.result.newFilename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);

  showToast('Downloaded!', 'success');
}

/**
 * Retry a failed job
 */
async function retryJob(jobId) {
  // Same as regenerate
  await regenerateJob(jobId);
}

/*
 * ============================================================================
 * ADD CSS STYLES
 * ============================================================================
 */

/*
Add to <style> section:

.status-badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: 600;
}

.status-queued {
  background: #fef3c7;
  color: #92400e;
}

.status-processing {
  background: #dbeafe;
  color: #1e40af;
}

.status-completed {
  background: #d1fae5;
  color: #065f46;
}

.status-failed {
  background: #fee2e2;
  color: #991b1b;
}

.progress-bar {
  width: 100%;
  height: 20px;
  background: #e5e7eb;
  border-radius: 10px;
  position: relative;
  overflow: hidden;
}

.progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #f97316, #fb923c);
  transition: width 0.3s ease;
}

.progress-text {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 11px;
  font-weight: 600;
  color: #1f2937;
}

.btn-icon {
  background: none;
  border: none;
  font-size: 18px;
  cursor: pointer;
  padding: 4px 8px;
  transition: transform 0.2s;
}

.btn-icon:hover {
  transform: scale(1.2);
}

.new-filename {
  color: #f97316;
  font-weight: 600;
}
*/

/*
 * ============================================================================
 * SUMMARY
 * ============================================================================
 *
 * This frontend code:
 * 1. Submits files to /api/files/process
 * 2. Receives job IDs immediately
 * 3. Polls /api/files/status/batch every 2 seconds
 * 4. Updates UI with progress bars and status badges
 * 5. Shows results when complete
 * 6. Allows regenerate, download, cancel, retry actions
 *
 * User experience:
 * - Upload files
 * - Click "Process"
 * - See jobs queued immediately
 * - Watch progress bars update in real-time
 * - Get results when complete
 * - Download files with new names
 */

// Model Configuration Data
const modelConfigs = {
  openai: {
    provider: 'openai',
    providerName: 'OpenAI',
    models: [
      { id: 'gpt-4o', name: 'GPT-4o', version: 'latest', categories: ['text', 'vision'], pricing: '$0.005/1K tokens',
        plans: { free: { enabled: false, priority: 0 }, credits_low: { enabled: true, priority: 2 }, credits_high: { enabled: true, priority: 1 }, unlimited: { enabled: true, priority: 1 } } },
      { id: 'gpt-4o-mini', name: 'GPT-4o Mini', version: 'standard', categories: ['text', 'vision'], pricing: '$0.00015/1K tokens',
        plans: { free: { enabled: true, priority: 1 }, credits_low: { enabled: true, priority: 1 }, credits_high: { enabled: true, priority: 2 }, unlimited: { enabled: true, priority: 2 } } },
      { id: 'gpt-3.5-turbo', name: 'GPT-3.5 Turbo', version: 'legacy', categories: ['text'], pricing: '$0.0005/1K tokens',
        plans: { free: { enabled: true, priority: 2 }, credits_low: { enabled: true, priority: 3 }, credits_high: { enabled: false, priority: 0 }, unlimited: { enabled: false, priority: 0 } } },
      { id: 'whisper-1', name: 'Whisper', version: 'v1', categories: ['audio'], pricing: '$0.006/min',
        plans: { free: { enabled: true, priority: 1 }, credits_low: { enabled: true, priority: 1 }, credits_high: { enabled: true, priority: 1 }, unlimited: { enabled: true, priority: 1 } } }
    ]
  },
  anthropic: {
    provider: 'anthropic',
    providerName: 'Anthropic',
    models: [
      { id: 'claude-3-5-sonnet', name: 'Claude 3.5 Sonnet', version: 'latest', categories: ['text', 'vision'], pricing: '$0.003/1K tokens',
        plans: { free: { enabled: true, priority: 1 }, credits_low: { enabled: true, priority: 1 }, credits_high: { enabled: true, priority: 2 }, unlimited: { enabled: true, priority: 2 } } },
      { id: 'claude-3-haiku', name: 'Claude 3 Haiku', version: 'fast', categories: ['text', 'vision'], pricing: '$0.00025/1K tokens',
        plans: { free: { enabled: true, priority: 2 }, credits_low: { enabled: true, priority: 2 }, credits_high: { enabled: true, priority: 3 }, unlimited: { enabled: true, priority: 3 } } },
      { id: 'claude-3-opus', name: 'Claude 3 Opus', version: 'premium', categories: ['text', 'vision'], pricing: '$0.015/1K tokens',
        plans: { free: { enabled: false, priority: 0 }, credits_low: { enabled: false, priority: 0 }, credits_high: { enabled: true, priority: 4 }, unlimited: { enabled: true, priority: 1 } } }
    ]
  },
  google: {
    provider: 'google',
    providerName: 'Google AI',
    models: [
      { id: 'gemini-2.0-flash', name: 'Gemini 2.0 Flash', version: 'latest', categories: ['text', 'vision'], pricing: '$0.00035/1K tokens',
        plans: { free: { enabled: true, priority: 1 }, credits_low: { enabled: true, priority: 1 }, credits_high: { enabled: true, priority: 1 }, unlimited: { enabled: true, priority: 1 } } },
      { id: 'gemini-1.5-pro', name: 'Gemini 1.5 Pro', version: 'standard', categories: ['text', 'vision', 'audio'], pricing: '$0.00125/1K tokens',
        plans: { free: { enabled: false, priority: 0 }, credits_low: { enabled: true, priority: 2 }, credits_high: { enabled: true, priority: 2 }, unlimited: { enabled: true, priority: 2 } } }
    ]
  },
  openrouter: {
    provider: 'openrouter',
    providerName: 'OpenRouter',
    models: [
      { id: 'qwen-2-vl-72b', name: 'Qwen 2 VL 72B', version: 'vision', categories: ['text', 'vision'], pricing: '$0.0004/1K tokens',
        plans: { free: { enabled: true, priority: 1 }, credits_low: { enabled: true, priority: 1 }, credits_high: { enabled: true, priority: 3 }, unlimited: { enabled: true, priority: 3 } } },
      { id: 'llama-3.2-90b-vision', name: 'LLaMA 3.2 90B Vision', version: 'vision', categories: ['text', 'vision'], pricing: '$0.0009/1K tokens',
        plans: { free: { enabled: true, priority: 2 }, credits_low: { enabled: true, priority: 2 }, credits_high: { enabled: true, priority: 4 }, unlimited: { enabled: true, priority: 4 } } }
    ]
  }
};

const ocrConfigs = {
  tesseract: { provider: 'tesseract', providerName: 'Tesseract OCR',
    plans: { free: { enabled: true, priority: 1 }, credits_low: { enabled: true, priority: 2 }, credits_high: { enabled: true, priority: 3 }, unlimited: { enabled: true, priority: 4 } } },
  google_vision: { provider: 'google_vision', providerName: 'Google Cloud Vision OCR',
    plans: { free: { enabled: true, priority: 2 }, credits_low: { enabled: true, priority: 1 }, credits_high: { enabled: true, priority: 1 }, unlimited: { enabled: true, priority: 1 } } },
  aws_textract: { provider: 'aws_textract', providerName: 'AWS Textract',
    plans: { free: { enabled: false, priority: 0 }, credits_low: { enabled: true, priority: 3 }, credits_high: { enabled: true, priority: 2 }, unlimited: { enabled: true, priority: 2 } } },
  azure_ocr: { provider: 'azure_ocr', providerName: 'Azure Computer Vision OCR',
    plans: { free: { enabled: false, priority: 0 }, credits_low: { enabled: false, priority: 0 }, credits_high: { enabled: true, priority: 4 }, unlimited: { enabled: true, priority: 3 } } }
};

const priorityLabels = { 0: 'Disabled', 1: 'Primary', 2: 'Secondary', 3: 'Tertiary', 4: 'Optional' };

// Render model configuration table for a provider
function renderModelConfigTable(providerId) {
  const config = modelConfigs[providerId];
  if (!config) return;
  
  const tbody = document.getElementById('modelTableBody' + capitalizeFirst(providerId));
  if (!tbody) return;
  
  tbody.innerHTML = '';
  
  config.models.forEach(model => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>
        <span class="model-name">${model.name}</span>
        <span class="model-version">(${model.version}, ${model.pricing})</span>
      </td>
      <td>
        <div class="category-tags">
          ${model.categories.map(cat => `<span class="category-tag ${cat}">${cat}</span>`).join('')}
        </div>
      </td>
      ${['free', 'credits_low', 'credits_high', 'unlimited'].map(plan => {
        const planConfig = model.plans[plan];
        const isEnabled = planConfig.enabled;
        const priority = planConfig.priority;
        return `
          <td class="plan-col-${plan.replace('_', '-')}">
            <div class="plan-config">
              <div class="plan-checkbox">
                <input type="checkbox" ${isEnabled ? 'checked' : ''} 
                  onchange="updateModelConfig('${providerId}', '${model.id}', '${plan}', this.checked, document.getElementById('priority_${providerId}_${model.id}_${plan}').value)">
              </div>
              <select class="priority-select" id="priority_${providerId}_${model.id}_${plan}" 
                ${!isEnabled ? 'disabled' : ''}
                onchange="updateModelConfig('${providerId}', '${model.id}', '${plan}', true, this.value)">
                <option value="0" ${priority === 0 ? 'selected' : ''}>Disabled</option>
                <option value="1" ${priority === 1 ? 'selected' : ''}>Primary</option>
                <option value="2" ${priority === 2 ? 'selected' : ''}>Secondary</option>
                <option value="3" ${priority === 3 ? 'selected' : ''}>Tertiary</option>
                <option value="4" ${priority === 4 ? 'selected' : ''}>Optional</option>
              </select>
            </div>
          </td>
        `;
      }).join('')}
    `;
    tbody.appendChild(row);
  });
}

// Update model configuration
function updateModelConfig(providerId, modelId, plan, enabled, priority) {
  const config = modelConfigs[providerId];
  if (!config) return;
  
  const model = config.models.find(m => m.id === modelId);
  if (!model) return;
  
  model.plans[plan] = {
    enabled: enabled,
    priority: parseInt(priority) || 0
  };
  
  // Update UI
  const selectEl = document.getElementById(`priority_${providerId}_${modelId}_${plan}`);
  if (selectEl) {
    selectEl.disabled = !enabled;
    if (!enabled) selectEl.value = '0';
  }
  
  // Save to server
  saveModelConfigs();
}

// Update OCR configuration
function updateOCRConfig(providerId, plan) {
  const checkbox = document.getElementById(`ocr${capitalizeFirst(providerId)}${capitalizeFirst(plan.replace('_', ''))}Cb`);
  const select = document.getElementById(`ocr${capitalizeFirst(providerId)}${capitalizeFirst(plan.replace('_', ''))}Priority`);
  
  if (!checkbox || !select) return;
  
  const enabled = checkbox.checked;
  const priority = parseInt(select.value) || 0;
  
  if (ocrConfigs[providerId]) {
    ocrConfigs[providerId].plans[plan] = { enabled, priority };
  }
  
  select.disabled = !enabled;
  if (!enabled) select.value = '0';
  
  saveModelConfigs();
}

// Filter plan columns
function filterPlan(providerId, plan) {
  const buttons = document.querySelectorAll(`#modelConfig${capitalizeFirst(providerId)} .plan-filter-btn`);
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  // Visual highlight only - all columns remain visible
  const table = document.getElementById(`modelTable${capitalizeFirst(providerId)}`);
  if (!table) return;
  
  // Remove all highlights
  table.querySelectorAll('th, td').forEach(cell => {
    cell.style.opacity = '1';
  });
  
  if (plan !== 'all') {
    // Dim non-selected columns
    const planIndex = { free: 2, credits_low: 3, credits_high: 4, unlimited: 5 }[plan];
    if (planIndex) {
      table.querySelectorAll('tr').forEach(row => {
        row.querySelectorAll('th, td').forEach((cell, idx) => {
          if (idx >= 2 && idx !== planIndex) {
            cell.style.opacity = '0.3';
          }
        });
      });
    }
  }
}

// Save configurations to server
async function saveModelConfigs() {
  try {
    const response = await fetch('/api/model-configs', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ modelConfigs, ocrConfigs })
    });
    if (!response.ok) throw new Error('Failed to save');
    console.log('Model configs saved');
  } catch (error) {
    console.error('Error saving model configs:', error);
  }
}

// Load configurations from server
async function loadModelConfigs() {
  try {
    const response = await fetch('/api/model-configs');
    if (response.ok) {
      const data = await response.json();
      if (data.modelConfigs) Object.assign(modelConfigs, data.modelConfigs);
      if (data.ocrConfigs) Object.assign(ocrConfigs, data.ocrConfigs);
    }
  } catch (error) {
    console.error('Error loading model configs:', error);
  }
  
  // Render tables for all providers
  ['openai', 'anthropic', 'google', 'openrouter'].forEach(renderModelConfigTable);
  renderOCRConfigs();
}

// Render OCR configurations
function renderOCRConfigs() {
  for (const providerId in ocrConfigs) {
    const config = ocrConfigs[providerId];
    ['free', 'credits_low', 'credits_high', 'unlimited'].forEach(plan => {
      const planConfig = config.plans[plan];
      const cbId = `ocr${capitalizeFirst(providerId)}${capitalizeFirst(plan.replace('_', ''))}Cb`;
      const selectId = `ocr${capitalizeFirst(providerId)}${capitalizeFirst(plan.replace('_', ''))}Priority`;
      
      const cb = document.getElementById(cbId);
      const select = document.getElementById(selectId);
      
      if (cb) cb.checked = planConfig.enabled;
      if (select) {
        select.value = planConfig.priority;
        select.disabled = !planConfig.enabled;
      }
    });
  }
}

function capitalizeFirst(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Load model configs after a short delay to ensure DOM is ready
  setTimeout(loadModelConfigs, 500);
});

</script>
</body>
</html>

